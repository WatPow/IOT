IoT & Security 
Gerald Maunier
03/2025
v1.3
About me…
2
Final Project 
(4-6h)                       .
Planning
Public clouds project 
(1-2h)
3
Security checkpoint project
(1h)
IoT & Security
What is IoT for you?
What are the main domains?
How many IoT devices expected in 2030?
What are the goals of IoT Security measures?
4
IoT: Definition
Oxford: « The interconnection via the Internet of computing devices embedded in everyday objects, enabling them to send and receive data»
Or, simply put: « The interface between the physical and digital worlds »
Application domains
Home automation 	Lights, thermostat…
Industrial Control System	Food dispensers, vehicles/assets fleets, production monitoring…
Healthcare		eCall system, cardiac monitors, insulin pumps…
Sport 		Quantified self, performance tracking…
Energy 		Consumption monitoring, smart grid control…
Automotive 		Connected car, autonomous cars …   
…
5
Projections on number of Connected objects
6
Projections on number of Connected objects
7
A world of connected objects
2025
30+Bs
Source : Gartner
22
50
38.6
2030
2025
2018
127 new IoT devices connect to the internet every second    McKinsey Global Institute
84% of organizations that have adopted IoT have experienced an IoT-related security breach.     Fierce Electronics
Spending on IoT endpoint security solutions will increase to $631M in 2025.     Gartner
Typical IoT solution architecture
The object is not alone
IoT security is not limited to object security
Challenges : 
    Server team does not know embedded device constraints
& Device team does not know anything about IT
8
Information
Commands
Analytics/
Storage
Monitor
Control
IoT  security goals
The goals of IoT Security measures
CIA ‘forever’ 
plus
Avoid counterfeiting 
Protect IP
Avoid firmware tampering
Avoid repurposing
Avoid data & commands tampering
Avoid privacy leaks
…
9
IoT [in]security
10
 ‘In the future, intelligence services might use the internet of things for identification, surveillance, monitoring, location tracking […]’, 
says James Clapper, 
director of US national intelligence. 
Guess what this is ? (an old story)
11
12
Not that old but same story…
Security mechanisms goals
13
Information
Commands
Analytics/
Storage
Monitor
Control
14
Information
Commands
Analytics/
Storage
Monitor
Control
Security mechanisms goals
15
Information
Commands
Analytics/
Storage
Monitor
Control
Security mechanisms goals
16
Information
Commands
Analytics/
Storage
Monitor
Control
Security mechanisms goals
17
Information
Commands
Analytics/
Storage
Monitor
Control
Security mechanisms goals
Business Challenges
Every single electrical device will be connected
This myriad of Objects will generate huge volume of data, collected and analyzed, creating new era of service & value
New business models are to be defined, but these opportunities must not be hampered by data breaches, data tampering, device repurposing, privacy exposure, …
18
Appropriate security is mandatory to realize this potential and protect people/brands/businesses…
Business Constraints
Business cost, environment and capabilities may bring technical challenges:
Network bandwidth may be limited
Power consumption considerations may be vital
Computing resources may be limited in device MCU (price)
Cloud operation cost may be under pressure
Devices are usually easily accessible to anyone to tamper with
User may act against the product
Most products will remain on the field for decades
19
All starts with a lot of choices…
What hardware and with what resources & security services?
What OS ?
What communication channel ?
What transport layer?
What authentication & encryption mechanisms ?
Going for DIY or leveraging IoT clouds ?
There is a need to aggregate of lot of different criteria and     knowledge domains
20
Traditional IoT projects constraints…
Prototype fast
MVP approach
Improve as you grow
Most of the time starting from existing hardware, no real IT/security experts
Security is often afterthought
21
Remember the dash button case…
Every project should start with a security assessment: what do we want to protect, against whom, and what would be the cost of failure (impact)
22
IoT OSs
Linux
RTOS
Pike OS
ARM mBed
…
None (Bare Metal)
23
IoT transport channels
Cellular
NB-IoT 
Lora
Sigfox
Wifi / Lan
Via a GW 
Zigbee
Z-Wave
BLE
Matter
Some additional challenges
Global coverage
FW update size vs data plans
24
IoT communication protocols 
TCP/UDP
TLS/dTLS
HTTP / REST
HTTP / CoAP
WebSocket
MQTT
LWM2M
…
25
IoT
Communication
Protocols
LWM2M
Remote device control
User side
Custom mobile application (iPhone/Android) ?
Web interface ?
Voice ?
Device control channels
Directly from the app/web server to the device?
Via a (cloud) messaging/brokering service?
26
Cloud services
Cloud services is meant from a device point of view
This « Cloud » may be based on:
On-Premises enterprise resources
PaaS 
Public messaging services (brokers)
Public IoT Clouds
27
Ambient IoT 
Greener by harvesting energy from ambient sources
Harnessing, transforming and storing energy 
From solar, RF waves, physical vibrations…
 extend lifetime, reduce use of disposable batteries…
Larger and better network, unlocking new use cases
Short range, Wireless connectivity
Dense and more reliable framework
 long term cost saving and more flexible, e.g. smart agriculture
28
Impact on you as cyber experts…
Cyber covers a huge variety of domains
Some are common and mandatory
But you need to have a large culture 
And a few specializations
29
Let’s start our own IoT project!
We want to produce smart lamps, with following features
Lamp has a dimmer 
Lamp reports power consumption
User may monitor & control it remotely from his mobile (presence simulation)
User may control the lamp via his voice assistant
Some choices have already been made by the PoC team:
We’ll use a raspberry Pi (could have been Arduino/Nucleo/ESP8266)
Application logic will be coded using Node Red (could have been python,…)
We’d like to avoid Mobile application development (browser preferred)
We’d like to leverage a public cloud platform to reach our lamps (we’re not IT specialists)
Online services must be ‘secure’
We’d like to use our internal PKI & avoid counterfeiting
Misc: use LAN connectivity, no special power consumption constraints, no BOM or operations price constraints, User is (maybe) friendly
30
Phase #1
Let’s build the hardware part
a Raspberry PI
a LED
a Button
a workflow
Almost a dumb lamp… but with a CPU
31
Preparing RPI for remote access
Create an SD card with pi OS
Raspberry Pi Imager : https://www.raspberrypi.org/software/ +  raspberry pi OS (other)-> raspberry pi os full (32 bits)
Or
WIN32diskimager: https://sourceforge.net/projects/win32diskimager/files/latest/download
OS image: https://www.raspberrypi.org/software/operating-systems/ (Raspberry Pi OS with desktop and recommended software)
Activate ssh in imager or:
create a file named ssh in boot partition 
or change RPI config
	sudo raspi-config
Login
	User: pi	Default password: raspberry
Configure Wifi in imager or:
	sudo nano /etc/wpa_supplicant/wpa_supplicant.conf
	Or just drop same file in /boot on SD (using unix file format)
	Note: For WPA2 AES add pairwise=CCMP
country=FR
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1
network={ 
	ssid="Webbing4G-3308"	
	psk=“xxxxxxxxxx"
	key_mgmt=WPA-PSK
                       pairwise=CCMP
}
/etc/wpa_supplicant/wpa_supplicant.conf
32
RPI GPIOs* 
PINs Mapping & numbering
GPIO.BOARD  numbering refers to the pins by the number of the pin on the plug and in the middle of the diagram.
GPIO.BCM  numbering means that you are referring to the pins by the "Broadcom SOC channel" number, these are the numbers after "GPIO" in the green rectangles around the diagram
*GPIO stands for General Purpose Input/Output
33
Few words aboud the Breadboard
34
To quickly prototype electronic circuits
Easy, reusable
			Lots of components available
LED on RPI – Hardware setup
Soldering / Cabling
Note : 
330Ω = Orange / Orange / Brown / Gold
LED anode = longest leg
LED cathode = shortest leg/flat side
Resistor color / resistance coding : https://www.digikey.com/en/resources/conversion-calculators/conversion-calculator-resistor-color-code-4-band 
GND (Board 6)
330Ω resistor
Cathode
Anode    
GPIO 18 (Board 12) 
LED
35
Be careful, handle board & SD card with care, don’t touch PCB when powered on, double check connections… no 5V!!
LED on RPI – Controlling with python
Importing the GPIO control library
	>>> import RPi.GPIO as GPIO
Selecting the GPIO PINs numbering mode 
	>>> GPIO.setmode(GPIO.BCM)
Set GPIO to output mode
	>>> GPIO.setup(18,GPIO.OUT)
Set GPIO 18 PIN to low or high current
	>>> GPIO.output(18,GPIO.HIGH)	>>> GPIO.output(18,GPIO.LOW)
To cleanup
	>>> GPIO.cleanup()
36
HINT : Start « python »  
>>> …
(^D to quit)
LED on RPI – Hands on in Python
Hands on: Make the LED blink every second
Create and edit with  nano LED.py
Execute with  python LED.py
Tips:
time.sleep(1)
In case of “warning” message: Need to cleanup…
37
Node Red on RPI
A flow based open source programming tool, designed by IBM in node.js
Install
sudo apt update
[sudo apt remove nodejs]
bash <(curl -sL https://raw.githubusercontent.com/node-red/linux-installers/master/deb/update-nodejs-and-nodered) 
	then answer Yes/Yes/Yes
Start/Stop Node Red on RPI manually [as a service]
	 node-red[-start/-stop]
[Starting Node Red on RPI automatically]
	sudo systemctl enable nodered.service  to autostart Node-RED at every boot
	sudo systemctl disable nodered.service to disable autostart on boot
Accessing Node Red
	Open a browser on RPI IP address:1880
Adding the dashboard features
	access Node Red menu / manage palette
		install / node-red-dashboard
Note: node red may be hosted on another device or in the cloud (but not for GPIOs)
38
Node Red - Basics
Flows, Nodes & Connectors
To execute/update a flow
	Click
To load & save a flow
	Your flow is stored in the device
	Click Menu and Import / Export (in clipboard!)
	Rename / Activate / Deactivate via double-click
39
Node Red - Basics
Useful nodes
Data injection
RPI GPIO In
RPI GPIO Out
Javascript Fct 
[context/flow/global].get("name") 
msg.payload
Return msg / null
Switch
Debug
MQTT
40
LED on RPI – Controlling with Node Red
Create ON and OFF buttons with Data Injection node
Number Value 0 or 1
41
LED on RPI – Controlling with Node Red
Create ON and OFF buttons with Data Injection node
Number Value 0 or 1
Add a debug node to display resulting value
   Tips : 
	Tick the ‘node status’ to display value in Flow 
	Bind debug to buttons to display msg.payload
	Deploy & play with the buttons
	Activate/deactive debug node
42
LED on RPI – Controlling with Node Red
Add GPIO output node for the LED on GPIO18
Connect the LED node to the 2 buttons
Try switching LED on & off
Hint : don’t forget to deploy!
43
LED on RPI – Controlling with Node Red
Solution
[{"id":"170afed9.5aeb29","type":"tab","label":"Flow 2","disabled":false,"info":""},{"id":"54b90cd8.e59d54","type":"inject","z":"170afed9.5aeb29","name":"","topic":"LED OFF","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":170,"y":220,"wires":[["fce7e702.2cf6b","5060b9ca.75152c"]]},{"id":"fce7e702.2cf6b","type":"debug","z":"170afed9.5aeb29","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":890,"y":200,"wires":[],"inputLabels":["msg.payload"]},{"id":"68594cb5.0f8a34","type":"inject","z":"170afed9.5aeb29","name":"","topic":"LED ON","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":260,"wires":[["5060b9ca.75152c","fce7e702.2cf6b"]]},{"id":"5060b9ca.75152c","type":"rpi-gpio out","z":"170afed9.5aeb29","name":"Led on GPIO18","pin":"12","set":false,"level":"0","freq":"","out":"out","x":900,"y":260,"wires":[]}]
Node Red Flow RPI_LED_1
44
LED on RPI – Controlling with Node Red
Create a « switch LED » flow using javascript fct
Tips : 
	msg.payload will be the expected LED state (0:OFF, 1:ON) on function return
	v=flow.get("myvar") and flow.set("myvar",v) may be used to store node ‘global’ variable called myvar
	context.get() and global.get() may also be used
Option: make it blink automatically every second
45
Switch LED
Node Red Flow RPI_LED_2
Note : when using ON/OFF buttons, switch is not behaving correctly…
[{"id":"d3f6bafc.517628","type":"tab","label":"RPI_LED_2","disabled":true,"info":""},{"id":"902a5801.3c24a8","type":"function","z":"d3f6bafc.517628","name":"Switch LED state","func":"var myvarnode = !context.get(\"myvarnode\");\ncontext.set(\"myvarnode\",myvarnode);\nmsg.payload=myvarnode;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":710,"y":460,"wires":[["eb402fd6.92129","725a55fc.06aeac"]]},{"id":"3a7b28a0.64f358","type":"inject","z":"d3f6bafc.517628","name":"chaque seconde","repeat":"1","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"date","x":330,"y":520,"wires":[[]]},{"id":"b59dbe3f.e3994","type":"inject","z":"d3f6bafc.517628","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED OFF","payload":"0","payloadType":"num","x":310,"y":360,"wires":[["725a55fc.06aeac","eb402fd6.92129"]]},{"id":"725a55fc.06aeac","type":"debug","z":"d3f6bafc.517628","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":1030,"y":340,"wires":[],"inputLabels":["msg.payload"]},{"id":"7224d36c.5491cc","type":"inject","z":"d3f6bafc.517628","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED ON","payload":"1","payloadType":"num","x":300,"y":400,"wires":[["eb402fd6.92129","725a55fc.06aeac"]]},{"id":"eb402fd6.92129","type":"rpi-gpio out","z":"d3f6bafc.517628","name":"Led on GPIO18","pin":"18","set":false,"level":"0","freq":"","out":"out","bcm":true,"x":1040,"y":400,"wires":[]},{"id":"c25a4ab6.bb9ab8","type":"inject","z":"d3f6bafc.517628","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"SWITCH LED","payload":"1","payloadType":"num","x":320,"y":460,"wires":[["902a5801.3c24a8"]]}]
46
Button on RPI – Hardware setup
Soldering / Cabling
Note : 
10KΩ = Brown / Black / Orange / Gold
Resistor color / resistance coding : https://www.digikey.com/en/resources/conversion-calculators/conversion-calculator-resistor-color-code-4-band 
3.3V (Board 1)
10KΩ resistor
GPIO4 (Board 7)
GND (Board 9)
Button
47
Button on RPI - with Python
Importing the GPIO control library
	import RPi.GPIO as GPIO
Selecting the GPIO PINs numbering mode 
	GPIO.setmode(GPIO.BCM)
Set GPIO to input mode
	GPIO.setup(4,GPIO.IN)
Get GPIO value
	GPIO.input(4)  True / False
To cleanup
	GPIO.cleanup()
48
Button on RPI - with Python
Hands on : Detect button press
Tips:
Create and edit with nano BTN.py
Execute with python BTN.py
In case of “warning” message: Need to cleanup…
49
Button on RPI - with Node Red
Add GPIO input node for Button on GPIO4
Add a debug value to display button output
Node Red Flow RPI_BTN_1
[{"id":"35c532b7.553d8e","type":"tab","label":"RPI_BTN_1","disabled":false,"info":""},{"id":"97893541.c43b38","type":"rpi-gpio in","z":"35c532b7.553d8e","name":"BTN on GPIO4","pin":"7","intype":"up","debounce":"25","read":true,"x":320,"y":300,"wires":[["e943d6ed.8b1868"]]},{"id":"e943d6ed.8b1868","type":"debug","z":"35c532b7.553d8e","name":"Button value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":750,"y":300,"wires":[],"inputLabels":["msg.payload"]}]
50
LED & Button on RPI - with Node Red
Connect button and LED
What’s wrong ?
Tip : 
	a button fires a ON and OFF event when pressed & released
Node Red Flow RPI_BTN_2
[{"id":"e8bc8e3b.751bc8","type":"tab","label":"RPI_BTN_2","disabled":false,"info":""},{"id":"b3d41a63.e3a398","type":"rpi-gpio in","z":"e8bc8e3b.751bc8","name":"BTN on GPIO4","pin":"7","intype":"up","debounce":"25","read":true,"x":360,"y":200,"wires":[["77238c7a.2829c4"]]},{"id":"77238c7a.2829c4","type":"rpi-gpio out","z":"e8bc8e3b.751bc8","name":"Led on GPIO18","pin":"12","set":false,"level":"0","freq":"","out":"out","x":740,"y":200,"wires":[]}]
51
LED & Button on RPI - with Node Red
Tweak LED flow to use button as a real switch
Tip : 
	both switch and function nodes may be used to filter events
52
LED & Button on RPI - with Node Red
Solution
Node Red Flow RPI_LED_BTN_1
53
LED & Button on RPI - with Node Red
Solution
[{"id":"72ecef13.ebb5a","type":"tab","label":"RPI_LED_BTN_1","disabled":false,"info":""},{"id":"3a693104.ead97e","type":"function","z":"72ecef13.ebb5a","name":"Switch LED state","func":"var myvarnode = !context.get(\"myvarnode\");\ncontext.set(\"myvarnode\", myvarnode);\nmsg.payload = myvarnode;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":670,"y":220,"wires":[["8a141a57.f516d8","9988edf5.8a8af"]]},{"id":"c1bf6711.e38f88","type":"inject","z":"72ecef13.ebb5a","name":"SWITCH LED","repeat":"1","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"date","x":220,"y":260,"wires":[[]]},{"id":"a2a5b2b3.448d4","type":"inject","z":"72ecef13.ebb5a","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED OFF","payload":"0","payloadType":"num","x":210,"y":120,"wires":[["9988edf5.8a8af","8a141a57.f516d8"]]},{"id":"9988edf5.8a8af","type":"debug","z":"72ecef13.ebb5a","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":930,"y":80,"wires":[],"inputLabels":["msg.payload"]},{"id":"38233206.e4beae","type":"inject","z":"72ecef13.ebb5a","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED ON","payload":"1","payloadType":"num","x":200,"y":160,"wires":[["8a141a57.f516d8","9988edf5.8a8af"]]},{"id":"8a141a57.f516d8","type":"rpi-gpio out","z":"72ecef13.ebb5a","name":"Led on GPIO18","pin":"18","set":false,"level":"0","freq":"","out":"out","bcm":true,"x":940,"y":160,"wires":[]},{"id":"6fea8dbc.4c0f14","type":"rpi-gpio in","z":"72ecef13.ebb5a","name":"BTN on GPIO4","pin":"4","intype":"up","debounce":"25","read":true,"bcm":true,"x":220,"y":340,"wires":[["883815dc.bf1768"]]},{"id":"65cb1f01.0628f","type":"inject","z":"72ecef13.ebb5a","name":"SWITCH LED","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":210,"y":220,"wires":[["3a693104.ead97e"]]},{"id":"3d09e14.de42a1e","type":"function","z":"72ecef13.ebb5a","name":"If button down","func":"if (msg.payload===0)\n    return msg;\n    \nreturn  null;","outputs":1,"noerr":0,"x":440,"y":340,"wires":[[]]},{"id":"883815dc.bf1768","type":"switch","z":"72ecef13.ebb5a","name":"If button down","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":440,"y":300,"wires":[["3a693104.ead97e"],[]]}]
Node Red Flow RPI_LED_BTN_1
54
Note : when using ON/OFF buttons, switch is still not behaving correctly…
LED & Button on RPI - with Node Red
Need to sync on/off buttons and switch 
Complete context var management. Use 
var value=flow.get(“var”) 
flow.set(“var”,value)
Optimize the number of connections 
Use dispatch nodes (‘change’ node)
Clean nodes’ names if needed
55
LED & Button on RPI - Adjust LED Power to dim
Need to change the LED node properties to Pulse Width Modulation:
And send 0-100 values to control LED state (0:OFF, 100:max light)
Note : Most LEDs are not dimmable over the whole 0-100 range
56
LED & Button on RPI
[{"id":"f7e0aaa6.572a88","type":"tab","label":"RPI_LED_BTN_2","disabled":false,"info":""},{"id":"d2f464b2.6660e8","type":"function","z":"f7e0aaa6.572a88","name":"Set LED state OFF","func":"var ledState = flow.get(\"LEDState\")||0;\nif (ledState===0)\n    return null;\n    \nledState = 0;\nmsg.payload = 0;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":140,"wires":[["e9fc023b.8920b"]]},{"id":"26b192f9.d4ebee","type":"function","z":"f7e0aaa6.572a88","name":"Set LED state ON","func":"var ledState = flow.get(\"LEDState\")||0;\nif (ledState==1)\n        return null;\n\nledState = 1;\nmsg.payload = 1;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":180,"wires":[["e9fc023b.8920b"]]},{"id":"e9fc023b.8920b","type":"change","z":"f7e0aaa6.572a88","name":"Dispatch","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":840,"y":160,"wires":[["f8ab0385.82db1","6073fa84.ab0024"]]},{"id":"ed9fa045.b70e9","type":"function","z":"f7e0aaa6.572a88","name":"Switch LED state","func":"var ledState=!flow.get(\"LEDState\");\n\nmsg.payload = ledState;\nflow.set(\"LEDState\", ledState);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":240,"wires":[["e9fc023b.8920b"]]},{"id":"163c5025.a9a45","type":"inject","z":"f7e0aaa6.572a88","name":"SWITCH LED","repeat":"1","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"date","x":200,"y":280,"wires":[[]]},{"id":"2c2a8daf.e5d5a2","type":"inject","z":"f7e0aaa6.572a88","name":"LED OFF","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"0","payloadType":"num","x":180,"y":140,"wires":[["d2f464b2.6660e8"]]},{"id":"f8ab0385.82db1","type":"debug","z":"f7e0aaa6.572a88","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":1030,"y":120,"wires":[],"inputLabels":["msg.payload"]},{"id":"dadd521c.de8f4","type":"inject","z":"f7e0aaa6.572a88","name":"LED ON","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":180,"y":180,"wires":[["26b192f9.d4ebee"]]},{"id":"6073fa84.ab0024","type":"rpi-gpio out","z":"f7e0aaa6.572a88","name":"Led on GPIO18","pin":"18","set":false,"level":"0","freq":"","out":"out","bcm":true,"x":1040,"y":180,"wires":[]},{"id":"2faeb32a.d0df3c","type":"rpi-gpio in","z":"f7e0aaa6.572a88","name":"BTN on GPIO4","pin":"4","intype":"up","debounce":"25","read":true,"bcm":true,"x":200,"y":360,"wires":[["400b610c.e5b86"]]},{"id":"44fdd616.fc72d8","type":"inject","z":"f7e0aaa6.572a88","name":"SWITCH LED","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":190,"y":240,"wires":[["ed9fa045.b70e9"]]},{"id":"82e435d3.ebe668","type":"function","z":"f7e0aaa6.572a88","name":"If button down","func":"if (msg.payload===0)\n    return msg;\n    \nreturn  null;","outputs":1,"noerr":0,"x":420,"y":360,"wires":[[]]},{"id":"400b610c.e5b86","type":"switch","z":"f7e0aaa6.572a88","name":"If button down","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":420,"y":320,"wires":[["ed9fa045.b70e9"],[]]}]
Node Red Flow RPI_LED_BTN_2
Synchronized state via flow variable
57
LED & Button on RPI
[{"id":"5ffe35f2.2f482","type":"tab","label":"RPI_LED_POWER","disabled":true,"info":""},{"id":"31b20ab2.cf4016","type":"function","z":"5ffe35f2.2f482","name":"Set LED state OFF","func":"var currentLedState = flow.get(\"LEDState\")||0;\nif (currentLedState===0)\n    return null;\n    \nledState = 0;\nmsg.payload = 0;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"noerr":0,"x":650,"y":260,"wires":[["9e73551b.957b68"]]},{"id":"ad25bcf8.f679d","type":"function","z":"5ffe35f2.2f482","name":"Set LED state ON","func":"currentLedState = flow.get(\"LEDState\")||0;\n\nif (currentLedState==1)\n        return null;\n\nledState = 1;\n\nmsg.payload = 100;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":300,"wires":[["9e73551b.957b68"]]},{"id":"9e73551b.957b68","type":"change","z":"5ffe35f2.2f482","name":"Dispatch","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":280,"wires":[["f0217add.5e72d8","51c3ecd0.02c22"]]},{"id":"906d98f5.339588","type":"function","z":"5ffe35f2.2f482","name":"Switch LED state","func":"ledState=flow.get(\"LEDState\")||0;\n\n(ledState === 0) ? ledState = 1 : ledState = 0;\nif (ledState==1)\n    msg.payload = 100;\nelse\n    msg.payload=0;\n    \nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":360,"wires":[["9e73551b.957b68"]]},{"id":"2257d2ed.9059de","type":"inject","z":"5ffe35f2.2f482","name":"SWITCH LED","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"onceDelay":"","x":220,"y":400,"wires":[[]]},{"id":"5477ff99.05dc0c","type":"inject","z":"5ffe35f2.2f482","name":"LED OFF","topic":"","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":200,"y":260,"wires":[["31b20ab2.cf4016"]]},{"id":"f0217add.5e72d8","type":"debug","z":"5ffe35f2.2f482","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":1050,"y":240,"wires":[],"inputLabels":["msg.payload"]},{"id":"10058c9e.951bcf","type":"inject","z":"5ffe35f2.2f482","name":"LED ON","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":200,"y":300,"wires":[["ad25bcf8.f679d"]]},{"id":"51c3ecd0.02c22","type":"rpi-gpio out","z":"5ffe35f2.2f482","name":"Led on GPIO18","pin":"12","set":false,"level":"0","freq":"","out":"pwm","x":1060,"y":300,"wires":[]},{"id":"a749d485.cb943","type":"rpi-gpio in","z":"5ffe35f2.2f482","name":"BTN on GPIO4","pin":"7","intype":"up","debounce":"25","read":true,"x":220,"y":480,"wires":[["5b60173a.79d1bc"]]},{"id":"b5453cd9.83e198","type":"inject","z":"5ffe35f2.2f482","name":"SWITCH LED","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":210,"y":360,"wires":[["906d98f5.339588"]]},{"id":"fb8adcab.f68d28","type":"function","z":"5ffe35f2.2f482","name":"If button down","func":"if (msg.payload===0)\n    return msg;\n    \nreturn  null;","outputs":1,"noerr":0,"x":440,"y":480,"wires":[[]]},{"id":"5b60173a.79d1bc","type":"switch","z":"5ffe35f2.2f482","name":"If button down","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":440,"y":440,"wires":[["906d98f5.339588"],[]]}]
Node Red Flow RPI_LED_POWER
Synchronized state & LED power, PWM
58
You may add a temporary buttons to set LED to 50%
Phase #2a
Adding a remote control API for our Smart Lamp
	Using MQTT
59
MQTT (MQ Telemetry Transport)
Publish/Subscribe message exchange transport protocol
Very lightweight and binary protocol, fitted for constrained devices
Works over IP
Requires a broker 
Avoids direct connection between message sender (publisher) and message receivers (subscribers)
Filters & distributes messages based on message ‘topic’
Enforces authentication and authorization of clients
60
MQTT
Works over http (default port 1883) or WebSockets 
Protocol details
Pubs and Subs are all clients
Note : 
A single connection by clientId is allowed (the others are disconnected)
61
MQTT
Protocol details (Cont.)
Topics may contain multi levels using / (no leading)
Subscriber topics may include wildcards : + (single level) and # (multi level)
retainFlag allows updating new subscribers as soon as they connect
QoS: 0 (at most once, best effort), 1 (at least once, until PUBACK received), 2 (exactly once)
Notes : 
Topics are case sensitive, leading $ is reserved for system topics (e.g. $SYS/something)
Message structure has to be know by all parties
Publisher doesn’t know if 0 or many subscribers received his “publish” message
QoS may be different for Pub & Sub
62
MQTT – MQTT practice
Install MQTT Box desktop client  on your laptop (check course files) or
https://apps.microsoft.com/store/detail/mqttbox/9NBLGGH55JZG?hl=fr-fr&gl=fr / https://chrome.google.com/webstore/detail/mqttbox/kaajoficamnjijhkeomgfljpicifbkaf?hl=fr 
Create 3 « MQTT Clients » 
Connecting to Mosquitto open broker
	Protocol : mqtt/tcp 
	Host : test.mosquitto.org:1883
Connecting to HiveMQ open broker
	Protocol : mqtt/tcp 
	Host: broker.hivemq.com:1883
Connecting to MQTTDashboard open broker
	Protocol : mqtt/tcp 
	Host: broker.mqttdashboard.com:1883
Open HiveMQ broker
Subscribe to a topic « test »
Publish something on the topic « test »
				Anything strange?
63
MQTT – MQTT practice
Mosquitto is an open source client library, and broker https://mosquitto.org/
Client installation on RPI
	sudo apt-get install mosquitto-clients 
Usage
mosquitto_sub -h broker.hivemq.com -p 1883 -t "test" 
	(-v displays topic in case of wildcard use)
mosquitto_pub -h broker.hivemq.com -p 1883 -t "test" -m "Message"
Let’s add authentication to broker :
[-u username] [-P password] 
				Anything strange ?
64
MQTT – MQTT practice
Try to collect all topics published on a public broker in 1mn
Broker: mqtt://mqtt.eclipseprojects.io:1883  OR mqtt://test.mosquitto.org:1883 (not possible on all brokers)
65
Subscribe to topic # with mosquito and watch 
	(add –v option to see topic name)
Or…
MQTT Spy
1. Create configuration file with sample content 
2. Double click in the 2nd line to configure existing or new connections
Click new and fill broker details if needed
3. You may click on a broker name to connect it
4. Then access broker tab to manage subscriptions
… Open test.mosquitto.org
Download : https://github.com/eclipse/paho.mqtt-spy/releases (requires java) 
2
1
3
4
66
MQTT Spy
1. Click New subscription and enter topic $SYS/#
2. You see list of published system topics in the lower part
3. You can navigate all posts, or by topic by ticking/unticking “browse” boxes in topics list
(use broker test.mosquitto.org )
1
2
3
67
MQTT Spy
You may change payload display with Tools – Formatting
You may create publishing scripts for testing
Generate some living charts : select some topics to browse and right-click on the topics list, then select Charts – Show payload values for browsed topics
Try monitoring nb of connected clients, then same for nb of msg sent and received in 1min
68
MQTT clients / brokers / protocols compatibility matrix
69
List of Online public brokers: https://github.com/mqtt/mqtt.github.io/wiki/public_brokers
MQTT clients / brokers / protocols compatibility matrix
70
MQTT – Exercise with Node Red
Broker 
Server: broker.mqttdashboard.com
Port: 1883
Add publication of current state
Topic: RPI/RPI1/MyLEDState
Value: LED power (0-100)
Add mqtt command reception
Topic: RPI/RPI1/MyLEDCommand
Add command parsing
Value : LED_ON / LED_OFF / LED_SWITCH
Option: Publish update only when LED state changed
Interact using MQTTBox on your laptop
71
MQTT – Exercise Solution
[{"id":"e741101a.b1d4","type":"tab","label":"MQTT_1","disabled":false,"info":""},{"id":"8664dc52.fbb3a","type":"function","z":"e741101a.b1d4","name":"Set LED state OFF","func":"var currentLedState = flow.get(\"LEDState\")||0;\nif (currentLedState===0)\n    return null;\n    \nvar ledState = 0;\nmsg.payload = 0;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":280,"wires":[["e1076d28.eceb5"]]},{"id":"f3057296.5e0d1","type":"function","z":"e741101a.b1d4","name":"Set LED state ON","func":"var currentLedState = flow.get(\"LEDState\")||0;\n\nif (currentLedState==1)\n        return null;\n\nvar ledState = 1;\n\nmsg.payload = 100;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":320,"wires":[["e1076d28.eceb5"]]},{"id":"e1076d28.eceb5","type":"change","z":"e741101a.b1d4","name":"Dispatch","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":300,"wires":[["439702e.ee91efc","7b6391a.971f07","c1e9340a.eacbd8"]]},{"id":"6803aaf4.9b7534","type":"function","z":"e741101a.b1d4","name":"Switch LED state","func":"var ledState=flow.get(\"LEDState\")||0;\n\n(ledState === 0) ? ledState = 1 : ledState = 0;\nif (ledState==1)\n    msg.payload = 100;\nelse\n    msg.payload=0;\n    \nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":380,"wires":[["e1076d28.eceb5"]]},{"id":"9c1b622a.a3a77","type":"inject","z":"e741101a.b1d4","name":"SWITCH LED","repeat":"1","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"date","x":120,"y":420,"wires":[[]]},{"id":"8edb7ef5.f8bc8","type":"inject","z":"e741101a.b1d4","name":"LED OFF","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"0","payloadType":"num","x":100,"y":280,"wires":[["8664dc52.fbb3a"]]},{"id":"439702e.ee91efc","type":"debug","z":"e741101a.b1d4","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":1050,"y":260,"wires":[],"inputLabels":["msg.payload"]},{"id":"8f40660b.b51ad8","type":"inject","z":"e741101a.b1d4","name":"LED ON","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":100,"y":320,"wires":[["f3057296.5e0d1"]]},{"id":"7b6391a.971f07","type":"rpi-gpio out","z":"e741101a.b1d4","name":"Led on GPIO18","pin":"18","set":false,"level":"0","freq":"","out":"pwm","bcm":true,"x":1060,"y":320,"wires":[]},{"id":"2b818147.c3b2ce","type":"rpi-gpio in","z":"e741101a.b1d4","name":"BTN on GPIO4","pin":"4","intype":"up","debounce":"25","read":true,"bcm":true,"x":120,"y":500,"wires":[["4c6dd0a9.5b8d4"]]},{"id":"90ecfd7a.25b96","type":"inject","z":"e741101a.b1d4","name":"SWITCH LED","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":110,"y":380,"wires":[["6803aaf4.9b7534"]]},{"id":"88d2dc67.f728b","type":"function","z":"e741101a.b1d4","name":"If button down","func":"if (msg.payload===0)\n    return msg;\n    \nreturn  null;","outputs":1,"noerr":0,"x":340,"y":500,"wires":[[]]},{"id":"4c6dd0a9.5b8d4","type":"switch","z":"e741101a.b1d4","name":"If button down","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":340,"y":460,"wires":[["6803aaf4.9b7534"],[]]},{"id":"c1e9340a.eacbd8","type":"mqtt out","z":"e741101a.b1d4","name":"Publish MyLEDState","topic":"RPI/RPI1/MyLEDState","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"87cc9444.0f3478","x":1080,"y":200,"wires":[]},{"id":"607137dc.8ab9d8","type":"mqtt in","z":"e741101a.b1d4","name":"","topic":"RPI/RPI1/MyLEDCommand","qos":"2","datatype":"auto","broker":"87cc9444.0f3478","nl":false,"rap":false,"inputs":0,"x":160,"y":120,"wires":[["71dc3ba1.16f504","56a3928e.c688dc"]]},{"id":"71dc3ba1.16f504","type":"switch","z":"e741101a.b1d4","name":"Parse command","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"LED_OFF","vt":"str"},{"t":"eq","v":"LED_ON","vt":"str"},{"t":"eq","v":"LED_SWITCH","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":4,"x":400,"y":120,"wires":[["8664dc52.fbb3a"],["f3057296.5e0d1"],["6803aaf4.9b7534"],[]]},{"id":"56a3928e.c688dc","type":"debug","z":"e741101a.b1d4","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":390,"y":180,"wires":[]},{"id":"b4499a64.705478","type":"delay","z":"e741101a.b1d4","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":880,"y":600,"wires":[[]]},{"id":"95192660.c60728","type":"delay","z":"e741101a.b1d4","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"10","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":900,"y":640,"wires":[[]]},{"id":"5d31a82c2b388adb","type":"comment","z":"e741101a.b1d4","name":"broker.hivemq.com","info":"","x":130,"y":40,"wires":[]},{"id":"0b1201e769557346","type":"mqtt in","z":"e741101a.b1d4","name":"","topic":"RPI/RPI1/MyLEDState","qos":"1","datatype":"auto-detect","broker":"d327ea10.85a108","nl":false,"rap":true,"rh":0,"inputs":0,"x":920,"y":540,"wires":[["d12681e0aa18f1a5"]]},{"id":"d12681e0aa18f1a5","type":"debug","z":"e741101a.b1d4","name":"LED Value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":1170,"y":540,"wires":[]},{"id":"a48b626f8270c023","type":"comment","z":"e741101a.b1d4","name":"DEBUG","info":"","x":870,"y":480,"wires":[]},{"id":"87cc9444.0f3478","type":"mqtt-broker","name":"broker.hivemq.com","broker":"broker.hivemq.com","port":"1883","clientid":"","autoConnect":true,"usetls":false,"protocolVersion":4,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"d327ea10.85a108","type":"mqtt-broker","name":"HiveMQ","broker":"broker.mqttdashboard.com","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""}]
Node Red Flow MQTT_1
72
MQTT – Security
Wireshark or TCPDump on port 1883…
sudo apt-get install tcpdump
tcpdump port 1883 –w dump.pcap
wireshark filter mqtt or Tcp.port=1883
mosquitto_pub -h broker.hivemq.com -t “test” -m “Message1” -u UserName -P MyPassword
Shiftr.io - Free personal broker
Create an account at https://cloud.shiftr.io 
Deploy [broker] instance
Create group My Group
Select Basic type
Note or change unique instance name
Click Deploy instance
Note the instance path, e.g. MyInstanceName.cloud.shiftr.io
Click on your instance
Click Sign In & Allow request then get started
Click settings (lower right icon), then Tokens
Creare a token with Full access, note the Secret value
Notes: 
max daily usage of broker is 6 hours (!)
     You need to close all your client subscriptions when done with an exercice for the instance to go idle and recharge 
Don’t terminate the instance manually as it will destroy it, your tokens etc
There exists a desktop version 
74
Cloud service
Shiftr.io – Local personal broker
Dowload personal broker at https://www.shiftr.io/desktop/#downloads 
Install 
Run broker
localhost:1884
75
Local install
Shiftr.io - Free personal broker
Publish messages on different topics on the mqtt token url with mosquito
	Use login and password as specified in full access token, in the form:
	                           mqtt://myLogin:myToken@myLogin.cloud.shiftr.io 
	mosquitto_pub -h myLogin.cloud.shiftr.io -u myLogin -P myToken -t ‘Test’ -m 'HELLO' 
	Send messages on various topics & see the graph growing!
76
Using Node Red, redirect topics ‘FisherHouse/#’ and ‘FisherSystem/#’ from broker.mqttdashboard.com to your shiftr broker 
	Note : do not specify a topic on publisher node
Shiftr.io redirections with node red: let’s go fishing ;-)
77
Shiftr.io redirections with node red
Node Red Flow SHIFTR.IO
[{"id":"849fc2bb.4b022","type":"tab","label":"SHIFTR.IO","disabled":false,"info":""},{"id":"2924744.cc5ec8c","type":"mqtt out","z":"849fc2bb.4b022","name":"shiftr.io","topic":"","qos":"","retain":"","broker":"169b1c74.dbd4e4","x":720,"y":240,"wires":[]},{"id":"1a2f26a0.38d0a9","type":"function","z":"849fc2bb.4b022","name":"Rate Limiter 100ms","func":"\nvar interval = 100; // minimum interval between messages (ms)\ncontext.lastTime = context.lastTime || 0;\n\nvar now = Date.now();\n\nif (context.lastTime===0)\n{\n    context.lastTime = now;\n    return null;\n}\n\n\nif (now-context.lastTime > interval) {\n  context.lastTime = now;\n  return msg;\n} else {\n  return null;\n}","outputs":1,"noerr":0,"x":490,"y":260,"wires":[["2924744.cc5ec8c","94376f19.7fcdc"]]},{"id":"94376f19.7fcdc","type":"debug","z":"849fc2bb.4b022","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":730,"y":320,"wires":[]},{"id":"78f775ee.65ff0c","type":"mqtt in","z":"849fc2bb.4b022","name":"","topic":"FisherHouse/#","qos":"0","datatype":"auto","broker":"2fc6eb97.8750e4","x":221.11112213134766,"y":307.7777900695801,"wires":[["9ee66e8e.2b98f"]]},{"id":"9ee66e8e.2b98f","type":"delay","z":"849fc2bb.4b022","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"10","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":477.7777786254883,"y":308.88890266418457,"wires":[["94376f19.7fcdc","2924744.cc5ec8c"]]},{"id":"9bdbe7e9.765f28","type":"mqtt in","z":"849fc2bb.4b022","name":"#","topic":"#","qos":"0","datatype":"auto","broker":"2a60c815.f762e8","x":187.66667938232422,"y":185.22224044799805,"wires":[[]]},{"id":"c48e126a.afab3","type":"mqtt in","z":"849fc2bb.4b022","name":"","topic":"FisherSystem/#","qos":"0","datatype":"auto","broker":"2fc6eb97.8750e4","x":222.2222137451172,"y":245.55556678771973,"wires":[["9ee66e8e.2b98f"]]},{"id":"169b1c74.dbd4e4","type":"mqtt-broker","z":"","name":"shiftr.io","broker":"MyRPIClient:a94f6c734127b8cd@broker.shiftr.io","port":"1883","clientid":"MyNodeRed","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"2fc6eb97.8750e4","type":"mqtt-broker","z":"","name":"MQTTDashboard","broker":"broker.mqttdashboard.com","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"2a60c815.f762e8","type":"mqtt-broker","z":"","name":"mqtt.eclipse.org","broker":"mqtt.eclipse.org","port":"1883","clientid":"RPI1","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""}]
78
Shiftr.io redirections with node red: let’s go fishing ;-)
Oh, an IP… FisherHouse/IP : 174.20.165.38 
FisherHouse: where is this guy? 
Let’s find IP region with https://iplocation.com/ : Minneapolis
Let’s try to google Fisher in Minneapolis : Fisher house foundation
Open the staff page …
Maybe we could change power state or trigger alarms 
	 FisherSystem/Cabin/Garage/Power/Enabled 0 ?
We have a partial internal network cartography, some devices types to target …
Let’s try to open a web page on the IP… : Dennis WAS under all graphs
We may start social engineering (Dennis: is he IT guy ?)
…
79
Who is Tish ?
(broker.mqttdashboard.com)
!! Engagement rules !! 
No penetration testing (vuln/port scan …), no impact on ‘target’ systems, only listening and reading publicly accessible data
MQTT – Potential security problems summary
Some do not know what is a public broker… or think they can hide their topics
	we’ll see in a minute…
Some may think they are safe using log/pwd on public brokers! 
	They are just ignored!
Others may think they are safe using log/pwd on commercial brokers! 
	All traffic is in clear by default (or subject to Mitm), 	log/pwd and data included!
The only way to be protected* is by using certificate-based mutual authn (for all clients)and [for public brokers, e2e applicative(!!?)] encryption
*somehow
80
Summary on MQTT security & SLA
public broker : availability ? scaling? DoS on your client IDs?
public broker: anyone can subscribe to listen your messages, or publish fake data
public broker + “secret topic” : someone may listen to # 
public broker + log/pwd : same for all your publishers and subscribers, transport in clear
public broker + log/pwd + srv cert : same for all your publishers and subscribers, possible mitm
public broker + message encryption : same key for all your publishers and subscribers
In a production environment, consider using Retain, QoS 1 and last-will to get subscribers informed
Your own local broker : protected by network may be sufficient (home)
Your own broker with device certs: stealing a cert(priv key) / compromising a device may allow publishing impersonated data 
Next : Add policy (ACL) : stolen cert(priv key) or compromised device may only act under device’s name/restrictions
Next : protect the private key (MCU OTP memory, SE/TEE?), and firmware integrity (secure boot etc)
Next : protect against side channel attacks…
81
Phase #2b
Adding a graphical interface to control our Smart Lamp
Note: Be sure dashboard palette has been installed
	If not, access Node Red       menu / manage palette / install palette / node-red-dashboard
	Note 2 : If Manage Palette is not present, install npm : sudo apt-get install npm   then restart node red
82
Node Red - Dashboard
Source: http://silanus.fr/sin/?p=984
83
1
2
 Controls order may be modified in node red layout sub tab     (dashboard tab, on the right)
84
Node Red - Dashboard
3
3
Node Red - Dashboard
[{"id":"34dc4701.34550c","type":"tab","label":"DASHBOARD_1","disabled":false,"info":""},{"id":"6ae5ca6f.3cd44c","type":"ui_slider","z":"34dc4701.34550c","name":"","label":"slider","tooltip":"","group":"a9cc672b.8f8638","order":6,"width":0,"height":0,"passthru":true,"outs":"all","topic":"","min":0,"max":"100","step":"10","x":450,"y":240,"wires":[["f6ba837d.64047","322a6540.4ddcc6","44448447.c756cc"]]},{"id":"322a6540.4ddcc6","type":"ui_gauge","z":"34dc4701.34550c","name":"","group":"a9cc672b.8f8638","order":9,"width":0,"height":0,"gtype":"gage","title":"gauge","label":"units","format":"{{value}}","min":0,"max":"100","colors":["#00B500","#E6E600","#CA3838"],"seg1":"","seg2":"","x":670,"y":200,"wires":[]},{"id":"44448447.c756cc","type":"ui_chart","z":"34dc4701.34550c","name":"","group":"a9cc672b.8f8638","order":11,"width":0,"height":0,"label":"chart","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"60","cutout":0,"useOneColor":false,"colors":["#1F77B4","#AEC7E8","#FF7F0E","#2CA02C","#98DF8A","#D62728","#FF9896","#9467BD","#C5B0D5"],"useOldStyle":false,"x":670,"y":300,"wires":[[],[]]},{"id":"f6ba837d.64047","type":"ui_text_input","z":"34dc4701.34550c","name":"","label":"Select a value","tooltip":"","group":"a9cc672b.8f8638","order":4,"width":0,"height":0,"passthru":true,"mode":"text","delay":300,"topic":"","x":240,"y":240,"wires":[["6ae5ca6f.3cd44c"]]},{"id":"a9cc672b.8f8638","type":"ui_group","z":0,"name":"TP dashboard","tab":"535619c2.3e692c","disp":true,"width":"6","collapse":false},{"id":"535619c2.3e692c","type":"ui_tab","z":0,"name":"TP","icon":"dashboard","disabled":false,"hidden":false}]
Node Red Flow  DASHBOARD_1
85
Connecting dashboard and LED management
Connect Gauge & Chart to LED state topic
Add ON/OFF/Switch dashboard buttons in RPI flow
Add MQTT command to change LED power
Topic : RPI/RPI1/MyLEDPower
Value : 0-100
Step : 10
Connect Slider to change LED Power command
Value : 0-100
Step : 10
Add a text field to indicate LED state
Note : For custom icon, you may use name ‘power_settings_new’
From https://material.io/tools/icons/?style=baseline , or https://fontawesome.com/v4.7.0/icons/ 
86
Complete Dashboard - solution
Node Red Flow  RPI_LED_BTN_MQTT_DASHBOARD_FINAL
Note : On/Off/Switch dashboard  
             buttons are not using MQTT
Node Red Flow  DASHBOARD_2
87
Complete dashboard - solution
Changes in functions:
88
Complete dashboard - solution
[{"id":"3f152265.215cbe","type":"tab","label":"RPI_LED_BTN_MQTT_DASHBOARD_FINAL","disabled":false,"info":""},{"id":"9e79a24b.119fd","type":"function","z":"3f152265.215cbe","name":"Switch LED state","func":"ledState=flow.get(\"LEDState\")||0;\nledPower=flow.get(\"LEDPower\")||0;\n\n(ledState === 0) ? ledState = 1 : ledState = 0;\nif (ledState==1)\n    {\n    if (ledPower===0)\n        ledPower=100;\n    msg.payload = ledPower;\n    }\nelse\n    msg.payload=0;\n    \nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":280,"wires":[["787e5b2c.a62404"]]},{"id":"577fc370.c516ec","type":"inject","z":"3f152265.215cbe","name":"SWITCH LED","repeat":"1","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"date","x":220,"y":320,"wires":[[]]},{"id":"55ef513a.7cb9d","type":"inject","z":"3f152265.215cbe","name":"LED OFF","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED OFF","payload":"0","payloadType":"num","x":200,"y":180,"wires":[["b8e52af8.91b5d8"]]},{"id":"e24ce3c1.d694c","type":"debug","z":"3f152265.215cbe","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":1110,"y":280,"wires":[],"inputLabels":["msg.payload"]},{"id":"2f2556b.a0869aa","type":"inject","z":"3f152265.215cbe","name":"LED ON","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED ON","payload":"ledPower","payloadType":"flow","x":200,"y":220,"wires":[["2fbc2614.bd7eda"]]},{"id":"38d3dc7.6469224","type":"rpi-gpio out","z":"3f152265.215cbe","name":"LED on GPIO18","pin":"18","set":false,"level":"0","freq":"","out":"pwm","bcm":true,"x":1120,"y":220,"wires":[]},{"id":"22f4c07.9e18d4","type":"rpi-gpio in","z":"3f152265.215cbe","name":"BTN on GPIO4","pin":"4","intype":"up","debounce":"25","read":true,"bcm":true,"x":220,"y":520,"wires":[["9eaf8262.2ef44"]]},{"id":"f42683eb.15bf7","type":"inject","z":"3f152265.215cbe","name":"SWITCH LED","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":210,"y":280,"wires":[["9e79a24b.119fd"]]},{"id":"5a6f8759.71f788","type":"function","z":"3f152265.215cbe","name":"If button down","func":"if (msg.payload===0)\n    return msg;\n    \nreturn  null;","outputs":1,"noerr":0,"x":420,"y":560,"wires":[[]]},{"id":"9eaf8262.2ef44","type":"switch","z":"3f152265.215cbe","name":"If button down","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":420,"y":520,"wires":[["9e79a24b.119fd"],[]]},{"id":"b8e52af8.91b5d8","type":"function","z":"3f152265.215cbe","name":"Set LED state OFF","func":"var currentLedState = flow.get(\"LEDState\")||0;\nif (currentLedState===0)\n    return null;\n    \nledState = 0;\nmsg.payload = ledState;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"noerr":0,"x":750,"y":180,"wires":[["787e5b2c.a62404"]]},{"id":"2fbc2614.bd7eda","type":"function","z":"3f152265.215cbe","name":"Set LED state ON","func":"currentLedState = flow.get(\"LEDState\")||0;\nledPower=flow.get(\"LEDPower\")||0;\n\nif (currentLedState==1)\n    if (ledPower==100)\n        return null;\n    else\n        ledPower=100;\n\nledState = 1;\nif (ledPower===0)\n    ledPower=100;\n    \nmsg.payload = ledPower;\n\nflow.set(\"LEDState\", ledState);\nflow.set(\"LEDPower\", ledPower);\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":220,"wires":[["787e5b2c.a62404"]]},{"id":"ce9d00b3.b9f2f","type":"mqtt in","z":"3f152265.215cbe","name":"","topic":"RPI/RPI1/MyLEDCommand","qos":"2","datatype":"auto","broker":"87cc9444.0f3478","inputs":0,"x":260,"y":40,"wires":[["de85a353.9ce42","e9b7d71d.451ed8"]]},{"id":"b9a52cb1.4f503","type":"mqtt out","z":"3f152265.215cbe","name":"Publish MyLEDState","topic":"RPI/RPI1/MyLEDState","qos":"","retain":"","broker":"87cc9444.0f3478","x":1140,"y":160,"wires":[]},{"id":"de85a353.9ce42","type":"switch","z":"3f152265.215cbe","name":"Parse command","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"LED_OFF","vt":"str"},{"t":"eq","v":"LED_ON","vt":"str"},{"t":"eq","v":"LED_SWITCH","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":4,"x":500,"y":40,"wires":[["b8e52af8.91b5d8"],["2fbc2614.bd7eda"],["9e79a24b.119fd"],["f8a45bac.ced858"]]},{"id":"e9b7d71d.451ed8","type":"debug","z":"3f152265.215cbe","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":490,"y":100,"wires":[]},{"id":"787e5b2c.a62404","type":"change","z":"3f152265.215cbe","name":"Dispatch","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":940,"y":220,"wires":[["e24ce3c1.d694c","38d3dc7.6469224","b9a52cb1.4f503","9b34547b.7e8bb8"]]},{"id":"f8a45bac.ced858","type":"change","z":"3f152265.215cbe","name":"Unknown command","rules":[{"t":"change","p":"payload","pt":"msg","from":"^(.*)$","fromt":"re","to":"Unknown MQTT command received : [$1] ","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":760,"y":40,"wires":[["9fabd03f.4376"]]},{"id":"ef0dfbee.65c3a8","type":"mqtt in","z":"3f152265.215cbe","name":"","topic":"RPI/RPI1/MyLEDPower","qos":"2","datatype":"auto","broker":"87cc9444.0f3478","inputs":0,"x":240,"y":140,"wires":[["e9b7d71d.451ed8","3b52a474.ea0d2c"]]},{"id":"3b52a474.ea0d2c","type":"function","z":"3f152265.215cbe","name":"Set LED Power","func":"var ledPower=msg.payload;\nvar ledState;\n\nif (ledPower===0)\n    {\n    ledState=0;\n    ledPower=100;\n    }\nelse\n    ledState=1;\n    \nflow.set(\"LEDState\", ledState);\nflow.set(\"LEDPower\", ledPower);\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":140,"wires":[["787e5b2c.a62404"]]},{"id":"9fabd03f.4376","type":"ui_text","z":"3f152265.215cbe","d":true,"group":"4608a4ea.943abc","order":13,"width":0,"height":0,"name":"Error","label":"text","format":"{{msg.payload}}","layout":"row-spread","x":1090,"y":40,"wires":[]},{"id":"b8c8d490.c9ad58","type":"ui_button","z":"3f152265.215cbe","name":"","group":"4608a4ea.943abc","order":2,"width":0,"height":0,"passthru":false,"label":"OFF","tooltip":"","color":"","bgcolor":"red","icon":"","payload":"0","payloadType":"str","topic":"","topicType":"str","x":190,"y":380,"wires":[["b8e52af8.91b5d8"]]},{"id":"cc0d31f6.b2af","type":"ui_button","z":"3f152265.215cbe","name":"","group":"4608a4ea.943abc","order":1,"width":0,"height":0,"passthru":false,"label":"ON","tooltip":"","color":"","bgcolor":"green","icon":"","payload":"1","payloadType":"str","topic":"","topicType":"str","x":190,"y":420,"wires":[["2fbc2614.bd7eda"]]},{"id":"3c84a633.401fba","type":"ui_switch","z":"3f152265.215cbe","name":"","label":"switch","tooltip":"","group":"4608a4ea.943abc","order":3,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"","topicType":"str","style":"","onvalue":"true","onvalueType":"bool","onicon":"power_settings_new","oncolor":"green","offvalue":"false","offvalueType":"bool","officon":"power_settings_new","offcolor":"red","animate":true,"x":190,"y":460,"wires":[["9e79a24b.119fd"]]},{"id":"9b34547b.7e8bb8","type":"link out","z":"3f152265.215cbe","name":"Display LED state","links":["6256c124.88157"],"x":1055,"y":380,"wires":[]},{"id":"54100fe1a08865e9","type":"comment","z":"3f152265.215cbe","name":"broker.hivemq.com","info":"","x":110,"y":100,"wires":[]},{"id":"679c406996b791fd","type":"comment","z":"3f152265.215cbe","name":"Activate also Dashboard_2","info":"","x":830,"y":440,"wires":[]},{"id":"87cc9444.0f3478","type":"mqtt-broker","name":"broker.hivemq.com","broker":"broker.hivemq.com","port":"1883","clientid":"","autoConnect":true,"usetls":false,"protocolVersion":4,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"4608a4ea.943abc","type":"ui_group","name":"Test","tab":"4823d28e.7016ec","order":1,"disp":true,"width":"6","collapse":false},{"id":"4823d28e.7016ec","type":"ui_tab","name":"Home","icon":"dashboard","disabled":false,"hidden":false}]
Node Red Flow  RPI_LED_BTN_MQTT_DASHBOARD_FINAL
89
Complete dashboard - solution
Note : On/Off/Switch dashboard buttons are not using MQTT
Node Red Flow  DASHBOARD_2
[{"id":"5159049.a3450fc","type":"tab","label":"DASHBOARD_2","disabled":false,"info":""},{"id":"1142b282.8ede2d","type":"mqtt out","z":"5159049.a3450fc","name":"Change LED power","topic":"RPI/RPI1/MyLEDPower","qos":"","retain":"","broker":"87cc9444.0f3478","x":570,"y":160,"wires":[]},{"id":"2435f94a.752026","type":"mqtt in","z":"5159049.a3450fc","name":"","topic":"RPI/RPI1/MyLEDState","qos":"2","datatype":"auto","broker":"87cc9444.0f3478","inputs":0,"x":400,"y":340,"wires":[["7e9195.01644e6c","c0292ab9.549ae8","fd93cb91.cba208"]]},{"id":"fd93cb91.cba208","type":"debug","z":"5159049.a3450fc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":617,"y":440.9999990463257,"wires":[]},{"id":"e7e8dcb7.08ca7","type":"debug","z":"5159049.a3450fc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":550,"y":100,"wires":[]},{"id":"9cdd9777.a77e48","type":"ui_slider","z":"5159049.a3450fc","name":"","label":"slider","tooltip":"","group":"4608a4ea.943abc","order":7,"width":0,"height":0,"passthru":true,"outs":"all","topic":"","topicType":"str","min":0,"max":"100","step":"10","x":370,"y":40,"wires":[["91bba0a4.473b8","1142b282.8ede2d","e7e8dcb7.08ca7"]]},{"id":"91bba0a4.473b8","type":"ui_text_input","z":"5159049.a3450fc","name":"","label":"Select a value","tooltip":"","group":"4608a4ea.943abc","order":5,"width":0,"height":0,"passthru":false,"mode":"text","delay":300,"topic":"","sendOnBlur":true,"className":"","topicType":"str","x":120,"y":40,"wires":[["9cdd9777.a77e48"]]},{"id":"7e9195.01644e6c","type":"ui_gauge","z":"5159049.a3450fc","name":"","group":"4608a4ea.943abc","order":10,"width":0,"height":0,"gtype":"gage","title":"gauge","label":"units","format":"{{value}}","min":0,"max":"100","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":607,"y":340.9999990463257,"wires":[]},{"id":"c0292ab9.549ae8","type":"ui_chart","z":"5159049.a3450fc","name":"","group":"4608a4ea.943abc","order":12,"width":0,"height":0,"label":"chart","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"60","cutout":0,"useOneColor":false,"useUTC":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"outputs":1,"useDifferentColor":false,"x":607,"y":380.9999990463257,"wires":[[]]},{"id":"16c0e0af.a6fb2f","type":"ui_text","z":"5159049.a3450fc","group":"4608a4ea.943abc","order":8,"width":0,"height":0,"name":"","label":"LED is ","format":"{{msg.payload}}%","layout":"row-spread","x":210,"y":260,"wires":[]},{"id":"6256c124.88157","type":"link in","z":"5159049.a3450fc","name":"","links":["9b34547b.7e8bb8"],"x":100,"y":260,"wires":[["16c0e0af.a6fb2f"]]},{"id":"87cc9444.0f3478","type":"mqtt-broker","name":"broker.hivemq.com","broker":"broker.hivemq.com","port":"1883","clientid":"","autoConnect":true,"usetls":false,"protocolVersion":4,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"4608a4ea.943abc","type":"ui_group","name":"Test","tab":"4823d28e.7016ec","order":1,"disp":true,"width":"6","collapse":false},{"id":"4823d28e.7016ec","type":"ui_tab","name":"Home","icon":"dashboard","disabled":false,"hidden":false}]
90
Dashboard Links
Use link nodes to connect accross flows
Simplifies multiple flows usage 
Improves flows lisibility
Insert an outgoing link, then input link
91
Group work	
One of the RPI will become a controller for the global RPI fleet
For “all” LEDs
Report State
Means to Switch individual state
Global “All ON” and “All OFF”
Constraint: 
use only 1 MQTT input & 1 MQTT output nodes
Notes: 
	You will consider only 3/4 devices
	Be sure to have mqtt/LED/Btn flow enabled on each RPI
92
Group work - Tips	
Monitoring
Start by checking wildcard MQTT subscription events structure
Regex « starts with RPI » = ^RPI
Switch node may have multiple output connectors
Individual RPI control
See MQTT publish node ‘tip’
Global RPI fleet control
MQTT publish node may accept multiple messages
Sample function generating multiple messages
93
var msg1={}, msg2={}, msg3={}, msg4={}, msg5={}
... msgX content init...
return  [msg1,msg2,msg3,msg4,msg5]
Group work - Solution	
94
Node Red Flow  DASHBOARD_GROUP_PROJECT
Group work - Solution	
95
Monitoring
Group work - Solution	
96
Node Red Flow  DASHBOARD_GROUP_PROJECT
[{"id":"c3b403f3.a5a5b","type":"tab","label":"DASHBOARD_GROUP_PROJECT","disabled":false,"info":""},{"id":"c3c8cfd0.71c9c","type":"mqtt in","z":"c3b403f3.a5a5b","name":"","topic":"RPI/+/MyLEDState","qos":"2","datatype":"auto","broker":"87cc9444.0f3478","inputs":0,"x":190,"y":200,"wires":[["5be95b40.71da54","12861adf.f936e5","101f4f3b.ef0201"]]},{"id":"12861adf.f936e5","type":"switch","z":"c3b403f3.a5a5b","name":"Which RPI","property":"topic","propertyType":"msg","rules":[{"t":"regex","v":"^RPI/RPI1","vt":"str","case":false},{"t":"regex","v":"^RPI/RPI2","vt":"str","case":false},{"t":"regex","v":"^RPI/RPI3","vt":"str","case":false},{"t":"regex","v":"^RPI/RPI4","vt":"str","case":false},{"t":"regex","v":"^RPI/RPI45","vt":"str","case":false}],"checkall":"true","repair":false,"outputs":5,"x":410,"y":200,"wires":[["d689c20f.b8758"],["b87997e7.66d298"],["f9cbf8a3.611cc8"],["4776ca0e.419484"],["5c7fa99879505dce"]]},{"id":"5be95b40.71da54","type":"debug","z":"c3b403f3.a5a5b","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":390,"y":20,"wires":[]},{"id":"101f4f3b.ef0201","type":"debug","z":"c3b403f3.a5a5b","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"topic","x":400,"y":80,"wires":[]},{"id":"bb2b4aba.9af848","type":"mqtt out","z":"c3b403f3.a5a5b","name":"Publish","topic":"","qos":"","retain":"","broker":"87cc9444.0f3478","x":1220,"y":260,"wires":[]},{"id":"a33bad1.077475","type":"change","z":"c3b403f3.a5a5b","name":"Set Command LED_SWITCH","rules":[{"t":"set","p":"payload","pt":"msg","to":"LED_SWITCH","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":990,"y":200,"wires":[["bb2b4aba.9af848"]]},{"id":"cc7297a1.e80e38","type":"function","z":"c3b403f3.a5a5b","name":"NOTIFY ALL","func":"var msg1 = {}, msg2 = {}, msg3 = {}, msg4 = {}, msg5 = {}\nmsg1.payload=msg.payload\nmsg1.topic=\"RPI/RPI1/MyLEDCommand\"\n\nmsg2.payload=msg.payload\nmsg2.topic=\"RPI/RPI2/MyLEDCommand\"\n\nmsg3.payload=msg.payload\nmsg3.topic=\"RPI/RPI3/MyLEDCommand\"\n\nmsg4.payload=msg.payload\nmsg4.topic=\"RPI/RPI4/MyLEDCommand\"\n\nmsg5.payload = msg.payload\nmsg5.topic = \"RPI/RPI5/MyLEDCommand\"\n\nreturn  [msg1,msg2,msg3,msg4,msg5]\n","outputs":5,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1050,"y":320,"wires":[["bb2b4aba.9af848"],["bb2b4aba.9af848"],["bb2b4aba.9af848"],["bb2b4aba.9af848"],["bb2b4aba.9af848"]]},{"id":"3f103d04.1b9182","type":"ui_button","z":"c3b403f3.a5a5b","name":"","group":"e7794a15.c6d108","order":1,"width":0,"height":0,"passthru":false,"label":"ALL OFF","tooltip":"","color":"","bgcolor":"RED","icon":"","payload":"LED_OFF","payloadType":"str","topic":"","topicType":"str","x":760.4000244140625,"y":356,"wires":[["cc7297a1.e80e38"]]},{"id":"d9101543.14acc8","type":"ui_button","z":"c3b403f3.a5a5b","name":"","group":"e7794a15.c6d108","order":4,"width":0,"height":0,"passthru":false,"label":"Switch","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"RPI/RPI1/MyLEDCommand","topicType":"str","x":750,"y":140,"wires":[["a33bad1.077475"]]},{"id":"169b634f.f0fbed","type":"ui_button","z":"c3b403f3.a5a5b","name":"","group":"e7794a15.c6d108","order":6,"width":0,"height":0,"passthru":false,"label":"Switch","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"RPI/RPI2/MyLEDCommand","topicType":"str","x":750,"y":180,"wires":[["a33bad1.077475"]]},{"id":"ba542ac1.c112a8","type":"ui_button","z":"c3b403f3.a5a5b","name":"","group":"e7794a15.c6d108","order":8,"width":0,"height":0,"passthru":false,"label":"Switch","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"RPI/RPI3/MyLEDCommand","topicType":"str","x":750,"y":220,"wires":[["a33bad1.077475"]]},{"id":"d43e6744.5d83c8","type":"ui_button","z":"c3b403f3.a5a5b","name":"","group":"e7794a15.c6d108","order":10,"width":0,"height":0,"passthru":false,"label":"Switch","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"RPI/RPI4/MyLEDCommand","topicType":"str","x":750,"y":260,"wires":[["a33bad1.077475"]]},{"id":"ca6b7299.603c6","type":"ui_button","z":"c3b403f3.a5a5b","name":"","group":"e7794a15.c6d108","order":2,"width":0,"height":0,"passthru":false,"label":"ALL ON","tooltip":"","color":"","bgcolor":"GREEN ","icon":"","payload":"LED_ON","payloadType":"str","topic":"","topicType":"str","x":760,"y":400,"wires":[["cc7297a1.e80e38"]]},{"id":"d689c20f.b8758","type":"ui_text","z":"c3b403f3.a5a5b","group":"e7794a15.c6d108","order":3,"width":0,"height":0,"name":"","label":"RPI 1 LED is ","format":"{{msg.payload}}%","layout":"row-spread","x":610,"y":140,"wires":[]},{"id":"b87997e7.66d298","type":"ui_text","z":"c3b403f3.a5a5b","group":"e7794a15.c6d108","order":5,"width":0,"height":0,"name":"","label":"RPI 2 LED is ","format":"{{msg.payload}}%","layout":"row-spread","x":610,"y":180,"wires":[]},{"id":"f9cbf8a3.611cc8","type":"ui_text","z":"c3b403f3.a5a5b","group":"e7794a15.c6d108","order":7,"width":0,"height":0,"name":"","label":"RPI 3 LED is ","format":"{{msg.payload}}%","layout":"row-spread","x":610,"y":220,"wires":[]},{"id":"4776ca0e.419484","type":"ui_text","z":"c3b403f3.a5a5b","group":"e7794a15.c6d108","order":9,"width":0,"height":0,"name":"","label":"RPI 4 LED is ","format":"{{msg.payload}}%","layout":"row-spread","x":610,"y":260,"wires":[]},{"id":"5c7fa99879505dce","type":"ui_text","z":"c3b403f3.a5a5b","group":"e7794a15.c6d108","order":11,"width":0,"height":0,"name":"","label":"RPI 5 LED is ","format":"{{msg.payload}}%","layout":"row-spread","className":"","x":610,"y":300,"wires":[]},{"id":"60168c1031696079","type":"ui_button","z":"c3b403f3.a5a5b","name":"","group":"e7794a15.c6d108","order":12,"width":0,"height":0,"passthru":false,"label":"Switch","tooltip":"","color":"","bgcolor":"","className":"","icon":"","payload":"","payloadType":"str","topic":"RPI/RPI5/MyLEDCommand","topicType":"str","x":750,"y":300,"wires":[["a33bad1.077475"]]},{"id":"94f1ac505db1c5ab","type":"comment","z":"c3b403f3.a5a5b","name":"Activate also Dashboard_2","info":"","x":290,"y":440,"wires":[]},{"id":"ae8bafb87f16e723","type":"comment","z":"c3b403f3.a5a5b","name":"Activate also RPI_LED_BTN_MQTT_DASHBOARD_FINAL","info":"","x":390,"y":400,"wires":[]},{"id":"87cc9444.0f3478","type":"mqtt-broker","name":"broker.hivemq.com","broker":"broker.hivemq.com","port":"1883","clientid":"","autoConnect":true,"usetls":false,"protocolVersion":4,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"e7794a15.c6d108","type":"ui_group","name":"Test","tab":"ab690596.b277f8","order":3,"disp":true,"width":"6","collapse":false},{"id":"ab690596.b277f8","type":"ui_tab","name":"Group","icon":"dashboard","disabled":false,"hidden":false}]
Phase #3
We want to me more serious with data protection
Why not using mTLS and PKI ?
Why not using a public IoT cloud providing SLA & better security model?
97
TLS – Transport Layer Security
Main goals
Server authentication
Data exchange confidentiality
Data exchange integrity
[Client authentication]
Versions 
SSL : forbidden!
TLS : 1.2 => 1.3 [=> 1.4]
Used in
Secure sockets
HTTPs
CoAP (Constrained Application Protocol) dTLS
…………………….
98
Something is wrong…
TLS
Negotiation phase
Key exchange protocol
Encryption algorithm
Integrity checking algorithm
Based on “Cipher suites“
Name indicates selected algorithms: e.g. TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
Key exchange/agreement : RSA, Diffie–Hellman, ECDH[E], PSK
Authentication: RSA, DSA, ECDSA
Block ciphers & mode: RC4, Triple DES, AES, IDEA, DES
Message authentication :using MD5, SHA1, SHA256
Protocol is known to be secure…
When implemented correctly
When deactivating weak cipher suites
…
99
100
Encryption 
with session key
Server
Device
TLS protocol messages
Server Authentication
Server private key
TLS with Mutual authentication (mTLS)
101
Encryption 
with session key
Client private key
Server
sign
Device
CertificateRequest
Certificate
CertificateVerify
Server private key
Mutual authentication
TLS in IoT
No need for multiple cipher suite support & multiple TLS versions! You know the device & the server!
Certificate based client authentication is preferred
Use certificate pinning to reduce processing/transmission time 
(may not be supported in some TLS implementations, may bring renewal challenges)
Reduce & protect the device trust store!
Protect the device private key!
102
TLS Stacks for IoT
mBed TLS (e.g. AWS IoT SDK)
OpenSSL (e.g. Linux & Windows devices)
JSSE (Java)
Others :
nanoSSL (mocana)
SharkSSL (RealTimeLogic)
WolfSSL 
…
Cellular Module’s TLS
Proprietary provisioning protocol
(!) No standard way to leverage SIM card security for keys
103
PKI for IoT
In IoT context, some shortcuts may be taken, while additional techniques are recommended
Device certificate is very powerful
The building block for secure communications
A possible simplification of provisioning files binding a device and a public key, allowing just in time registration 
Certificate is bound to a “thing” at production time
Except if regulated environment or highly sensitive device/data, 
Device certificate lifetime may be set to the device lifetime (e.g. 5, or 10 years) 
No real need to renew device certificates or keys stored in a Secure Element/Enclave	
But remotely managing keys may be required
KMIP (Key Management Interoperability Protocol), from OASIS
CMP (Certificate Management Protocol), RFC 4210, complete but heavy
SCEP (Simple Certificate Enrollment Protocol), widely used for smartphones
EST (Enrollment over Secure Transport), support for server side keygen, no large support
ACME (Automated Certificate Management Environment), RFC 8555, for web servers
104
The [IoT] PKI risks
Déjà Vu at LinkedIn: Second TLS Certificate Expiry in 2 Years
Cellular outage for 32 million Brits caused by expired certificate
GAO Report: Expired Certificate Allowed Extended Exfiltration
105
https://venafi.com/blog/expired-certificate-takes-down-microsoft-teams/ 
PKI for IoT
“Thing” will probably connect to a single back-end
No need for a public PKI signed by a “well known CA”, private PKI is probably sufficient
Certificate chain may be optimized and remain compact (bandwidth consumption & processing time)
Certificate revocation may be replaced by device deactivation in the back end database
In closed ecosystems no need to operate OCSP/CRL systems
Server certificate verification for general IoT
Protect the Trust store ! (if possible read only and obfuscated, remote administration only)
Reduce certificate chains
Certificate pinning (shorten certificate verification time, may reduce attackers opportunities to get access to a stolen certificate)
106
PKI for IoT
Trust store usages
Remote backend server identity
Authorized device software issuers
Authorized issuer of remote access / maintenance personnel certificates
Other PKI related data to be protected in secure storage
Device configuration (backend URL, …)
Service configuration (activated features, …)
107
MQTT and TLS
108
In MQTTbox on your laptop
Create a connection to test.mosquitto.org protocol mqtt/tcp [port 1883]
Create a connection to test.mosquitto.org protocol mqtts/tls [port 8883]
Note the differences in TLS certificate choices 
None
CA signed server cert (simple certificate presence verification !)
CA certificate only
self signed certificates (strange name for mTLS)
Note : Navigate to http://test.mosquitto.org with your browser to download broker certificate (mosquitto.org.crt)
Security checkpoint – Project description 
109
Review the project structure so far and, assuming the ‘device’ is to be industrialized and delivered to users as MVP:
List the current solution’s assets & attack surface
Identify few scenarios, associated impact
Propose some possible remediation 
 Delivery : 3 slides, 5’ presentation
Nice try !
Security checkpoint - Some answers
Assets
Attack path/ surface
Security checkpoint - Some answers
Few possible scenarios
Security checkpoint - Some answers
Some possible remediations & improvements
Security checkpoint - Some answers
Assets
The device & its parts
Device’s credentials (RPI user, SSH user, nodered user, dashboard user) 
Nodered flows (firmware protection, IP)
MQTT Broker access credentials
MQTT Messages confidentiality, integrity, originating address
The backend ! (Private MQTT broker and future cloud processing)
Logs
Attack path/ surface
Physical access (dump / tamper / steal device or SD card ) 
Local user login to RPI
SSH remote login
NodeRed flows web access
Dashboard access
MQTT messages in transit
MQTT broker access 
To Send/listen msg to device
To Send/listen msg to backend
Other RPI ports/services (part of default RPI image ‘full’)
Network traffic (MiTm, eavesdropping)
Security checkpoint - Some answers
Few possible scenarios
Steal device or SD
Repurpose the device (replace SD card, find weak user/ssh/nodered credentials…)
Steal IP by accessing application logic flows (dump SD, find weak user/ssh/nodered credentials…)
Alter behaviour (tamper with flows,…)
Steal credentials (access config files, monitor insecure transmissions…)
Detect user’s usage & presence (listen to traffic or monitor MQTT messages on broker/web site)
Stalk user by changing device state remotely (via MQTT broker, Remotely change device/flows settings)
Enroll device in botnet (via weak user/ssh/nodered credentials)
(User) Save money by emulating an expensive officiel remote (send MQTT messages directly)
Device DoS (Publishing lots of real-fake messages via broker to flood device, disconnect with clientID)
Ramsonware (Encryption of device or system data / flows)
High-impact DoS (Publish large number of real-fake messages to broker / back-end / and others!)
Unavailability (e.g. Broker goes down)
Gain access via vulnerabilities becoming known during product’s lifetime
Who tried to connect to another PI and « play » with it ?
Security checkpoint - Some answers
Some possible remediations & improvements
Include a Kensington lock system in the lamp casing? (anti-theft, anti-opening)
Encrypt SD card (confidentiallity & anti-tampering) , secure boot with password entry if acceptable, or obfuscated / hashed by a device unique identifier / OTP
Secure RPI user access (no default user/password, close?)
Secure SSH access (no default user/password , close?)
Secure NodeRed web access (close/remove?)
Secure data & flows at rest (encrypt SD, encrypt flows at nodered level, user ACLs)
Secure the dashboard access (end-user authn, change port number ?)
Secure input/output data flows content (use TLS), and policies (who publishes on which topic…)
Secure MQTT messages (Private broker with proper authn)
Protect device & infrastructure (use mTLS and private broker)
Increase SLA with private cloud / broker
Plan firmware/software updates
Close all unused ports & stop services, consider more compact OS version (ruggedized)
…
Monitoring of activities on server (traffic size, direction…)
Securing NodeRed Flows
Secure the flows storage
Where are the flows (application logic) ?
	Location : ~/.node-red   		(for root : /root/.node-red)
	File : flows[_raspberrypi].json  		(raspberrypi  being the hostname)
Where are the security credentials (username /password, broker @) ?
	 cat ~/.node-red/flows_cred.json	(for root : sudo cat /root/.node-red/flows[_raspberrypi]_cred.json )
		[encrypted content]
Did you notice the « Warning » each time you start node-red:
“Your flow credentials file is encrypted using a system-generated key. If the system-generated key is lost for any reason, your credentials file will not be recoverable, you will have to delete it and re-enter your credentials. You should set your own key using the 'credentialSecret' option in your settings file. Node-RED will then re-encrypt your credentials file using your chosen key the next time you deploy a change.”
And in ~/.node-red/settings.js file you’ll find that setting "credentialSecret : false“ will set credentials in clear after node-red restart…
	cat ~/.node-red/flows_raspberrypi_cred.json
		{"9b9602c2.6f8d8":{"user":"MYUSERNAME","password":"MYPASSWORD"}}
	Unless you put a real key … inside settings.js (!)
You definitely want to understand all these security aspects when relying on 3rd party tools / frameworks / systems !
Securing NodeRed Flow editor access
Activate flow editor access controls
Based on Password
~/.node-red/settings.js , uncomment and fill content: 
Generating password hashes (bCrypt salted format)
[sudo npm install -g node-red-admin]
node-red-admin hash-pw
Ensure default permission doesn’t allow ‘read’ for all (IP protection)
Ensure TLS is activated as well ! (see after)
Alternative : OAuth/OpenID, custom code
adminAuth: { 
	type: "credentials", 
	users: [
		 { username: "admin", 
			password: "$2a$08$zZWtXTja0fB1pzD4sHCMyOCMYz2Z6dNbM6tl8sJogENOMcxWV9DN.", 
			permissions: "*" },
		 { username: “pi", 
			password: “$2a$08$cgcKFPCEFYxkgXN0LkYYcenJwWyVwJY3r40iRX82IwytWEHI8fWbW", 
			permissions: "read" } 
	],
	default: { permissions: "read" }	 
} 
Securing NodeRed Dashboard access
Secure access to dashboard
Password-protect the node-defined HTTP endpoints and dashboard
	Uncomment & fill following line in ~/.node-red/settings.js :
		httpNodeAuth: {user:"user",pass:"pass_hash"},
	Pass field is a bcrypt hash of the password (see previous slide) 
Activate TLS 
Provide key & cert  in settings.js and force TLS usage
	https: {
		key: fs.readFileSync('privatekey.pem'),
		cert: fs.readFileSync('certificate.pem')
		}, 
	requireHttps: true,
Public IoT cloud services
Amazon AWS IoT Core ()
Azure Iot HUB ()
Google Cloud IoT ()
Alibaba Cloud IoT Platforms ()
PTC ThingWorx Industrial IoT Platform ()
Oracle IoT Cloud Service ()
IBM Watson IoT Cloud ()
SAP Cloud platform IoT ()
Balena.io ()
Software AG ()
Backberry IoT Platform ()
Cisco Jasper Control Center
Salesforce IoT
Braincube
…
119
Magic Quadrant for cloud infrastructure and platform services
Magic Quadrant for industrial iot platforms
AWS – Amazon Web Services
Create a free account (need a credit card!)
https://aws.amazon.com/fr 
Use a strong password (and 2FA)! This is your AWS account root user 
AWS Management Console
Access IAM
Create First Group & User (access type AWS management console access)
Administrators / Administrator : AdministratorAccess policy
		Note the new account login page and always use this IAM account 
		 https://474127109425.signin.aws.amazon.com/console (yours will be different)
120
AWS Global Free Tier
+ Amazon SNS customers free services: 1st million requests free, first 100 000 HTTP notifications, first 100 SMS notifications TO THE US ONLY, 1 000 first e-mail notifications. 
+ Device management actions : 50 remote actions free per month
 impacts real products too! Objects state update frequency vs bandwidth/cost/power must be considered
121
AWS – Amazon Web Services - Invitation
Activate your student account (You’ve been invited…)
You should have received an email "Your AWS Educate Application" from "AWS Educate Support":
Please follow the link to start activating your classroom account on AWS 
122
Hi - Your educator has invited you to join AWS Educate and access a "Classroom" for your course work. A "Classroom" is a hands-on learning environment for you to access AWS services and practice AWS. There are no costs or fees to access a Classroom. Classrooms are managed by a third-party content and service provider, Vocareum ("Third-Party Content Provider"), and use of the Classroom feature is governed by the Third-Party Content Provider’s terms and conditions (including its Privacy Policy) in addition to the AWS Educate Terms and Conditions. If you accept the Classroom invitation, the Third-Party Content Provider may allow your educator to view your Classroom account and activity, including the AWS console in your Classroom account, the number of EC2 instances running and any Content running in the services, and your access activity. Click here to complete the AWS Educate application process, accept your Classroom invitation and receive access to program benefits, including cloud career learning pathways, access to AWS resources and promotional credit through the AWS Educate Starter Account, and access to the AWS Educate Job Board, where applicable. Please apply using the link above to accept this invitation. If you do not wish to proceed, ignore this email. Thank you, AWS Educate 
AWS – Amazon Web Services - Registration
Fill-in your firstname/name/birthdate/graduate date
You will receive a 2nd email you’ll have to click to confirm your address
And from 3rd email link you will be able to create your password
Bookmark the login page https://www.awseducate.com/signin
Note: This account will be valid only for the duration of the classroom or until you spent all allocated credit on it. Your application will be reviewed and accepted, this may take up to 3 days…
123
AWS – Amazon Web Services - Classroom
From https://www.awseducate.com/signin
124
Click MyClassrooms
Accept invitation to       "IoT Security" course
Wait for course to be activated
AWS – Amazon Web Services – Creation
From https://www.awseducate.com/signin
125
When course is activated:
Click AWSAccount 
Click 	Create Starter Account
AWS – Amazon Web Services - Access
From https://www.awseducate.com/signin
126
Click AWSAccount 
Click AWS Educate Starter Account
AWS – Amazon Web Services - Access
From https://www.awseducate.com/signin
127
You may check your remaining credit
Or get your API Key :click Account details then show
To access AWS services, click AWS console button
AWS – Amazon Web Services - WARNING
128
Note only us-east-1 is supported by AWS Educate
You cannot create other users/roles with ‘login profile’ (only technical roles)
AWS – Amazon Web Services - Invitation
Activate your student account (You’ve been invited…)
You should have received an email “Course Invitation" from “AWS Academy":
Please follow the link to start activating your classroom account on AWS 
129
AWS – Amazon Web Services - Registration
Confirm account creation
Create a password & click Register
Bookmark the login page https://awsacademy.instructure.com/login/canvas 
Note: This account will be valid only for the duration of the classroom or until you spent all allocated credit on it. Your application will be reviewed and accepted, this may take up to 3 days…
130
AWS – Amazon Web Services - Classroom
131
Click Courses
Select AWS Academy 		Learner Lab
Open Modules
AWS – Amazon Web Services – Lab access
132
Open the Learner Lab
Accep Terms & Conditions
Click the Student access
AWS – Amazon Web Services – Lab access
133
Start Lab
Wait until AWS status is green
(be patient the 1st time…)
AWS – Amazon Web Services – Lab details
134
You may check your remaining credit
To get your CLI API Key :click i AWS Details then show
To access AWS console, click AWS button
You may send CLI commands from within the terminal window
AWS Recommendations
You have limited credit
Do not activate too much logs, stop your devices & apps when not used
To make your life easier
Set English language
135
AWS Terminology
Regions (not applicable to IAM). Select one of these regions for later Alexa usage
Asia Pacific (Tokyo)
EU (Ireland) : eu-west-1
US East (N. Virginia)
US West (Oregon)
30+ available regions
Availability zones (AZ) inside a region
2-6 AZ per region, total 99 AZs
Each AZ is made of several data centers
Service health report : https://health.aws.amazon.com/health/status (+ your account health) 
136
AWS Educate accounts are supported 
only in North Virginia region
137
2021
AWS Terminology
User
Role: A specific identity with permissions, associated to users / processes
Policy: Defines permissions over resources that may be associated to roles
EC2: Elastic Compute Cloud
ARN : Amazon Resource Name
   format: « arn:partition:service:region:account-id:resource »
e.g. arn:aws:lambda:eu-west-1:474127109425:function:LambdaForAlexaRPI
138
AWS Management console
Find a service
Access recently used services
139
AWS IoT Core 
IoT Core Allows secure device / cloud data exchanges & device management, with device shadow option
	Supported Protocols, authentication & ports
						Note there is no unauthenticated access…
MQTT capability with guaranteed performance level and availability (paying…)
140
AWS IoT Core 
Start IoT Core service
141
AWS IoT Core 
Let’s create our smart lamp and assign its certificate
Create device (Thing)
Manage / All devices / Things/ Create Things / Create a single Thing
Name : RPI1 (use your own number)
Type : Create type : RPI
Group : Create group LED, described as « Device with remotely controllable LED»
Tick Skip creating a certificate (we’ll do it manually below)
Create certificate
Security / Certificates / Create 
Click « Auto-generate new certificate » 
Set certificate status to Active
Click create
Download the 3 device cert components & the amazon root CA (Amazon Root CA 1)
142
AWS IoT Core 
Then specify our smart lamp permissions…
Create policy for MQTT (iot:)
Security / Policies/ Create
Name :  All
Policy effect : Allow 
Action: * (in fact it’s meant iot:*)
Resource : *    
(for more restrictive policy we could use arn:aws:iot:us-east-2:474127109425:RPI/RPI1/Test (but we’ll see later))
Click Create
Bind everything together
Security / Certificates , click the certificate. 
Policies / Attach policies, Select policy ‘All’ + Attach
Things / Attach to things, Select thing ‘RPI1’ + Attach
143
AWS IoT Core
To be able to publish data on AWT IoT Core private MQTT broker
Note your account endpoint (AWT IoT Core menu / Connect / Domain / Domain name) 
e.g.       a2mi339glkcxco-ats.iot.us-east-1.amazonaws.com
Transfer amazon root CA certificates & 3 device cert parts into the client 
Create destination directory on RPI : /home/pi/awsCerts
Use WinSCP or scp command line on linux to transfer the 4 files
	scp AmazonRootCA1.pem pi@192.168.0.92:~/awsCerts
	scp bab32bba39-* pi@192.168.0.92:~/awsCerts
(e.g. bab32bba39-certificate.pem.crt, bab32bba39-private.pem.key, bab32bba39-public.pem.key)
144
AWS IoT Core
Publishing data on AWT IoT Core private MQTT broker with node red
Create new flow
Create nodes to Publish & Subscribe on topic ‘RPI/Test’
Message type JSON : {"value":"1"}
Create a new MQTT broker setup ‘AWS RPI1’ (use your number)
Server : a37nlvgzkylhiz-ats.iot.us-east-1.amazonaws.com (replace by your own endpoint)
Port : 8883
Client ID : RPI1 (use your number)
QoS : 0 or 1 (2 not supported by AWS IoT)
Enable TLS security and create TLS configuration
Name : RPI1 (use your number)
Point to the 3 key/certificate files (e.g. /home/pi/awsCerts/bab32bba39-private.pem.key)
Note: use AmazonRootCA1.pem for server certificate and use your own generated certificate number
145
Checklist: 	Node Red is started (node-red-start) / access to node red (@IP:1880)  / Deploy
FAQ: 	Ensure subscriber QoS<=1 / check lab is running / check certificate is active / check policy is bound to certificate /
	 verify certs path on RPI & NodeRed / verify Amazon root cert content… check log!
AWS IoT Core
Testing AWS IoT Core private MQTT broker
Launch MQTT Test client from AWS IoT console / Test
Test publishing on & subscribing to topic ‘RPI/Test’
146
Quid of device ID ?
AWS IoT with Node red
Note: you need to change the AWS broker url and certificates names to match yours!
Node Red Flow  AWS1
[{"id":"145f19d3.21f876","type":"tab","label":"AWS1","disabled":false,"info":""},{"id":"15776c.ca587894","type":"inject","z":"145f19d3.21f876","name":"","topic":"RPI/Test","payload":"{\"value\":\"1\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":360,"y":220,"wires":[["4676495f.5e6068"]]},{"id":"4676495f.5e6068","type":"mqtt out","z":"145f19d3.21f876","name":"","topic":"RPI/Test","qos":"1","retain":"","broker":"de5e8b6d.d98b68","x":620,"y":220,"wires":[]},{"id":"258d8cc8.b79614","type":"mqtt in","z":"145f19d3.21f876","name":"","topic":"RPI/Test","qos":"1","datatype":"auto","broker":"de5e8b6d.d98b68","x":310,"y":300,"wires":[["621da404.6a832c"]]},{"id":"621da404.6a832c","type":"debug","z":"145f19d3.21f876","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":630,"y":300,"wires":[]},{"id":"de5e8b6d.d98b68","type":"mqtt-broker","z":"","name":"AWS RPI1","broker":"a37nlvgzkylhiz-ats.iot.us-east-1.amazonaws.com","port":"8883","tls":"361362d3.6b745e","clientid":"RPI1","usetls":true,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"361362d3.6b745e","type":"tls-config","z":"","name":"RPI1","cert":"/home/pi/awsCerts/470f14abc8-certificate.pem.crt","key":"/home/pi/awsCerts/470f14abc8-private.pem.key","ca":"/home/pi/awsCerts/AmazonRootCA1.pem","certname":"cc2956e006-certificate.pem.crt","keyname":"cc2956e006-private.pem.key","caname":"VeriSign-Class 3-Public-Primary-Certification-Authority-G5.pem","servername":"","verifyservercert":true}]
147
AWS IoT Core
If several devices are publishing on ‘RPI/Test’ : how to distinguish source device?
Need to bind data to a specific device: inject clientID in the topic name
E.g. RPI/RPI1/Test   where RPI1 is the same as clientID
Alternatively we could add the ClientID in the message payload itself 
E.g topic ‘RPI/test’ and payload { “value":“1", "device":"RPI1" }
148
Are certificates & topic Name & client ID enough ? 
Not really :  Another onboarded device (e.g. RPI2) may still generate data under RPI1 topic or use its client ID!
AWS IoT with Node red
Note: you need to change the AWS broker url and certificates names to match yours!
Node Red Flow  AWS2
[{"id":"fc93d78f.1f92d8","type":"tab","label":"AWS2","disabled":false,"info":""},{"id":"40c39958.c72808","type":"inject","z":"fc93d78f.1f92d8","name":"","topic":"RPI/RPI1/Test","payload":"{\"value\":\"1\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":230,"y":260,"wires":[["4862e2e1.63c1cc"]]},{"id":"4862e2e1.63c1cc","type":"mqtt out","z":"fc93d78f.1f92d8","name":"","topic":"RPI/RPI1/Test","qos":"0","retain":"","broker":"de5e8b6d.d98b68","x":500,"y":260,"wires":[]},{"id":"5cc13aa9.63c964","type":"mqtt in","z":"fc93d78f.1f92d8","name":"","topic":"RPI/RPI1/Test","qos":"1","broker":"de5e8b6d.d98b68","x":180,"y":340,"wires":[["e93121fb.3cb6c"]]},{"id":"e93121fb.3cb6c","type":"debug","z":"fc93d78f.1f92d8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":490,"y":340,"wires":[]},{"id":"de5e8b6d.d98b68","type":"mqtt-broker","z":"","name":"AWS RPI1","broker":"a37nlvgzkylhiz-ats.iot.us-east-1.amazonaws.com","port":"8883","tls":"361362d3.6b745e","clientid":"RPI1","usetls":true,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"361362d3.6b745e","type":"tls-config","z":"","name":"RPI1","cert":"/home/pi/awsCerts/470f14abc8-certificate.pem.crt","key":"/home/pi/awsCerts/470f14abc8-private.pem.key","ca":"/home/pi/awsCerts/AmazonRootCA1.pem","certname":"cc2956e006-certificate.pem.crt","keyname":"cc2956e006-private.pem.key","caname":"VeriSign-Class 3-Public-Primary-Certification-Authority-G5.pem","servername":"","verifyservercert":true}]
149
[the need for] AWS Policies
150
Node Red Flow  AWS Policies#1
[{"id":"3da35f20.0b7b6","type":"tab","label":"AWS Policies#1","disabled":false,"info":""},{"id":"174770b1.af3eff","type":"mqtt out","z":"3da35f20.0b7b6","name":"from RPI1:RPI/RPI2/Test","topic":"RPI/RPI2/Test","qos":"0","retain":"","broker":"26cc290e.df7a56","x":848.3333587646484,"y":152.2222080230713,"wires":[]},{"id":"54077064.3aeae","type":"inject","z":"3da35f20.0b7b6","name":"","topic":"RPI/RPI2/Test","payload":"{\"value\":\"3\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":488.33335876464844,"y":152.2222080230713,"wires":[["174770b1.af3eff"]]},{"id":"d6f83725.dc0588","type":"inject","z":"3da35f20.0b7b6","name":"","topic":"RPI/RPI1/Test","payload":"{\"value\":\"1\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":487.7777404785156,"y":56.666669845581055,"wires":[["5198119c.efe39"]]},{"id":"5198119c.efe39","type":"mqtt out","z":"3da35f20.0b7b6","name":"from RPI1:RPI/RPI1/Test","topic":"RPI/RPI1/Test","qos":"0","retain":"","broker":"26cc290e.df7a56","x":847.7777404785156,"y":56.666669845581055,"wires":[]},{"id":"3d03a375.8a892c","type":"comment","z":"3da35f20.0b7b6","name":"Impersonate publication OK as RPI1 is allowed to publish on any topic","info":"","x":713.8888549804688,"y":203.33333587646484,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"6bc360fb.8d20f","type":"comment","z":"3da35f20.0b7b6","name":"'All' policy on RPI1 & RPI2","info":"","x":115,"y":20,"wires":[]},{"id":"ffbd2bd4.805278","type":"comment","z":"3da35f20.0b7b6","name":"Real RPI1","info":"","x":106.66669845581055,"y":55.555551528930664,"wires":[]},{"id":"6e8eb10c.aa959","type":"comment","z":"3da35f20.0b7b6","name":"Real RPI2","info":"","x":107.77777862548828,"y":104.44444274902344,"wires":[]},{"id":"e34c73e.fff5f9","type":"comment","z":"3da35f20.0b7b6","name":"RPI1 fakes RPI2 messages","info":"","x":165.5555648803711,"y":152.2222194671631,"wires":[]},{"id":"138302e7.5f060d","type":"mqtt out","z":"3da35f20.0b7b6","name":"from RPI2:RPI/RPI2/Test","topic":"RPI/RPI2/Test","qos":"0","retain":"","broker":"f443af26.bbf6b","x":848.8889083862305,"y":105.5555648803711,"wires":[]},{"id":"a85b3b6c.318598","type":"inject","z":"3da35f20.0b7b6","name":"","topic":"RPI/RPI2/Test","payload":"{\"value\":\"2\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":488.88890838623047,"y":105.5555648803711,"wires":[["138302e7.5f060d"]]},{"id":"5c4fce11.61124","type":"mqtt in","z":"3da35f20.0b7b6","name":"RPI1 subs to RPI/#","topic":"RPI/#","qos":"1","datatype":"auto","broker":"26cc290e.df7a56","x":442.7777786254883,"y":580,"wires":[["2749f2.3b46360e"]]},{"id":"2749f2.3b46360e","type":"debug","z":"3da35f20.0b7b6","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","targetType":"msg","x":881.6666793823242,"y":580.0000138282776,"wires":[]},{"id":"765af254.ee5c0c","type":"debug","z":"3da35f20.0b7b6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":871.6666793823242,"y":632.2222428321838,"wires":[]},{"id":"7173d20e.ab313c","type":"mqtt in","z":"3da35f20.0b7b6","name":"RPI2 subs to RPI/#","topic":"RPI/#","qos":"1","datatype":"auto","broker":"f443af26.bbf6b","x":442.7777786254883,"y":632.2222290039062,"wires":[["765af254.ee5c0c"]]},{"id":"1ce6a438.82291c","type":"comment","z":"3da35f20.0b7b6","name":"No constraints on subscriptions","info":"","x":135,"y":551.111120223999,"wires":[]},{"id":"334219c2.c5ea06","type":"comment","z":"3da35f20.0b7b6","name":">> Attach publish & subscribe policy v1 to RPI2 to block it","info":"","x":670,"y":340,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"3d7bb76b.421668","type":"inject","z":"3da35f20.0b7b6","name":"","topic":"RPI/RPI1/Test","payload":"{\"value\":\"4\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":490,"y":240,"wires":[["b5ba52fc.32582"]]},{"id":"b5ba52fc.32582","type":"mqtt out","z":"3da35f20.0b7b6","name":"from RPI2:RPI/RPI1/Test","topic":"RPI/RPI1/Test","qos":"0","retain":"","broker":"f443af26.bbf6b","x":850,"y":240,"wires":[]},{"id":"d9049ca3.b1765","type":"comment","z":"3da35f20.0b7b6","name":"RPI2 fakes RPI1 messages","info":"","x":167.22220611572266,"y":240.0000114440918,"wires":[]},{"id":"b6d353b5.2483b","type":"comment","z":"3da35f20.0b7b6","name":"Impersonate publication OK as RPI1 is allowed to publish on any topic","info":"","x":715.5554962158203,"y":291.11112785339355,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"26cc290e.df7a56","type":"mqtt-broker","z":"","name":"AWS RPI1","broker":"a16auruvfvphj1-ats.iot.us-east-1.amazonaws.com","port":"8883","tls":"2603cee1.048f22","clientid":"RPI1","usetls":true,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"f443af26.bbf6b","type":"mqtt-broker","z":"","name":"AWS RPI2","broker":"a16auruvfvphj1-ats.iot.us-east-1.amazonaws.com","port":"8883","tls":"41d7a882.eec658","clientid":"RPI2","usetls":true,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"2603cee1.048f22","type":"tls-config","z":"","name":"RPI1","cert":"/home/pi/awsCerts/5dd81a0622-certificate.pem.crt","key":"/home/pi/awsCerts/5dd81a0622-private.pem.key","ca":"/home/pi/awsCerts/AmazonRootCA1.pem","certname":"cc2956e006-certificate.pem.crt","keyname":"cc2956e006-private.pem.key","caname":"VeriSign-Class 3-Public-Primary-Certification-Authority-G5.pem","servername":"","verifyservercert":true},{"id":"41d7a882.eec658","type":"tls-config","z":"","name":"RPI2","cert":"/home/pi/awsCerts/e4d27820bc-certificate.pem.crt","key":"/home/pi/awsCerts/e4d27820bc-private.pem.key","ca":"/home/pi/awsCerts/AmazonRootCA1.pem","certname":"","keyname":"","caname":"","servername":"","verifyservercert":true}]
We filtered unregistered things thx to certificates, but what about a REAL lying device ? RPI2 may publish messages on RPI1 topic…
AWS Policies
We want to enforce a client device to publish only on « its own » topic
We can write a more restrictive policy using variables in policy statement’s resource arn 
	      ${iot:ClientId}
	Or ${iot:Certificate.Subject.CommonName} if it’s meaningful (not for our test)
	Or ${iot:Connection.Thing.ThingName}
In Security menu, Create a new policy, called ‘PublishSubscribe’ and select ‘advanced mode’ (JSON) to edit policy
151
AWS Policies
To restrict clients publishing on topic ‘RPI/clientID/+’ we need a rule to ensure consistency between: 
	clientID -> topic
(don’t forget to attach it to the RPI2 certificate instead of ‘All’ policy!)
152
{ 	
	"Version": "2012-10-17", 
	"Statement": [
		 { 
		"Effect": "Allow", 
		"Action": ["iot:connect", "iot:Subscribe", "iot:Receive"], 
		"Resource": "*" 
		},
		{ 
		"Effect": "Allow", 
		"Action": ["iot:Publish"], 
		"Resource": [ "arn:aws:iot:us-east-1:464090521505:topic/RPI/${iot:ClientId}/*" ]
	 	}
 	]
 }
First version of AWS Policy PublishSubscribe 
Be careful this is NOT your endpoint, this is your resource ARN prefix (get it e.g. from your thing name or your account upper right corner)
This doesn’t enforce it’s actually the real clientID: there is no link with certificate or thing name! 
AWS Policies
RPI2 may still publish messages on RPI1 topic using ‘RPI1’ as client ID
153
Node Red Flow  AWS Policies#2
[{"id":"eeada7b9.633358","type":"tab","label":"AWS Policies#2","disabled":false,"info":""},{"id":"b49308c1.e3e7e8","type":"mqtt in","z":"eeada7b9.633358","name":"RPI1 subs to RPI/#","topic":"RPI/#","qos":"1","datatype":"auto","broker":"26cc290e.df7a56","x":442.7777786254883,"y":588.8889827728271,"wires":[["98a97537.90f4a8"]]},{"id":"98a97537.90f4a8","type":"debug","z":"eeada7b9.633358","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","targetType":"msg","x":881.6666793823242,"y":588.8889966011047,"wires":[]},{"id":"d8e63b73.782118","type":"debug","z":"eeada7b9.633358","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":871.6666793823242,"y":641.111225605011,"wires":[]},{"id":"3f1cb0ff.68a0a","type":"mqtt in","z":"eeada7b9.633358","name":"RPI2 subs to RPI/#","topic":"RPI/#","qos":"1","datatype":"auto","broker":"f443af26.bbf6b","x":442.7777786254883,"y":641.1112117767334,"wires":[["d8e63b73.782118"]]},{"id":"7bd5804.565268","type":"mqtt out","z":"eeada7b9.633358","name":"From RPI2:RPI/RPI2/Test","topic":"RPI/RPI2/Test","qos":"0","retain":"","broker":"f443af26.bbf6b","x":850,"y":80,"wires":[]},{"id":"97f30e52.24805","type":"inject","z":"eeada7b9.633358","name":"","topic":"RPI/RPI2/Test","payload":"{\"value\":\"4\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":470,"y":80,"wires":[["7bd5804.565268"]]},{"id":"b31972f1.b1fc9","type":"comment","z":"eeada7b9.633358","name":">> attach policy v2 to RPI2 to block it as soon as it connects","info":"","x":720,"y":220,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"11a6406a.a4d8a","type":"comment","z":"eeada7b9.633358","name":"No constraints on subscriptions","info":"","x":135,"y":560.0001029968262,"wires":[]},{"id":"3583a474.bb170c","type":"comment","z":"eeada7b9.633358","name":"Connection & Publication constraints on RPI2 : Publish & Subscibe Policy version 1","info":"","x":296.6666259765625,"y":45.555542945861816,"wires":[]},{"id":"e264a194.9318d","type":"mqtt out","z":"eeada7b9.633358","name":"Connect from RPI2 as fake RPI1:RPI/RPI1/Test","topic":"RPI/RPI1/Test","qos":"0","retain":"","broker":"8347ae6e.249ec","x":781.6666259765625,"y":123.33332633972168,"wires":[]},{"id":"bf1902d2.3dc0f","type":"comment","z":"eeada7b9.633358","name":"Impersonate connection OK as thing name matches client ID!","info":"","x":726.1111145019531,"y":174.44451808929443,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"21f41d28.e18572","type":"comment","z":"eeada7b9.633358","name":"RPI2 still connecting & pubishing","info":"","x":179.4444122314453,"y":81.33332824707031,"wires":[]},{"id":"a53e9ba6.7b66a8","type":"comment","z":"eeada7b9.633358","name":"RPI2 using RPI1 as clientID","info":"","x":170.55551147460938,"y":129.11111164093018,"wires":[]},{"id":"73137f63.2e3f5","type":"comment","z":"eeada7b9.633358","name":"#B gets disconnected by #A","info":"","x":1100,"y":580,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"5e6e4861.030c98","type":"inject","z":"eeada7b9.633358","name":"","topic":"RPI/RPI1/Test","payload":"{\"value\":\"5\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":471.6666259765625,"y":123.33332633972168,"wires":[["e264a194.9318d"]]},{"id":"7072bcc.f8af344","type":"comment","z":"eeada7b9.633358","name":"#A gets disconnected by #B","info":"","x":1080,"y":140,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"26cc290e.df7a56","type":"mqtt-broker","z":"","name":"AWS RPI1","broker":"a16auruvfvphj1-ats.iot.us-east-1.amazonaws.com","port":"8883","tls":"2603cee1.048f22","clientid":"RPI1","usetls":true,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"f443af26.bbf6b","type":"mqtt-broker","z":"","name":"AWS RPI2","broker":"a16auruvfvphj1-ats.iot.us-east-1.amazonaws.com","port":"8883","tls":"41d7a882.eec658","clientid":"RPI2","usetls":true,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"8347ae6e.249ec","type":"mqtt-broker","z":"","name":"AWS RPI2 trying to fake RPI1","broker":"a16auruvfvphj1-ats.iot.us-east-1.amazonaws.com","port":"8883","tls":"41d7a882.eec658","clientid":"RPI1","usetls":true,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"2603cee1.048f22","type":"tls-config","z":"","name":"RPI1","cert":"/home/pi/awsCerts/5dd81a0622-certificate.pem.crt","key":"/home/pi/awsCerts/5dd81a0622-private.pem.key","ca":"/home/pi/awsCerts/AmazonRootCA1.pem","certname":"cc2956e006-certificate.pem.crt","keyname":"cc2956e006-private.pem.key","caname":"VeriSign-Class 3-Public-Primary-Certification-Authority-G5.pem","servername":"","verifyservercert":true},{"id":"41d7a882.eec658","type":"tls-config","z":"","name":"RPI2","cert":"/home/pi/awsCerts/e4d27820bc-certificate.pem.crt","key":"/home/pi/awsCerts/e4d27820bc-private.pem.key","ca":"/home/pi/awsCerts/AmazonRootCA1.pem","certname":"","keyname":"","caname":"","servername":"","verifyservercert":true}]
as topic name matches clientID
AWS Policies v2
We need to extend the Publish rule to ensure consistency between: 
	Thing Name -> clientID -> topic
 Use ${iot:Connection.Thing.ThingName} variable in policy statement’s resource arn 
 e.g. Policy to publish on topic containing thing name :
We now need to manage the connect & subscribe aspects (topic RPI/#)
154
{ 	
	"Version": "2012-10-17", 
	"Statement": [
 		{
      		"Effect": "Allow",
      		"Action": ["iot:Subscribe", "iot:Receive“, "iot:connect" ],
      		"Resource": "*"
    		},
		{ 
		"Effect": "Allow", 
		"Action": ["iot:Publish"], 
		"Resource": [ "arn:aws:iot: us-east-1:464090521505 :topic/RPI/${iot:Connection.Thing.ThingName}/*" ]
	 	}
 	]
 }
2nd version of AWS Policy PublishSubscribe 
Challenges of production
155
Double click on your device certificate on windows 
      or 
type on your RPI :
openssl   x509 -in cfa29a….123-certificate.pem.crt -text -noout
dumpcert.sh
Challenges of production
AWS integrated PKI or own PKI?
we want to specify certificates properties (CN,…)
we want to control certificates issuance process
3rd party producing devices
	Anti-counterfeiting (‘real-fake’)
	Device diversification requires handling secrets
Plan for unpredictable future
	Lifecycle management (secrets, firmware)
	Long life and crypto evolutions
Provision the cloud from production flow
manual provisioning not viable
156
openssl genrsa -out $1.key 2048 
openssl req -new -key $1.key -out $1.csr -subj "/CN=$1"
openssl x509 -req -in $1.csr -CA rootcacert.pem -CAkey rootcapriv.key -CAcreateserial -out $1.crt -days 365 -sha256 
cat $1.crt rootcacert.pem  > $1full.crt
Using own CA with AWS – PKI preparation
Goal 
Control certificates issuance process (VA/RA)
Be able to issue certs in production, without being connected to AWS
Use device name as CN and control content of other certificate fields
Create an OwnPKI directory
[Create root CA key and self signed root certificate]
Create a script to generate new device certificates using your own CA 
		parameter : thing name, e.g. RPI01
Note : we’ll need “full certificate chain” later on, so 4th script line concatenates device cert and root cert
157
openssl genrsa -out rootcapriv.key 2048
openssl req -x509 -new -nodes -key rootcapriv.key -sha256 -days 1024 -out rootcacert.pem 
setupRootCA.sh
generateNewDeviceCert.sh
Using own CA with AWS - Process
Register your own CA into your AWS account
Prove to AWS your own the CA 
Issue your own device certificates to your devices
Provision your own device certificates in AWS 
Connect things as usual…
Note: a CA certificate may be provisioned in only one AWS IoT account
158
Registering our own CA in AWS
Open IoT Core / Security / CAs
Click Register CA certificate / Single-account
Follow the process below:
Generate a new ‘verification’ key/csr/cert on yourmachine using generateNewDeviceCert.sh script
	Provide registration code as parameter
Upload your root CA cert & verification cert 
rootcacert.pem & f5d85…e7d.crt
Tick Active CA status
Tick On auto certificate registration
Click Register
159
Note : if you follow the process as described in step 3 for CSR generation, you may get an error “No template, please set one up. Problems making Certificate Request”, you’ll then need to add the following parameter to your command:
 -subj "/C=/ST=/L=/O=/OU= /CN=f5d85a0f49d07f032477456dcd92d5860a8572405d5c54d32a86a148262d8e7d“ 
Issuing our own things certificates
Once CA is registered successfully , use the generateNewDeviceCert.sh script to generate a new device certificate e.g. RPI01b
Create a new thing RPI01b in IoT Core (group ‘LED’)
	Provision & activate your own certificate 	by selecting « Use my certificate » 
	Select your registered CA 
	Choose the device certificate (RPI01b.crt)
	Next
Attach ‘PublishSubscribe’ policy to the new thing
Create Thing
160
Testing our own thing certificates
[Import new device certificate on the RPI (private key+full cert)]
Create a script called testNewDeviceConnectionPub.sh to connect to AWS and publish using mosquitto_pub
	 parameter : thing name, e.g. RPI01b
Test connecting as new device  with the script (or create a Node Red broker configuration)
	./testNewDeviceConnectionPub.sh RPI01b
FAQ : check new thing certificate is activated / attach ‘ALL’ policy / check AmazonRootCA1.pem path is correct
	Specify clientID correctly or policy will reject connection / Check endpoint
161
mosquitto_pub -h a37nlvgzkylhiz-ats.iot. us-east-1.amazonaws.com 
   	      -p 8883 
	      --cafile AmazonRootCA1.pem 
                             --cert $1full.crt 
                             --key $1.key 
	      -t RPI/$1/Test                               -m "Hello from $1"
	      -i $1
testNewDeviceConnectionPub.sh
See IoTCore / settings
for endpoint 
Copy AmazonRootCA1.pem 
in OwnPKI folder
AWS Policies: Final
The final policy will ensure device:
Connects with a valid certificate, bound to a thing name
Claims a clientID=thingName , 
Publishes only on topics ‘RPI/thingName/#’
May still subscribe/receive messages on any topic ‘RPI/#’
Verify everything still works as before
Check you are not allowed to publish / subscribe to other topics
Notes : 
Device is disconnected as soon as it breaks a rule 
	(e.g. connect or publish on forbidden topic)
Do not mess up ‘+’ (in subscribe topic names) and ‘*’ (in publish topic names)
Do not confuse topic (for publish) & topicfilter (for subscribe)
Policy effect could be « Deny »
Bind the new policy to the object
Unbind policy‘ All’, as they are cumulative!
Check Client ID / Topic / Thing name are the same…
Final version 3 of AWS Policy PublishSubscribe
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "iot:Connect"
      ],
      "Resource": [
        "arn:aws:iot:us-east-1:602617322509:client/${iot:Connection.Thing.ThingName}"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "iot:Publish"
      ],
      "Resource": [
        "arn:aws:iot:us-east-1:602617322509:topic/RPI/${iot:Connection.Thing.ThingName}/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "iot:Subscribe"
      ],
      "Resource": [
        "arn:aws:iot:us-east-1:602617322509:topicfilter/RPI/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "iot:Receive"
      ],
      "Resource": [
        "arn:aws:iot:us-east-1:602617322509:topic/RPI/*"
      ]
    }
  ]
}
162
AWS Policies verification with Node Red
163
Validating the policies
« All » on RPI1
« All » on RPI2
	No restriction, any thing may ‘lie’
Assign stricter policy v3
« PublishSubscribe» on RPI2
	No more impersonation is possible from RPI2!
	 Subscriptions are restricted to RPI/#
(of course same policy should be applied to all devices!)
AWS Rules
AWS enables serverless processing thanks to Rules and Actions
Note : Rules work better on JSON messages
Use case : we want to listen to all our RPIs’ MQTT topic ‘RPI/+/Test’ and republish the MQTT message on an ‘RPI/Alert’ Topic if a value of an RPI goes above e.g. 80% (could be thermostat reporting out of range temperature, etc). We also want to send an email to an admin 
We will:
Define the rule containing conditions to trigger an action (e.g. value>80)
Define the action(s) (e.g. Lambda execution, republish a message or send a notification)
Enrich the message before forwarding it on an alert topic (‘RPI/Alert’)
Define the associated roles and policies
164
In AWS IoT Core, go to Message routing and create a rule
Name : RepublishAlerts
Description : «  Republish a message on RPI/Alert topic if value exceeds 80 »
Select SQL Version : 2016
Fill the rule query statement as follow:
SELECT * FROM 'RPI/+/Test' WHERE value>80
Add an action
Select « Republish to AWS IoT topic » & configure action
Fill the targeted topic : ‘RPI/Alert’
Click create role
Role Name : MQTTAlertForwarding
Click next
Click create
AWS Rules
165
Testing the AWS rule with Node Red
166
Create a new flow with 3 buttons to send MQTT messages to topic ‘RPI/RPI1/Test’ from your RPI with following JSON content to your AWS account:  
Listen to the topic ‘RPI/Alert’ and display received messages in a debug node
Verify the RepublishAlerts rule is triggered and MQTT message is received on topic ‘RPI/Alert’ if value > 80
Note : if you are disconnected after adding subscription to RPI/Alert, check the QoS…
Pb : we do not know what device triggered the alert (check in node red log)
{ “value”:”1”}
{ “value”:”81”}
{ “value”:”101”}
AWS Rules
In AWS IoT Core, go to Message routing and modify the RepublishAlerts rule
Fill the rule query statement as follow:
SELECT clientid() AS ClientId, topic() AS topic, value AS valueAlert FROM 'RPI/+/Test' WHERE value>80
Note we may include some system variables :
	clientid()
	topic()
	principal()
and change an attribute name from the input json message with ‘AS’ :
	value AS valueAlert
You may also perform computations, conversions etc
Check in Node Red alert message now contains initial ClientID and topic values (see node red log)
167
Testing the rule with Node Red
Node Red Flow  AWSRules1
[{"id":"6bc95f22.c5c54","type":"tab","label":"AWSRules1","disabled":false,"info":""},{"id":"c1cf3b0c.fc90f8","type":"inject","z":"6bc95f22.c5c54","name":"","topic":"RPI/RPI1/Test","payload":"{\"value\":\"101\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":220,"y":140,"wires":[["8fe63c58.d9fed"]]},{"id":"8fe63c58.d9fed","type":"mqtt out","z":"6bc95f22.c5c54","name":"","topic":"RPI/RPI1/Test","qos":"0","retain":"","broker":"de5e8b6d.d98b68","x":500,"y":100,"wires":[]},{"id":"86a6bd91.98952","type":"mqtt in","z":"6bc95f22.c5c54","name":"","topic":"RPI/RPI1/Test","qos":"1","broker":"de5e8b6d.d98b68","x":158.8888931274414,"y":220.0000057220459,"wires":[["d9f26fa1.8be36"]]},{"id":"d9f26fa1.8be36","type":"debug","z":"6bc95f22.c5c54","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":470,"y":220,"wires":[]},{"id":"71c62c5d.b3ddb4","type":"inject","z":"6bc95f22.c5c54","name":"","topic":"RPI/RPI1/Test","payload":"{\"value\":\"1\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":210,"y":60,"wires":[["8fe63c58.d9fed"]]},{"id":"5be9d7e8.5f9658","type":"mqtt in","z":"6bc95f22.c5c54","name":"","topic":"RPI/Alert","qos":"1","broker":"de5e8b6d.d98b68","x":151,"y":300,"wires":[["8d92eb4f.ec78f8"]]},{"id":"8d92eb4f.ec78f8","type":"debug","z":"6bc95f22.c5c54","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":470,"y":300,"wires":[]},{"id":"8ce2a2b5.a7076","type":"inject","z":"6bc95f22.c5c54","name":"","topic":"RPI/RPI1/Test","payload":"{\"value\":\"81\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":220,"y":100,"wires":[["8fe63c58.d9fed"]]},{"id":"768adc7.a66eb24","type":"debug","z":"6bc95f22.c5c54","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":470,"y":380,"wires":[]},{"id":"639dd544.f6a9dc","type":"mqtt in","z":"6bc95f22.c5c54","name":"","topic":"RPI/Alert2","qos":"1","broker":"de5e8b6d.d98b68","x":151,"y":380,"wires":[["768adc7.a66eb24"]]},{"id":"de5e8b6d.d98b68","type":"mqtt-broker","z":"","name":"AWS RPI1","broker":"a37nlvgzkylhiz-ats.iot.us-east-1.amazonaws.com","port":"8883","tls":"361362d3.6b745e","clientid":"RPI1","usetls":true,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"361362d3.6b745e","type":"tls-config","z":"","name":"RPI1","cert":"/home/pi/awsCerts/470f14abc8-certificate.pem.crt","key":"/home/pi/awsCerts/470f14abc8-private.pem.key","ca":"/home/pi/awsCerts/AmazonRootCA1.pem","certname":"cc2956e006-certificate.pem.crt","keyname":"cc2956e006-private.pem.key","caname":"VeriSign-Class 3-Public-Primary-Certification-Authority-G5.pem","servername":"","verifyservercert":true}]
168
AWS SNS (Simple Notification Service)
SNS allows sending various notifications to multiple subscribers
- App to Person : email/SMS/push
- App to App : lambda, queue, email, http…
Using SNS topics will allow changing how SNS is actually notifying subscribers while keeping publishers’ triggering rules unchanged
169
AWS Rules – Using SNS (Simple Notification Service)
Quickly create a new rule ‘AlertAdmin’ triggering when value >100
	SELECT *, clientid() AS clientId FROM 'RPI/+/Test' WHERE value>100
	(use SQL 2016!)
Add an action 
	Select SNS & configure action
	Create SNS Target «AlertAdminNotification »  [ ensure you select “Standard” and not “FIFO”!]		(This is a topic name triggered in SNS, we’ll define how to handle it later)
	Select message format Raw
	Chose Create role, name «AlertAdminNotificationRole» 		(do not reuse existing one or the attached policy will not match)
	Click next
Click create
170
AWS SNS (Simple Notification Service) and eMails
We now need to handle the topic, configure what the notification will look like, define the target recipients and ensure they previously agreed to receive such notifications…
Access the SNS service
In Topics, select your newly created topic SNS ‘AlertAdminNotification’ 
Click create subscription
	Select protocol : Email
	Specify endpoint : your email address
An Opt-in confirmation email is being sent, and subscription status is pending
	Received email will appear as issued by Topic name ‘AlertAdminNotification’
	Click the confirmation link in the email and subscription becomes active
Select the topic again and try publish message feature to validate email subscription is ok, then go to node red and publish value >100 to trigger the full rule and alert notification process. 
You should receive an email with the mqtt message content
You may add several subscriptions of various types, they will all be triggered by a simple call to this SNS Topic
Try Changing AlertAdmin Rule-Message format to JSON and add "default": "my message"  to Node Red 
171
AWS SNS (Simple Notification Service) and SMS
SMSs may be sent to mobile devices almost worldwide, but not all regions offer the SNS SMS messaging service
 (03/2023 status)
172
Free-Tier 		: Be careful, free tier includes 100 SMSs notifications only to the US!!
AWS educate 	
AWS academy         : Cost will be assigned to your course credit
!! Remember this will cost you between 0,06€ and 0,10€ per SMS out of US !! (varies from country to country) 
AWS SNS (Simple Notification Service) and SMS
Return to SNS service / Topics, select topic ‘AlertAdminNotification’ 
Create a new subscription for the same SNS Topic 
	Select protocol : SMS
	Specify endpoint : your mobile phone number in international format (+33 6 ….)
Opt-in, then trigger the rule from node red (value>100), or manually send a message…
173
Free-Tier 		: Be careful, free tier includes 100 SMSs notifications only to the US!!
AWS educate 	
AWS academy         : Cost will be assigned to your course credit
!! Remember this will cost you between 0,06€ and 0,10€ per SMS out of US !! (varies from country to country) 
AWS IoT Device Defender
Monitoring activities is crucial to detect abnormal behaviors & possible [security] incidents. We’ll define what a ‘good’ behaviour is…
Open the Security / Detect section,
Click Security Profiles
Create a ruled-based anomaly detect profile
Name SmartLamp_MessageSent 
Target All ThingsClick Next
174
AWS IoT Device Defender
Monitoring activities is crucial to detect abnormal behaviors & possible [security] incidents. We’ll define what a ‘good’ behaviour is…
Select metric Message Sent
Configure the expected behaviour
     message sent : Less than 10 over a 5’ period
175
AWS IoT Device Defender
Select any additional retained metrics like =>
	Click Add metric
	Select e.g. “Message Size”
	click Don’t send an alert (retain metric)
Click Next
Don’t export metrics
You may select an SNS topic for Alarms (we won’t)
Click Create
Note: Metrics type Device-side requires AWS device agent to be used.
176
AWS IoT Device Defender
				Create a flow in nodeRed to publish a msg every second
				After a few minutes, data starts to be populated 
in Security Profile / SmartLamp / Defender metrics		and later in Alarms panel
177
AWS IoT Device Defender
A very powerful feature:
Collect & monitor device behavior
	There are much more complex rules allowing to detect deviation from the global devices behavior at each point in time (e.g. varying activities during the day)
	ML based rules may be created 
Run Audits on the fleet
Remediation actions may be triggered 
	Change/Remove certificate policy
	Move to a different group
	Publish an SNS event for custom handling, e.g. lambda
178
Public IoT cloud services
Amazon AWS IoT Core ()
Azure Iot HUB ()
Google Cloud IoT ()
Alibaba Cloud IoT Platforms ()
PTC ThingWorx Industrial IoT Platform ()
Oracle IoT Cloud Service ()
IBM Watson IoT Cloud ()
SAP Cloud platform IoT ()
Balena.io ()
Software AG ()
Backberry IoT Platform ()
Cisco Jasper Control Center
Salesforce IoT
Braincube
…
179
Public IoT cloud services - Project
Search one of IoT clouds providers and present its IoT features to the group in 5/10’
Wording
Supported device authentication methods
Supported communication protocols
Additional IoT services 
Provisioning modes (JITP/Batch/CLI/Manual)
[free tier / cost]
…
180
Groups
181
Damien                   Hassko
Public IoT cloud - Project
182
AWS - CLI
System deployment must be automated & reproducible (no manual operations): AWS CLI helps designing “Infrastructure & production as code”
Use CLI (Command Line Interface) to interact with AWS services
Functionally equivalent to that provided by the browser-based AWS Management Console 
Available as Python package (or native) to script deployment and management actions
Be careful : nothing will be automatically done for you any more (role/policies/bindings/…)
Install (for convenience on same device as your own PKI)
				          on linux
Then verify using
pip3 install awscli --upgrade [--user] [--break-system-packages ]
aws --version
183
TIP : You may run directly CLI commands from AWS Academy Lab Terminal or from CloudShell (accessible via AWS console bar)
AWS CLI – Configuring access credentials
CLI requires an Access Key
Create a CLI user (‘CLIAdministrator’) from IAM console
Select access type « programmatic access » to create an access key
Set to group Administrators
Note access key ID and key value after pressing Create User button!
Start aws configure from shell on your machine
aws configure 
AWS Access Key ID [None]: AKIAI44QH8DHBEXAMPLE 
AWS Secret Access Key [None]: MtGbClwBF/2Zp9Utk/h3EXAMPLEKEY 
Default region name [None]: eu-west-1
Default output format [None]: text                 (could be json)
184
ONLY
AWS CLI – Configuring access credentials
CLI requires an Access Key
It has already been created for you with your AWS educate account
Log to AWS educate, Go to classroom, click account Details then Show
Copy content and paste it in 
[Linux/macOS/Unix]  ~/.aws/credentials
[Windows] C:\Users\USERNAME\.aws\credentials
Start aws configure from shell on your machine, add region & text format
[default]
aws_access_key_id=ASIAYYTWKTQGWBJLZEJ3
aws_secret_access_key=0Av/rqKzGxxxxxxxxxxxxxiAfAdb
aws_session_token=FwoGZXIvYXdzEF….. Zyjxg==
185
ONLY
AWS CLI – Configuring access credentials
CLI requires an Access Key
It has already been created for you with your AWS academy account
Log to AWS academy, Go to Courses, select Learner Lab, click Modules and open Lab click Student Access, start Lab and finally i AWS Details then Show
Copy content and paste it in 
[Linux/macOS/Unix]  ~/.aws/credentials
[Windows] C:\Users\USERNAME\.aws\credentials
Start aws configure from shell on your machine, add region & text format
							Just press enter for the Key ID and Secret 							as they are already set
[default]
aws_access_key_id=ASIAYYTWKTQGWBJLZEJ3
aws_secret_access_key=0Av/rqKzGxxxxxxxxxxxxxiAfAdb
aws_session_token=FwoGZXIvYXdzEF….. Zyjxg==
186
ONLY
AWS CLI
General command format:
	aws <command> <subcommand> [options and parameters]
	Examples:
	aws iot describe-endpoint
	aws iot list-things
	aws iot list-certificates
	aws iot list-thing-groups
	aws iam list-users
	aws iot create-thing-group --thing-group-name testgroup
	aws iot delete-thing-group --thing-group-name testgroup
 	Help:
		aws <command> help 		aws <command> <subcommand> help
187
Online Help on CLI IoT commands:
	https://docs.aws.amazon.com/cli/latest/reference/iot/index.html#cli-aws-iot 
As soon as you start playing with CLI, expect some desync in Management console!
AWS – PKI & CLI Project
We want to automate secure device production (1000s of devices are considered each month, but we’ll use 1 in our tests) as they can connect as soon as they are powered on. We will consider 3 scripts:
Automated Key & Cert generation with our internal PKI (use generateNewDeviceCert.sh)
Provisioning of AWS, as object may connect directly once powered on
Test new thing can connect (use testNewDeviceConnectionPub.sh)
Start step by step using CLI:
Create thing with name (RPIxxx), RPI type and part of LED group
Provision & activate certificate
Bind certificate to policy ‘All’
Bind certificate to thing 
Note: We do not want to use bulk provisioning
188
AWS – PKI & CLI Project
Create thing with name (RPIxxx), set RPI type and assign to LED group
Provision & activate certificate
Bind certificate to policy ‘All’
Bind certificate to thing 
Tips: To register a certificate and extract its arn : (ensure aws configure output is set to text)
189
Some useful CLI commands:
aws iot create-thing --thing-name XXXX
aws iot register-certificate --certificate-pem file://FileName --status state
aws iot attach-policy --policy-name policyname --target CertARN
aws iot attach-thing-principal --thing-name XXXX --principal CertARN
aws iot update-thing --thing-name XXXX --thing-type-name YYY
aws iot add-thing-to-thing-group --thing-name XXXX --thing-group-name YYY
result=`(aws iot register-certificate --certificate-pem file://$THING_NAME.crt --status ACTIVE)`
#result is like   arn<space>id
read -ra arr <<<"$result"
CERTIFICATE_ARN=${arr[0]}
echo    The cert arn is : $CERTIFICATE_ARN
AWS – PKI & CLI Project tips
You may need for your tests to create a cleaning shell with:
To find certificate ID (the string after ‘/’ in ARN ):						
190
IFS='/' read -ra arr <<<"$CERTIFICATE_ARN"
CERTIFICATE_ID=${arr[1]}
Some useful CLI commands:
aws iot detach-thing-principal --thing-name $THING_NAME  --principal $CERTIFICATE_ARN
aws iot delete-thing --thing-name $THING_NAME
aws iot detach-principal-policy --policy-name $POLICY_NAME --principal $CERTIFICATE_ARN
aws iot update-certificate --new-status INACTIVE –certificate-id $CERTIFICATE_ID
aws iot delete-certificate --certificate-id $CERTIFICATE_ID
AWS – PKI & CLI Project solution
191
THING_NAME=$1
THING_GROUP_NAME=LED
THING_TYPE_NAME=RPI
POLICY_NAME=All
# create a thing in the thing registry
echo - Creating Thing $THING_NAME
aws iot create-thing --thing-name $THING_NAME
# upload and activate cert
echo - Uploading and activating thing certificate $THING_NAME.crt
result=`(aws iot register-certificate --certificate-pem file://$THING_NAME.crt --status ACTIVE)`
#result is like "arn:aws:iot:eu-west-1:474127109425:cert/d4d62bccadcdf3a8622ad2a7e77d3cb6ad3eff0a6799bbb53d3ffa1f4e8cec2d                       d4d62bccadcdf3a8622ad2a7e77d3cb6ad3eff0a6799bbb53d3ffa1f4e8cec2d"
read -ra arr <<<"$result"
CERTIFICATE_ARN=${arr[0]}
echo    The cert arn is : $CERTIFICATE_ARN
# attach the policy to the certificate
echo - Attaching policy to certificate
aws iot attach-policy --policy-name $POLICY_NAME  --target $CERTIFICATE_ARN
# attach the certificate to the thing
echo - Attaching thing to certificate
aws iot attach-thing-principal --thing-name $THING_NAME  --principal $CERTIFICATE_ARN
#set type
echo - Setting thing type
aws iot update-thing --thing-name $THING_NAME --thing-type-name $THING_TYPE_NAME
#set group
echo - Setting thing group
aws iot add-thing-to-thing-group --thing-group-name $THING_GROUP_NAME --thing-name $THING_NAME
echo "Done !"
CLIProv.sh   ThingName
Usage : 1) generateNewDeviceCert.sh NewThingName
2) CLIProv.sh NewThingName
3) testNewDeviceConnectionPub.sh NewThingName
4) CLIClean.sh ThingName CertificateARN
Notes : 1) CA must be provisioned
2) Group LED must exist
3) Type RPI must exist
4) Policy All must exist
AWS – PKI & CLI Project solution
192
THING_NAME=$1
#ex : RPI101
CERTIFICATE_ARN=$2
#ex : arn:aws:iot:eu-west-1:474127109425:cert/d4d62bccadcdf3a8622ad2a7e77d3cb6ad3eff0a6799bbb53d3ffa1f4e8cec2d
POLICY_NAME=All
IFS='/' read -ra arr <<<"$CERTIFICATE_ARN"
CERTIFICATE_ID=${arr[1]}
echo - Detaching certificate from thing
aws iot detach-thing-principal --thing-name $THING_NAME --principal $CERTIFICATE_ARN
echo - Deleting thing
aws iot delete-thing --thing-name $THING_NAME
echo - Detaching policy from certificate
aws iot detach-principal-policy --policy-name $POLICY_NAME --principal $CERTIFICATE_ARN
echo - Setting certificate to INACTIVE
aws iot update-certificate --new-status INACTIVE --certificate-id $CERTIFICATE_ID
echo - Deleting certificate
aws iot delete-certificate --certificate-id $CERTIFICATE_ID
echo "Done !"
CLIclean.sh  ThingName   CertARN
AWS Lambda – Event driven compute, quick intro
A mean to run your code in the cloud
Node.js, Python, Ruby, java, Go, .NET
With built-in 
auto scaling 
HA
Logging & monitoring
Without managing servers
Triggered on events
Change on data
Incoming requests (HTTP, MQTT)
[System] events
Pricing on compute time only 
193
Write, test, and view execution results in console online editor 
Access AWS Services - Lambda
JITP and JITR: alternative provisioning models
Connecting production to internet is often forbidden or impractical: JITP (Just In Time Provisioning) and JITR (Just In Time Registration) can be used to avoid pre-provisioning of device certificates in AWS:
OEM injects device certificates in factory
Devices are deployed and connect to AWS for the first time
AWS extracts & validates the device certificate and finds associated AWS OEM account
AWS registers the certificate in AWS OEM account (not activated)
OEM AWS JITP or JITR process handles the final device registration and activation steps
Pre-requisites
Devices have a full-chain certificate
OEM CA certificate has auto-registration enabled
194
JITP and JITR: alternative provisioning models
JITP: Just In Time Provisioning
              Own CA and Provisioning Template required
                1.Device connects to AWS IoT, device certificate gets registered (inactive)
                2.JITP provisions device according to the provisioning template
JITR: Just In Time Registration
                 Own CA is required
                  1.Device connects to AWS IoT, device certificate gets registered (inactive)
                  2.AWS IoT publishes message on topic $aws/events/certificates/registered/ 
                  3.AWS IoT Rule (to be created) is invoked and triggers a lambda (to be created) 	   4.Lambda provisions device (create thing, attach policy & thing, activate cert)
                     + Other actions may be done (e.g. authorization workflow, late provisioning, 	       email notifications sent to admin…)
195
JITR project - Intro 
Understanding the AWS built-in triggering mechanisms: 
0) Launch IoT Core test module and subscribe to system topic $aws/events/certificates/registered/+
1) Generate a new device certificate with generateNewDeviceCert.sh script
2) Ensure testNewDeviceConnectionPub.sh uses full chain device certificate 
	($1full.cert instead of $1.cert)
3) Connect to AWS with the newly generated cert using testNewDeviceConnectionPub.sh
4) Check (& save) system notification is sent by AWS on system topic 
	$aws/events/certificates/registered/<caCertificateID>
5) Check certificates registry for a new cert in PENDING_ACTIVATION state
6) Note there is no new thing listed
Notes : 
Auto-registration must be enabled on OEM CA certificate
You must use a full chain certificate on the client side (containing the root CA) as AWS can find your AWS account more easily
Device will be disconnected until someone activates the certificate…
196
JITR project - Goal
You will now automatically onboard new devices with JITR mechanism
Catch system events of new connecting devices in a ‘JITR’ rule and trigger a lambda execution with event content
Write the python lambda ‘JITRLambda’ handling it and assign enough privileges to its associated role
Create a thing
Bind thing to certificate 
Bind ‘PublishSubscribe’ policy to certificate
Activate certificate
Bonus : Use certificate CN as thing name
197
Click Use an existing role
Pick LabRole
Create a default lambda function 
Go to Services / Lambda / Functions
Click Create function
Author from scratch
Function Name : JITRLambda
Runtime : python 3.9
Note the role name at the bottom of the section ‘Change default execution role’: 	JITRLambda-role-xxxxxxxx
Click Create function again
JITR project – Solution part 1
198
Create [IoT Core / Message routing /] Rule to catch system events related to new incoming JITR certificates
Name : JITR
Description : Autoenroll new devices & notify admin
Query statement : SELECT * FROM '$aws/events/certificates/registered/+'
Rule Action : select Lambda
Configure action
Select JITRLambda  
Click Next & Create
Note : you may add WHERE certificateStatus = "PENDING_ACTIVATION" 
JITR project – Solution part 2
199
Return to services / Lambda / Functions / JITRLambda
Verify Lamdba execution is triggered by the rule
Edit lambda to add a log entry (Mind the save         /                  button)
Try a connection from RPI with a non activated certificate (RPI02b)
./testNewDeviceConnectionPub.sh RPI02b
Click Monitor then View logs in cloudwatch
Verify you see your traces in first stream
JITR project – Solution part 3
200
Create a test case with event data to develop your lambda
Click Test Tab
Click Test button to execute it and check logs in Execution result / details
JITR project – Solution part 4
201
Tick create new test event
Name : JITRRPI01b
Template hello-world
Paste JSON system event content you saved previously
Click save changes
Configure Lamdba execution role and policies to authorize IoT operations
Click Configuration tab then Execution role, and JITRLambda-role-xxxxx
In IAM, click Add inline Policy then JSON Tab
Paste following code
Click Review policy
Enter Policy name : JITRLambdaPolicy
Click Create policy
JITR project – Solution part 5
202
{    "Version": "2012-10-17",   
     "Statement": [        
	{            
	"Effect": "Allow",            
	"Action": [    "iot:CreateThing",                
		"iot:AddThingToThingGroup",                
		"iot:AttachThingPrincipal",                
		"iot:AttachPolicy",                
		"iot:UpdateCertificate",                
		"iot:CreatePolicy",                
		"iot:AttachPrincipalPolicy",                
		"iot:DescribeCertificate"            ],            
	"Resource": "*"        
	} 
        ]
}
JITRLambdaPolicy.txt
JITR project – Solution part 6 
203
The lambda…
import boto3
import logging
# configure logging once
logging.basicConfig(format='%(asctime)s %(levelname)s: %(message)s')
logger = logging.getLogger()
logger.setLevel(logging.INFO)
def lambda_handler(event, context):
    print("JITRLambda triggered"+str(event))
    certificate_id=event['certificateId']
    thing_name=certificate_id
    thing_type='RPI'
    thing_group='LED'
    policy_name='PublishSubscribe'
    iot = boto3.client('iot')
    try:
        response = iot.create_thing(thingName=thing_name,
                                    thingTypeName=thing_type)
        logger.info("create_thing: response: {}".format(response))
        response = iot.add_thing_to_thing_group(thingGroupName=thing_group,
                                                thingName=thing_name)
        logger.info("add_thing_to_thing_group: response: {}".format(response))
        response = iot.describe_certificate(certificateId=certificate_id)
        certificate_arn = response['certificateDescription']['certificateArn']
        logger.info("certificate_arn: {}".format(certificate_arn))
        response = iot.attach_thing_principal( thingName=thing_name,
                                                principal=certificate_arn )
        logger.info("attach_thing_principal: response: {}".format(response))
        response = iot.attach_policy( policyName=policy_name,
                                      target=certificate_arn )
        logger.info("attach_policyAndThing: response: {}".format(response))
        response = iot.update_certificate(  certificateId=certificate_id,
                                            newStatus='ACTIVE'        )
        logger.info("update_certificate: response: {}".format(response))
    except Exception as e:
        logger.error("JITRLambda error: {}".format(e))
    return True
The real interesting part to come
JITRLambda.py
JITR project – Solution part 6 cont. 
204
The lambda…
JITR project – Solution validation
Start over from RPI
A new thing with certificate name must be created, bound to the cert
Certificate must be active and associated to policy
      OK
      ?!!
Hint : Attaching ‘All’ policy to certificate would make it work… 
Why ? 
What else could be done?
205
#
# Handle JITR event
#   Extract CN from new certificate
#   Create new Thing with name=certificate CN
#   Attach new thing to new certificate
#   Attach policy to new certificate
#   Activate new certificate
import boto3    # AWS services client
import os       # for CN extraction only
import ssl      # for CN extraction only
import logging
# configure logging once
logging.basicConfig(format='%(asctime)s %(levelname)s: %(message)s')
logger = logging.getLogger()
logger.setLevel(logging.INFO)
#
#create a thing with given name, type, group
def create_thing(iot, thing_name,thing_type,thing_group):
    try:
        response = iot.create_thing(thingName=thing_name,thingTypeName=thing_type)
        logger.info("create_thing: response: {}".format(response))
        response = iot.add_thing_to_thing_group(
                thingGroupName=thing_group,
                thingName=thing_name
        )
        logger.info("add_thing_to_thing_group: response: {}".format(response))
    except Exception as e:
        logger.error("create_thing: {}".format(e))
#
# activate certificate based on its ID
def activate_certificate(iot, certificate_id):
    try:
        response = iot.update_certificate(
            certificateId=certificate_id,
            newStatus='ACTIVE'
        )
        logger.info("activate_certificate: response: {}".format(response))
    except Exception as e:
        logger.error("activate_certificate: {}".format(e))
#
# attach a policy and thing identified by their names to a certificate identified by its ID
def attach_policyAndThing(iot,certificate_id,policy_name,thing_name):
    try:
        response = iot.describe_certificate(certificateId=certificate_id)
        certificate_arn = response['certificateDescription']['certificateArn']
        logger.info("certificate_arn: {}".format(certificate_arn))
        response = iot.attach_thing_principal(
            thingName=thing_name,
            principal=certificate_arn
        )
        logger.info("attach_thing_principal: response: {}".format(response))
        response = iot.attach_policy(
            policyName=policy_name,
            target=certificate_arn
        )
        logger.info("attach_policyAndThing: response: {}".format(response))
    except Exception as e:
        logger.error("attach_policyAndThing: {}".format(e))
#
# extract and return CN from a certificate whose ID is provided
def extractCN(iot, certificate_id):
    tempCertFilePath="/tmp/"+certificate_id+".pem"
    try:
        response = iot.describe_certificate(certificateId=certificate_id)
        logger.info("describe_certificate: response: {}".format(response))
        #Undocumented ssl._ssl exposes a method to parse PEM certs but from file... lets's save our PEM buffer in /tmp first 
        tempCertFile = open(tempCertFilePath,"w") 
        tempCertFile.write(response['certificateDescription']['certificatePem'])
        tempCertFile.close()
        #then ask for pem file parsing
        cert_dict = ssl._ssl._test_decode_cert(tempCertFilePath)
        #logger.info("cert decode: {}".format(cert_dict))
        # typical cert decode: {'subject': ((('commonName', 'RPI5'),),), 'issuer': ((('countryName', 'FR'),), (('stateOrProvinceName', 'Some-State'),), (('organizationName', 'MyRPIFactory'),), (('commonName', 'MyRPIFactory'),)), 'version': 1, 'serialNumber': '408334F7E85D04F4B3B46F9FC8A7DE84CD69854B', 'notBefore': 'Mar  1 17:24:16 2020 GMT', 'notAfter': 'Mar  1 17:24:16 2021 GMT'}
        subject=cert_dict['subject']
        #logger.info("subject: "+str(subject))
        # typical subject possible content: 
        #    'subject': ((('businessCategory', 'Private Organization'),),
        #                (('jurisdictionCountryName', 'US'),),
        #                (('jurisdictionStateOrProvinceName', 'California'),),
        #                (('serialNumber', 'C3268102'),),
        #                (('countryName', 'US'),),
        #                (('stateOrProvinceName', 'California'),),
        #                (('localityName', 'San Francisco'),),
        #                (('organizationName', 'GitHub, Inc.'),),
        #                (('commonName', 'github.com'),)
        #               ),
        for attr in subject:
            print('attr:'+str(attr))
            if attr[0][0]=='commonName':
                CN=attr[0][1]
                break;
        logger.info("extracted CN: "+CN)
    except Exception as e:
        logger.error("extractCN: {}".format(e))
    #cleanup
    os.unlink(tempCertFilePath)
    return CN
#MAIN lambda entry point
#   New thing to register triggers this lambda with following kind of event : 
#   {'certificateId': '9bb01c2490b902677f28459ce453f7396f310b99a6ca1deb354e1e480afcee15', 
#    'caCertificateId': 'e8c029776411d8535af07f6bcb2731262c7da50deb50a2ba5df5dc730f00f26c', 
#    'timestamp': 1583101612138, 
#    'certificateStatus': 'PENDING_ACTIVATION', 
#    'awsAccountId': '602617322509', 
#    'certificateRegistrationTimestamp': '1583083478752'
#   }
#
def lambda_handler(event, context):
    logger.info("event:\n" + str(event))
    logger.info("certificate_id: " + event['certificateId'])
    logger.info("certificate_status: " + event['certificateStatus'])
    iot = boto3.client('iot')
    CN=extractCN(iot,event['certificateId'])
    create_thing(iot, thing_name=CN,thing_type='RPI',thing_group='LED')
    attach_policyAndThing(iot, event['certificateId'],'PublishSubscribe',CN)
    activate_certificate(iot, event['certificateId'])
    return True
JITR project – Final Solution
Add Lambda CN extraction
206
JITRLambdaFinal.py
207
[Own]PKI & AWS IoT : was it that hard ?
208
[Own]PKI & AWS IoT : was it that hard ?
209
[Own]PKI & AWS IoT : was it that hard ?
210
[Own]PKI & AWS IoT : was it that hard ?
Focus on connected vehicles
Jusqu’à 100 contrôleurs intégrés
211
Future is connected
Remote start/stop
Remote diagnoses
« Keyless » car sharing & car rental
Parcell delivery in vehicle’s trunk
Search, book and pay parking 
Behavioural insurance rates
2030(?): Full autonomous cars
Turn back driver to consumer (again)!
Technology has some limits
Lots of components
Remote updates from multiple vendors
More code = more bugs & vulnerabilities
V2V Communication
V2I  Communication
V2X More networks = larger attack surface
Focus on connected vehicles
Jusqu’à 100 contrôleurs intégrés
212
Driving assistance is not autonomy
Speed controls
Lane assist
Emergency breaking
…
 vehicle can drive itself but still relies on the driver to ensure safety!
2022
2025
2030+
Focus on Connected vehicles
213
Up to 100 controllers (ECUs) connected on various buses
Lights control, door opening… 
Trajectory controls, obstacle detection…
With more and more complex function
Automatic parking, anticipated emergency braking, autonomy to safe parking…
Sleep detection, liveness detection… 
CAN-bus (Controller Area Network-bus)
Used in the industrial, automotive and aviation sectors 
Extensive error checking, flexible implementation and built-in redundancy.
	Cars, elevators, aircraft, robotics and other systems all use CAN-bus because of its ability 	to operate with one very long pair of wires and hundreds of separate modules reliably
214
Data frame format is proprietary, except for diagnostics
CAN bus in a vehicle is typically accessed via the OBD2 port 
	standardized connector that, as mandated by law, has been a 	requirement in all consumer vehicles since 2006 and in most since 	1999, in Europe and the US. 
Authentication anyone ?
215
Other automotive buses
Internal car topology is getting much more complex: mix of star network, high speed backbone, and more local buses
Gateways are interconnecting these sub networks
TSN - Time Sensitive Network
Tesla complete hack example
Car is looking for some predetermined SSIDs, one ‘Tesla Guest’…
Ref: https://www.blackhat.com/docs/us-17/thursday/us-17-Nie-Free-Fall-Hacking-Tesla-From-Wireless-To-CAN-Bus-wp.pdf
216
CID 	: Center Information Display
IC 	: Instrument Cluster
Gateway 	: handling external coms
Parrot 	: Bluetooth…


Impact was high due to series of badly designed things & non-patched public CVEs exploited by attacker. 
Now much more secure, thanks to the remote update capability (10days fix!)
Approaches to securing internal car network
Due to time and performance constraints, hybrid models must be considered
Controller Authentication
MCU with OEM certificate
GW as verifying point (trust store)
GW issuing symmetric bus group keys
Exchanges encryption
PKI to secure symmetric encryption keys distribution
Periodic key rotation
Firewalling
Controllers certificates may contain authorizations to leave subnet
217
Keyfob – Cryptanalysis hack
Tesla Model S keyfob sends an encrypted code based on a secret cryptographic keyto car passive entry system (from Pektron)
	unlock and disable immobilizer, allowing engine to start, …
Source : https://www.wired.com/story/hackers-steal-tesla-model-s-seconds-key-fob/
218
Gaining two codes from any given key fob, cryptographic key can be brute- forced until key is found in “reasonable time”
!! Happens to use weak 40-bit cipher to encrypt these codes
With 6-terabyte table of pre-computed keys  1.6 seconds keyfob hack!
KU Leuven researcher Tomer Ashur : "Someone screwed up. Epically.“
Now recommended to users to activate in-car PIN code to start vehicle
Keyfob – Relay attack
What's the best anti-theft protection of a tesla? 
(same on VW but less funny videos)
219
The charging cable!
Sneak around 15"
searching for the fob signal 35"
unplug 1'40"!
Note the roof and doorbell cameras souvenirs…
Ref : https://www.theverge.com/2018/10/22/18008514/tesla-model-s-stolen-key-fob-hack-watch-video 
Phase #4
Let’s add voice control to our smart lamp!
220
Alexa – Smart lamp use case
Alexa will allow us to voice-control the LED
«Alexa, tell my PI to turn on the light » 
We’ll use https://developer.amazon.com 
To develop
To test on an Alexa device emulator
You need to use your amazon developer account (not AWS, the shopping one ;-)
221
Alexa, tell my pi to turn on the light
Alexa - Introduction 
Terminology
AVS
ASK Skills / Custom skills / store
Invocation name & phrase
"Open, Launch, Start, Tell, Ask" are the invocation keywords to trigger a skill and call the LaunchRequest intent, and create a session. To invoke custom Intent using launch phrase utterance should be like “Alexa, launch wise parrot and tell me about Indian music""Ask XXX to YYY" invocation phrases are used to invoke custom intent YYY while launching the skill XXX.In French : “Ouvre / Demarre / Lance / Demande à” Skill name
Intents
Utterances
Slots
Session
Cards
Accessible in many devices, including Echo, Echo Dot, Show, Mobile …
222
Alexa – Smart lamp architecture
223
Alexa, tell my pi to turn on the light
We’ll need:
A custom alexa skill describing the user interactions and firing intents
A serverless Lambda function hosted on AWS to handle skill’s intents and implement the logic
We’ll leverage our existing MQTT remote LED control protocol
Alexa – Creating the custom Skill 
Log to https://developer.amazon.com with your developper account
Select Alexa, then create Alexa Skills, and console :
Create a new skill
Name : LEDControlSkill
Locale : English
Click Next
Select Other type & Custom model
Click Provision your own
Click Next
Choose Start from scratch
Click Next
Click Create Skill
224
Alexa – Skill invocation
Specify an invocation name : « Alexa, tell INVOCATION_NAME to turn on the light »
	Enter : « my pi » (could be « light control »…)
Click on CUSTOM menu anytime to return to this screen…
225
Alexa – Custom skill intent
We want to support “turn the light ON” command
Open Interaction Model then Intents
Notice the built-in intents on the left
Add a custom intent 
	« TurnTheLight » 
Give some invocation examples (utterances)
	Using Slots as “variables” : {LEDState}
E.g.: 	Turn the light {LEDState}
and	Turn {LEDState} the light
Confirm each new slot creation
226
Alexa – Slots & slots types
Create a custom slot type, i.e. a “variable type”
	Click Slot Types then Add
	Name : LEDSTATETYPE 
And possible slot type values 
	on
	off
Then go back to the TurnTheLight intent &specify the LEDState slot type
(Note the possible complex types!)
Save & Build the model
227
Alexa – Slots options
You may force the slot to be « present » (i.e. user must give a value)
And plan for Alexa to prompt user, should the value be missing:
228
Alexa – Testing the utterances
229
Build the skill and click Test, then set it to development
Note : Test cases for our future lambda may be captured here…
Alexa – Finding your custom skill ID
We’ll need the skill ID to authorize it calling a lambda function in AWS
Return to ‘your skills’ and note the LEDControlSkill skill ID
230
Go to AWS Lambda service (aws.amazon.com) & Create a function
Name : LambdaForAlexaRPI
Select Node.js 22.x
Select Create a new role from AWS policy template
Enter role name : RoleLambdaForAlexaRPI
Create function
Select Add trigger in overview section: Alexa Skills Kit
Enter your Alexa skill ID
	        amzn1.ask.skill.85b6422c-47d2-4aa4-b25b-c441fe163f76
Click add, then save
Click on Lambda name and Code tab
Edit lambda code below (index.mjs)
Note: be sure to select one of the following regions in AWS:
Asia Pacific (Tokyo)
EU (Ireland)
US East (N. Virginia)
US West (Oregon)
Otherwise symptoms are: cannot create skill with arn of lambda in amazon, and cannot declare alexa skills kit as trigger for lambda in aws
231
Alexa - Creating an AWS Lambda to react to intents
Click Use an existing role
Pick LabRole
Alexa- AWS lambda content
To simplify first test, copy content of file:
LambdaForAlexaRPI.mjs
It contains a handler (turnTheLightInSession) for our custom TurnTheLight Alexa intent and few other Alexa default intents handlers
Then paste content in the inline code editing (overwrite existing one)
Update MQTT Topic with your RPI name 
Click Deploy!
Reminder: your endpoint can be found in IoT Core / Settings
232
'use strict';
/*
 * This sample demonstrates a simple skill built with the Amazon Alexa Skills Kit.
 * The Intent Schema, Custom Slots, and Sample Utterances for this skill, as well as
 * testing instructions are located at http://amzn.to/1LzFrj6
 *
 * For additional samples, visit the Alexa Skills Kit Getting Started guide at
 * http://amzn.to/1LGWsLG
 * 
 * NEW VERSION FOR NODEJS 18+
 */
//##### MQTT endpoint and topic settings
import { IoTDataPlaneClient, PublishCommand } from "@aws-sdk/client-iot-data-plane";
const client = new IoTDataPlaneClient({ region: 'us-east-1' });
const mqttTopic= "RPI/RPI1/MyLEDCommand";  // update the topic!
//##### end MQTT endpoint and topic settings
// --------------- Helpers that build all of the responses -----------------------
function buildSpeechletResponse(title, output, repromptText, shouldEndSession) {
    return {
        outputSpeech: {
            type: 'PlainText',
            text: output,
        },
        card: {
            type: 'Simple',
            title: "My Pi - " + title,
            content: output,
        },
        reprompt: {
            outputSpeech: {
                type: 'PlainText',
                text: repromptText,
            },
        },
        shouldEndSession: shouldEndSession
    };
}
function buildResponse(sessionAttributes, speechletResponse) {
    return {
        version: '1.0',
        sessionAttributes,
        response: speechletResponse,
    };
}
// --------------- Functions that control the skill's behavior -----------------------
function getWelcomeResponse(callback) {
    // If we wanted to initialize the session to have some attributes we could add those here.
    const sessionAttributes = {};
    const cardTitle = 'Welcome';
    const speechOutput = "Welcome to My Pi. How can I help you?";
    // If the user either does not reply to the welcome message or says something that is not
    // understood, they will be prompted again with this text.
    const repromptText = "How can I help you?";
    const shouldEndSession = false;
    callback(sessionAttributes,
        buildSpeechletResponse(cardTitle, speechOutput, repromptText, shouldEndSession));
}
function handleSessionEndRequest(callback) {
    const cardTitle = 'Session Ended';
    const speechOutput = 'Thank you for trying My Pi. Have a nice day!';
    // Setting this to true ends the session and exits the skill.
    const shouldEndSession = true;
    callback({}, buildSpeechletResponse(cardTitle, speechOutput, null, shouldEndSession));
}
function createLEDStateAttributes(ledState) {
    return {
        LEDState: ledState
    };
}
/**
 * Control Light in the session and prepares the speech to reply to the user.
 */
async function turnTheLightInSession(intent, session, callback) {
    const cardTitle = "My Pi";
    const LEDStateRequest = intent.slots.LEDState;
    let repromptText = '';
    let sessionAttributes = {};
    const shouldEndSession = false;
    let speechOutput = '';
    console.log(">>turnTheLightInSession !");
    if (LEDStateRequest) {
        console.log(">>LEDState slot found !");
        var LEDState = LEDStateRequest.value;
        console.log(">>LEDState value:"+LEDState);
        var mqttpayload="";
        if (LEDState=="on")
                    mqttpayload= "LED_ON";
        else
                    mqttpayload="LED_OFF";
        const publishCommand = new PublishCommand({
            topic : mqttTopic,
            payload: mqttpayload,
            qos: 0,
            });  
        try {
        const data = await client.send(publishCommand);
        console.log(data);
        sessionAttributes = createLEDStateAttributes(LEDState);
                    speechOutput = "Ok, turning the light " + LEDState;
                    repromptText = "Ok, turning the light " + LEDState;
                    callback(sessionAttributes,buildSpeechletResponse(cardTitle, speechOutput, repromptText, shouldEndSession));  
        } catch (error) {
        console.error(error);
        speechOutput = "Sorry there is a problem. Bye" ;
                    repromptText = "Sorry there is a problem. Bye" ;
                    callback(null,buildSpeechletResponse(cardTitle, speechOutput, repromptText, true));
        }
    }
    else
    {
        speechOutput = "Please try again";
        repromptText = "Please try again";
        callback(sessionAttributes,buildSpeechletResponse(cardTitle, speechOutput, repromptText, shouldEndSession));
    }
}
// --------------- Events -----------------------
/**
 * Called when the session starts.
 */
function onSessionStarted(sessionStartedRequest, session) {
    console.log("onSessionStarted requestId=${sessionStartedRequest.requestId}, sessionId=${session.sessionId}");
}
/**
 * Called when the user launches the skill without specifying what they want.
 */
function onLaunch(launchRequest, session, callback) {
    console.log("onLaunch requestId=${launchRequest.requestId}, sessionId=${session.sessionId}");
    // Dispatch to your skill's launch.
    getWelcomeResponse(callback);
}
/**
 * Called when the user specifies an intent for this skill.
 */
async function onIntent(intentRequest, session, callback) {
    console.log("onIntent requestId=${intentRequest.requestId}, sessionId=${session.sessionId}");
    const intent = intentRequest.intent;
    const intentName = intentRequest.intent.name;
    // Dispatch to your skill's intent handlers
    if (intentName === 'TurnTheLight') {
        try {
            const data = await turnTheLightInSession(intent, session, callback);
            console.log(data);
          } catch (error) {
             console.error(error);
        } 
    } 
    else if (intentName === 'AMAZON.HelpIntent') {
        getWelcomeResponse(callback);
    } else if (intentName === 'AMAZON.StopIntent' || intentName === 'AMAZON.CancelIntent') {
        handleSessionEndRequest(callback);
    } else {
        throw new Error('Invalid intent');
    }
}
/**
 * Called when the user ends the session.
 * Is not called when the skill returns shouldEndSession=true.
 */
function onSessionEnded(sessionEndedRequest, session) {
    console.log("onSessionEnded requestId=${sessionEndedRequest.requestId}, sessionId=${session.sessionId}");
    // Add cleanup logic here
}
// --------------- Main handler -----------------------
// Route the incoming request based on type (LaunchRequest, IntentRequest,
// etc.) The JSON body of the request is provided in the event parameter.
export const handler = async (event,context) => {
    try {
        console.log("event.session.application.applicationId=${event.session.application.applicationId}");
        /**
         * Uncomment this if statement and populate with your skill's application ID to
         * prevent someone else from configuring a skill that sends requests to this function.
         */
        /*
        if (event.session.application.applicationId !== 'amzn1.echo-sdk-ams.app.[unique-value-here]') {
             context.fail("Invalid Application ID");
        }
        */
        if (event.session.new) {
            onSessionStarted({ requestId: event.request.requestId }, event.session);
        }
        if (event.request.type === 'LaunchRequest') {
            onLaunch(event.request,
                event.session,
                function callback(sessionAttributes, speechletResponse) {
                    context.succeed(buildResponse(sessionAttributes, speechletResponse));
                });
        } else if (event.request.type === 'IntentRequest') {
            await onIntent(event.request,
                event.session,
                function callback(sessionAttributes, speechletResponse) {
                    context.succeed(buildResponse(sessionAttributes, speechletResponse));
                });
        } else if (event.request.type === 'SessionEndedRequest') {
            onSessionEnded(event.request, event.session);
            context.succeed();
        }
    } catch (e) {
        context.fail("Exception: " + e);
    }
};
LambdaForAlexaRPI.js
'use strict';
/**
 * This sample demonstrates a simple skill built with the Amazon Alexa Skills Kit.
 * The Intent Schema, Custom Slots, and Sample Utterances for this skill, as well as
 * testing instructions are located at http://amzn.to/1LzFrj6
 *
 * For additional samples, visit the Alexa Skills Kit Getting Started guide at
 * http://amzn.to/1LGWsLG
 */
//##### MQTT endpoint and topic settings
const AWS = require('aws-sdk');
const iotData = new AWS.IotData({ endpoint:  'a37nlvgzkylhiz-ats.iot.us-east-1.amazonaws.com'}); // update the endpoint!
const mqttTopic= "RPI/RPI1/MyLEDCommand";  // update the topic!
//##### end MQTT endpoint and topic settings
// --------------- Helpers that build all of the responses -----------------------
function buildSpeechletResponse(title, output, repromptText, shouldEndSession) {
    return {
        outputSpeech: {
            type: 'PlainText',
            text: output,
        },
        card: {
            type: 'Simple',
            title: "My Pi - " + title,
            content: output,
        },
        reprompt: {
            outputSpeech: {
                type: 'PlainText',
                text: repromptText,
            },
        },
        shouldEndSession: shouldEndSession
    };
}
function buildResponse(sessionAttributes, speechletResponse) {
    return {
        version: '1.0',
        sessionAttributes,
        response: speechletResponse,
    };
}
// --------------- Functions that control the skill's behavior -----------------------
function getWelcomeResponse(callback) {
    // If we wanted to initialize the session to have some attributes we could add those here.
    const sessionAttributes = {};
    const cardTitle = 'Welcome';
    const speechOutput = "Welcome to My Pi. How can I help you?";
    // If the user either does not reply to the welcome message or says something that is not
    // understood, they will be prompted again with this text.
    const repromptText = "How can I help you?";
    const shouldEndSession = false;
    callback(sessionAttributes,
        buildSpeechletResponse(cardTitle, speechOutput, repromptText, shouldEndSession));
}
function handleSessionEndRequest(callback) {
    const cardTitle = 'Session Ended';
    const speechOutput = 'Thank you for trying My Pi. Have a nice day!';
    // Setting this to true ends the session and exits the skill.
    const shouldEndSession = true;
    callback({}, buildSpeechletResponse(cardTitle, speechOutput, null, shouldEndSession));
}
function createLEDStateAttributes(ledState) {
    return {
        LEDState: ledState
    };
}
/**
 * Control Light in the session and prepares the speech to reply to the user.
 */
function turnTheLightInSession(intent, session, callback) {
    const cardTitle = "My Pi";
    const LEDStateRequest = intent.slots.LEDState;
    let repromptText = '';
    let sessionAttributes = {};
    const shouldEndSession = false;
    let speechOutput = '';
    console.log(">>turnTheLightInSession !");
    if (LEDStateRequest) {
        console.log(">>LEDState slot found !");
		var LEDState = LEDStateRequest.value;
		console.log(">>LEDState value:"+LEDState);
	    var mqttpayload="";
		if (LEDState=="on")
			    	mqttpayload= "LED_ON";
		else
			    	mqttpayload="LED_OFF";
        var params = {
            topic: mqttTopic, /* required */
            payload: mqttpayload,
            qos: 0
            };
        iotData.publish(params, function(err, data) {
              if (err) {
			  console.log(err, err.stack); // an error occurred
              speechOutput = "Sorry there is a problem. Bye" ;
            				repromptText = "Sorry there is a problem. Bye" ;
            				callback(null,buildSpeechletResponse(cardTitle, speechOutput, repromptText, true));}
			  else     {
                          console.log('Function called succesfully:', data);
            				sessionAttributes = createLEDStateAttributes(LEDState);
            				speechOutput = "Ok, turning the light " + LEDState;
            				repromptText = "Ok, turning the light " + LEDState;
            				callback(sessionAttributes,buildSpeechletResponse(cardTitle, speechOutput, repromptText, shouldEndSession));  }
            }
        );
	} else {
		speechOutput = "Please try again";
		repromptText = "Please try again";
		callback(sessionAttributes,buildSpeechletResponse(cardTitle, speechOutput, repromptText, shouldEndSession));
	}
}
// --------------- Events -----------------------
/**
 * Called when the session starts.
 */
function onSessionStarted(sessionStartedRequest, session) {
    console.log("onSessionStarted requestId=${sessionStartedRequest.requestId}, sessionId=${session.sessionId}");
}
/**
 * Called when the user launches the skill without specifying what they want.
 */
function onLaunch(launchRequest, session, callback) {
    console.log("onLaunch requestId=${launchRequest.requestId}, sessionId=${session.sessionId}");
    // Dispatch to your skill's launch.
    getWelcomeResponse(callback);
}
/**
 * Called when the user specifies an intent for this skill.
 */
function onIntent(intentRequest, session, callback) {
    console.log("onIntent requestId=${intentRequest.requestId}, sessionId=${session.sessionId}");
    const intent = intentRequest.intent;
    const intentName = intentRequest.intent.name;
    // Dispatch to your skill's intent handlers
    if (intentName === 'TurnTheLight') {
        turnTheLightInSession(intent, session, callback);
    } 
    else if (intentName === 'AMAZON.HelpIntent') {
        getWelcomeResponse(callback);
    } else if (intentName === 'AMAZON.StopIntent' || intentName === 'AMAZON.CancelIntent') {
        handleSessionEndRequest(callback);
    } else {
        throw new Error('Invalid intent');
    }
}
/**
 * Called when the user ends the session.
 * Is not called when the skill returns shouldEndSession=true.
 */
function onSessionEnded(sessionEndedRequest, session) {
    console.log("onSessionEnded requestId=${sessionEndedRequest.requestId}, sessionId=${session.sessionId}");
    // Add cleanup logic here
}
// --------------- Main handler -----------------------
// Route the incoming request based on type (LaunchRequest, IntentRequest,
// etc.) The JSON body of the request is provided in the event parameter.
exports.handler = (event, context) => {
    try {
        console.log("event.session.application.applicationId=${event.session.application.applicationId}");
        /**
         * Uncomment this if statement and populate with your skill's application ID to
         * prevent someone else from configuring a skill that sends requests to this function.
         */
        /*
        if (event.session.application.applicationId !== 'amzn1.echo-sdk-ams.app.[unique-value-here]') {
             context.fail("Invalid Application ID");
        }
        */
        if (event.session.new) {
            onSessionStarted({ requestId: event.request.requestId }, event.session);
        }
        if (event.request.type === 'LaunchRequest') {
            onLaunch(event.request,
                event.session,
                function callback(sessionAttributes, speechletResponse) {
					context.succeed(buildResponse(sessionAttributes, speechletResponse));
				});
        } else if (event.request.type === 'IntentRequest') {
            onIntent(event.request,
                event.session,
                function callback(sessionAttributes, speechletResponse) {
					context.succeed(buildResponse(sessionAttributes, speechletResponse));
				});
        } else if (event.request.type === 'SessionEndedRequest') {
            onSessionEnded(event.request, event.session);
            context.succeed();
        }
    } catch (e) {
        context.fail("Exception: " + e);
    }
};
NODE JS 16 LambdaForAlexaRPI.js
233
Alexa- AWS lambda content structure
LambdaForAlexaRPI
Async
Async
Handler(event,context)
Session new => could initialize session data
LaunchRequest => return welcome message
IntentRequest => handle a received skill’s Intent
SessionEndedRequest => should clean up session data
‘Returns’ Context.succeed(json response message)
234
Alexa- AWS lambda content structure
OnIntent(intent,session,callback)
Handle Built-in intents
	AMAZON.StopIntent
	AMAZON.HelpIntent
And our custom intent (the name we used in skill)
	 TurnTheLight 
Return voice feedback to handler
235
Alexa- AWS lambda content structure
turnTheLight(intent, session, callback)
Handle skill slot content
Issue MQTT commands
236
Alexa- AWS lambda content structure
Alexa- Editing the AWS lambda
Response speech to Alexa is a JSON msg
outputSpeech
card (see below json traces)
reprompt
And a flag to terminate session
237
Alexa- Adding AWS policy to our lambda role
Open IAM service, then roles
Search for role RoleLambdaForAlexaRPI and click on it
Click attach policy then create policy
Select service IoT
In Access level, expand write and tick connect & publish boxes
Click resources, tick All resources
Click Review policy
Fill policy name : LambdaPublishPolicy
Fill policy description « Allow publishing on any MQTT topic »
Click Create policy
Close the window and return to Role, refresh policies list and search for LambdaPublishPolicy
Select it and click Attach Policy
 Our LambdaForAlexaRPI may now send MQTT messages on any topic of our internal AWS MQTT broker
238
Alexa - Testing AWS lambda alone
Later-on you may copy a sample intent in Alexa dev console / Test
Type “ask my pi to turn on the light” and copy JSON input 1 content
Create test cases TurnTheLightON 
Paste this JSON requet
Ensure all your node red mqtt nodes are connecting to AWS broker endpoint successfully (and same topic/thing)
	Test and check input/output and logs/LED
You may click lambda monitoring & View logs in cloudwatch to analyse Lambda execution results
You may check MQTT events in IoT Core / Test
Create the TurnTheLightOFF test case
TestTurnTheLightON.json
{  "version": "1.0",  "session": {    "new": false,    "sessionId": "amzn1.echo-api.session.123456789012",    "application": {      "applicationId": "amzn1.ask.skill.987654321"    },    "attributes": {},    "user": {      "userId": "amzn1.ask.account.testUser"    }  },  "context": {    "AudioPlayer": {      "playerActivity": "IDLE"    },    "System": {      "application": {        "applicationId": "amzn1.ask.skill.987654321"      },      "user": {        "userId": "amzn1.ask.account.userId"      },      "device": {        "supportedInterfaces": {          "AudioPlayer": {}        }      }    }  },  "request": {    "type": "IntentRequest",    "requestId": "amzn1.echo-api.request.1234",    "timestamp": "2016-10-27T21:06:28Z",    "locale": "en-US",    "intent": {      "name": "TurnTheLight",      "slots": {        "LEDState": {          "name": "LEDState",          "value": "on"        }      }    }  }}
239
Linking AWS Lambda with Alexa Skill
When done with Lambda tests, copy the lambda ARN 
and set it to alexa custom skill endpoint in http://developer.amazon.com 
Click Save endpoints 
Build skill
240
Alexa - Testing our skill
Go back to alexa skill and Test it (set it to development if needed)
Type or say « [start] my pi », to start a session
Alexa should answer «  Welcome to My Pi. How can I help you? »
Type or say « Turn on the light » (needs to be in session)
Alexa should answer « ok turning the light on »
You may copy any json input messages and go back to lambda to create a new test case 
Notes: 
	- Alexa will try to match better utterance…even if completely different sometimes!
	- Hanging simulator 	  may be cause by CORS restrictions (try e.g. firefox portable)
241
Test with Alexa Mobile app
Install Amazon Alexa Android Application
Log in with your developer.amazon.com account
Click 	   and Speak… (e.g. “start My PI”…)
Notes :
Also works in Android emulators 
Select appropriate phone system language before starting app!! (English for now or wait next step…)
Manage registered devices on amazon.com/Account&lists/Content&devices/Devices
242
Test with your real Alexa device
Your Alexa device must be bound to your
	 developer.amazon.com account
Notes :
It’s probably in your native language
Create the equivalent skill language (see after)
Recreate your interactions / utterances / slots…
243
Alexa – 1st skill & lambda version
Skill
Lambda
LEDControlSkill.json
LambdaForAlexaRPI.js Node22+
{    "interactionModel": {        "languageModel": {            "invocationName": "my pi",            "intents": [                {                    "name": "AMAZON.CancelIntent",                    "samples": []                },                {                    "name": "AMAZON.HelpIntent",                    "samples": []                },                {                    "name": "AMAZON.StopIntent",                    "samples": []                },                {                    "name": "HelloWorldIntent",                    "slots": [],                    "samples": [                        "hello",                        "how are you",                        "say hi world",                        "say hi",                        "hi",                        "say hello world",                        "say hello"                    ]                },                {                    "name": "AMAZON.NavigateHomeIntent",                    "samples": []                },                {                    "name": "AMAZON.FallbackIntent",                    "samples": []                },                {                    "name": "TurnTheLight",                    "slots": [                        {                            "name": "LEDState",                            "type": "LEDSTATETYPE",                            "samples": [                                "{LEDState}"                            ]                        }                    ],                    "samples": [                        "turn {LEDState} the light",                        "turn the light {LEDState}"                    ]                }            ],            "types": [                {                    "name": "LEDSTATETYPE",                    "values": [                        {                            "name": {                                "value": "off"                            }                        },                        {                            "name": {                                "value": "on"                            }                        }                    ]                }            ]        },        "dialog": {            "intents": [                {                    "name": "TurnTheLight",                    "confirmationRequired": false,                    "prompts": {},                    "slots": [                        {                            "name": "LEDState",                            "type": "LEDSTATETYPE",                            "confirmationRequired": false,                            "elicitationRequired": true,                            "prompts": {                                "elicitation": "Elicit.Slot.479384117920.105510157651"                            }                        }                    ]                }            ],            "delegationStrategy": "ALWAYS"        },        "prompts": [            {                "id": "Elicit.Slot.479384117920.105510157651",                "variations": [                    {                        "type": "PlainText",                        "value": "please say on or off"                    }                ]            }        ]    }}
'use strict';
/*
 * This sample demonstrates a simple skill built with the Amazon Alexa Skills Kit.
 * The Intent Schema, Custom Slots, and Sample Utterances for this skill, as well as
 * testing instructions are located at http://amzn.to/1LzFrj6
 *
 * For additional samples, visit the Alexa Skills Kit Getting Started guide at
 * http://amzn.to/1LGWsLG
 * 
 * NEW VERSION FOR NODEJS 18+
 */
//##### MQTT endpoint and topic settings
import { IoTDataPlaneClient, PublishCommand } from "@aws-sdk/client-iot-data-plane";
const client = new IoTDataPlaneClient({ region: 'us-east-1' });
const mqttTopic= "RPI/RPI1/MyLEDCommand";  // update the topic!
//##### end MQTT endpoint and topic settings
// --------------- Helpers that build all of the responses -----------------------
function buildSpeechletResponse(title, output, repromptText, shouldEndSession) {
    return {
        outputSpeech: {
            type: 'PlainText',
            text: output,
        },
        card: {
            type: 'Simple',
            title: "My Pi - " + title,
            content: output,
        },
        reprompt: {
            outputSpeech: {
                type: 'PlainText',
                text: repromptText,
            },
        },
        shouldEndSession: shouldEndSession
    };
}
function buildResponse(sessionAttributes, speechletResponse) {
    return {
        version: '1.0',
        sessionAttributes,
        response: speechletResponse,
    };
}
// --------------- Functions that control the skill's behavior -----------------------
function getWelcomeResponse(callback) {
    // If we wanted to initialize the session to have some attributes we could add those here.
    const sessionAttributes = {};
    const cardTitle = 'Welcome';
    const speechOutput = "Welcome to My Pi. How can I help you?";
    // If the user either does not reply to the welcome message or says something that is not
    // understood, they will be prompted again with this text.
    const repromptText = "How can I help you?";
    const shouldEndSession = false;
    callback(sessionAttributes,
        buildSpeechletResponse(cardTitle, speechOutput, repromptText, shouldEndSession));
}
function handleSessionEndRequest(callback) {
    const cardTitle = 'Session Ended';
    const speechOutput = 'Thank you for trying My Pi. Have a nice day!';
    // Setting this to true ends the session and exits the skill.
    const shouldEndSession = true;
    callback({}, buildSpeechletResponse(cardTitle, speechOutput, null, shouldEndSession));
}
function createLEDStateAttributes(ledState) {
    return {
        LEDState: ledState
    };
}
/**
 * Control Light in the session and prepares the speech to reply to the user.
 */
async function turnTheLightInSession(intent, session, callback) {
    const cardTitle = "My Pi";
    const LEDStateRequest = intent.slots.LEDState;
    let repromptText = '';
    let sessionAttributes = {};
    const shouldEndSession = false;
    let speechOutput = '';
    console.log(">>turnTheLightInSession !");
    if (LEDStateRequest) {
        console.log(">>LEDState slot found !");
        var LEDState = LEDStateRequest.value;
        console.log(">>LEDState value:"+LEDState);
        var mqttpayload="";
        if (LEDState=="on")
                    mqttpayload= "LED_ON";
        else
                    mqttpayload="LED_OFF";
        const publishCommand = new PublishCommand({
            topic : mqttTopic,
            payload: mqttpayload,
            qos: 0,
            });  
        try {
        const data = await client.send(publishCommand);
        console.log(data);
        sessionAttributes = createLEDStateAttributes(LEDState);
                    speechOutput = "Ok, turning the light " + LEDState;
                    repromptText = "Ok, turning the light " + LEDState;
                    callback(sessionAttributes,buildSpeechletResponse(cardTitle, speechOutput, repromptText, shouldEndSession));  
        } catch (error) {
        console.error(error);
        speechOutput = "Sorry there is a problem. Bye" ;
                    repromptText = "Sorry there is a problem. Bye" ;
                    callback(null,buildSpeechletResponse(cardTitle, speechOutput, repromptText, true));
        }
    }
    else
    {
        speechOutput = "Please try again";
        repromptText = "Please try again";
        callback(sessionAttributes,buildSpeechletResponse(cardTitle, speechOutput, repromptText, shouldEndSession));
    }
}
// --------------- Events -----------------------
/**
 * Called when the session starts.
 */
function onSessionStarted(sessionStartedRequest, session) {
    console.log("onSessionStarted requestId=${sessionStartedRequest.requestId}, sessionId=${session.sessionId}");
}
/**
 * Called when the user launches the skill without specifying what they want.
 */
function onLaunch(launchRequest, session, callback) {
    console.log("onLaunch requestId=${launchRequest.requestId}, sessionId=${session.sessionId}");
    // Dispatch to your skill's launch.
    getWelcomeResponse(callback);
}
/**
 * Called when the user specifies an intent for this skill.
 */
async function onIntent(intentRequest, session, callback) {
    console.log("onIntent requestId=${intentRequest.requestId}, sessionId=${session.sessionId}");
    const intent = intentRequest.intent;
    const intentName = intentRequest.intent.name;
    // Dispatch to your skill's intent handlers
    if (intentName === 'TurnTheLight') {
        try {
            const data = await turnTheLightInSession(intent, session, callback);
            console.log(data);
          } catch (error) {
             console.error(error);
        } 
    } 
    else if (intentName === 'AMAZON.HelpIntent') {
        getWelcomeResponse(callback);
    } else if (intentName === 'AMAZON.StopIntent' || intentName === 'AMAZON.CancelIntent') {
        handleSessionEndRequest(callback);
    } else {
        throw new Error('Invalid intent');
    }
}
/**
 * Called when the user ends the session.
 * Is not called when the skill returns shouldEndSession=true.
 */
function onSessionEnded(sessionEndedRequest, session) {
    console.log("onSessionEnded requestId=${sessionEndedRequest.requestId}, sessionId=${session.sessionId}");
    // Add cleanup logic here
}
// --------------- Main handler -----------------------
// Route the incoming request based on type (LaunchRequest, IntentRequest,
// etc.) The JSON body of the request is provided in the event parameter.
export const handler = async (event,context) => {
    try {
        console.log("event.session.application.applicationId=${event.session.application.applicationId}");
        /**
         * Uncomment this if statement and populate with your skill's application ID to
         * prevent someone else from configuring a skill that sends requests to this function.
         */
        /*
        if (event.session.application.applicationId !== 'amzn1.echo-sdk-ams.app.[unique-value-here]') {
             context.fail("Invalid Application ID");
        }
        */
        if (event.session.new) {
            onSessionStarted({ requestId: event.request.requestId }, event.session);
        }
        if (event.request.type === 'LaunchRequest') {
            onLaunch(event.request,
                event.session,
                function callback(sessionAttributes, speechletResponse) {
                    context.succeed(buildResponse(sessionAttributes, speechletResponse));
                });
        } else if (event.request.type === 'IntentRequest') {
            await onIntent(event.request,
                event.session,
                function callback(sessionAttributes, speechletResponse) {
                    context.succeed(buildResponse(sessionAttributes, speechletResponse));
                });
        } else if (event.request.type === 'SessionEndedRequest') {
            onSessionEnded(event.request, event.session);
            context.succeed();
        }
    } catch (e) {
        context.fail("Exception: " + e);
    }
};
244
Alexa - Project
Improve our voice control
Add vocal commands to switch the light state, and set the LED power to X%
Manage the help request and consistent card display using Test console
https://developer.amazon.com/fr/docs/custom-skills/include-a-card-in-your-skills-response.html#overview-of-cards 
Option : Add French support for commands and 	    help response
	« OUVRE ….. MON…… PI »
Deliver as a functional feature on your current device
NOTE: In test console numbers fail sometimes, type in plain text
245
Alexa – Project validation
We’ll use following test sentences:
Start my pi		/ Lance mon pi
Turn the light on		/ Lumière sur On
Turn the light off	/ Lumière sur Off
Switch the light		/ Bascule la lumière
Set light to 30		/ Puissance sur 30
Set light to 120		/ Puissance sur 120
Turn the light 		/ Lumière
	(may require typing as Alexa tries to match, or I have a bad accent ;-)
On				On
Help			/ Aide
Stop			/ Stop
246
Alexa simulator language selection
Alexa skill language selection
Intent content
Alexa – Project Solution / skill
Skill: Add 2 intents
SwitchTheLight
Utterance: "switch the light“
SetPowerTo
Utterances: "set power to {LEDPower}", "set light to {LEDPower} pourcent", "set light to {LEDPower}"
Slot: LEDPower
Slot Type: AMAZON.NUMBER
Save & build model
Lambda: Dispatch & handle the 2 new custom intents and fix the standard AMAZON.HelpIntent behaviour
247
Alexa – Project Solution / new code for lambda
New global
const mqttTopic2= "RPI/RPI1/MyLEDPower“
/**
 * switch light  in the session and prepares the speech to reply to the user.
 */
function switchTheLightInSession(intent, session, callback) {
    const cardTitle = "My Pi";
    let repromptText = '';
    let sessionAttributes = {};
    const shouldEndSession = false;
    let speechOutput = '';
    var mqttpayload="LED_SWITCH";
     var params = {
            topic: mqttTopic, /* required */
            payload: mqttpayload,
            qos: 0
            };
        iotData.publish(params, function(err, data) {
              if (err) {
	console.log(err, err.stack); // an error occurred
              	speechOutput = "Sorry there is a problem. Bye" ;
            	repromptText = "Sorry there is a problem. Bye" ;
            	callback(null,buildSpeechletResponse(cardTitle, speechOutput, repromptText, true));	}
             else     {
	console.log('Function called succesfully:', data);
	speechOutput = "Ok, light switched";
	repromptText = "Ok, light switched";
	callback(sessionAttributes,buildSpeechletResponse(cardTitle, speechOutput, 			repromptText, shouldEndSession));
              }
            }
        );
}
function getHelpResponse(callback) {
    const sessionAttributes = {};
    const cardTitle = 'My PI - Help';
    const speechOutput = "You can say something like, turn on the light, or, switch the light, or, set light to 30";
    const repromptText = "How can I help you?";
    const shouldEndSession = false;
    callback(sessionAttributes,
        buildSpeechletResponse(cardTitle, speechOutput, repromptText, shouldEndSession));
}
Help Handler
SwitchTheLight Handler
248
To be fixed for NodeJS above v16
Alexa – Project Solution / new code for lambda
/**
 * Control power of Light in the session and prepares the speech to reply to the user.
 */
function setPowerToInSession(intent, session, callback) {
    const cardTitle = "My Pi";
    const LEDPower = intent.slots.LEDPower;
    let repromptText = '';
    let sessionAttributes = {};
    const shouldEndSession = false;
    let speechOutput = '';
    if (LEDPower)
    {
        var pow = LEDPower.value;
        if ((pow>=0) && (pow <=100)) {
	var mqttpayload=pow;
	var params = {
         	   topic: mqttTopic2, /* required */
       	     payload: mqttpayload,
         	   qos: 0
            };
        iotData.publish(params, function(err, data) {
        if (err) {
	  console.log(err, err.stack); // an error occurred
              	speechOutput = "Sorry there is a problem. Bye" ;
            	repromptText = "Sorry there is a problem. Bye" ;
            	callback(null,buildSpeechletResponse(cardTitle, speechOutput, repromptText, true));
	}
         else     {
	console.log('Function called succesfully:', data);
	speechOutput = "Ok, light set to " + pow + " pourcent";
	repromptText = "Ok, light set to " + pow + " pourcent";
	callback(sessionAttributes,buildSpeechletResponse(cardTitle, speechOutput, repromptText, shouldEndSession));
                    }
            }
    );
    } else {
	speechOutput = "Value must be between 0 and 100. Please try again";
	repromptText = "Value must be between 0 and 100. Please try again";
	callback(sessionAttributes,buildSpeechletResponse(cardTitle, speechOutput, repromptText, shouldEndSession));
   }
} else {
	speechOutput = "Please try again";
	repromptText = "Please try again";
	callback(sessionAttributes,buildSpeechletResponse(cardTitle, speechOutput, repromptText, shouldEndSession));
 }
}
setPowerTo handler
New handlers calls
 else if (intentName === 'SwitchTheLight') {
        switchTheLightInSession(intent, session, callback);
    } else if (intentName === 'SetPowerTo') {
        setPowerToInSession(intent, session, callback);
    }
else if (intentName === 'AMAZON.HelpIntent') {
     //getWelcomeResponse(callback);
        getHelpResponse(callback);
249
To be fixed for NodeJS above v16
Alexa – Final skill & lambda Solution
Skill US
Lambda
AlexaSkillFinal.json
LambdaForAlexaRPIFinal.js
{    "interactionModel": {        "languageModel": {            "invocationName": "my pi",            "intents": [                {                    "name": "AMAZON.FallbackIntent",                    "samples": []                },                {                    "name": "AMAZON.CancelIntent",                    "samples": []                },                {                    "name": "AMAZON.HelpIntent",                    "samples": []                },                {                    "name": "AMAZON.StopIntent",                    "samples": []                },                {                    "name": "AMAZON.NavigateHomeIntent",                    "samples": []                },                {                    "name": "TurnTheLight",                    "slots": [                        {                            "name": "LEDState",                            "type": "LEDSTATETYPE",                            "samples": [                                "{LEDState}"                            ]                        }                    ],                    "samples": [                        "turn {LEDState} the light",                        "turn the light {LEDState}"                    ]                },                {                    "name": "SwitchTheLight",                    "slots": [],                    "samples": [                        "switch the light"                    ]                },                {                    "name": "SetPowerTo",                    "slots": [                        {                            "name": "LEDPower",                            "type": "AMAZON.NUMBER"                        }                    ],                    "samples": [                        "set light to {LEDPower}",                        "set power to {LEDPower}"                    ]                }            ],            "types": [                {                    "name": "LEDSTATETYPE",                    "values": [                        {                            "name": {                                "value": "off"                            }                        },                        {                            "name": {                                "value": "on"                            }                        }                    ]                }            ]        },        "dialog": {            "intents": [                {                    "name": "TurnTheLight",                    "confirmationRequired": false,                    "prompts": {},                    "slots": [                        {                            "name": "LEDState",                            "type": "LEDSTATETYPE",                            "confirmationRequired": false,                            "elicitationRequired": true,                            "prompts": {                                "elicitation": "Elicit.Slot.794456455103.432747743616"                            }                        }                    ]                }            ],            "delegationStrategy": "ALWAYS"        },        "prompts": [            {                "id": "Elicit.Slot.794456455103.432747743616",                "variations": [                    {                        "type": "PlainText",                        "value": "Please say on or off"                    }                ]            }        ]    }}
'use strict';
/**
 * This sample demonstrates a simple skill built with the Amazon Alexa Skills Kit.
 * The Intent Schema, Custom Slots, and Sample Utterances for this skill, as well as
 * testing instructions are located at http://amzn.to/1LzFrj6
 *
 * For additional samples, visit the Alexa Skills Kit Getting Started guide at
 * http://amzn.to/1LGWsLG
 */
const AWS = require('aws-sdk');
const iotData = new AWS.IotData({ endpoint:  'accrdvv9cw1fw-ats.iot.us-east-1.amazonaws.com'}); // update the endpoint!
const mqttTopic= "RPI/RPI1/MyLEDCommand";  // update the topic!
//######## Project solution #############
const mqttTopic2= "RPI/RPI1/MyLEDPower"    // update the topic!
//######## Project solution #############
// --------------- Helpers that build all of the responses -----------------------
function buildSpeechletResponse(title, output, repromptText, shouldEndSession) {
    return {
        outputSpeech: {
            type: 'PlainText',
            text: output,
        },
        card: {
            type: 'Simple',
            title: "My Pi - " + title,
            content: output,
        },
        reprompt: {
            outputSpeech: {
                type: 'PlainText',
                text: repromptText,
            },
        },
        shouldEndSession: shouldEndSession
    };
}
function buildResponse(sessionAttributes, speechletResponse) {
    return {
        version: '1.0',
        sessionAttributes,
        response: speechletResponse,
    };
}
// --------------- Functions that control the skill's behavior -----------------------
function getWelcomeResponse(locale,callback) {
    // If we wanted to initialize the session to have some attributes we could add those here.
    const sessionAttributes = {};
    const shouldEndSession = false;
    if (locale === 'fr-FR') 
        callback(sessionAttributes,
                buildSpeechletResponse('Bienvenue', "Bienvenue dans Mon PI. comment puis-je vous aider?", "Comment puis-je vous aider?", shouldEndSession));
    else
        callback(sessionAttributes,
                buildSpeechletResponse('Welcome', "Welcome to My Pi. How can I help you?", "How can I help you?", shouldEndSession));
}
function handleSessionEndRequest(locale, callback) {
    // Setting this to true ends the session and exits the skill.
    const shouldEndSession = true;
    if (locale === 'fr-FR') 
        callback({}, buildSpeechletResponse('Fin de session', "Merci d'avoir utilisé Mon PI", null, shouldEndSession));
    else
        callback({}, buildSpeechletResponse('Session Ended', 'Thank you for trying My Pi. Have a nice day!', null, shouldEndSession));
}
function handleUnknownRequest(locale, callback) {
    // Setting this to true ends the session and exits the skill.
    const shouldEndSession = false;
    if (locale === 'fr-FR') 
        callback({}, buildSpeechletResponse('Commande inconnue', "Je ne connais pas cette commande. Dites Aide pour connaitre les commandes possibles", null, shouldEndSession));
    else
        callback({}, buildSpeechletResponse('Unknown command', "I don't unsertand this command. Say Help to get some help", null, shouldEndSession));
}
function createLEDStateAttributes(ledState) {
    return {
        LEDState: ledState
    };
}
/**
 * Control Light in the session and prepares the speech to reply to the user.
 */
function turnTheLightInSession(locale, intent, session, callback) {
    const cardTitle = "My Pi";
    const LEDStateRequest = intent.slots.LEDState;
    let repromptText = '';
    let sessionAttributes = {};
    const shouldEndSession = false;
    let speechOutput = '';
    console.log(">>turnTheLightInSession !");
    if (LEDStateRequest) {
        console.log(">>LEDState slot found !");
		var LEDState = LEDStateRequest.value;
		console.log(">>LEDState value:"+LEDState);
	    var mqttpayload="";
		if (LEDState=="on")
			    	mqttpayload= "LED_ON";
		else
			    	mqttpayload="LED_OFF";
        var params = {
            topic: mqttTopic, /* required */
            payload: mqttpayload,
            qos: 0
            };
        iotData.publish(params, function(err, data) {
              if (err) {
        			  console.log(err, err.stack); // an error occurred
                      speechOutput = (locale==="fr-FR"?"Désolée, un problème est survenu":"Sorry there is a problem. Bye") ;
            		  repromptText = (locale==="fr-FR"?"Désolée, un problème est survenu":"Sorry there is a problem. Bye") ;
            		  callback(null,buildSpeechletResponse(cardTitle, speechOutput, repromptText, true));
              }
			  else     {
                      console.log('Function called succesfully:', data);
            		  sessionAttributes = createLEDStateAttributes(LEDState);
            		  speechOutput = (locale==="fr-FR"?"Ok, lumière sur ":"Ok, turning the light ") + LEDState;
            		  repromptText = (locale==="fr-FR"?"Ok, lumière sur ":"Ok, turning the light ") + LEDState;
            		  callback(sessionAttributes,buildSpeechletResponse(cardTitle, speechOutput, repromptText, shouldEndSession));  
			  }
            }
        );
	} else {
		speechOutput = (locale==="fr-FR"?"Ré-essayez":"Please try again");
		repromptText = (locale==="fr-FR"?"Ré-essayez":"Please try again");
		callback(sessionAttributes,buildSpeechletResponse(cardTitle, speechOutput, repromptText, shouldEndSession));
	}
}
//######## Project solution #############
/**
 * switch light  in the session and prepares the speech to reply to the user.
 */
function switchTheLightInSession(locale,intent, session, callback) {
    const cardTitle = (locale==="fr-FR"?"Mon PI":"My Pi");
    let repromptText = '';
    let sessionAttributes = {};
    const shouldEndSession = false;
    let speechOutput = '';
		var mqttpayload="LED_SWITCH";
        var params = {
            topic: mqttTopic, /* required */
            payload: mqttpayload,
            qos: 0
            };
        iotData.publish(params, function(err, data) {
              if (err) {
			          console.log(err, err.stack); // an error occurred
                      speechOutput = (locale==="fr-FR"?"Désolée, un problème est survenu":"Sorry there is a problem. Bye") ;
            		  repromptText = (locale==="fr-FR"?"Désolée, un problème est survenu":"Sorry there is a problem. Bye") ;
            		  callback(null,buildSpeechletResponse(cardTitle, speechOutput, repromptText, true));
          	  }
			  else     {
				        console.log('Function called succesfully:', data);
				        speechOutput = (locale==="fr-FR"?"Ok, lumière basculée":"Ok, light switched");
				        repromptText = (locale==="fr-FR"?"Ok, lumière basculée":"Ok, light switched");
				        callback(sessionAttributes,buildSpeechletResponse(cardTitle, speechOutput, repromptText, shouldEndSession));
              }
            }
        );
}
/**
 * Control power of Light in the session and prepares the speech to reply to the user.
 */
function setPowerToInSession(locale,intent, session, callback) {
    const cardTitle = (locale==="fr-FR"?"Mon PI":"My Pi");
    const LEDPower = intent.slots.LEDPower;
    let repromptText = '';
    let sessionAttributes = {};
    const shouldEndSession = false;
    let speechOutput = '';
    if (LEDPower)
    {
        var pow = LEDPower.value;
		if ((pow>=0) && (pow <=100)) {
		var mqttpayload=pow;
        var params = {
            topic: mqttTopic2, /* required */
            payload: mqttpayload,
            qos: 0
            };
        iotData.publish(params, function(err, data) {
              if (err) {
			  console.log(err, err.stack); // an error occurred
                      speechOutput = (locale==="fr-FR"?"Désolée, un problème est survenu":"Sorry there is a problem. Bye") ;
            		  repromptText = (locale==="fr-FR"?"Désolée, un problème est survenu":"Sorry there is a problem. Bye") ;
            		  callback(null,buildSpeechletResponse(cardTitle, speechOutput, repromptText, true));
				}
			  else     {
				console.log('Function called succesfully:', data);
				speechOutput = (locale==="fr-FR"?"ok, puissance sur ":"Ok, light set to ") + pow + " %";
				repromptText = (locale==="fr-FR"?"ok, puissance sur ":"Ok, light set to ") + pow + " %";
				callback(sessionAttributes,buildSpeechletResponse(cardTitle, speechOutput, repromptText, shouldEndSession));
			    }
            }
		);
    } else {
		speechOutput = (locale==="fr-FR"?"La puissance doit être entre 0 et 100":"Value must be between 0 and 100. Please try again");
		repromptText = (locale==="fr-FR"?"La puissance doit être entre 0 et 100":"Value must be between 0 and 100. Please try again");
		callback(sessionAttributes,buildSpeechletResponse(cardTitle, speechOutput, repromptText, shouldEndSession));
	}
	} else {
		speechOutput = (locale==="fr-FR"?"Ré-essayez":"Please try again");
		repromptText = (locale==="fr-FR"?"Ré-essayez":"Please try again");
		callback(sessionAttributes,buildSpeechletResponse(cardTitle, speechOutput, repromptText, shouldEndSession));
	}
}
function getHelpResponse(locale,callback) {
    const sessionAttributes = {};
    const cardTitle = (locale==="fr-FR"?'Mon PI - Aide':'My PI - Help'); 
    const speechOutput = (locale==="fr-FR"?"Vous pouvez dire, lumière sur OFF, ou, bascule la lumière, ou, puissance sur 30":"You can say something like, turn on the light, or, switch the light, or, set light to 30");
    const repromptText = (locale==="fr-FR"?"Comment puis-je vous aider?": "How can I help you?"); 
    const shouldEndSession = false;
    callback(sessionAttributes,
        buildSpeechletResponse(cardTitle, speechOutput, repromptText, shouldEndSession));
}
//######## Project solution #############
// --------------- Events -----------------------
/**
 * Called when the session starts.
 */
function onSessionStarted(sessionStartedRequest, session) {
    console.log("onSessionStarted requestId=${sessionStartedRequest.requestId}, sessionId=${session.sessionId}");
}
/**
 * Called when the user launches the skill without specifying what they want.
 */
function onLaunch(launchRequest, session, callback) {
    console.log("onLaunch requestId=${launchRequest.requestId}, sessionId=${session.sessionId}");
    // Dispatch to your skill's launch.
    getWelcomeResponse(launchRequest.locale,callback);
}
/**
 * Called when the user specifies an intent for this skill.
 */
function onIntent(intentRequest, session, callback) {
    console.log("onIntent requestId=${intentRequest.requestId}, sessionId=${session.sessionId}");
    const intent = intentRequest.intent;
    const intentName = intentRequest.intent.name;
    // Dispatch to your skill's intent handlers
    if (intentName === 'TurnTheLight') {
        turnTheLightInSession(intentRequest.locale,intent, session, callback);
    } 
//######## Project solution #############
     	else if (intentName === 'SwitchTheLight') {
        switchTheLightInSession(intentRequest.locale, intent, session, callback);
    } else if (intentName === 'SetPowerTo') {
        setPowerToInSession(intentRequest.locale, intent, session, callback);
    }
//######## Project solution #############
    else if (intentName === 'AMAZON.HelpIntent') {
//######## Project solution #############
        //getWelcomeResponse(callback);
        getHelpResponse(intentRequest.locale,callback);
//######## Project solution #############
    } else if (intentName === 'AMAZON.StopIntent' || intentName === 'AMAZON.CancelIntent') {
        handleSessionEndRequest(intentRequest.locale,callback);
    } else {
    console.log("onIntent received unknown intent:",intentName);
    handleUnknownRequest(intentRequest.locale,callback);
    }
}
/**
 * Called when the user ends the session.
 * Is not called when the skill returns shouldEndSession=true.
 */
function onSessionEnded(sessionEndedRequest, session) {
    console.log("onSessionEnded requestId=${sessionEndedRequest.requestId}, sessionId=${session.sessionId}");
    // Add cleanup logic here
}
// --------------- Main handler -----------------------
// Route the incoming request based on type (LaunchRequest, IntentRequest,
// etc.) The JSON body of the request is provided in the event parameter.
exports.handler = (event, context) => {
    try {
        console.log("event.session.application.applicationId=${event.session.application.applicationId}");
        /**
         * Uncomment this if statement and populate with your skill's application ID to
         * prevent someone else from configuring a skill that sends requests to this function.
         */
        /*
        if (event.session.application.applicationId !== 'amzn1.echo-sdk-ams.app.[unique-value-here]') {
             context.fail("Invalid Application ID");
        }
        */
        if (event.session.new) {
            onSessionStarted({ requestId: event.request.requestId }, event.session);
        }
        if (event.request.type === 'LaunchRequest') {
            onLaunch(event.request,
                event.session,
                function callback(sessionAttributes, speechletResponse) {
					context.succeed(buildResponse(sessionAttributes, speechletResponse));
				});
        } else if (event.request.type === 'IntentRequest') {
            onIntent(event.request,
                event.session,
                function callback(sessionAttributes, speechletResponse) {
					context.succeed(buildResponse(sessionAttributes, speechletResponse));
				});
        } else if (event.request.type === 'SessionEndedRequest') {
            onSessionEnded(event.request, event.session);
            context.succeed();
        }
    } catch (e) {
        context.fail("Exception: " + e);
    }
};
250
{    "interactionModel": {        "languageModel": {            "invocationName": "mon pi",            "intents": [                {                    "name": "AMAZON.CancelIntent",                    "samples": []                },                {                    "name": "AMAZON.HelpIntent",                    "samples": []                },                {                    "name": "AMAZON.StopIntent",                    "samples": []                },                {                    "name": "AMAZON.NavigateHomeIntent",                    "samples": []                },                {                    "name": "TurnTheLight",                    "slots": [                        {                            "name": "LEDState",                            "type": "LEDSTATETYPE",                            "samples": [                                "{LEDState}"                            ]                        }                    ],                    "samples": [                        "lumière sur {LEDState}",                        "met la lumière sur {LEDState}"                    ]                },                {                    "name": "SwitchTheLight",                    "slots": [],                    "samples": [                        "bascule la lumière"                    ]                },                {                    "name": "SetPowerTo",                    "slots": [                        {                            "name": "LEDPower",                            "type": "AMAZON.NUMBER"                        }                    ],                    "samples": [                        "puissance sur {LEDPower}"                    ]                }            ],            "types": [                {                    "name": "LEDSTATETYPE",                    "values": [                        {                            "name": {                                "value": "off"                            }                        },                        {                            "name": {                                "value": "on"                            }                        }                    ]                }            ]        },        "dialog": {            "intents": [                {                    "name": "TurnTheLight",                    "confirmationRequired": false,                    "prompts": {},                    "slots": [                        {                            "name": "LEDState",                            "type": "LEDSTATETYPE",                            "confirmationRequired": false,                            "elicitationRequired": true,                            "prompts": {                                "elicitation": "Elicit.Slot.95849952536.509977210253"                            }                        }                    ]                }            ],            "delegationStrategy": "ALWAYS"        },        "prompts": [            {                "id": "Elicit.Slot.95849952536.509977210253",                "variations": [                    {                        "type": "PlainText",                        "value": "spécifiez on ou off svp"                    }                ]            }        ]    }}
Skill FR
AlexaSkillFinalFR.json
To be fixed for NodeJS above v16
Voice assistants – Risks
251
Voice assistants – Risks
252
https://www.wired.com/story/lasers-hack-amazon-echo-google-home/ 
Smart homes - Risks Illustrations
Mr Robot Smart home hacking 
https://www.youtube.com/watch?v=aAj8zHOEfiI
							South Park (funny but it actually works!) works!)actually works!)
							https://www.youtube.com/watch?v=x-fjSiDwnCc 
253
Smart homes - Risks Illustrations
Welkom ad
https://www.youtube.com/watch?v=_CQA3X-qNgA 
254
255
https://www.zdnet.com/article/alexa-and-google-home-devices-leveraged-to-phish-and-eavesdrop-on-users-again/ 
Final Phase! We did it!
256
Final Phase! We did it!
But we’ll check how others are doing with MyHouse project…
We should now
 Secure development process (Code review, Review 3rd party libraries, …)
 Obfuscate the device firmware
 Implement a code signature process
 Deploy firmware update platform
 Better protect the device private key
 Segregate cloud accounts
 Consider user enrollment/binding/authentication system
 Secure the production flow
 Perform a security audit
 Check HA/performance
 …
257
Final Phase! We did it! NodeRed final
258
[{"id":"17b72791.ffa268","type":"tab","label":"FINAL","disabled":false,"info":""},{"id":"6f5ad1f2.57456","type":"function","z":"17b72791.ffa268","name":"Switch LED state","func":"ledState=flow.get(\"LEDState\")||0;\nledPower=flow.get(\"LEDPower\")||0;\n\n(ledState === 0) ? ledState = 1 : ledState = 0;\nif (ledState==1)\n    {\n    if (ledPower===0)\n        ledPower=100;\n    msg.payload = ledPower;\n    }\nelse\n    msg.payload=0;\n    \nflow.set(\"LEDState\", ledState);\nflow.set(\"LEDPower\", ledPower);\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":500,"wires":[["52d15c37.f9ec84"]]},{"id":"b62daf9d.ca9d7","type":"inject","z":"17b72791.ffa268","name":"LED OFF","topic":"LED OFF","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":220,"y":500,"wires":[["93a2a01b.c54d6"]]},{"id":"d3c16c15.993c6","type":"debug","z":"17b72791.ffa268","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":1069.9999923706055,"y":523.0000057220459,"wires":[],"inputLabels":["msg.payload"]},{"id":"f2b4552e.be9468","type":"inject","z":"17b72791.ffa268","name":"LED ON","topic":"LED ON","payload":"ledPower","payloadType":"flow","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":220,"y":577,"wires":[["4fc00dfa.507b04"]]},{"id":"541d56eb.7ce148","type":"rpi-gpio out","z":"17b72791.ffa268","name":"LED on GPIO18","pin":"12","set":false,"level":"0","freq":"","out":"pwm","x":1079.9999923706055,"y":463.0000057220459,"wires":[]},{"id":"aac78019.32d9b","type":"rpi-gpio in","z":"17b72791.ffa268","name":"BTN on GPIO4","pin":"7","intype":"up","debounce":"25","read":true,"x":164.99999237060547,"y":761.0000038146973,"wires":[["20b2e9c8.452886"]]},{"id":"7dbc1b07.4fa944","type":"inject","z":"17b72791.ffa268","name":"SWITCH LED","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":230,"y":648,"wires":[["6f5ad1f2.57456"]]},{"id":"bebc7ed3.d0605","type":"function","z":"17b72791.ffa268","name":"If button down","func":"if (msg.payload===0)\n    return msg;\n    \nreturn  null;","outputs":1,"noerr":0,"x":382.0908889770508,"y":794.7272987365723,"wires":[[]]},{"id":"20b2e9c8.452886","type":"switch","z":"17b72791.ffa268","name":"If button down","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":379.99999237060547,"y":760.0000038146973,"wires":[["6f5ad1f2.57456"],[]]},{"id":"93a2a01b.c54d6","type":"function","z":"17b72791.ffa268","name":"Set LED state OFF","func":"var currentLedState = flow.get(\"LEDState\")||0;\nif (currentLedState===0)\n    return null;\n    \nledState = 0;\nmsg.payload = 0;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"noerr":0,"x":709.9999923706055,"y":423.0000057220459,"wires":[["52d15c37.f9ec84"]]},{"id":"4fc00dfa.507b04","type":"function","z":"17b72791.ffa268","name":"Set LED state ON","func":"currentLedState = flow.get(\"LEDState\")||0;\nledPower=flow.get(\"LEDPower\")||0;\n\nif (currentLedState==1)\n    if (ledPower==100)\n        return null;\n    else\n        ledPower=100;\n\nledState = 1;\nif (ledPower===0)\n    ledPower=100;\n    \nmsg.payload = ledPower;\n\nflow.set(\"LEDState\", ledState);\nflow.set(\"LEDPower\", ledPower);\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":461.9999990463257,"wires":[["52d15c37.f9ec84"]]},{"id":"2a2ed7ed.6df978","type":"mqtt in","z":"17b72791.ffa268","name":"","topic":"RPI/RPI1/MyLEDCommand","qos":"0","datatype":"auto","broker":"de5e8b6d.d98b68","x":204.99999237060547,"y":284.00000858306885,"wires":[["3e7d4763.182fc8","6c0c47ee.a78cb8"]]},{"id":"a5788181.875a5","type":"mqtt out","z":"17b72791.ffa268","name":"Publish MyLEDState","topic":"RPI/RPI1/MyLEDState","qos":"0","retain":"","broker":"de5e8b6d.d98b68","x":1099.9999923706055,"y":403.0000057220459,"wires":[]},{"id":"3e7d4763.182fc8","type":"switch","z":"17b72791.ffa268","name":"Parse command","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"LED_OFF","vt":"str"},{"t":"eq","v":"LED_ON","vt":"str"},{"t":"eq","v":"LED_SWITCH","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":4,"x":455,"y":266.00000858306885,"wires":[["93a2a01b.c54d6"],["4fc00dfa.507b04"],["6f5ad1f2.57456"],["889b55c4.068648"]]},{"id":"6c0c47ee.a78cb8","type":"debug","z":"17b72791.ffa268","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":451.99999618530273,"y":336.0000104904175,"wires":[]},{"id":"7e4d0ac.240d2f4","type":"ui_button","z":"17b72791.ffa268","name":"","group":"bd4b99eb.217178","order":1,"width":0,"height":0,"passthru":false,"label":"ON","tooltip":"","color":"","bgcolor":"green","icon":"","payload":"1","payloadType":"str","topic":"","x":210,"y":608,"wires":[["4fc00dfa.507b04"]]},{"id":"e977e105.550f8","type":"ui_switch","z":"17b72791.ffa268","name":"","label":"switch","tooltip":"","group":"bd4b99eb.217178","order":3,"width":0,"height":0,"passthru":false,"decouple":"true","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"power_settings_new","oncolor":"green","offvalue":"false","offvalueType":"bool","officon":"power_settings_new","offcolor":"red","x":210,"y":680,"wires":[["6f5ad1f2.57456"]]},{"id":"75e2f737.6d80d8","type":"ui_button","z":"17b72791.ffa268","name":"","group":"bd4b99eb.217178","order":2,"width":0,"height":0,"passthru":false,"label":"OFF","tooltip":"","color":"","bgcolor":"red","icon":"","payload":"0","payloadType":"str","topic":"","x":208.99999237060547,"y":531.0000047683716,"wires":[["93a2a01b.c54d6"]]},{"id":"3b8dad9a.0f3372","type":"ui_text","z":"17b72791.ffa268","group":"bd4b99eb.217178","order":8,"width":0,"height":0,"name":"","label":"LED is ","format":"{{msg.payload}}%","layout":"row-spread","x":1049.9999923706055,"y":583.0000057220459,"wires":[]},{"id":"52d15c37.f9ec84","type":"change","z":"17b72791.ffa268","name":"Dispatch","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":899.9999923706055,"y":463.0000057220459,"wires":[["3b8dad9a.0f3372","d3c16c15.993c6","541d56eb.7ce148","a5788181.875a5","8a6c842a.3402a8","61de96d4.23cb28","31202dff.12dde2","b06f051a.517398","611f6ec3.3db66"]]},{"id":"889b55c4.068648","type":"change","z":"17b72791.ffa268","name":"Unknown command","rules":[{"t":"change","p":"payload","pt":"msg","from":"^(.*)$","fromt":"re","to":"Unknown MQTT command received : [$1] ","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":703,"y":235.00003242492676,"wires":[["94b83c9e.4ff89","42b01d32.e28504"]]},{"id":"94b83c9e.4ff89","type":"ui_text","z":"17b72791.ffa268","group":"bd4b99eb.217178","order":13,"width":0,"height":0,"name":"Error","label":"text","format":"{{msg.payload}}","layout":"row-spread","x":1068.0000076293945,"y":241.00000762939453,"wires":[]},{"id":"62f572fe.4935ac","type":"mqtt in","z":"17b72791.ffa268","name":"","topic":"RPI/RPI1/MyLEDPower","qos":"0","datatype":"auto","broker":"de5e8b6d.d98b68","x":184.99999237060547,"y":356.99999713897705,"wires":[["6c0c47ee.a78cb8","47f98164.216ef"]]},{"id":"47f98164.216ef","type":"function","z":"17b72791.ffa268","name":"Set LED Power","func":"var ledPower=msg.payload;\nvar ledState;\n\nif (ledPower===0)\n    {\n    ledState=0;\n    ledPower=100;\n    }\nelse\n    ledState=1;\n    \nflow.set(\"LEDState\", ledState);\nflow.set(\"LEDPower\", ledPower);\nreturn msg;","outputs":1,"noerr":0,"x":699.9999923706055,"y":383.0000057220459,"wires":[["52d15c37.f9ec84"]]},{"id":"4bc572de.47622c","type":"comment","z":"17b72791.ffa268","name":"CoAP PUT (controls) ","info":"","x":187.09089374542236,"y":843.7272806167603,"wires":[]},{"id":"420b109d.2dbf4","type":"debug","z":"17b72791.ffa268","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"req.payload","x":449.99999618530273,"y":119.0000057220459,"wires":[]},{"id":"efe31fcc.6b0fd","type":"function","z":"17b72791.ffa268","name":"BufferToString","func":"msg.payload=msg.req.payload.toString();\nreturn msg;","outputs":1,"noerr":0,"x":452,"y":164.00000667572021,"wires":[["48ff81ca.e6b12","3e7d4763.182fc8"]]},{"id":"48ff81ca.e6b12","type":"debug","z":"17b72791.ffa268","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"req.payload","x":681,"y":164.00000715255737,"wires":[]},{"id":"a4c97a08.06a5b8","type":"function","z":"17b72791.ffa268","name":"Responder","func":"currentLedState = flow.get(\"LEDState\")||0;\ncurrentLedPower = flow.get(\"LEDPower\")||0;\n\nif (currentLedState===0)\n    msg.res.end(\"0\");\nelse\n    msg.res.end(currentLedPower.toString());\nreturn msg;","outputs":1,"noerr":0,"x":440.99999618530273,"y":82.00000524520874,"wires":[[]]},{"id":"a99f328b.a9dfb","type":"inject","z":"17b72791.ffa268","name":"","topic":"","payload":"LED_ON","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"","x":179.99999237060547,"y":923.0000047683716,"wires":[["1cc33efe.d13551"]]},{"id":"e0b663db.dfa54","type":"inject","z":"17b72791.ffa268","name":"","topic":"","payload":"LED_OFF","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"","x":179.99999237060547,"y":963.0000047683716,"wires":[["1cc33efe.d13551"]]},{"id":"5b72d425.5bd0dc","type":"debug","z":"17b72791.ffa268","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","x":759.9999923706055,"y":883.0000047683716,"wires":[]},{"id":"80d03e76.a8d8b","type":"inject","z":"17b72791.ffa268","name":"","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"","x":169.99999237060547,"y":883.0000047683716,"wires":[["8270c233.b40c2"]]},{"id":"42b01d32.e28504","type":"debug","z":"17b72791.ffa268","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","x":1084.0000076293945,"y":191.00000667572021,"wires":[],"inputLabels":["msg.payload"]},{"id":"c52a560e.cefe78","type":"coap in","z":"17b72791.ffa268","method":"POST","name":"","server":"7d400227.ba488c","url":"/storage/LED","x":184.99999237060547,"y":122.00000667572021,"wires":[["420b109d.2dbf4","efe31fcc.6b0fd"]]},{"id":"e51d7cc5.29ca8","type":"coap in","z":"17b72791.ffa268","method":"PUT","name":"","server":"7d400227.ba488c","url":"/storage/LED","x":174.99999237060547,"y":162.00000667572021,"wires":[["420b109d.2dbf4","efe31fcc.6b0fd"]]},{"id":"87288f4e.b842b","type":"coap in","z":"17b72791.ffa268","method":"GET","name":"","server":"7d400227.ba488c","url":"/storage/LED","x":174.99999237060547,"y":82.00000667572021,"wires":[["a4c97a08.06a5b8"]]},{"id":"1cc33efe.d13551","type":"coap request","z":"17b72791.ffa268","method":"PUT","observe":false,"url":"coap://127.0.0.1:55683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"PUT /storage/LED","x":489.99999237060547,"y":943.0000047683716,"wires":[[]]},{"id":"8270c233.b40c2","type":"coap request","z":"17b72791.ffa268","method":"GET","observe":true,"url":"coap://localhost:55683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"GET /storage/LED","x":489.99999237060547,"y":883.0000047683716,"wires":[["5b72d425.5bd0dc"]]},{"id":"8a6c842a.3402a8","type":"ui_gauge","z":"17b72791.ffa268","name":"","group":"bd4b99eb.217178","order":10,"width":0,"height":0,"gtype":"gage","title":"gauge","label":"units","format":"{{value}}","min":0,"max":"100","colors":["#00B500","#E6E600","#CA3838"],"seg1":"","seg2":"","x":1051.0000038146973,"y":626.0000133514404,"wires":[]},{"id":"61de96d4.23cb28","type":"ui_chart","z":"17b72791.ffa268","name":"","group":"bd4b99eb.217178","order":12,"width":0,"height":0,"label":"chart","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"60","cutout":0,"useOneColor":false,"colors":["#1F77B4","#AEC7E8","#FF7F0E","#2CA02C","#98DF8A","#D62728","#FF9896","#9467BD","#C5B0D5"],"useOldStyle":false,"outputs":2,"x":1052.0000038146973,"y":666.0000133514404,"wires":[[],[]]},{"id":"c901d845.9e7d18","type":"ui_slider","z":"17b72791.ffa268","name":"","label":"slider","tooltip":"","group":"bd4b99eb.217178","order":7,"width":0,"height":0,"passthru":false,"outs":"all","topic":"","min":0,"max":"100","step":"10","x":210,"y":435,"wires":[["47f98164.216ef"]]},{"id":"e131b893.fc12f8","type":"ui_text_input","z":"17b72791.ffa268","name":"","label":"Select a value","tooltip":"","group":"bd4b99eb.217178","order":5,"width":0,"height":0,"passthru":false,"mode":"text","delay":300,"topic":"","x":239.99999237060547,"y":466.0000047683716,"wires":[["47f98164.216ef"]]},{"id":"909b6371.c593a","type":"comment","z":"17b72791.ffa268","name":"CoAP responder","info":"","x":164.99999237060547,"y":46.600003242492676,"wires":[]},{"id":"5b62be56.3557c","type":"comment","z":"17b72791.ffa268","name":"MQTT responder","info":"","x":164.99999237060547,"y":215.00000858306885,"wires":[]},{"id":"f1615675.407c18","type":"comment","z":"17b72791.ffa268","name":"Dashboard & inflow controls","info":"","x":204.99999237060547,"y":404.0000009536743,"wires":[]},{"id":"19eb6368.b7d18d","type":"comment","z":"17b72791.ffa268","name":"Hardware button","info":"","x":164.99999237060547,"y":723.0000038146973,"wires":[]},{"id":"21ea8993.9fa6f6","type":"comment","z":"17b72791.ffa268","name":"LED state & commands mgt","info":"","x":735.9999923706055,"y":337.0000047683716,"wires":[]},{"id":"311dce13.075402","type":"comment","z":"17b72791.ffa268","name":"LED change, notifications, dashboard out","info":"","x":1080,"y":337,"wires":[]},{"id":"ff1c7bdf.d74bd8","type":"link in","z":"17b72791.ffa268","name":"Inject in Text/Slider","links":["31202dff.12dde2"],"x":35,"y":460,"wires":[["67679162.c9d26","e131b893.fc12f8","c901d845.9e7d18"]]},{"id":"31202dff.12dde2","type":"link out","z":"17b72791.ffa268","name":"Inject in Text/Slider","links":["ff1c7bdf.d74bd8"],"x":1014.9999923706055,"y":703.0000047683716,"wires":[]},{"id":"62bc7359.9dc85c","type":"mqtt out","z":"17b72791.ffa268","name":"Test Switch by MQTT","topic":"RPI/RPI1/MyLEDCommand","qos":"0","retain":"","broker":"de5e8b6d.d98b68","x":1220,"y":100,"wires":[]},{"id":"573f5809.ef1f98","type":"inject","z":"17b72791.ffa268","name":"","topic":"","payload":"LED_SWITCH","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1010,"y":100,"wires":[["62bc7359.9dc85c"]]},{"id":"7c0c5693.a2c1c8","type":"mqtt in","z":"17b72791.ffa268","name":"","topic":"RPI/RPI1/MyLEDState","qos":"0","datatype":"auto","broker":"de5e8b6d.d98b68","x":1020,"y":60,"wires":[["6167de95.48233"]]},{"id":"6167de95.48233","type":"debug","z":"17b72791.ffa268","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","targetType":"msg","x":1240,"y":60,"wires":[]},{"id":"67679162.c9d26","type":"function","z":"17b72791.ffa268","name":"# to Bool","func":"// convert 0-100 to True / False for swith button state\nmsg.payload=msg.payload!==0;\nreturn msg;","outputs":1,"noerr":0,"x":80,"y":680,"wires":[["e977e105.550f8"]]},{"id":"b06f051a.517398","type":"debug","z":"17b72791.ffa268","name":"flow.LEDPower","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"$flowContext(\"LEDPower\")","targetType":"jsonata","x":1270,"y":560,"wires":[]},{"id":"611f6ec3.3db66","type":"debug","z":"17b72791.ffa268","name":"flow.LEDState","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"$flowContext(\"LEDState\")","targetType":"jsonata","x":1260,"y":500,"wires":[]},{"id":"c36d3d4e.b025a","type":"comment","z":"17b72791.ffa268","name":"DEBUG","info":"","x":970.0000076293945,"y":16.999995231628418,"wires":[]},{"id":"de5e8b6d.d98b68","type":"mqtt-broker","z":"","name":"AWS RPI1","broker":"a1xjq2umk7o625-ats.iot.us-east-1.amazonaws.com","port":"8883","tls":"361362d3.6b745e","clientid":"RPI1","usetls":true,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"bd4b99eb.217178","type":"ui_group","z":0,"name":"LED Commands","tab":"dd9947c0.718f78","disp":true,"width":"6","collapse":false},{"id":"7d400227.ba488c","type":"coap-server","z":"","name":"coap://192.168.0.92","port":"55683"},{"id":"361362d3.6b745e","type":"tls-config","z":"","name":"RPI1","cert":"/home/pi/awsCerts/6a0cad2792-certificate.pem.crt","key":"/home/pi/awsCerts/6a0cad2792-private.pem.key","ca":"/home/pi/awsCerts/AmazonRootCA1.pem","certname":"cc2956e006-certificate.pem.crt","keyname":"cc2956e006-private.pem.key","caname":"VeriSign-Class 3-Public-Primary-Certification-Authority-G5.pem","servername":"","verifyservercert":true},{"id":"dd9947c0.718f78","type":"ui_tab","z":0,"name":"Home","icon":"dashboard","disabled":false,"hidden":false}]
FINAL
Final Phase! We did it! NodeRed final
259
[{"id":"291195f6.c56a3a","type":"tab","label":"RPI_LED_1","disabled":true,"info":""},{"id":"a3e9cca0.9f2cf","type":"tab","label":"RPI_LED_2","disabled":true,"info":""},{"id":"ec50e367.467d4","type":"tab","label":"RPI_BTN_1","disabled":true,"info":""},{"id":"1b291fb1.3ef12","type":"tab","label":"RPI_BTN_2","disabled":true,"info":""},{"id":"d7f5c745.30fbf8","type":"tab","label":"RPI_LED_BTN_1","disabled":true,"info":""},{"id":"5a858abd.8e0534","type":"tab","label":"RPI_LED_BTN_2","disabled":true,"info":""},{"id":"557915bd.b9a3dc","type":"tab","label":"RPI_LED_POWER","disabled":true,"info":""},{"id":"d67507fd.920a88","type":"tab","label":"MQTT_1","disabled":true,"info":""},{"id":"849fc2bb.4b022","type":"tab","label":"SHIFTR.IO","disabled":true,"info":""},{"id":"cb7ce764.369a78","type":"tab","label":"DASHBOARD_1","disabled":true,"info":""},{"id":"df04784a.d18f88","type":"tab","label":"RPI_LED_BTN_MQTT_DASHBOARD_FINAL","disabled":true,"info":""},{"id":"2bbfd6b4.0796aa","type":"tab","label":"DASHBOARD_2","disabled":true,"info":""},{"id":"17d2a295.77e4ad","type":"tab","label":"RPI_LED_BTN_MQTT_DASHBOARD_FINAL_LINKS","disabled":true,"info":""},{"id":"9c0b8654.c93088","type":"tab","label":"DASHBOARD_2_LINKS","disabled":true,"info":""},{"id":"862af712.0c0838","type":"tab","label":"DASHBOARD_GROUP_PROJECT","disabled":true,"info":""},{"id":"d98d1ceb.8108","type":"tab","label":"MQTT secure","disabled":true,"info":""},{"id":"145f19d3.21f876","type":"tab","label":"AWS1","disabled":true,"info":""},{"id":"fc93d78f.1f92d8","type":"tab","label":"AWS2","disabled":true,"info":""},{"id":"87526546.9e5728","type":"tab","label":"AWS Policies","disabled":true,"info":""},{"id":"6bc95f22.c5c54","type":"tab","label":"AWSRules1","disabled":true,"info":""},{"id":"fd7b7375.ee446","type":"tab","label":"CoAPClient","disabled":true,"info":""},{"id":"31505c05.967164","type":"tab","label":"CoAPServerLED","disabled":true,"info":""},{"id":"17b72791.ffa268","type":"tab","label":"FINAL","disabled":false,"info":""},{"id":"5e96290d.916808","type":"mqtt-broker","z":"","name":"broker.hivemq.com","broker":"broker.hivemq.com","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"361362d3.6b745e","type":"tls-config","z":"","name":"RPI1","cert":"/home/pi/awsCerts/6a0cad2792-certificate.pem.crt","key":"/home/pi/awsCerts/6a0cad2792-private.pem.key","ca":"/home/pi/awsCerts/AmazonRootCA1.pem","certname":"cc2956e006-certificate.pem.crt","keyname":"cc2956e006-private.pem.key","caname":"VeriSign-Class 3-Public-Primary-Certification-Authority-G5.pem","servername":"","verifyservercert":true},{"id":"de5e8b6d.d98b68","type":"mqtt-broker","z":"","name":"AWS RPI1","broker":"a1xjq2umk7o625-ats.iot.us-east-1.amazonaws.com","port":"8883","tls":"361362d3.6b745e","clientid":"RPI1","usetls":true,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"cd68504a.7e337","type":"tls-config","z":"","name":"RPI2","cert":"/home/pi/awsCerts/bab32bba39-certificate.pem.crt","key":"/home/pi/awsCerts/bab32bba39-private.pem.key","ca":"/home/pi/awsCerts/AmazonRootCA1.pem","certname":"","keyname":"","caname":"","servername":"","verifyservercert":true},{"id":"25f2c26e.622efe","type":"mqtt-broker","z":"","name":"AWS RPI2","broker":"a37nlvgzkylhiz-ats.iot.us-east-1.amazonaws.com","port":"8883","tls":"cd68504a.7e337","clientid":"RPI2","usetls":true,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"502fbdc.2b38744","type":"mqtt-broker","z":"","name":"AWS RPI2 trying to fake RPI1","broker":"a1blmeju6wco4p-ats.iot.eu-west-1.amazonaws.com","port":"8883","tls":"cd68504a.7e337","clientid":"RPI1","usetls":true,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"2a60c815.f762e8","type":"mqtt-broker","z":"","name":"mqtt.eclipse.org","broker":"mqtt.eclipse.org","port":"1883","clientid":"RPI1","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"169b1c74.dbd4e4","type":"mqtt-broker","z":"","name":"shiftr.io","broker":"MyRPIClient:a94f6c734127b8cd@broker.shiftr.io","port":"1883","clientid":"MyNodeRed","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"c8d1b7e8.8c2a28","type":"mqtt-broker","z":"","name":"HiveMQ","broker":"broker.mqttdashboard.com","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"80f554bd.fe2b08","type":"ui_base","z":0,"theme":{"name":"theme-light","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#0094CE","value":"#0094CE","edited":false},"page-titlebar-backgroundColor":{"value":"#0094CE","edited":false},"page-backgroundColor":{"value":"#fafafa","edited":false},"page-sidebar-backgroundColor":{"value":"#ffffff","edited":false},"group-textColor":{"value":"#1bbfff","edited":false},"group-borderColor":{"value":"#ffffff","edited":false},"group-backgroundColor":{"value":"#ffffff","edited":false},"widget-textColor":{"value":"#111111","edited":false},"widget-backgroundColor":{"value":"#0094ce","edited":false},"widget-borderColor":{"value":"#ffffff","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"bd4b99eb.217178","type":"ui_group","z":0,"name":"LED Commands","tab":"dd9947c0.718f78","disp":true,"width":"6","collapse":false},{"id":"dd9947c0.718f78","type":"ui_tab","z":0,"name":"Home","icon":"dashboard","disabled":false,"hidden":false},{"id":"c3b69147.0547d","type":"ui_group","z":"df04784a.d18f88","name":"Second","tab":"409a88be.2a07a8","order":2,"disp":true,"width":"5"},{"id":"409a88be.2a07a8","type":"ui_tab","z":"df04784a.d18f88","name":"Home","icon":"link","order":1},{"id":"9464b82e.fd5be8","type":"ui_tab","z":0,"name":"TP","icon":"dashboard","disabled":false,"hidden":false},{"id":"acff4ef0.55292","type":"ui_group","z":0,"name":"TP dashboard","tab":"9464b82e.fd5be8","disp":true,"width":"6","collapse":false},{"id":"cea85f80.0b03","type":"mqtt-broker","z":"","name":"","broker":"test.mosquitto.org","port":"1883","clientid":"Test222","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"15303ee8.440701","type":"ui_tab","z":"","name":"Group","icon":"dashboard","disabled":false,"hidden":false},{"id":"2fd691e9.6d64de","type":"ui_group","z":"","name":"RPI Command center","tab":"15303ee8.440701","order":1,"disp":true,"width":"6","collapse":false},{"id":"fc2bfb8d.9e67f8","type":"ui_group","z":"","name":"Group 2","tab":"15303ee8.440701","order":2,"disp":false,"width":"6","collapse":false},{"id":"7d400227.ba488c","type":"coap-server","z":"","name":"coap://192.168.0.92","port":"55683"},{"id":"5ebcea58.e50a74","type":"coap-server","name":"Hello CoAP Server","port":"5683"},{"id":"4f2f321a.505fcc","type":"ui_group","z":"","name":"test to delete","tab":"dd9947c0.718f78","disp":true,"width":"6","collapse":false},{"id":"2fc6eb97.8750e4","type":"mqtt-broker","z":"","name":"MQTTDashboard","broker":"broker.mqttdashboard.com","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"9b35ae2b.9d3fb","type":"mqtt-broker","z":"","name":"AWS RPI1 trying to fake RPI2","broker":"a37nlvgzkylhiz-ats.iot.us-east-1.amazonaws.com","port":"1883","tls":"361362d3.6b745e","clientid":"RPI2","usetls":true,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"6d9f52ca.0ed27c","type":"tls-config","z":"","name":"RPI3 own CA","cert":"","key":"","ca":"","certname":"RPI3.crt","keyname":"RPI3.key","caname":"AmazonRootCA1.pem","servername":"","verifyservercert":true},{"id":"ec86ade6.d9f7","type":"mqtt-broker","z":"","name":"AWS RPI3","broker":"a37nlvgzkylhiz-ats.iot.us-east-1.amazonaws.com","port":"8883","tls":"6d9f52ca.0ed27c","clientid":"RPI3","usetls":true,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"ce19bdf7.7bc96","type":"mqtt-broker","z":"","name":"test.mosquitto.org TLS","broker":"test.mosquitto.org","port":"8883","tls":"bfab486b.5e8cc8","clientid":"","usetls":true,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"bfab486b.5e8cc8","type":"tls-config","z":"","name":"","cert":"","key":"","ca":"","certname":"","keyname":"","caname":"mosquitto.org.pem","servername":"","verifyservercert":true},{"id":"52036f0f.f6564","type":"mqtt-broker","z":"","name":"","broker":"test.mosquitto.org","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"a3d12627.70c4e8","type":"function","z":"df04784a.d18f88","name":"Switch LED state","func":"ledState=flow.get(\"LEDState\")||0;\nledPower=flow.get(\"LEDPower\")||0;\n\n(ledState === 0) ? ledState = 1 : ledState = 0;\nif (ledState==1)\n    {\n    if (ledPower===0)\n        ledPower=100;\n    msg.payload = ledPower;\n    }\nelse\n    msg.payload=0;\n    \nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":280,"wires":[["ffb831f.f1348d"]]},{"id":"476134bc.4ff5bc","type":"inject","z":"df04784a.d18f88","name":"SWITCH LED","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"onceDelay":"","x":220,"y":320,"wires":[[]]},{"id":"50ffd369.4e679c","type":"inject","z":"df04784a.d18f88","name":"LED OFF","topic":"LED OFF","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":200,"y":180,"wires":[["1bb3b952.a3b307"]]},{"id":"4f190cb1.c0a864","type":"debug","z":"df04784a.d18f88","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":1110,"y":280,"wires":[],"inputLabels":["msg.payload"]},{"id":"6deb2ce4.ae0e84","type":"inject","z":"df04784a.d18f88","name":"LED ON","topic":"LED ON","payload":"ledPower","payloadType":"flow","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":200,"y":220,"wires":[["f221371c.dc4d48"]]},{"id":"abf00512.587838","type":"rpi-gpio out","z":"df04784a.d18f88","name":"LED on GPIO18","pin":"12","set":false,"level":"0","freq":"","out":"pwm","x":1120,"y":220,"wires":[]},{"id":"ab6cf6db.440b18","type":"rpi-gpio in","z":"df04784a.d18f88","name":"BTN on GPIO4","pin":"7","intype":"up","debounce":"25","read":true,"x":220,"y":520,"wires":[["67f5872c.e8d488"]]},{"id":"25444e4c.8c3772","type":"inject","z":"df04784a.d18f88","name":"SWITCH LED","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":210,"y":280,"wires":[["a3d12627.70c4e8"]]},{"id":"d499d4b5.8dbc98","type":"function","z":"df04784a.d18f88","name":"If button down","func":"if (msg.payload===0)\n    return msg;\n    \nreturn  null;","outputs":1,"noerr":0,"x":420,"y":560,"wires":[[]]},{"id":"67f5872c.e8d488","type":"switch","z":"df04784a.d18f88","name":"If button down","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":420,"y":520,"wires":[["a3d12627.70c4e8"],[]]},{"id":"1bb3b952.a3b307","type":"function","z":"df04784a.d18f88","name":"Set LED state OFF","func":"var currentLedState = flow.get(\"LEDState\")||0;\nif (currentLedState===0)\n    return null;\n    \nledState = 0;\nmsg.payload = ledState;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"noerr":0,"x":750,"y":180,"wires":[["ffb831f.f1348d"]]},{"id":"f221371c.dc4d48","type":"function","z":"df04784a.d18f88","name":"Set LED state ON","func":"currentLedState = flow.get(\"LEDState\")||0;\nledPower=flow.get(\"LEDPower\")||0;\n\nif (currentLedState==1)\n    if (ledPower==100)\n        return null;\n    else\n        ledPower=100;\n\nledState = 1;\nif (ledPower===0)\n    ledPower=100;\n    \nmsg.payload = ledPower;\n\nflow.set(\"LEDState\", ledState);\nflow.set(\"LEDPower\", ledPower);\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":220,"wires":[["ffb831f.f1348d"]]},{"id":"c5437659.ddd648","type":"mqtt in","z":"df04784a.d18f88","name":"","topic":"RPI/RPI1/MyLEDCommand","qos":"0","datatype":"auto","broker":"5e96290d.916808","x":260,"y":40,"wires":[["1584f721.a275d9","ee98f577.119368"]]},{"id":"409c3ef0.bc2c1","type":"mqtt out","z":"df04784a.d18f88","name":"Publish MyLEDState","topic":"RPI/RPI1/MyLEDState","qos":"","retain":"","broker":"5e96290d.916808","x":1140,"y":160,"wires":[]},{"id":"1584f721.a275d9","type":"switch","z":"df04784a.d18f88","name":"Parse command","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"LED_OFF","vt":"str"},{"t":"eq","v":"LED_ON","vt":"str"},{"t":"eq","v":"LED_SWITCH","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":4,"x":500,"y":40,"wires":[["1bb3b952.a3b307"],["f221371c.dc4d48"],["a3d12627.70c4e8"],["e8804182.7f948"]]},{"id":"ee98f577.119368","type":"debug","z":"df04784a.d18f88","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":490,"y":100,"wires":[]},{"id":"b4b0f29f.a46a","type":"ui_button","z":"df04784a.d18f88","name":"","group":"bd4b99eb.217178","order":1,"width":0,"height":0,"passthru":false,"label":"ON","tooltip":"","color":"","bgcolor":"green","icon":"","payload":"1","payloadType":"str","topic":"","x":190,"y":420,"wires":[["f221371c.dc4d48"]]},{"id":"91779b97.2deae8","type":"ui_switch","z":"df04784a.d18f88","name":"","label":"switch","tooltip":"","group":"bd4b99eb.217178","order":3,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"power_settings_new","oncolor":"green","offvalue":"false","offvalueType":"bool","officon":"power_settings_new","offcolor":"red","x":190,"y":460,"wires":[[]]},{"id":"a6348708.41c508","type":"ui_button","z":"df04784a.d18f88","name":"","group":"bd4b99eb.217178","order":2,"width":0,"height":0,"passthru":false,"label":"OFF","tooltip":"","color":"","bgcolor":"red","icon":"","payload":"0","payloadType":"str","topic":"","x":190,"y":380,"wires":[["1bb3b952.a3b307"]]},{"id":"264fdc22.f36694","type":"ui_text","z":"df04784a.d18f88","group":"bd4b99eb.217178","order":8,"width":0,"height":0,"name":"","label":"LED is ","format":"{{msg.payload}}%","layout":"row-spread","x":1090,"y":340,"wires":[]},{"id":"ffb831f.f1348d","type":"change","z":"df04784a.d18f88","name":"Dispatch","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":940,"y":220,"wires":[["264fdc22.f36694","4f190cb1.c0a864","abf00512.587838","409c3ef0.bc2c1","a1b12525.770318"]]},{"id":"e8804182.7f948","type":"change","z":"df04784a.d18f88","name":"Unknown command","rules":[{"t":"change","p":"payload","pt":"msg","from":"^(.*)$","fromt":"re","to":"Unknown MQTT command received : [$1] ","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":760,"y":40,"wires":[["1407ade7.e43242"]]},{"id":"1407ade7.e43242","type":"ui_text","z":"df04784a.d18f88","group":"bd4b99eb.217178","order":13,"width":0,"height":0,"name":"Error","label":"text","format":"{{msg.payload}}","layout":"row-spread","x":1090,"y":40,"wires":[]},{"id":"35bfb993.3a97a6","type":"ui_slider","z":"cb7ce764.369a78","name":"","label":"slider","tooltip":"","group":"acff4ef0.55292","order":6,"width":0,"height":0,"passthru":true,"outs":"all","topic":"","min":0,"max":"100","step":"10","x":450,"y":240,"wires":[["d5e15841.5d8858","f0f72da2.ad5ad","58fbb82.890a948"]]},{"id":"f0f72da2.ad5ad","type":"ui_gauge","z":"cb7ce764.369a78","name":"","group":"acff4ef0.55292","order":9,"width":0,"height":0,"gtype":"gage","title":"gauge","label":"units","format":"{{value}}","min":0,"max":"100","colors":["#00B500","#E6E600","#CA3838"],"seg1":"","seg2":"","x":670,"y":200,"wires":[]},{"id":"58fbb82.890a948","type":"ui_chart","z":"cb7ce764.369a78","name":"","group":"acff4ef0.55292","order":11,"width":0,"height":0,"label":"chart","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"60","cutout":0,"useOneColor":false,"colors":["#1F77B4","#AEC7E8","#FF7F0E","#2CA02C","#98DF8A","#D62728","#FF9896","#9467BD","#C5B0D5"],"useOldStyle":false,"outputs":2,"x":670,"y":300,"wires":[[],[]]},{"id":"d5e15841.5d8858","type":"ui_text_input","z":"cb7ce764.369a78","name":"","label":"Select a value","tooltip":"","group":"acff4ef0.55292","order":4,"width":0,"height":0,"passthru":true,"mode":"text","delay":300,"topic":"","x":240,"y":240,"wires":[["35bfb993.3a97a6"]]},{"id":"1e3d299d.890786","type":"mqtt in","z":"df04784a.d18f88","name":"","topic":"RPI/RPI1/MyLEDPower","qos":"0","datatype":"auto","broker":"5e96290d.916808","x":240,"y":140,"wires":[["ee98f577.119368","8ab9ea83.414378"]]},{"id":"8ab9ea83.414378","type":"function","z":"df04784a.d18f88","name":"Set LED Power","func":"var ledPower=msg.payload;\nvar ledState;\n\nif (ledPower===0)\n    {\n    ledState=0;\n    ledPower=100;\n    }\nelse\n    ledState=1;\n    \nflow.set(\"LEDState\", ledState);\nflow.set(\"LEDPower\", ledPower);\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":140,"wires":[["ffb831f.f1348d"]]},{"id":"275a7768.96a1b8","type":"mqtt in","z":"87526546.9e5728","name":"RPI1 subs to RPI/RPI1/Test","topic":"RPI/+/Test","qos":"1","broker":"de5e8b6d.d98b68","x":472.7777786254883,"y":588.8889827728271,"wires":[["592d92af.d0ad6c"]]},{"id":"aa68420f.6ca9e","type":"mqtt out","z":"87526546.9e5728","name":"from RPI1:RPI/RPI2/Test","topic":"RPI/RPI2/Test","qos":"0","retain":"","broker":"de5e8b6d.d98b68","x":848.3333587646484,"y":152.2222080230713,"wires":[]},{"id":"a4d13a54.21c1d8","type":"inject","z":"87526546.9e5728","name":"","topic":"RPI/RPI2/Test","payload":"{\"value\":\"2\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":488.33335876464844,"y":152.2222080230713,"wires":[["aa68420f.6ca9e"]]},{"id":"592d92af.d0ad6c","type":"debug","z":"87526546.9e5728","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":871.6666793823242,"y":588.8889966011047,"wires":[]},{"id":"43d3057d.1bd3cc","type":"debug","z":"87526546.9e5728","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":871.6666793823242,"y":641.111225605011,"wires":[]},{"id":"fdd16bce.621178","type":"mqtt in","z":"87526546.9e5728","name":"RPI2 subs to RPI/#","topic":"RPI/#","qos":"1","datatype":"auto","broker":"25f2c26e.622efe","x":442.7777786254883,"y":641.1112117767334,"wires":[["43d3057d.1bd3cc"]]},{"id":"444addf5.4d8e14","type":"inject","z":"87526546.9e5728","name":"","topic":"RPI/RPI2/Test","payload":"{\"value\":\"4\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":486.66673278808594,"y":495.55567169189453,"wires":[["55cf55d9.53af1c"]]},{"id":"55cf55d9.53af1c","type":"mqtt out","z":"87526546.9e5728","name":"From RPI2:RPI/RPI1/Test","topic":"RPI/RPI1/Test","qos":"0","retain":"","broker":"25f2c26e.622efe","x":855.5556182861328,"y":495.55566692352295,"wires":[]},{"id":"e39587e4.3c78a8","type":"mqtt out","z":"87526546.9e5728","name":"From RPI2:RPI/RPI2/Test","topic":"RPI/RPI2/Test","qos":"0","retain":"","broker":"25f2c26e.622efe","x":848.3333740234375,"y":276.6666736602783,"wires":[]},{"id":"69098bbf.3cfb94","type":"inject","z":"87526546.9e5728","name":"","topic":"RPI/RPI2/Test","payload":"{\"value\":\"3\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":488.3333740234375,"y":276.6666736602783,"wires":[["e39587e4.3c78a8"]]},{"id":"ae097e49.7c65","type":"inject","z":"87526546.9e5728","name":"","topic":"RPI/RPI1/Test","payload":"{\"value\":\"1\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":487.7777404785156,"y":56.666669845581055,"wires":[["6d31db54.f56834"]]},{"id":"6d31db54.f56834","type":"mqtt out","z":"87526546.9e5728","name":"from RPI1:RPI/RPI1/Test","topic":"RPI/RPI1/Test","qos":"0","retain":"","broker":"de5e8b6d.d98b68","x":847.7777404785156,"y":56.666669845581055,"wires":[]},{"id":"5062e327.63ec8c","type":"comment","z":"87526546.9e5728","name":"Impersonate publication OK as RPI1 is allowed to publish on any topic","info":"","x":713.8888549804688,"y":203.33333587646484,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"d94d23c8.62bce","type":"comment","z":"87526546.9e5728","name":"Impersonate publication KO=> will disconnect RPI2 client","info":"","x":757.7779083251953,"y":544.4445266723633,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"2cdc514c.bacdae","type":"comment","z":"87526546.9e5728","name":"No constraints on subscriptions","info":"","x":135,"y":560.0001029968262,"wires":[]},{"id":"cdc64270.e0ce2","type":"comment","z":"87526546.9e5728","name":"'All' policy on RPI1 & RPI2","info":"","x":115,"y":20,"wires":[]},{"id":"3fa5d5be.3fc69a","type":"comment","z":"87526546.9e5728","name":"Connection & Publication constraints on RPI2 : Publish & Subscibe Policy","info":"","x":265,"y":242.22221660614014,"wires":[]},{"id":"adf554bf.7f7f38","type":"mqtt out","z":"87526546.9e5728","name":"Connect from RPI2 as fake RPI1:RPI/RPI1/Test","topic":"RPI/RPI1/Test","qos":"0","retain":"","broker":"502fbdc.2b38744","x":782.7777557373047,"y":324.4444522857666,"wires":[]},{"id":"ca246eb1.1f28f","type":"comment","z":"87526546.9e5728","name":"Impersonate connection KO as thing name doesn't match client ID","info":"","x":734.4444885253906,"y":371.11119174957275,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"a1a22d8d.44a68","type":"inject","z":"291195f6.c56a3a","name":"","topic":"LED OFF","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":150,"y":200,"wires":[["473c045a.2da90c","1632d365.2c232d"]]},{"id":"473c045a.2da90c","type":"debug","z":"291195f6.c56a3a","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":890,"y":200,"wires":[],"inputLabels":["msg.payload"]},{"id":"e32fae0b.80b95","type":"inject","z":"291195f6.c56a3a","name":"","topic":"LED ON","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":260,"wires":[["1632d365.2c232d","473c045a.2da90c"]]},{"id":"1632d365.2c232d","type":"rpi-gpio out","z":"291195f6.c56a3a","name":"Led on GPIO18","pin":"12","set":false,"level":"0","freq":"","out":"out","x":900,"y":260,"wires":[]},{"id":"7729bb04.f25004","type":"function","z":"a3e9cca0.9f2cf","name":"Switch LED state","func":"\ncontext.state = context.state || 0;\n\n(context.state === 0) ? context.state = 1 : context.state = 0;\nmsg.payload = context.state;\n\nreturn msg;","outputs":1,"noerr":0,"x":558.0000076293945,"y":239.00000667572021,"wires":[["ae27e10e.61c81","44b04e32.300fb"]]},{"id":"534ec465.57ea5c","type":"inject","z":"a3e9cca0.9f2cf","name":"chaque seconde","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"onceDelay":"","x":178.00000762939453,"y":299.0000066757202,"wires":[[]]},{"id":"f44c457.380d5b8","type":"inject","z":"a3e9cca0.9f2cf","name":"","topic":"LED OFF","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":158.00000762939453,"y":139.00000667572021,"wires":[["44b04e32.300fb","ae27e10e.61c81"]]},{"id":"44b04e32.300fb","type":"debug","z":"a3e9cca0.9f2cf","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":878.0000076293945,"y":119.00000667572021,"wires":[],"inputLabels":["msg.payload"]},{"id":"6d904c4d.5c3734","type":"inject","z":"a3e9cca0.9f2cf","name":"","topic":"LED ON","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":148.00000762939453,"y":179.00000667572021,"wires":[["ae27e10e.61c81","44b04e32.300fb"]]},{"id":"ae27e10e.61c81","type":"rpi-gpio out","z":"a3e9cca0.9f2cf","name":"Led on GPIO18","pin":"12","set":false,"level":"0","freq":"","out":"out","x":888.0000076293945,"y":179.00000667572021,"wires":[]},{"id":"1125d07c.70291","type":"inject","z":"a3e9cca0.9f2cf","name":"","topic":"SWITCH LED","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":168.00000762939453,"y":239.00000667572021,"wires":[["7729bb04.f25004"]]},{"id":"4dac946f.32f09c","type":"rpi-gpio in","z":"ec50e367.467d4","name":"BTN on GPIO4","pin":"7","intype":"up","debounce":"25","read":true,"x":320,"y":300,"wires":[["9474c192.66e2e"]]},{"id":"9474c192.66e2e","type":"debug","z":"ec50e367.467d4","name":"Button value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":750,"y":300,"wires":[],"inputLabels":["msg.payload"]},{"id":"314d89d1.fa1436","type":"rpi-gpio in","z":"1b291fb1.3ef12","name":"BTN on GPIO4","pin":"7","intype":"up","debounce":"25","read":true,"x":360,"y":200,"wires":[["cbd1c4de.05ea48"]]},{"id":"cbd1c4de.05ea48","type":"rpi-gpio out","z":"1b291fb1.3ef12","name":"Led on GPIO18","pin":"12","set":false,"level":"0","freq":"","out":"out","x":740,"y":200,"wires":[]},{"id":"f8dfba04.8e3528","type":"function","z":"d7f5c745.30fbf8","name":"Switch LED state","func":"context.state = context.state || 0;\n\n(context.state === 0) ? context.state = 1 : context.state = 0;\nmsg.payload = context.state;\n\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":220,"wires":[["5de78698.716458","341f73c0.2e04fc"]]},{"id":"15969c4e.1c5fb4","type":"inject","z":"d7f5c745.30fbf8","name":"SWITCH LED","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"onceDelay":"","x":220,"y":260,"wires":[[]]},{"id":"fe388826.e57908","type":"inject","z":"d7f5c745.30fbf8","name":"","topic":"LED OFF","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":210,"y":120,"wires":[["341f73c0.2e04fc","5de78698.716458"]]},{"id":"341f73c0.2e04fc","type":"debug","z":"d7f5c745.30fbf8","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":930,"y":100,"wires":[],"inputLabels":["msg.payload"]},{"id":"221f5bd1.4f6b44","type":"inject","z":"d7f5c745.30fbf8","name":"","topic":"LED ON","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":200,"y":160,"wires":[["5de78698.716458","341f73c0.2e04fc"]]},{"id":"5de78698.716458","type":"rpi-gpio out","z":"d7f5c745.30fbf8","name":"Led on GPIO18","pin":"12","set":false,"level":"0","freq":"","out":"out","x":940,"y":160,"wires":[]},{"id":"85a8d9f5.1acdd8","type":"rpi-gpio in","z":"d7f5c745.30fbf8","name":"BTN on GPIO4","pin":"7","intype":"up","debounce":"25","read":true,"x":220,"y":340,"wires":[["565e7034.33ad6"]]},{"id":"12722f95.67c7b","type":"inject","z":"d7f5c745.30fbf8","name":"SWITCH LED","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":210,"y":220,"wires":[["f8dfba04.8e3528"]]},{"id":"5de97d95.0996b4","type":"function","z":"d7f5c745.30fbf8","name":"If button down","func":"if (msg.payload===0)\n    return msg;\n    \nreturn  null;","outputs":1,"noerr":0,"x":440,"y":340,"wires":[[]]},{"id":"565e7034.33ad6","type":"switch","z":"d7f5c745.30fbf8","name":"If button down","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":440,"y":300,"wires":[["f8dfba04.8e3528"],[]]},{"id":"f9a099e4.358278","type":"function","z":"5a858abd.8e0534","name":"Set LED state OFF","func":"var currentLedState = flow.get(\"LEDState\")||0;\nif (currentLedState===0)\n    return null;\n    \nledState = 0;\nmsg.payload = 0;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"noerr":0,"x":630,"y":140,"wires":[["6b889c92.524764"]]},{"id":"daf6fcea.358ef","type":"function","z":"5a858abd.8e0534","name":"Set LED state ON","func":"currentLedState = flow.get(\"LEDState\")||0;\n\nif (currentLedState==1)\n        return null;\n\nledState = 1;\n\nmsg.payload = 1;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":180,"wires":[["6b889c92.524764"]]},{"id":"6b889c92.524764","type":"change","z":"5a858abd.8e0534","name":"Dispatch","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":840,"y":160,"wires":[["d32ab892.80aae8","4296ce48.185f3"]]},{"id":"a26c7626.823178","type":"function","z":"5a858abd.8e0534","name":"Switch LED state","func":"ledState=flow.get(\"LEDState\")||0;\n\n(ledState === 0) ? ledState = 1 : ledState = 0;\nif (ledState==1)\n    msg.payload = 1;\nelse\n    msg.payload=0;\n    \nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"noerr":0,"x":630,"y":240,"wires":[["6b889c92.524764"]]},{"id":"48b1bd03.61b514","type":"inject","z":"5a858abd.8e0534","name":"SWITCH LED","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"onceDelay":"","x":200,"y":280,"wires":[[]]},{"id":"d2b2a271.0b85b","type":"inject","z":"5a858abd.8e0534","name":"LED OFF","topic":"","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":140,"wires":[["f9a099e4.358278"]]},{"id":"d32ab892.80aae8","type":"debug","z":"5a858abd.8e0534","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":1030,"y":120,"wires":[],"inputLabels":["msg.payload"]},{"id":"b2113d67.603db","type":"inject","z":"5a858abd.8e0534","name":"LED ON","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":180,"wires":[["daf6fcea.358ef"]]},{"id":"4296ce48.185f3","type":"rpi-gpio out","z":"5a858abd.8e0534","name":"Led on GPIO18","pin":"12","set":false,"level":"0","freq":"","out":"out","x":1040,"y":180,"wires":[]},{"id":"f77ed20f.fb342","type":"rpi-gpio in","z":"5a858abd.8e0534","name":"BTN on GPIO4","pin":"7","intype":"up","debounce":"25","read":true,"x":200,"y":360,"wires":[["2f590e54.dcda72"]]},{"id":"c0e4deea.584bf","type":"inject","z":"5a858abd.8e0534","name":"SWITCH LED","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":190,"y":240,"wires":[["a26c7626.823178"]]},{"id":"c5bbcbe4.7dfe28","type":"function","z":"5a858abd.8e0534","name":"If button down","func":"if (msg.payload===0)\n    return msg;\n    \nreturn  null;","outputs":1,"noerr":0,"x":420,"y":360,"wires":[[]]},{"id":"2f590e54.dcda72","type":"switch","z":"5a858abd.8e0534","name":"If button down","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":420,"y":320,"wires":[["a26c7626.823178"],[]]},{"id":"aee3a688.5348d8","type":"function","z":"557915bd.b9a3dc","name":"save state","func":"\nflow.set(\"LEDState\", msg.payload);\nreturn msg;\n\n","outputs":1,"noerr":0,"x":630,"y":260,"wires":[["7a02b9d.f0c0248"]]},{"id":"7a02b9d.f0c0248","type":"change","z":"557915bd.b9a3dc","name":"Dispatch","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":280,"wires":[["d518dacc.28b668","587c3853.acfef8"]]},{"id":"cd30415b.91d64","type":"function","z":"557915bd.b9a3dc","name":"Switch LED state","func":"ledState=flow.get(\"LEDState\")||0;\n\n(ledState === 0) ? ledState = 1 : ledState = 0;\nif (ledState==1)\n    msg.payload = 100;\nelse\n    msg.payload=0;\n    \nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":360,"wires":[["7a02b9d.f0c0248"]]},{"id":"298d9bc7.119b54","type":"inject","z":"557915bd.b9a3dc","name":"SWITCH LED","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"onceDelay":"","x":220,"y":400,"wires":[[]]},{"id":"996bfefc.13406","type":"inject","z":"557915bd.b9a3dc","name":"LED OFF","topic":"","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":200,"y":260,"wires":[["aee3a688.5348d8"]]},{"id":"d518dacc.28b668","type":"debug","z":"557915bd.b9a3dc","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":1050,"y":240,"wires":[],"inputLabels":["msg.payload"]},{"id":"a4e667d1.85e568","type":"inject","z":"557915bd.b9a3dc","name":"LED ON","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":200,"y":300,"wires":[["aee3a688.5348d8"]]},{"id":"587c3853.acfef8","type":"rpi-gpio out","z":"557915bd.b9a3dc","name":"Led on GPIO18","pin":"12","set":false,"level":"0","freq":"","out":"pwm","x":1060,"y":300,"wires":[]},{"id":"883ac8e9.b99798","type":"rpi-gpio in","z":"557915bd.b9a3dc","name":"BTN on GPIO4","pin":"7","intype":"up","debounce":"25","read":true,"x":220,"y":480,"wires":[["52997280.1f607c"]]},{"id":"347d3bc9.42c9a4","type":"inject","z":"557915bd.b9a3dc","name":"SWITCH LED","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":210,"y":360,"wires":[["cd30415b.91d64"]]},{"id":"595c83ca.dd00fc","type":"function","z":"557915bd.b9a3dc","name":"If button down","func":"if (msg.payload===0)\n    return msg;\n    \nreturn  null;","outputs":1,"noerr":0,"x":440,"y":480,"wires":[[]]},{"id":"52997280.1f607c","type":"switch","z":"557915bd.b9a3dc","name":"If button down","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":440,"y":440,"wires":[["cd30415b.91d64"],[]]},{"id":"71f0d8f4.f86888","type":"function","z":"d67507fd.920a88","name":"Set LED state OFF","func":"var currentLedState = flow.get(\"LEDState\")||0;\nif (currentLedState===0)\n    return null;\n    \nledState = 0;\nmsg.payload = 0;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"noerr":0,"x":650,"y":280,"wires":[["ce3ab7a6.51f7c8"]]},{"id":"6cda789f.faacf8","type":"function","z":"d67507fd.920a88","name":"Set LED state ON","func":"currentLedState = flow.get(\"LEDState\")||0;\n\nif (currentLedState==1)\n        return null;\n\nledState = 1;\n\nmsg.payload = 100;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":320,"wires":[["ce3ab7a6.51f7c8"]]},{"id":"ce3ab7a6.51f7c8","type":"change","z":"d67507fd.920a88","name":"Dispatch","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":300,"wires":[["e571380c.0fa008","468138b5.46a9c8","f7378090.cc42a","7539c58b.e0125c"]]},{"id":"cacdccd0.8fd78","type":"function","z":"d67507fd.920a88","name":"Switch LED state","func":"ledState=flow.get(\"LEDState\")||0;\n\n(ledState === 0) ? ledState = 1 : ledState = 0;\nif (ledState==1)\n    msg.payload = 100;\nelse\n    msg.payload=0;\n    \nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":380,"wires":[["ce3ab7a6.51f7c8"]]},{"id":"4c2f4492.644c0c","type":"inject","z":"d67507fd.920a88","name":"SWITCH LED","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"onceDelay":"","x":120,"y":420,"wires":[[]]},{"id":"aca48454.dffa58","type":"inject","z":"d67507fd.920a88","name":"LED OFF","topic":"","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":100,"y":280,"wires":[["71f0d8f4.f86888"]]},{"id":"e571380c.0fa008","type":"debug","z":"d67507fd.920a88","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":1050,"y":260,"wires":[],"inputLabels":["msg.payload"]},{"id":"f9b69b60.cc5138","type":"inject","z":"d67507fd.920a88","name":"LED ON","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":100,"y":320,"wires":[["6cda789f.faacf8"]]},{"id":"468138b5.46a9c8","type":"rpi-gpio out","z":"d67507fd.920a88","name":"Led on GPIO18","pin":"12","set":false,"level":"0","freq":"","out":"pwm","x":1060,"y":320,"wires":[]},{"id":"eec95aa4.0e8498","type":"rpi-gpio in","z":"d67507fd.920a88","name":"BTN on GPIO4","pin":"7","intype":"up","debounce":"25","read":true,"x":120,"y":500,"wires":[["e592c43b.555158"]]},{"id":"a2cb6c15.63e8c","type":"inject","z":"d67507fd.920a88","name":"SWITCH LED","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":110,"y":380,"wires":[["cacdccd0.8fd78"]]},{"id":"5ac4a62e.32a8b8","type":"function","z":"d67507fd.920a88","name":"If button down","func":"if (msg.payload===0)\n    return msg;\n    \nreturn  null;","outputs":1,"noerr":0,"x":340,"y":500,"wires":[[]]},{"id":"e592c43b.555158","type":"switch","z":"d67507fd.920a88","name":"If button down","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":340,"y":460,"wires":[["cacdccd0.8fd78"],[]]},{"id":"f7378090.cc42a","type":"mqtt out","z":"d67507fd.920a88","name":"Publish MyLEDState","topic":"RPI/RPI1/MyLEDState","qos":"","retain":"","broker":"5e96290d.916808","x":1080,"y":200,"wires":[]},{"id":"e8d943f5.0f432","type":"mqtt in","z":"d67507fd.920a88","name":"","topic":"RPI/RPI1/MyLEDCommand","qos":"2","datatype":"auto","broker":"5e96290d.916808","x":160,"y":120,"wires":[["cb4abda9.7d974","60d96e87.3428d"]]},{"id":"cb4abda9.7d974","type":"switch","z":"d67507fd.920a88","name":"Parse command","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"LED_OFF","vt":"str"},{"t":"eq","v":"LED_ON","vt":"str"},{"t":"eq","v":"LED_SWITCH","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":4,"x":400,"y":120,"wires":[["71f0d8f4.f86888"],["6cda789f.faacf8"],["cacdccd0.8fd78"],[]]},{"id":"60d96e87.3428d","type":"debug","z":"d67507fd.920a88","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":390,"y":180,"wires":[]},{"id":"e9e7a484.fe5d48","type":"ui_slider","z":"2bbfd6b4.0796aa","name":"","label":"slider","tooltip":"","group":"bd4b99eb.217178","order":7,"width":0,"height":0,"passthru":true,"outs":"all","topic":"","min":0,"max":"100","step":"10","x":610,"y":280,"wires":[["d1b1e318.b6124","d9707b06.226488","571434f0.b592fc"]]},{"id":"d7ce70be.0a2dc","type":"ui_gauge","z":"2bbfd6b4.0796aa","name":"","group":"bd4b99eb.217178","order":10,"width":0,"height":0,"gtype":"gage","title":"gauge","label":"units","format":"{{value}}","min":0,"max":"100","colors":["#00B500","#E6E600","#CA3838"],"seg1":"","seg2":"","x":330,"y":80,"wires":[]},{"id":"8a3c5f68.a0ec8","type":"ui_chart","z":"2bbfd6b4.0796aa","name":"","group":"bd4b99eb.217178","order":12,"width":0,"height":0,"label":"chart","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"60","cutout":0,"useOneColor":false,"colors":["#1F77B4","#AEC7E8","#FF7F0E","#2CA02C","#98DF8A","#D62728","#FF9896","#9467BD","#C5B0D5"],"useOldStyle":false,"outputs":2,"x":330,"y":120,"wires":[[],[]]},{"id":"d1b1e318.b6124","type":"ui_text_input","z":"2bbfd6b4.0796aa","name":"","label":"Select a value","tooltip":"","group":"bd4b99eb.217178","order":5,"width":0,"height":0,"passthru":true,"mode":"text","delay":300,"topic":"","x":360,"y":280,"wires":[["e9e7a484.fe5d48"]]},{"id":"d9707b06.226488","type":"mqtt out","z":"2bbfd6b4.0796aa","name":"Change LED power","topic":"RPI/RPI1/MyLEDPower","qos":"","retain":"","broker":"5e96290d.916808","x":810,"y":400,"wires":[]},{"id":"a834c942.427548","type":"mqtt in","z":"2bbfd6b4.0796aa","name":"","topic":"RPI/RPI1/MyLEDState","qos":"2","broker":"5e96290d.916808","x":123,"y":79.00000095367432,"wires":[["d7ce70be.0a2dc","8a3c5f68.a0ec8","f4615a95.a9dd18","d1b1e318.b6124"]]},{"id":"f4615a95.a9dd18","type":"debug","z":"2bbfd6b4.0796aa","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","x":340,"y":180,"wires":[]},{"id":"571434f0.b592fc","type":"debug","z":"2bbfd6b4.0796aa","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":780,"y":360,"wires":[]},{"id":"2924744.cc5ec8c","type":"mqtt out","z":"849fc2bb.4b022","name":"shiftr.io","topic":"","qos":"","retain":"","broker":"169b1c74.dbd4e4","x":720,"y":240,"wires":[]},{"id":"1a2f26a0.38d0a9","type":"function","z":"849fc2bb.4b022","name":"Rate Limiter 100ms","func":"\nvar interval = 100; // minimum interval between messages (ms)\ncontext.lastTime = context.lastTime || 0;\n\nvar now = Date.now();\n\nif (context.lastTime===0)\n{\n    context.lastTime = now;\n    return null;\n}\n\n\nif (now-context.lastTime > interval) {\n  context.lastTime = now;\n  return msg;\n} else {\n  return null;\n}","outputs":1,"noerr":0,"x":490,"y":260,"wires":[["2924744.cc5ec8c","94376f19.7fcdc"]]},{"id":"94376f19.7fcdc","type":"debug","z":"849fc2bb.4b022","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":730,"y":320,"wires":[]},{"id":"78f775ee.65ff0c","type":"mqtt in","z":"849fc2bb.4b022","name":"","topic":"FisherHouse/#","qos":"0","datatype":"auto","broker":"2fc6eb97.8750e4","x":221.11112213134766,"y":307.7777900695801,"wires":[["9ee66e8e.2b98f"]]},{"id":"40c39958.c72808","type":"inject","z":"fc93d78f.1f92d8","name":"","topic":"RPI/RPI1/Test","payload":"{\"value\":\"1\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":230,"y":260,"wires":[["4862e2e1.63c1cc"]]},{"id":"4862e2e1.63c1cc","type":"mqtt out","z":"fc93d78f.1f92d8","name":"","topic":"RPI/RPI1/Test","qos":"0","retain":"","broker":"de5e8b6d.d98b68","x":435,"y":260,"wires":[],"l":false},{"id":"e93121fb.3cb6c","type":"debug","z":"fc93d78f.1f92d8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":490,"y":340,"wires":[]},{"id":"15776c.ca587894","type":"inject","z":"145f19d3.21f876","name":"","topic":"RPI/Test","payload":"{\"value\":\"1\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":360,"y":220,"wires":[["4676495f.5e6068"]]},{"id":"4676495f.5e6068","type":"mqtt out","z":"145f19d3.21f876","name":"","topic":"RPI/Test","qos":"1","retain":"","broker":"de5e8b6d.d98b68","x":620,"y":220,"wires":[]},{"id":"258d8cc8.b79614","type":"mqtt in","z":"145f19d3.21f876","name":"","topic":"RPI/Test","qos":"1","datatype":"auto","broker":"de5e8b6d.d98b68","x":310,"y":300,"wires":[["621da404.6a832c"]]},{"id":"621da404.6a832c","type":"debug","z":"145f19d3.21f876","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":630,"y":300,"wires":[]},{"id":"c1cf3b0c.fc90f8","type":"inject","z":"6bc95f22.c5c54","name":"","topic":"RPI/RPI1/Test","payload":"{\"value\":\"101\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":220,"y":140,"wires":[["8fe63c58.d9fed"]]},{"id":"8fe63c58.d9fed","type":"mqtt out","z":"6bc95f22.c5c54","name":"","topic":"RPI/RPI1/Test","qos":"0","retain":"","broker":"de5e8b6d.d98b68","x":500,"y":100,"wires":[]},{"id":"86a6bd91.98952","type":"mqtt in","z":"6bc95f22.c5c54","name":"","topic":"RPI/RPI1/Test","qos":"1","broker":"de5e8b6d.d98b68","x":158.8888931274414,"y":220.0000057220459,"wires":[["d9f26fa1.8be36"]]},{"id":"d9f26fa1.8be36","type":"debug","z":"6bc95f22.c5c54","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":470,"y":220,"wires":[]},{"id":"71c62c5d.b3ddb4","type":"inject","z":"6bc95f22.c5c54","name":"","topic":"RPI/RPI1/Test","payload":"{\"value\":\"1\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":210,"y":60,"wires":[["8fe63c58.d9fed"]]},{"id":"5be9d7e8.5f9658","type":"mqtt in","z":"6bc95f22.c5c54","name":"","topic":"RPI/Alert","qos":"1","broker":"de5e8b6d.d98b68","x":151,"y":300,"wires":[["8d92eb4f.ec78f8"]]},{"id":"8d92eb4f.ec78f8","type":"debug","z":"6bc95f22.c5c54","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":470,"y":300,"wires":[]},{"id":"8ce2a2b5.a7076","type":"inject","z":"6bc95f22.c5c54","name":"","topic":"RPI/RPI1/Test","payload":"{\"value\":\"81\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":220,"y":100,"wires":[["8fe63c58.d9fed"]]},{"id":"cbdcb595.8e1d28","type":"delay","z":"d67507fd.920a88","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":680,"y":500,"wires":[[]]},{"id":"13df88aa.af98b7","type":"delay","z":"d67507fd.920a88","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"10","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":640,"y":600,"wires":[[]]},{"id":"9ee66e8e.2b98f","type":"delay","z":"849fc2bb.4b022","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"5","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":467.7777786254883,"y":308.88890266418457,"wires":[["94376f19.7fcdc","2924744.cc5ec8c"]]},{"id":"e6ac907.986867","type":"mqtt in","z":"862af712.0c0838","name":"","topic":"RPI/+/MyLEDState","qos":"2","datatype":"auto","broker":"5e96290d.916808","x":190,"y":200,"wires":[["994db83f.aca868","217d9364.c17bbc","8c25ff66.697"]]},{"id":"217d9364.c17bbc","type":"switch","z":"862af712.0c0838","name":"Which RPI","property":"topic","propertyType":"msg","rules":[{"t":"regex","v":"^RPI/RPI244","vt":"str","case":false},{"t":"regex","v":"^RPI/RPI246","vt":"str","case":false},{"t":"regex","v":"^RPI/RPI243","vt":"str","case":false},{"t":"regex","v":"^RPI/RPI4","vt":"str","case":false}],"checkall":"true","repair":false,"outputs":4,"x":410,"y":200,"wires":[["a7929311.642b5"],["beca7157.85aec"],["7b3f46b.b1120b8"],["ed6998a8.3318b8"]]},{"id":"a7929311.642b5","type":"ui_text","z":"862af712.0c0838","group":"2fd691e9.6d64de","order":1,"width":0,"height":0,"name":"","label":"RPI 1 LED is ","format":"{{msg.payload}}%","layout":"row-spread","x":610,"y":140,"wires":[]},{"id":"994db83f.aca868","type":"debug","z":"862af712.0c0838","name":"","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"true","targetType":"full","x":390,"y":40,"wires":[]},{"id":"8c25ff66.697","type":"debug","z":"862af712.0c0838","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"topic","x":400,"y":80,"wires":[]},{"id":"beca7157.85aec","type":"ui_text","z":"862af712.0c0838","group":"2fd691e9.6d64de","order":3,"width":0,"height":0,"name":"","label":"RPI 2 LED is ","format":"{{msg.payload}}%","layout":"row-spread","x":610,"y":180,"wires":[]},{"id":"7b3f46b.b1120b8","type":"ui_text","z":"862af712.0c0838","group":"2fd691e9.6d64de","order":5,"width":0,"height":0,"name":"","label":"RPI 3 LED is ","format":"{{msg.payload}}%","layout":"row-spread","x":610,"y":220,"wires":[]},{"id":"ed6998a8.3318b8","type":"ui_text","z":"862af712.0c0838","group":"2fd691e9.6d64de","order":7,"width":0,"height":0,"name":"","label":"RPI 4 LED is ","format":"{{msg.payload}}%","layout":"row-spread","x":610,"y":260,"wires":[]},{"id":"27b46d9b.b533a2","type":"ui_button","z":"862af712.0c0838","name":"","group":"fc2bfb8d.9e67f8","order":1,"width":0,"height":0,"passthru":false,"label":"ALL OFF","tooltip":"","color":"","bgcolor":"RED","icon":"","payload":"LED_OFF","payloadType":"str","topic":"","x":740,"y":320,"wires":[["27f44d2c.7f6792"]]},{"id":"11d0bdb7.088b02","type":"ui_button","z":"862af712.0c0838","name":"","group":"2fd691e9.6d64de","order":2,"width":0,"height":0,"passthru":false,"label":"Switch","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"RPI/RPI243/MyLEDCommand","x":750,"y":140,"wires":[["589ad70b.03f468"]]},{"id":"cc6443f4.34ad9","type":"mqtt out","z":"862af712.0c0838","name":"Publish","topic":"","qos":"","retain":"","broker":"5e96290d.916808","x":1220,"y":260,"wires":[]},{"id":"589ad70b.03f468","type":"change","z":"862af712.0c0838","name":"Set Command LED_SWITCH","rules":[{"t":"set","p":"payload","pt":"msg","to":"LED_SWITCH","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":990,"y":200,"wires":[["cc6443f4.34ad9"]]},{"id":"eabd6efc.9ca36","type":"ui_button","z":"862af712.0c0838","name":"","group":"2fd691e9.6d64de","order":4,"width":0,"height":0,"passthru":false,"label":"Switch","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"RPI/RPI244/MyLEDCommand","x":750,"y":180,"wires":[["589ad70b.03f468"]]},{"id":"27f44d2c.7f6792","type":"function","z":"862af712.0c0838","name":"NOTIFY ALL","func":"var msg1={}, msg2={}, msg3={}, msg4={}\nmsg1.payload=msg.payload\nmsg1.topic=\"RPI/RPI243/MyLEDCommand\"\n\nmsg2.payload=msg.payload\nmsg2.topic=\"RPI/RPI244/MyLEDCommand\"\n\nmsg3.payload=msg.payload\nmsg3.topic=\"RPI/RPI246/MyLEDCommand\"\n\nmsg4.payload=msg.payload\nmsg4.topic=\"RPI/RPI4/MyLEDCommand\"\n\nreturn  [msg1,msg2,msg3,msg4]\n","outputs":4,"noerr":0,"x":1050,"y":320,"wires":[["cc6443f4.34ad9"],["cc6443f4.34ad9"],["cc6443f4.34ad9"],["cc6443f4.34ad9"]]},{"id":"22e60fe0.3baf3","type":"ui_button","z":"862af712.0c0838","name":"","group":"2fd691e9.6d64de","order":6,"width":0,"height":0,"passthru":false,"label":"Switch","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"RPI/RPI246/MyLEDCommand","x":750,"y":220,"wires":[["589ad70b.03f468"]]},{"id":"c6d83b87.ce1fa8","type":"ui_button","z":"862af712.0c0838","name":"","group":"2fd691e9.6d64de","order":8,"width":0,"height":0,"passthru":false,"label":"Switch","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"RPI/RPI4/MyLEDCommand","x":750,"y":260,"wires":[["589ad70b.03f468"]]},{"id":"768adc7.a66eb24","type":"debug","z":"6bc95f22.c5c54","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":470,"y":380,"wires":[]},{"id":"639dd544.f6a9dc","type":"mqtt in","z":"6bc95f22.c5c54","name":"","topic":"RPI/Alert2","qos":"1","broker":"de5e8b6d.d98b68","x":151,"y":380,"wires":[["768adc7.a66eb24"]]},{"id":"6040c00a.0ad51","type":"inject","z":"fd7b7375.ee446","name":"Start Subscribe","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"","x":120,"y":400,"wires":[["730e5bc.be430a4"]]},{"id":"b1778b65.a3c828","type":"debug","z":"fd7b7375.ee446","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","x":680,"y":400,"wires":[]},{"id":"6f4fb17d.81d59","type":"debug","z":"fd7b7375.ee446","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","x":660,"y":200,"wires":[]},{"id":"973ea794.5b6208","type":"inject","z":"fd7b7375.ee446","name":"","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"","x":90,"y":159.00000190734863,"wires":[["958e412.16ad4c"]]},{"id":"75cd9b53.65a914","type":"inject","z":"fd7b7375.ee446","name":"","topic":"","payload":"LED_ON","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"","x":100,"y":240,"wires":[["4b9ee9db.054ae8"]]},{"id":"47bfe75.4cab918","type":"inject","z":"fd7b7375.ee446","name":"","topic":"","payload":"LED_OFF","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"","x":100,"y":280,"wires":[["4b9ee9db.054ae8"]]},{"id":"ec03e0be.bde1a","type":"inject","z":"fd7b7375.ee446","name":"","topic":"","payload":"INIT","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"","x":90,"y":80,"wires":[["b72cb58d.7ea428"]]},{"id":"a345b9f1.323d18","type":"comment","z":"fd7b7375.ee446","name":"!! Click here once to create topic on local coapserver.py (ensure coappserver.py is running on default port 5683","info":"","x":390,"y":40,"wires":[]},{"id":"d7f24b31.907998","type":"comment","z":"fd7b7375.ee446","name":"Unitary PUT / GET","info":"","x":106,"y":123.00000190734863,"wires":[]},{"id":"2951debc.a2da42","type":"comment","z":"fd7b7375.ee446","name":"Subscription via Observe","info":"","x":130,"y":360,"wires":[]},{"id":"ad7f06a8.0c59d8","type":"debug","z":"31505c05.967164","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"req.payload","x":390,"y":340,"wires":[]},{"id":"85ef3a06.c68818","type":"inject","z":"31505c05.967164","name":"","topic":"","payload":"LED_ON","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"","x":140,"y":140,"wires":[["45218a58.27c474"]]},{"id":"dac4fa34.398f48","type":"inject","z":"31505c05.967164","name":"","topic":"","payload":"LED_OFF","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"","x":140,"y":180,"wires":[["45218a58.27c474"]]},{"id":"472c569e.a52e78","type":"switch","z":"31505c05.967164","name":"Parse command","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"LED_OFF","vt":"str"},{"t":"eq","v":"LED_ON","vt":"str"},{"t":"eq","v":"LED_SWITCH","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":4,"x":600,"y":520,"wires":[["6bc93800.8b93a8"],["d406e61a.bd5ee8"],[],[]]},{"id":"6bc93800.8b93a8","type":"function","z":"31505c05.967164","name":"Set LED state OFF","func":"var currentLedState = flow.get(\"LEDState\")||0;\nif (currentLedState===0)\n    return null;\n    \nledState = 0;\nmsg.payload = ledState;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"noerr":0,"x":850,"y":500,"wires":[["80217ef5.e3cb7"]]},{"id":"d406e61a.bd5ee8","type":"function","z":"31505c05.967164","name":"Set LED state ON","func":"currentLedState = flow.get(\"LEDState\")||0;\nledPower=flow.get(\"LEDPower\")||0;\n\nif (currentLedState==1)\n    if (ledPower==100)\n        return null;\n    else\n        ledPower=100;\n\nledState = 1;\nif (ledPower===0)\n    ledPower=100;\n    \nmsg.payload = ledPower;\n\nflow.set(\"LEDState\", ledState);\nflow.set(\"LEDPower\", ledPower);\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":540,"wires":[["80217ef5.e3cb7"]]},{"id":"80217ef5.e3cb7","type":"change","z":"31505c05.967164","name":"Dispatch","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1040,"y":520,"wires":[["c52aa6ba.e64b28","185e2e99.dada51"]]},{"id":"185e2e99.dada51","type":"rpi-gpio out","z":"31505c05.967164","name":"LED on GPIO18","pin":"12","set":false,"level":"0","freq":"","out":"pwm","x":1220,"y":480,"wires":[]},{"id":"c52aa6ba.e64b28","type":"debug","z":"31505c05.967164","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":1210,"y":540,"wires":[],"inputLabels":["msg.payload"]},{"id":"9b61fe8c.8ece4","type":"function","z":"31505c05.967164","name":"BufferToString","func":"msg.payload=msg.req.payload.toString();\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":400,"wires":[["472c569e.a52e78","f5d86757.304858"]]},{"id":"f5d86757.304858","type":"debug","z":"31505c05.967164","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"req.payload","x":610,"y":400,"wires":[]},{"id":"30f044bd.62e3bc","type":"comment","z":"31505c05.967164","name":"Add this to your MQTT flow","info":"","x":170,"y":260,"wires":[]},{"id":"70636f6b.25f8c","type":"comment","z":"31505c05.967164","name":"..............................  Existing MQTT Flow.....................................","info":"","x":750,"y":460,"wires":[]},{"id":"b648298.e3ad9d8","type":"comment","z":"31505c05.967164","name":"Copy and update this to your MQTT flow","info":"","x":220,"y":60,"wires":[]},{"id":"66dc04b6.82720c","type":"function","z":"31505c05.967164","name":"Responder","func":"currentLedState = flow.get(\"LEDState\")||0;\ncurrentLedPower = flow.get(\"LEDPower\")||0;\n\nif (currentLedState===0)\n    msg.res.end(\"0\");\nelse\n    msg.res.end(currentLedPower.toString());\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":300,"wires":[[]]},{"id":"2606053b.4b0b4a","type":"debug","z":"31505c05.967164","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","x":730.0000076293945,"y":100.00000190734863,"wires":[]},{"id":"6beea1ea.8e6de","type":"inject","z":"31505c05.967164","name":"","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"","x":130,"y":100,"wires":[["b915c530.8d5478"]]},{"id":"c3e8c88f.c8bc88","type":"coap in","z":"31505c05.967164","method":"POST","name":"","server":"7d400227.ba488c","url":"/storage/LED","x":160,"y":340,"wires":[["ad7f06a8.0c59d8","9b61fe8c.8ece4","bba22d14.f8d65"]]},{"id":"d31e8518.97b688","type":"coap in","z":"31505c05.967164","method":"PUT","name":"","server":"7d400227.ba488c","url":"/storage/LED","x":150,"y":380,"wires":[["ad7f06a8.0c59d8","9b61fe8c.8ece4","bba22d14.f8d65"]]},{"id":"bc0e35b3.4902a8","type":"coap in","z":"31505c05.967164","method":"GET","name":"","server":"7d400227.ba488c","url":"/storage/LED","x":150,"y":300,"wires":[["66dc04b6.82720c"]]},{"id":"318869e0.2ef116","type":"coap request","z":"fd7b7375.ee446","method":"GET","observe":false,"url":"coap://localhost:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"GET /storage/LED","x":410,"y":200,"wires":[["6f4fb17d.81d59"]]},{"id":"4b9ee9db.054ae8","type":"coap request","z":"fd7b7375.ee446","method":"PUT","observe":false,"url":"coap://localhost:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"PUT /storage/LED","x":410,"y":260,"wires":[[]]},{"id":"b72cb58d.7ea428","type":"coap request","z":"fd7b7375.ee446","method":"POST","observe":false,"url":"coap://localhost:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"POST /storage/LED","x":400,"y":80,"wires":[[]]},{"id":"45218a58.27c474","type":"coap request","z":"31505c05.967164","method":"PUT","observe":false,"url":"coap://127.0.0.1:55683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"PUT /storage/LED","x":450,"y":160,"wires":[[]]},{"id":"730e5bc.be430a4","type":"coap request","z":"fd7b7375.ee446","method":"GET","observe":true,"url":"coap://localhost:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"GET Observe /storage/LED","x":440,"y":400,"wires":[["b1778b65.a3c828"]]},{"id":"b915c530.8d5478","type":"coap request","z":"31505c05.967164","method":"GET","observe":true,"url":"coap://localhost:55683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"GET /storage/LED","x":450,"y":100,"wires":[["2606053b.4b0b4a"]]},{"id":"bba22d14.f8d65","type":"function","z":"31505c05.967164","name":"Responder","func":"msg.res.end();\nreturn msg;","outputs":1,"noerr":0,"x":371.111083984375,"y":529.3333129882812,"wires":[[]]},{"id":"958e412.16ad4c","type":"coap request","z":"fd7b7375.ee446","method":"GET","observe":false,"url":"coap://localhost:5683/.well-known/core","content-format":"text/plain","raw-buffer":false,"name":"GET /.well-known/core","x":419,"y":158,"wires":[["6f4fb17d.81d59"]]},{"id":"cb970838.4719f8","type":"inject","z":"fd7b7375.ee446","name":"","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"","x":90.00000381469727,"y":201.00000381469727,"wires":[["318869e0.2ef116"]]},{"id":"4c348f2.2662f7","type":"ui_button","z":"862af712.0c0838","name":"","group":"fc2bfb8d.9e67f8","order":1,"width":0,"height":0,"passthru":false,"label":"ALL ON","tooltip":"","color":"","bgcolor":"GREEN ","icon":"","payload":"LED_ON","payloadType":"str","topic":"","x":739.5999755859375,"y":364,"wires":[["27f44d2c.7f6792"]]},{"id":"c48e126a.afab3","type":"mqtt in","z":"849fc2bb.4b022","name":"","topic":"FisherSystem/#","qos":"0","datatype":"auto","broker":"2fc6eb97.8750e4","x":222.2222137451172,"y":245.55556678771973,"wires":[["9ee66e8e.2b98f"]]},{"id":"8b50a333.b54dc","type":"mqtt in","z":"fc93d78f.1f92d8","name":"","topic":"RPI/RPI1/Test","qos":"1","datatype":"auto","broker":"de5e8b6d.d98b68","x":185.5555419921875,"y":338.88887453079224,"wires":[["e93121fb.3cb6c"]]},{"id":"88ec1865.5cae78","type":"comment","z":"87526546.9e5728","name":"Real RPI1","info":"","x":106.66669845581055,"y":55.555551528930664,"wires":[]},{"id":"d94124d1.412f78","type":"comment","z":"87526546.9e5728","name":"Real RPI2","info":"","x":107.77777862548828,"y":104.44444274902344,"wires":[]},{"id":"6186a85f.221308","type":"comment","z":"87526546.9e5728","name":"RPI1 fakes RPI2 messages","info":"","x":165.5555648803711,"y":152.2222194671631,"wires":[]},{"id":"8df5dadd.85d868","type":"mqtt out","z":"87526546.9e5728","name":"from RPI2:RPI/RPI2/Test","topic":"RPI/RPI2/Test","qos":"0","retain":"","broker":"25f2c26e.622efe","x":848.8889083862305,"y":105.5555648803711,"wires":[]},{"id":"e49fec4a.db468","type":"inject","z":"87526546.9e5728","name":"","topic":"RPI/RPI2/Test","payload":"{\"value\":\"1\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":488.88890838623047,"y":105.5555648803711,"wires":[["8df5dadd.85d868"]]},{"id":"91fdbd05.1118f","type":"comment","z":"87526546.9e5728","name":"RPI2 still connecting & pubishing","info":"","x":177.7777862548828,"y":278.00000190734863,"wires":[]},{"id":"8752dfe3.0a80f","type":"comment","z":"87526546.9e5728","name":"RPI2 fakes RPI1 topic","info":"","x":151.6667022705078,"y":492.44453620910645,"wires":[]},{"id":"f95453ed.9613e","type":"comment","z":"87526546.9e5728","name":"RPI2 trying to use RPI1 as clientID","info":"","x":188.88888549804688,"y":325.7777853012085,"wires":[]},{"id":"614babe3.ff11e4","type":"mqtt out","z":"87526546.9e5728","name":"Connect from RPI1 as fake RPI2:RPI/RPI2/Test","topic":"RPI/RPI2/Test","qos":"0","retain":"","broker":"9b35ae2b.9d3fb","x":784.4443702697754,"y":405.5555648803711,"wires":[]},{"id":"70ebc1d3.3fe02","type":"comment","z":"87526546.9e5728","name":"RPI1 trying to use RPI2 as clientID","info":"","x":191.11111450195312,"y":406.6666135787964,"wires":[]},{"id":"4a9064d.fff099c","type":"comment","z":"87526546.9e5728","name":"Impersonate connection KO as thing name doesn't match client ID","info":"","x":736.6666259765625,"y":454.4444274902344,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"9f02fd2e.6e4e4","type":"mqtt out","z":"6bc95f22.c5c54","name":"","topic":"RPI/RPI3/Test","qos":"0","retain":"","broker":"ec86ade6.d9f7","x":484.4444274902344,"y":508.88885498046875,"wires":[]},{"id":"3b2d17ab.84a2f8","type":"inject","z":"6bc95f22.c5c54","name":"","topic":"RPI/RPI3/Test","payload":"{\"value\":\"1\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":204.44444274902344,"y":510.0000150203705,"wires":[["9f02fd2e.6e4e4"]]},{"id":"7283e728.4a2ae8","type":"debug","z":"6bc95f22.c5c54","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":473.33331298828125,"y":567.7777709960938,"wires":[]},{"id":"bd7452bd.82fcc","type":"mqtt in","z":"6bc95f22.c5c54","name":"","topic":"RPI/RPI3/#","qos":"1","datatype":"auto","broker":"25f2c26e.622efe","x":154.33331298828125,"y":567.7777709960938,"wires":[["7283e728.4a2ae8"]]},{"id":"44c54e90.7d5a5","type":"ui_slider","z":"9c0b8654.c93088","name":"","label":"slider","tooltip":"","group":"bd4b99eb.217178","order":7,"width":0,"height":0,"passthru":true,"outs":"all","topic":"","min":0,"max":"100","step":"10","x":610,"y":280,"wires":[["486da844.ddb508","289ed8ca.82da58","290012fe.5b032e"]]},{"id":"f553885d.7d8788","type":"ui_gauge","z":"9c0b8654.c93088","name":"","group":"bd4b99eb.217178","order":10,"width":0,"height":0,"gtype":"gage","title":"gauge","label":"units","format":"{{value}}","min":0,"max":"100","colors":["#00B500","#E6E600","#CA3838"],"seg1":"","seg2":"","x":330,"y":80,"wires":[]},{"id":"9f2d045d.d807e8","type":"ui_chart","z":"9c0b8654.c93088","name":"","group":"bd4b99eb.217178","order":12,"width":0,"height":0,"label":"chart","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"60","cutout":0,"useOneColor":false,"colors":["#1F77B4","#AEC7E8","#FF7F0E","#2CA02C","#98DF8A","#D62728","#FF9896","#9467BD","#C5B0D5"],"useOldStyle":false,"outputs":2,"x":330,"y":120,"wires":[[],[]]},{"id":"486da844.ddb508","type":"ui_text_input","z":"9c0b8654.c93088","name":"","label":"Select a value","tooltip":"","group":"bd4b99eb.217178","order":5,"width":0,"height":0,"passthru":true,"mode":"text","delay":300,"topic":"","x":360,"y":280,"wires":[["44c54e90.7d5a5"]]},{"id":"7f5ce07b.39037","type":"debug","z":"9c0b8654.c93088","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":340,"y":180,"wires":[]},{"id":"289ed8ca.82da58","type":"debug","z":"9c0b8654.c93088","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":780,"y":360,"wires":[]},{"id":"290012fe.5b032e","type":"link out","z":"9c0b8654.c93088","name":"ChangeLEDPowerFromDashboard","links":["a29cd549.33ca48"],"x":730.0000114440918,"y":205.00000286102295,"wires":[]},{"id":"8fdbac6f.d23d5","type":"function","z":"17d2a295.77e4ad","name":"Switch LED state","func":"ledState=flow.get(\"LEDState\")||0;\nledPower=flow.get(\"LEDPower\")||0;\n\n(ledState === 0) ? ledState = 1 : ledState = 0;\nif (ledState==1)\n    {\n    if (ledPower===0)\n        ledPower=100;\n    msg.payload = ledPower;\n    }\nelse\n    msg.payload=0;\n    \nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":280,"wires":[["a10c7980.ad5e58"]]},{"id":"31f17a23.f33ef6","type":"inject","z":"17d2a295.77e4ad","name":"SWITCH LED","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"onceDelay":"","x":220,"y":320,"wires":[[]]},{"id":"55a16041.b46cc","type":"debug","z":"17d2a295.77e4ad","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":1110,"y":280,"wires":[],"inputLabels":["msg.payload"]},{"id":"35c24c4a.364454","type":"inject","z":"17d2a295.77e4ad","name":"LED ON","topic":"LED ON","payload":"ledPower","payloadType":"flow","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":200,"y":220,"wires":[["66f2fc02.c7bd74"]]},{"id":"ea99cde.865833","type":"rpi-gpio out","z":"17d2a295.77e4ad","name":"LED on GPIO18","pin":"12","set":false,"level":"0","freq":"","out":"pwm","x":1120,"y":220,"wires":[]},{"id":"ecbbf5af.b3b518","type":"rpi-gpio in","z":"17d2a295.77e4ad","name":"BTN on GPIO4","pin":"7","intype":"up","debounce":"25","read":true,"x":220,"y":520,"wires":[["213aad10.3281d2"]]},{"id":"a81a4e94.68935","type":"inject","z":"17d2a295.77e4ad","name":"SWITCH LED","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":210,"y":280,"wires":[["8fdbac6f.d23d5"]]},{"id":"e896e95.4366318","type":"function","z":"17d2a295.77e4ad","name":"If button down","func":"if (msg.payload===0)\n    return msg;\n    \nreturn  null;","outputs":1,"noerr":0,"x":420,"y":560,"wires":[[]]},{"id":"213aad10.3281d2","type":"switch","z":"17d2a295.77e4ad","name":"If button down","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":420,"y":520,"wires":[["8fdbac6f.d23d5"],[]]},{"id":"66f2fc02.c7bd74","type":"function","z":"17d2a295.77e4ad","name":"Set LED state ON","func":"currentLedState = flow.get(\"LEDState\")||0;\nledPower=flow.get(\"LEDPower\")||0;\n\nif (currentLedState==1)\n    if (ledPower==100)\n        return null;\n    else\n        ledPower=100;\n\nledState = 1;\nif (ledPower===0)\n    ledPower=100;\n    \nmsg.payload = ledPower;\n\nflow.set(\"LEDState\", ledState);\nflow.set(\"LEDPower\", ledPower);\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":220,"wires":[["a10c7980.ad5e58"]]},{"id":"2997c814.4aa5c8","type":"mqtt in","z":"17d2a295.77e4ad","name":"","topic":"RPI/RPI001/MyLEDCommand","qos":"2","datatype":"auto","broker":"5e96290d.916808","x":260,"y":40,"wires":[["c8a11f6a.f83e5","5eb90b85.3f0014"]]},{"id":"54568637.12d4a8","type":"mqtt out","z":"17d2a295.77e4ad","name":"Publish MyLEDState","topic":"RPI/RPI001/MyLEDState","qos":"","retain":"","broker":"5e96290d.916808","x":1140,"y":160,"wires":[]},{"id":"c8a11f6a.f83e5","type":"switch","z":"17d2a295.77e4ad","name":"Parse command","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"LED_OFF","vt":"str"},{"t":"eq","v":"LED_ON","vt":"str"},{"t":"eq","v":"LED_SWITCH","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":4,"x":500,"y":40,"wires":[["46df3ad3.92fdf4"],["66f2fc02.c7bd74"],["8fdbac6f.d23d5"],["5605fe51.d147e"]]},{"id":"fae7f0da.04766","type":"ui_button","z":"17d2a295.77e4ad","name":"","group":"bd4b99eb.217178","order":1,"width":0,"height":0,"passthru":false,"label":"ON","tooltip":"","color":"","bgcolor":"green","icon":"","payload":"1","payloadType":"str","topic":"","x":190,"y":420,"wires":[["66f2fc02.c7bd74"]]},{"id":"409c37ca.44a0c8","type":"ui_switch","z":"17d2a295.77e4ad","name":"","label":"switch","tooltip":"","group":"bd4b99eb.217178","order":3,"width":0,"height":0,"passthru":false,"decouple":"true","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"power_settings_new","oncolor":"green","offvalue":"false","offvalueType":"bool","officon":"power_settings_new","offcolor":"red","x":190,"y":460,"wires":[["8fdbac6f.d23d5"]]},{"id":"beb16209.d73f","type":"ui_button","z":"17d2a295.77e4ad","name":"","group":"bd4b99eb.217178","order":2,"width":0,"height":0,"passthru":false,"label":"OFF","tooltip":"","color":"","bgcolor":"red","icon":"","payload":"0","payloadType":"str","topic":"","x":190,"y":380,"wires":[["46df3ad3.92fdf4"]]},{"id":"df9a1e43.8ecf5","type":"ui_text","z":"17d2a295.77e4ad","group":"bd4b99eb.217178","order":8,"width":0,"height":0,"name":"","label":"LED is ","format":"{{msg.payload}}%","layout":"row-spread","x":1090,"y":340,"wires":[]},{"id":"a10c7980.ad5e58","type":"change","z":"17d2a295.77e4ad","name":"Dispatch","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":940,"y":220,"wires":[["df9a1e43.8ecf5","55a16041.b46cc","ea99cde.865833","54568637.12d4a8","90014cdd.dc132","1a45aece.362881"]]},{"id":"5605fe51.d147e","type":"change","z":"17d2a295.77e4ad","name":"Unknown command","rules":[{"t":"change","p":"payload","pt":"msg","from":"^(.*)$","fromt":"re","to":"Unknown MQTT command received : [$1] ","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":760,"y":40,"wires":[["fc110016.35e7a"]]},{"id":"fc110016.35e7a","type":"ui_text","z":"17d2a295.77e4ad","group":"bd4b99eb.217178","order":13,"width":0,"height":0,"name":"Error","label":"text","format":"{{msg.payload}}","layout":"row-spread","x":1090,"y":40,"wires":[]},{"id":"58ac770c.df1f98","type":"link in","z":"9c0b8654.c93088","name":"LEDStateChanged","links":["90014cdd.dc132"],"x":208.00000095367432,"y":126.00000190734863,"wires":[["9f2d045d.d807e8","7f5ce07b.39037","f553885d.7d8788","486da844.ddb508"]]},{"id":"90014cdd.dc132","type":"link out","z":"17d2a295.77e4ad","name":"UpdateDashboardWithLEDState","links":["58ac770c.df1f98"],"x":1051.0000162124634,"y":116.0000057220459,"wires":[]},{"id":"44d527f6.ba8818","type":"inject","z":"17d2a295.77e4ad","name":"LED OFF","topic":"LED OFF","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":200,"y":180,"wires":[["46df3ad3.92fdf4"]]},{"id":"46df3ad3.92fdf4","type":"function","z":"17d2a295.77e4ad","name":"Set LED state OFF","func":"var currentLedState = flow.get(\"LEDState\")||0;\nif (currentLedState===0)\n    return null;\n    \nledState = 0;\nmsg.payload = ledState;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"noerr":0,"x":750,"y":180,"wires":[["a10c7980.ad5e58"]]},{"id":"91a4d47.14b2128","type":"mqtt in","z":"17d2a295.77e4ad","name":"","topic":"RPI/RPI001/MyLEDPower","qos":"2","datatype":"auto","broker":"5e96290d.916808","x":250,"y":140,"wires":[["58551e2.17470e","5eb90b85.3f0014"]]},{"id":"58551e2.17470e","type":"function","z":"17d2a295.77e4ad","name":"Set LED Power","func":"var ledPower=msg.payload;\nvar ledState;\n\nif (ledPower===0)\n    {\n    ledState=0;\n    ledPower=100;\n    }\nelse\n    ledState=1;\n    \nflow.set(\"LEDState\", ledState);\nflow.set(\"LEDPower\", ledPower);\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":140,"wires":[["a10c7980.ad5e58"]]},{"id":"a29cd549.33ca48","type":"link in","z":"17d2a295.77e4ad","name":"DashboardLEDPowerControls","links":["290012fe.5b032e"],"x":324.00000286102295,"y":100.00000095367432,"wires":[["58551e2.17470e"]]},{"id":"5eb90b85.3f0014","type":"debug","z":"17d2a295.77e4ad","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":490,"y":100,"wires":[]},{"id":"f67ee69a.1fe598","type":"switch","z":"862af712.0c0838","name":"","property":"payload","propertyType":"msg","rules":[{"t":"head","v":"","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":260.6666734483507,"y":415.999993218316,"wires":[[]]},{"id":"85ca29f1.658778","type":"change","z":"862af712.0c0838","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":408.4444512261285,"y":410.4444376627604,"wires":[[]]},{"id":"c8438ef3.e0f7a","type":"mqtt in","z":"d98d1ceb.8108","name":"test.mosquitto.org TLS","topic":"TestMe","qos":"1","datatype":"auto","broker":"ce19bdf7.7bc96","x":177.33336639404297,"y":337.3333492279053,"wires":[["f0d13fd3.e3512"]]},{"id":"7c2ef4da.376d0c","type":"mqtt out","z":"d98d1ceb.8108","name":"test.mosquitto.org TLS","topic":"TestMe","qos":"","retain":"","broker":"ce19bdf7.7bc96","x":372.88890075683594,"y":417.3333549499512,"wires":[]},{"id":"f0d13fd3.e3512","type":"debug","z":"d98d1ceb.8108","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","x":404.0000419616699,"y":337.3333511352539,"wires":[]},{"id":"e7a7af4f.ebc27","type":"inject","z":"d98d1ceb.8108","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":147.33336639404297,"y":417.77779960632324,"wires":[["7c2ef4da.376d0c"]]},{"id":"5db00232.0edb1c","type":"comment","z":"d98d1ceb.8108","name":"Verify test.mosquitto.org","info":"","x":128.44445037841797,"y":57.097222328186035,"wires":[]},{"id":"f97c99b1.4ee8d8","type":"comment","z":"d98d1ceb.8108","name":"Verify TLS on test.mosquitto.org (server domain mosquitto.)org","info":"","x":243.3333511352539,"y":282.2222261428833,"wires":[]},{"id":"b5cbf7fb.d9a7b8","type":"mqtt out","z":"d98d1ceb.8108","name":"test.mosquitto.org","topic":"TestMe","qos":"","retain":"","broker":"52036f0f.f6564","x":359.9999771118164,"y":205.5555238723755,"wires":[]},{"id":"d3acfc4d.7628","type":"inject","z":"d98d1ceb.8108","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":144.44444274902344,"y":205.99996852874756,"wires":[["b5cbf7fb.d9a7b8"]]},{"id":"72653b98.bd7f54","type":"debug","z":"d98d1ceb.8108","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","x":404.4444351196289,"y":123.33332252502441,"wires":[]},{"id":"1c97ebf7.ff3f74","type":"mqtt in","z":"d98d1ceb.8108","name":"test.mosquitto.org","topic":"TestMe","qos":"1","datatype":"auto","broker":"2fc6eb97.8750e4","x":167.77775955200195,"y":123.33332061767578,"wires":[["72653b98.bd7f54"]]},{"id":"4265f131.d27f9","type":"mqtt out","z":"d98d1ceb.8108","name":"AWS own CA TLS","topic":"TestMe","qos":"","retain":"","broker":"ec86ade6.d9f7","x":946.6666259765625,"y":237.77777099609375,"wires":[]},{"id":"5f1410c.b515ef","type":"inject","z":"d98d1ceb.8108","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":731.1110916137695,"y":238.22221565246582,"wires":[["4265f131.d27f9"]]},{"id":"7539c58b.e0125c","type":"change","z":"d67507fd.920a88","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"LEDState","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":708.6000366210938,"y":116,"wires":[["b0deaf53.8e4c"]]},{"id":"b0deaf53.8e4c","type":"debug","z":"d67507fd.920a88","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":897,"y":86,"wires":[]},{"id":"9bdbe7e9.765f28","type":"mqtt in","z":"849fc2bb.4b022","name":"#","topic":"#","qos":"0","datatype":"auto","broker":"2fc6eb97.8750e4","x":187.66667938232422,"y":185.22224044799805,"wires":[[]]},{"id":"1c91e2bc.71badd","type":"debug","z":"df04784a.d18f88","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","x":1113.000015258789,"y":403.0000066757202,"wires":[],"inputLabels":["msg.payload"]},{"id":"a1b12525.770318","type":"function","z":"df04784a.d18f88","name":"","func":"v=msg.payload!==0;\nmsg.payload=v;\nreturn msg;","outputs":1,"noerr":0,"x":885.6000137329102,"y":402.00000762939453,"wires":[["1c91e2bc.71badd"]]},{"id":"8998b634.d3ba88","type":"debug","z":"17d2a295.77e4ad","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","x":1073,"y":446,"wires":[],"inputLabels":["msg.payload"]},{"id":"1a45aece.362881","type":"function","z":"17d2a295.77e4ad","name":"","func":"v=msg.payload!==0;\nmsg.payload=v;\nreturn msg;","outputs":1,"noerr":0,"x":845.5999984741211,"y":445.0000009536743,"wires":[["8998b634.d3ba88","409c37ca.44a0c8"]]},{"id":"6f5ad1f2.57456","type":"function","z":"17b72791.ffa268","name":"Switch LED state","func":"ledState=flow.get(\"LEDState\")||0;\nledPower=flow.get(\"LEDPower\")||0;\n\n(ledState === 0) ? ledState = 1 : ledState = 0;\nif (ledState==1)\n    {\n    if (ledPower===0)\n        ledPower=100;\n    msg.payload = ledPower;\n    }\nelse\n    msg.payload=0;\n    \nflow.set(\"LEDState\", ledState);\nflow.set(\"LEDPower\", ledPower);\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":500,"wires":[["52d15c37.f9ec84"]]},{"id":"b62daf9d.ca9d7","type":"inject","z":"17b72791.ffa268","name":"LED OFF","topic":"LED OFF","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":220,"y":500,"wires":[["93a2a01b.c54d6"]]},{"id":"d3c16c15.993c6","type":"debug","z":"17b72791.ffa268","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":1069.9999923706055,"y":523.0000057220459,"wires":[],"inputLabels":["msg.payload"]},{"id":"f2b4552e.be9468","type":"inject","z":"17b72791.ffa268","name":"LED ON","topic":"LED ON","payload":"ledPower","payloadType":"flow","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":220,"y":577,"wires":[["4fc00dfa.507b04"]]},{"id":"541d56eb.7ce148","type":"rpi-gpio out","z":"17b72791.ffa268","name":"LED on GPIO18","pin":"12","set":false,"level":"0","freq":"","out":"pwm","x":1079.9999923706055,"y":463.0000057220459,"wires":[]},{"id":"aac78019.32d9b","type":"rpi-gpio in","z":"17b72791.ffa268","name":"BTN on GPIO4","pin":"7","intype":"up","debounce":"25","read":true,"x":164.99999237060547,"y":761.0000038146973,"wires":[["20b2e9c8.452886"]]},{"id":"7dbc1b07.4fa944","type":"inject","z":"17b72791.ffa268","name":"SWITCH LED","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":230,"y":648,"wires":[["6f5ad1f2.57456"]]},{"id":"bebc7ed3.d0605","type":"function","z":"17b72791.ffa268","name":"If button down","func":"if (msg.payload===0)\n    return msg;\n    \nreturn  null;","outputs":1,"noerr":0,"x":382.0908889770508,"y":794.7272987365723,"wires":[[]]},{"id":"20b2e9c8.452886","type":"switch","z":"17b72791.ffa268","name":"If button down","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":379.99999237060547,"y":760.0000038146973,"wires":[["6f5ad1f2.57456"],[]]},{"id":"93a2a01b.c54d6","type":"function","z":"17b72791.ffa268","name":"Set LED state OFF","func":"var currentLedState = flow.get(\"LEDState\")||0;\nif (currentLedState===0)\n    return null;\n    \nledState = 0;\nmsg.payload = 0;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"noerr":0,"x":709.9999923706055,"y":423.0000057220459,"wires":[["52d15c37.f9ec84"]]},{"id":"4fc00dfa.507b04","type":"function","z":"17b72791.ffa268","name":"Set LED state ON","func":"currentLedState = flow.get(\"LEDState\")||0;\nledPower=flow.get(\"LEDPower\")||0;\n\nif (currentLedState==1)\n    if (ledPower==100)\n        return null;\n    else\n        ledPower=100;\n\nledState = 1;\nif (ledPower===0)\n    ledPower=100;\n    \nmsg.payload = ledPower;\n\nflow.set(\"LEDState\", ledState);\nflow.set(\"LEDPower\", ledPower);\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":461.9999990463257,"wires":[["52d15c37.f9ec84"]]},{"id":"2a2ed7ed.6df978","type":"mqtt in","z":"17b72791.ffa268","name":"","topic":"RPI/RPI1/MyLEDCommand","qos":"0","datatype":"auto","broker":"de5e8b6d.d98b68","x":204.99999237060547,"y":284.00000858306885,"wires":[["3e7d4763.182fc8","6c0c47ee.a78cb8"]]},{"id":"a5788181.875a5","type":"mqtt out","z":"17b72791.ffa268","name":"Publish MyLEDState","topic":"RPI/RPI1/MyLEDState","qos":"0","retain":"","broker":"de5e8b6d.d98b68","x":1099.9999923706055,"y":403.0000057220459,"wires":[]},{"id":"3e7d4763.182fc8","type":"switch","z":"17b72791.ffa268","name":"Parse command","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"LED_OFF","vt":"str"},{"t":"eq","v":"LED_ON","vt":"str"},{"t":"eq","v":"LED_SWITCH","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":4,"x":455,"y":266.00000858306885,"wires":[["93a2a01b.c54d6"],["4fc00dfa.507b04"],["6f5ad1f2.57456"],["889b55c4.068648"]]},{"id":"6c0c47ee.a78cb8","type":"debug","z":"17b72791.ffa268","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":451.99999618530273,"y":336.0000104904175,"wires":[]},{"id":"7e4d0ac.240d2f4","type":"ui_button","z":"17b72791.ffa268","name":"","group":"bd4b99eb.217178","order":1,"width":0,"height":0,"passthru":false,"label":"ON","tooltip":"","color":"","bgcolor":"green","icon":"","payload":"1","payloadType":"str","topic":"","x":210,"y":608,"wires":[["4fc00dfa.507b04"]]},{"id":"e977e105.550f8","type":"ui_switch","z":"17b72791.ffa268","name":"","label":"switch","tooltip":"","group":"bd4b99eb.217178","order":3,"width":0,"height":0,"passthru":false,"decouple":"true","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"power_settings_new","oncolor":"green","offvalue":"false","offvalueType":"bool","officon":"power_settings_new","offcolor":"red","x":210,"y":680,"wires":[["6f5ad1f2.57456"]]},{"id":"75e2f737.6d80d8","type":"ui_button","z":"17b72791.ffa268","name":"","group":"bd4b99eb.217178","order":2,"width":0,"height":0,"passthru":false,"label":"OFF","tooltip":"","color":"","bgcolor":"red","icon":"","payload":"0","payloadType":"str","topic":"","x":208.99999237060547,"y":531.0000047683716,"wires":[["93a2a01b.c54d6"]]},{"id":"3b8dad9a.0f3372","type":"ui_text","z":"17b72791.ffa268","group":"bd4b99eb.217178","order":8,"width":0,"height":0,"name":"","label":"LED is ","format":"{{msg.payload}}%","layout":"row-spread","x":1049.9999923706055,"y":583.0000057220459,"wires":[]},{"id":"52d15c37.f9ec84","type":"change","z":"17b72791.ffa268","name":"Dispatch","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":899.9999923706055,"y":463.0000057220459,"wires":[["3b8dad9a.0f3372","d3c16c15.993c6","541d56eb.7ce148","a5788181.875a5","8a6c842a.3402a8","61de96d4.23cb28","31202dff.12dde2","b06f051a.517398","611f6ec3.3db66"]]},{"id":"889b55c4.068648","type":"change","z":"17b72791.ffa268","name":"Unknown command","rules":[{"t":"change","p":"payload","pt":"msg","from":"^(.*)$","fromt":"re","to":"Unknown MQTT command received : [$1] ","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":703,"y":235.00003242492676,"wires":[["94b83c9e.4ff89","42b01d32.e28504"]]},{"id":"94b83c9e.4ff89","type":"ui_text","z":"17b72791.ffa268","group":"bd4b99eb.217178","order":13,"width":0,"height":0,"name":"Error","label":"text","format":"{{msg.payload}}","layout":"row-spread","x":1068.0000076293945,"y":241.00000762939453,"wires":[]},{"id":"62f572fe.4935ac","type":"mqtt in","z":"17b72791.ffa268","name":"","topic":"RPI/RPI1/MyLEDPower","qos":"0","datatype":"auto","broker":"de5e8b6d.d98b68","x":184.99999237060547,"y":356.99999713897705,"wires":[["6c0c47ee.a78cb8","47f98164.216ef"]]},{"id":"47f98164.216ef","type":"function","z":"17b72791.ffa268","name":"Set LED Power","func":"var ledPower=msg.payload;\nvar ledState;\n\nif (ledPower===0)\n    {\n    ledState=0;\n    ledPower=100;\n    }\nelse\n    ledState=1;\n    \nflow.set(\"LEDState\", ledState);\nflow.set(\"LEDPower\", ledPower);\nreturn msg;","outputs":1,"noerr":0,"x":699.9999923706055,"y":383.0000057220459,"wires":[["52d15c37.f9ec84"]]},{"id":"4bc572de.47622c","type":"comment","z":"17b72791.ffa268","name":"CoAP PUT (controls) ","info":"","x":187.09089374542236,"y":843.7272806167603,"wires":[]},{"id":"420b109d.2dbf4","type":"debug","z":"17b72791.ffa268","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"req.payload","x":449.99999618530273,"y":119.0000057220459,"wires":[]},{"id":"efe31fcc.6b0fd","type":"function","z":"17b72791.ffa268","name":"BufferToString","func":"msg.payload=msg.req.payload.toString();\nreturn msg;","outputs":1,"noerr":0,"x":452,"y":164.00000667572021,"wires":[["48ff81ca.e6b12","3e7d4763.182fc8"]]},{"id":"48ff81ca.e6b12","type":"debug","z":"17b72791.ffa268","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"req.payload","x":681,"y":164.00000715255737,"wires":[]},{"id":"a4c97a08.06a5b8","type":"function","z":"17b72791.ffa268","name":"Responder","func":"currentLedState = flow.get(\"LEDState\")||0;\ncurrentLedPower = flow.get(\"LEDPower\")||0;\n\nif (currentLedState===0)\n    msg.res.end(\"0\");\nelse\n    msg.res.end(currentLedPower.toString());\nreturn msg;","outputs":1,"noerr":0,"x":440.99999618530273,"y":82.00000524520874,"wires":[[]]},{"id":"a99f328b.a9dfb","type":"inject","z":"17b72791.ffa268","name":"","topic":"","payload":"LED_ON","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"","x":179.99999237060547,"y":923.0000047683716,"wires":[["1cc33efe.d13551"]]},{"id":"e0b663db.dfa54","type":"inject","z":"17b72791.ffa268","name":"","topic":"","payload":"LED_OFF","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"","x":179.99999237060547,"y":963.0000047683716,"wires":[["1cc33efe.d13551"]]},{"id":"5b72d425.5bd0dc","type":"debug","z":"17b72791.ffa268","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","x":759.9999923706055,"y":883.0000047683716,"wires":[]},{"id":"80d03e76.a8d8b","type":"inject","z":"17b72791.ffa268","name":"","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"","x":169.99999237060547,"y":883.0000047683716,"wires":[["8270c233.b40c2"]]},{"id":"42b01d32.e28504","type":"debug","z":"17b72791.ffa268","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","x":1084.0000076293945,"y":191.00000667572021,"wires":[],"inputLabels":["msg.payload"]},{"id":"c52a560e.cefe78","type":"coap in","z":"17b72791.ffa268","method":"POST","name":"","server":"7d400227.ba488c","url":"/storage/LED","x":184.99999237060547,"y":122.00000667572021,"wires":[["420b109d.2dbf4","efe31fcc.6b0fd"]]},{"id":"e51d7cc5.29ca8","type":"coap in","z":"17b72791.ffa268","method":"PUT","name":"","server":"7d400227.ba488c","url":"/storage/LED","x":174.99999237060547,"y":162.00000667572021,"wires":[["420b109d.2dbf4","efe31fcc.6b0fd"]]},{"id":"87288f4e.b842b","type":"coap in","z":"17b72791.ffa268","method":"GET","name":"","server":"7d400227.ba488c","url":"/storage/LED","x":174.99999237060547,"y":82.00000667572021,"wires":[["a4c97a08.06a5b8"]]},{"id":"1cc33efe.d13551","type":"coap request","z":"17b72791.ffa268","method":"PUT","observe":false,"url":"coap://127.0.0.1:55683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"PUT /storage/LED","x":489.99999237060547,"y":943.0000047683716,"wires":[[]]},{"id":"8270c233.b40c2","type":"coap request","z":"17b72791.ffa268","method":"GET","observe":true,"url":"coap://localhost:55683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"GET /storage/LED","x":489.99999237060547,"y":883.0000047683716,"wires":[["5b72d425.5bd0dc"]]},{"id":"8a6c842a.3402a8","type":"ui_gauge","z":"17b72791.ffa268","name":"","group":"bd4b99eb.217178","order":10,"width":0,"height":0,"gtype":"gage","title":"gauge","label":"units","format":"{{value}}","min":0,"max":"100","colors":["#00B500","#E6E600","#CA3838"],"seg1":"","seg2":"","x":1051.0000038146973,"y":626.0000133514404,"wires":[]},{"id":"61de96d4.23cb28","type":"ui_chart","z":"17b72791.ffa268","name":"","group":"bd4b99eb.217178","order":12,"width":0,"height":0,"label":"chart","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"60","cutout":0,"useOneColor":false,"colors":["#1F77B4","#AEC7E8","#FF7F0E","#2CA02C","#98DF8A","#D62728","#FF9896","#9467BD","#C5B0D5"],"useOldStyle":false,"outputs":2,"x":1052.0000038146973,"y":666.0000133514404,"wires":[[],[]]},{"id":"c901d845.9e7d18","type":"ui_slider","z":"17b72791.ffa268","name":"","label":"slider","tooltip":"","group":"bd4b99eb.217178","order":7,"width":0,"height":0,"passthru":false,"outs":"all","topic":"","min":0,"max":"100","step":"10","x":210,"y":435,"wires":[["47f98164.216ef"]]},{"id":"e131b893.fc12f8","type":"ui_text_input","z":"17b72791.ffa268","name":"","label":"Select a value","tooltip":"","group":"bd4b99eb.217178","order":5,"width":0,"height":0,"passthru":false,"mode":"text","delay":300,"topic":"","x":239.99999237060547,"y":466.0000047683716,"wires":[["47f98164.216ef"]]},{"id":"909b6371.c593a","type":"comment","z":"17b72791.ffa268","name":"CoAP responder","info":"","x":164.99999237060547,"y":46.600003242492676,"wires":[]},{"id":"5b62be56.3557c","type":"comment","z":"17b72791.ffa268","name":"MQTT responder","info":"","x":164.99999237060547,"y":215.00000858306885,"wires":[]},{"id":"f1615675.407c18","type":"comment","z":"17b72791.ffa268","name":"Dashboard & inflow controls","info":"","x":204.99999237060547,"y":404.0000009536743,"wires":[]},{"id":"19eb6368.b7d18d","type":"comment","z":"17b72791.ffa268","name":"Hardware button","info":"","x":164.99999237060547,"y":723.0000038146973,"wires":[]},{"id":"21ea8993.9fa6f6","type":"comment","z":"17b72791.ffa268","name":"LED state & commands mgt","info":"","x":735.9999923706055,"y":337.0000047683716,"wires":[]},{"id":"311dce13.075402","type":"comment","z":"17b72791.ffa268","name":"LED change, notifications, dashboard out","info":"","x":1080,"y":337,"wires":[]},{"id":"ff1c7bdf.d74bd8","type":"link in","z":"17b72791.ffa268","name":"Inject in Text/Slider","links":["31202dff.12dde2"],"x":35,"y":460,"wires":[["67679162.c9d26","e131b893.fc12f8","c901d845.9e7d18"]]},{"id":"31202dff.12dde2","type":"link out","z":"17b72791.ffa268","name":"Inject in Text/Slider","links":["ff1c7bdf.d74bd8"],"x":1014.9999923706055,"y":703.0000047683716,"wires":[]},{"id":"62bc7359.9dc85c","type":"mqtt out","z":"17b72791.ffa268","name":"Test Switch by MQTT","topic":"RPI/RPI1/MyLEDCommand","qos":"0","retain":"","broker":"de5e8b6d.d98b68","x":1220,"y":100,"wires":[]},{"id":"573f5809.ef1f98","type":"inject","z":"17b72791.ffa268","name":"","topic":"","payload":"LED_SWITCH","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1010,"y":100,"wires":[["62bc7359.9dc85c"]]},{"id":"7c0c5693.a2c1c8","type":"mqtt in","z":"17b72791.ffa268","name":"","topic":"RPI/RPI1/MyLEDState","qos":"0","datatype":"auto","broker":"de5e8b6d.d98b68","x":1020,"y":60,"wires":[["6167de95.48233"]]},{"id":"6167de95.48233","type":"debug","z":"17b72791.ffa268","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","targetType":"msg","x":1240,"y":60,"wires":[]},{"id":"67679162.c9d26","type":"function","z":"17b72791.ffa268","name":"# to Bool","func":"// convert 0-100 to True / False for swith button state\nmsg.payload=msg.payload!==0;\nreturn msg;","outputs":1,"noerr":0,"x":80,"y":680,"wires":[["e977e105.550f8"]]},{"id":"b06f051a.517398","type":"debug","z":"17b72791.ffa268","name":"flow.LEDPower","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"$flowContext(\"LEDPower\")","targetType":"jsonata","x":1270,"y":560,"wires":[]},{"id":"611f6ec3.3db66","type":"debug","z":"17b72791.ffa268","name":"flow.LEDState","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"$flowContext(\"LEDState\")","targetType":"jsonata","x":1260,"y":500,"wires":[]},{"id":"c36d3d4e.b025a","type":"comment","z":"17b72791.ffa268","name":"DEBUG","info":"","x":970.0000076293945,"y":16.999995231628418,"wires":[]}]
AllFlows
Focus on EV Charging - Crash Course in Acronyms
260
A few terms and acronyms that you might hear in this presentation
Electric Vehicle (EV)
Battery Electric Vehicle (BEV)
Plug-in Hybrid Electric Vehicle (PHEV)
Internal Combustion Engine (ICE)
Charge Point (CP) or
Electric Vehicle Supply Equipment (EVSE)
eMobility Service Provider (EMSP) or
Mobility Operator (MO)
Charging Point Operator (CPO)
Distribution System Operator (DSO)
Original Equipment Manufacturer (OEM)
used for Car Manufacturers
Focus on EV Charging
Electric Vehicle (EV) will demand charging infrastructure
EV Charging is at the crossroad of multiple services
EV may be charging from the grid (demand)or injecting energy to the grid (supply)
Electric Vehicle Charging
An overlapping segment that is important to make cities greener; to transform auto OEM into service providers; and to help DSOs diversify and adapt to new energy needs
261
EV : Electric Vehicle
OEM : in this context, car makers
DSO : Distribution system operators 
Importance of EV Charging
262
More charging points mean less range anxiety for consumers
Charging points (especially fast/DC charging) can improve consumer convenience
Standards-compliant infrastructure (charging cable, socket etc.) improves consumer convenience
Standards-compliant communication ensures seamless consumer charging experience
It also ensures effective V2G (vehicle-to-grid) communication for better demand and supply management
Standards-compliancy is a huge benefit for OEMs for achieving economies of scale, rather than investing in multiple non-standard product development
Charging infrastructure includes the charging point till the electric vehicle’s battery
Key Components of EV Charging
Standardized communication is critical for actors to exchange information, for consumer safety, security and convenience
Key components of charging ecosystem need to communicate with each other
Original Equipment Manufacturer (OEM)
EV Consumer
EV Supply Equipment (EVSE)
Charging Point Operator (CPO)
eMobility Service Provider (EMSP)
Electric Vehicle (EV)
EV Communication Controller (EVCC)
Supply Equipment Communication Controller (SECC)
Distribution Service Operator (DSO)
A CPO may own many charging points, or EVSE.
An EMSP may have agreements with multiple CPOs.
EVSE Manufacturer
A consumer may have a contract with one or more EMSP.
A CPO may purchase EVSE from different manufacturers
263
e.g. ERDF
e.g. NewMotion, avia, total
e.g. Peugeot
e.g. ChargeMap, Hubject, Freshmile…
e.g. SchneiderElectric, ChargePoint, Siemens, Tesla
2. EV Consumer plugs in the charging cable.
3. EV Consumer taps the RFID card or NFC smartphone on the Charge Point (CP/EVSE) to initiate charging
4. EV Consumer stores the card back in the wallet
1. EV Consumer uses the charging card provided by the Mobility Operator (EMSP) or Charging Point Operator (CPO)
Charging Process - Options
1. EV Consumer plugs in the charging cable to initiate charging
Plug & Charge
264
ISO 15118
PKI – the cornerstone of ISO 15118 security
265
The ISO 15118 standard mandates the use of Public Key Infrastructure for all communication security
MO = Mobility Operator = eMSP
CPO = Charging Point Operator
PKI – the cornerstone of ISO 15118 security
266
The ISO 15118 standard mandates the use of Public Key Infrastructure for all communication security
The SECC Certificate needs to be provisioned in the EVSE so that it can authenticate to the EV/EVCC or other Secondary Actors
The Contract Certificate governs the contractual binding between the EV[owner], the EMSP and the CPO.
The OEM Provisioning Certificate needs to be provisioned in the EVCC at the time of production, by the OEM
What PKI enables in this ecosystem:
Mutual authentication between EV and EVSE
Authentication of EV to the eMobility Service Provider (EMSP) for contract updates
Authentication of EVSE to the Charging Point Operator (CPO)
MO = Mobility Operator = eMSP
CPO = Charging Point Operator
ISO15118 Plug & Charge
ISO 15118 advanced use case – No contract available in the EV
OEM manufactures Electric Vehicles (EV) with diversified OEM car certificates
Bob buys new EV from this OEM reseller
Bob contracts with an eMobile SP (EMSP) to be enable to charge his EV at charging points (CP) from several Charging Points Operators (CPOs)
Bob provides information about his EV (e.g. VIN)
Bob drives his vehicle to one partner CPO (Charging Points Operator) and plugs its EV to a CP (Charging Point)
The CP (Charging Point) authenticates to the EV as genuine CP
The EV authenticates to the CP (Charging Point) with the car OEM certificate (as no contract is present yet)
CP (Charging Point) will contact CPO partners eMSPs (eMobility Service Providers) and search for possible  contract for this EV
Contracted eMSP will send back Bob’s contract (certificate and private key), wrapped by the car OEM certificate key
CP (Charging Point) transfers the contract provisioning message to the EV
EV extracts its contract certificate and private key (decrypting with its OEM issued private key)
EV re-authenticates to the CP (Charging Point) but now with contract certificate
CP (Charging Point) receives a contract certificate and checks it’s a valid one (date/status/issuer is a partner eMSP/…)
CP (Charging Point) sends billing information to eMSP, signed by the CPO’s CP certificate
Understanding the different Certificates
268
EMSP : eMobility SP 
CPO : Charging Point Operator
CP: Charging Point
Focus on Smart Energy
Energy Distribution System Operators (DSO)  need to trust the data that is coming from the meters in order to: 
269
Focus on Smart Energy
Jusqu’à 100 contrôleurs intégrés
270
Electricity distribution is part of the critical infrastructures of the country
Economic costs of blackouts are huge
Cost simulator sponsored by EU
	(http://www.blackout-simulator.com/ )
How long would society resist in case of blackout?
Against ‘citizens’
Against external threats
Real life story #1Tampering with the Smart meter data
Real life story #2Spying on the data concentration points through gateways
Real life story #3Attack the grid from the back-end to inflicts extensive damages
AMI (advanced Metering Infra) 
Furthermore security is not an implement-and-forget process : It should be upgradable with hackers rising skills 
Remote meter configuration change
No personnel sent on site
Focus on Smart Energy
Jusqu’à 100 contrôleurs intégrés
275
Some Smart grid use cases
Remote meter data collection
Live consumption metrics
No personnel to collect manually
Remote service activation/deactivation
Moving 'in-out of a flat / unpaid bill
Prove green energy source
Amount of sold green energy matches green electricity
Authenticate maintenance personnel
Automatic Meter enrollment
Meter installation less prone to errors, faster
The Advanced Metering Infrastructure is becoming a critical IoT network that opens new doors for attackers
Focus on Smart Energy
MDMS : Meter Device Management System
HES : Head-end-System 
Use Case : Smart Meters discovery
Smart Grid Back-end
0- Meter has its DLMS keys and is properly provisioned in the KMS
1- Meter is powered on, it broadcasts via PLC its MAC address and attaches to the closest DC
2- DC asks the KMS via the HES the Meter keys: PSK then GUEK.
3- KMS delivers the keys:
PSK wrapped with DC EK PSK Key
GUEK wrapped with DC EK DLMS key
4- Pairing is done and the communication starts 
Note: 
DC – Backend communication is cellular or LAN
Meter – DC communication is PLC
DC - Data concentrator
PSK – Pre Shared Key
GUEK - Global Unicast Encryption Key
DLMS - Device Language Message Specification
Maintenance use case: Devices with Certificates
Short-lived certificate to access the admin console of the DC for service operation 
Certificate Generation Request
The back end (SMOC) requests the generation of a temporary certificates to allow service operators accessing the DC 
The KMS generates the certificate and sends it back to the SMOC back end
Certificate delivery
The SMOC installs the certificate on the operator’s devices
Local access
The service operator can then physically access the Data concentrator console
Authorizations are extracted from certificate (Date/DC serial…)
Smart Grid Back-end
MDMS
OCSP responder
Head-end system
SMOC
KMS IoT Security Platform
SSL off-loader
DC : Data Concentrator
MDMS : Meter Data Management System (billing)
SMOC : Smart Meter Operation Center
HES : Head End System (interface to most field devices)
Field deployment and operations  
Device life cycle management
Diversified Credential injection 1
Provisioning identities in SmartGrid 
back-end
Device Maintenance
Device deactivation or reallocation 
Device update Credential renewalSigned firmware update
Diversified Credential injection 2
Data transmission 
encrypted and
Cloud synchronization 
Device installation & activation
Smart grid operational processes
Device Identities Management – Smart grid PKI
Encryption engine –
HSM
KMS
Smart grid process translator
HES
Authenticated and encrypted communication
ETSI CoAP - Constrained Application Protocol
Service level protocol for constrained devices (RFC 7252)
Client/Server exchanges (a client may also be a server)
Targets 8bits Controllers, small RAM, very low bandwidth (KB/s)
Works over UDP or dTLS (sometimes SMS) 
Uses URIs, Schemes coap:// (port 5683) and coaps:// (port 5684)
Client may observe (‘subscribe to’) resources
Multicast, low overhead, and simplicity
Binary encoded, 4 bytes header, URI support
MTU packet size (e.g. 576 bytes IPV4, 1280 bytes IPV6,…)  
RFC 7390: Group Communication for CoAP (Multicast)
281
ETSI CoAP - Constrained Application Protocol
282
Nodes exchange messages
T: Confirmable & non-confirmable Request / Ack / Reset
CoAP Request/Response Code Methods
	GET : Get resource	POST : Create resource
	DELETE : Delete 	PUT : Update (or create)
Easily translated to HTTP & RESTful. 
Code encoding:
Methods 0.xx 
	(Get=1/Post=2/Put=3/Delete…)
Success 2.xx
	(Created=1/Deleted=2/Changed=4/Content=5/…)
Client Error 4.xx
	(Unauthorized=1/Not found=4/…)
Server Error 5.xx
ETSI CoAP – Some implementations
CoAP LibNyci
SMCP
txThings (Python)
CoAPthon3 (Python)
node-coap (Node.js)
NodeRed extension (node-red-contrib-coap)
iot.eclipse.org CoAP server sandbox
coap://californium.eclipseprojects.io:5683
coaps://californium.eclipseprojects.io:5684 (DTLS-enabled version)
coap.me 
server sandbox (coap://coap.me:5683/)
CoAP Web crawler client (http://coap.me/)
283
More at http://coap.technology/impls.html  
ETSI CoAP – Installing python CoAP Library on RPI
284
Install coap python library on the RPI
	[check your python version python --version]
	pip3 install CoAPthon3 [--break-system-packages ]
Copy copadclient.py, coapserver.py and exampleresources.py on the raspberry
Start CoAP server (only user pi, not pi2 or change port in coapserver.py)
	python3 coapserver.py
	it should display a list of « predefined » server resources
#!/usr/bin/env python
import getopt
import sys
from coapthon.server.coap import CoAP
from exampleresources import BasicResource, Long, Separate, Storage, Big, voidResource, XMLResource, ETAGResource, \
    Child, \
    MultipleEncodingResource, AdvancedResource, AdvancedResourceSeparate
__author__ = 'Giacomo Tanganelli'
class CoAPServer(CoAP):
    def __init__(self, host, port, multicast=False):
        CoAP.__init__(self, (host, port), multicast)
        self.add_resource('basic/', BasicResource())
        self.add_resource('storage/', Storage())
        self.add_resource('separate/', Separate())
        self.add_resource('long/', Long())
        self.add_resource('big/', Big())
        self.add_resource('void/', voidResource())
        self.add_resource('xml/', XMLResource())
        self.add_resource('encoding/', MultipleEncodingResource())
        self.add_resource('etag/', ETAGResource())
        self.add_resource('child/', Child())
        self.add_resource('advanced/', AdvancedResource())
        self.add_resource('advancedSeparate/', AdvancedResourceSeparate())
        print ("CoAP Server start on " + host + ":" + str(port))
        print (self.root.dump())
def usage():  # pragma: no cover
    print ("coapserver.py -i <ip address> -p <port>")
def main(argv):  # pragma: no cover
    ip = "0.0.0.0"
    port = 5683
    multicast = False
    try:
        opts, args = getopt.getopt(argv, "hi:p:m", ["ip=", "port=", "multicast"])
    except getopt.GetoptError:
        usage()
        sys.exit(2)
    for opt, arg in opts:
        if opt == '-h':
            usage()
            sys.exit()
        elif opt in ("-i", "--ip"):
            ip = arg
        elif opt in ("-p", "--port"):
            port = int(arg)
        elif opt in ("-m", "--multicast"):
            multicast = True
    server = CoAPServer(ip, port, multicast)
    try:
        server.listen(10)
    except KeyboardInterrupt:
        print ("Server Shutdown")
        server.close()
        print ("Exiting...")
if __name__ == "__main__":  # pragma: no cover
    main(sys.argv[1:])
import time
from coapthon import defines
from coapthon.resources.resource import Resource
__author__ = 'Giacomo Tanganelli'
class BasicResource(Resource):
    def __init__(self, name="BasicResource", coap_server=None):
        super(BasicResource, self).__init__(name, coap_server, visible=True,
                                            observable=True, allow_children=True)
        self.payload = "Basic Resource"
        self.resource_type = "rt1"
        self.content_type = "text/plain"
        self.interface_type = "if1"
    def render_GET(self, request):
        return self
    def render_PUT(self, request):
        self.edit_resource(request)
        return self
    def render_POST(self, request):
        res = self.init_resource(request, BasicResource())
        return res
    def render_DELETE(self, request):
        return True
class Storage(Resource):
    def __init__(self, name="StorageResource", coap_server=None):
        super(Storage, self).__init__(name, coap_server, visible=True, observable=True, allow_children=True)
        self.payload = "Storage Resource for PUT, POST and DELETE"
    def render_GET(self, request):
        return self
    def render_POST(self, request):
        res = self.init_resource(request, BasicResource())
        return res
class Child(Resource):
    def __init__(self, name="ChildResource", coap_server=None):
        super(Child, self).__init__(name, coap_server, visible=True, observable=True, allow_children=True)
        self.payload = ""
    def render_GET(self, request):
        return self
    def render_PUT(self, request):
        self.payload = request.payload
        return self
    def render_POST(self, request):
        res = BasicResource()
        res.location_query = request.uri_query
        res.payload = request.payload
        return res
    def render_DELETE(self, request):
        return True
class Separate(Resource):
    def __init__(self, name="Separate", coap_server=None):
        super(Separate, self).__init__(name, coap_server, visible=True, observable=True, allow_children=True)
        self.payload = "Separate"
        self.max_age = 60
    def render_GET(self, request):
        return self, self.render_GET_separate
    def render_GET_separate(self, request):
        time.sleep(5)
        return self
    def render_POST(self, request):
        return self, self.render_POST_separate
    def render_POST_separate(self, request):
        self.payload = request.payload
        return self
    def render_PUT(self, request):
        return self, self.render_PUT_separate
    def render_PUT_separate(self, request):
        self.payload = request.payload
        return self
    def render_DELETE(self, request):
        return self, self.render_DELETE_separate
    def render_DELETE_separate(self, request):
        return True
class Long(Resource):
    def __init__(self, name="Long", coap_server=None):
        super(Long, self).__init__(name, coap_server, visible=True, observable=True, allow_children=True)
        self.payload = "Long Time"
    def render_GET(self, request):
        time.sleep(10)
        return self
class Big(Resource):
    def __init__(self, name="Big", coap_server=None):
        super(Big, self).__init__(name, coap_server, visible=True, observable=True, allow_children=True)
        self.payload = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Cras sollicitudin fermentum ornare. " \
                       "Cras accumsan tellus quis dui lacinia eleifend. Proin ultrices rutrum orci vitae luctus. " \
                       "Nullam malesuada pretium elit, at aliquam odio vehicula in. Etiam nec maximus elit. " \
                       "Etiam at erat ac ex ornare feugiat. Curabitur sed malesuada orci, id aliquet nunc. Phasellus " \
                       "nec leo luctus, blandit lorem sit amet, interdum metus. Duis efficitur volutpat magna, ac " \
                       "ultricies nibh aliquet sit amet. Etiam tempor egestas augue in hendrerit. Nunc eget augue " \
                       "ultricies, dignissim lacus et, vulputate dolor. Nulla eros odio, fringilla vel massa ut, " \
                       "facilisis cursus quam. Fusce faucibus lobortis congue. Fusce consectetur porta neque, id " \
                       "sollicitudin velit maximus eu. Sed pharetra leo quam, vel finibus turpis cursus ac. " \
                       "Aenean ac nisi massa. Cras commodo arcu nec ante tristique ullamcorper. Quisque eu hendrerit" \
                       " urna. Cras fringilla eros ut nunc maximus, non porta nisl mollis. Aliquam in rutrum massa." \
                       " Praesent tristique turpis dui, at ultricies lorem fermentum at. Vivamus sit amet ornare neque, " \
                       "a imperdiet nisl. Quisque a iaculis libero, id tempus lacus. Aenean convallis est non justo " \
                       "consectetur, a hendrerit enim consequat. In accumsan ante a egestas luctus. Etiam quis neque " \
                       "nec eros vestibulum faucibus. Nunc viverra ipsum lectus, vel scelerisque dui dictum a. Ut orci " \
                       "enim, ultrices a ultrices nec, pharetra in quam. Donec accumsan sit amet eros eget fermentum." \
                       "Vivamus ut odio ac odio malesuada accumsan. Aenean vehicula diam at tempus ornare. Phasellus " \
                       "dictum mauris a mi consequat, vitae mattis nulla fringilla. Ut laoreet tellus in nisl efficitur," \
                       " a luctus justo tempus. Fusce finibus libero eget velit finibus iaculis. Morbi rhoncus purus " \
                       "vel vestibulum ullamcorper. Sed ac metus in urna fermentum feugiat. Nulla nunc diam, sodales " \
                       "aliquam mi id, varius porta nisl. Praesent vel nibh ac turpis rutrum laoreet at non odio. " \
                       "Phasellus ut posuere mi. Suspendisse malesuada velit nec mauris convallis porta. Vivamus " \
                       "sed ultrices sapien, at cras amet."
    def render_GET(self, request):
        return self
    def render_POST(self, request):
        if request.payload is not None:
            self.payload = request.payload
        return self
class voidResource(Resource):
    def __init__(self, name="Void"):
        super(voidResource, self).__init__(name)
class XMLResource(Resource):
    def __init__(self, name="XML"):
        super(XMLResource, self).__init__(name)
        self.value = 0
        self.payload = (defines.Content_types["application/xml"], "<value>"+str(self.value)+"</value>")
    def render_GET(self, request):
        return self
class MultipleEncodingResource(Resource):
    def __init__(self, name="MultipleEncoding"):
        super(MultipleEncodingResource, self).__init__(name)
        self.value = 0
        self.payload = str(self.value)
        self.content_type = [defines.Content_types["application/xml"], defines.Content_types["application/json"]]
    def render_GET(self, request):
        if request.accept == defines.Content_types["application/xml"]:
            self.payload = (defines.Content_types["application/xml"],  "<value>"+str(self.value)+"</value>")
        elif request.accept == defines.Content_types["application/json"]:
            self.payload = (defines.Content_types["application/json"], "{'value': '"+str(self.value)+"'}")
        elif request.accept == defines.Content_types["text/plain"]:
            self.payload = (defines.Content_types["text/plain"], str(self.value))
        return self
    def render_PUT(self, request):
        self.edit_resource(request)
        return self
    def render_POST(self, request):
        res = self.init_resource(request, MultipleEncodingResource())
        return res
class ETAGResource(Resource):
    def __init__(self, name="ETag"):
        super(ETAGResource, self).__init__(name)
        self.count = 0
        self.payload = "ETag resource"
        self.etag = str(self.count)
    def render_GET(self, request):
        return self
    def render_POST(self, request):
        self.payload = request.payload
        self.count += 1
        self.etag = str(self.count)
        return self
    def render_PUT(self, request):
        self.payload = request.payload
        return self
class AdvancedResource(Resource):
    def __init__(self, name="Advanced"):
        super(AdvancedResource, self).__init__(name)
        self.payload = "Advanced resource"
    def render_GET_advanced(self, request, response):
        response.payload = self.payload
        response.max_age = 20
        response.code = defines.Codes.CONTENT.number
        return self, response
    def render_POST_advanced(self, request, response):
        self.payload = request.payload
        from coapthon.messages.response import Response
        assert(isinstance(response, Response))
        response.payload = "Response changed through POST"
        response.code = defines.Codes.CREATED.number
        return self, response
    def render_PUT_advanced(self, request, response):
        self.payload = request.payload
        from coapthon.messages.response import Response
        assert(isinstance(response, Response))
        response.payload = "Response changed through PUT"
        response.code = defines.Codes.CHANGED.number
        return self, response
    def render_DELETE_advanced(self, request, response):
        response.payload = "Response deleted"
        response.code = defines.Codes.DELETED.number
        return True, response
class AdvancedResourceSeparate(Resource):
    def __init__(self, name="Advanced"):
        super(AdvancedResourceSeparate, self).__init__(name)
        self.payload = "Advanced resource"
    def render_GET_advanced(self, request, response):
        return self, response, self.render_GET_separate
    def render_POST_advanced(self, request, response):
        return self, response, self.render_POST_separate
    def render_PUT_advanced(self, request, response):
        return self, response, self.render_PUT_separate
    def render_DELETE_advanced(self, request, response):
        return self, response, self.render_DELETE_separate
    def render_GET_separate(self, request, response):
        time.sleep(5)
        response.payload = self.payload
        response.max_age = 20
        return self, response
    def render_POST_separate(self, request, response):
        self.payload = request.payload
        response.payload = "Response changed through POST"
        return self, response
    def render_PUT_separate(self, request, response):
        self.payload = request.payload
        response.payload = "Response changed through PUT"
        return self, response
    def render_DELETE_separate(self, request, response):
        response.payload = "Response deleted"
        return True, response
coapserver.py
exampleresources.py
ETSI CoAP – Installing CoAP client on laptop
285
Install coap python library on your laptop
	[check your python version python –version]
	pip install CoAPthon (use CoAPthon3 for python 3+)
Copy coapclient.py 
Try following commands on your laptop:
	python coapclient.py -o GET -p coap://192.168.0.92/basic (replace with your RPI IP) 
								 Basic Resource
	python coapclient.py -o GET -p coap://californium.eclipseprojects.io:5683/test  something
	python coapclient.py -o GET -p coap://coap.me:5683/hello   « world »
#!/usr/bin/env python
import getopt
import socket
import sys
from coapthon.client.helperclient import HelperClient
from coapthon.utils import parse_uri
__author__ = 'Giacomo Tanganelli'
client = None
def usage():  # pragma: no cover
    print ("Command:\tcoapclient.py -o -p [-P] [-u]")
    print ("Options:")
    print ("\t-o, --operation=\tGET|PUT|POST|DELETE|DISCOVER|OBSERVE")
    print ("\t-p, --path=\t\tPath of the request")
    print ("\t-P, --payload=\t\tPayload of the request")
    print ("\t-f, --payload-file=\tFile with payload of the request")
    print ("\t-u, --proxy-uri-header=\tProxy-Uri CoAP Header of the request")
def client_callback(response):
    print ("Callback")
def client_callback_observe(response):  # pragma: no cover
    global client
    print ("Callback_observe")
    check = True
    while check:
        chosen = input("Stop observing? [y/N]: ") # GM raw_input("Stop observing? [y/N]: ")
        if chosen != "" and not (chosen == "n" or chosen == "N" or chosen == "y" or chosen == "Y"):
            print ("Unrecognized choose.")
            continue
        elif chosen == "y" or chosen == "Y":
            while True:
                rst = input("Send RST message? [Y/n]: ") # GM raw_input("Send RST message? [Y/n]: ")
                if rst != "" and not (rst == "n" or rst == "N" or rst == "y" or rst == "Y"):
                    print ("Unrecognized choose.")
                    continue
                elif rst == "" or rst == "y" or rst == "Y":
                    client.cancel_observing(response, True)
                else:
                    client.cancel_observing(response, False)
                check = False
                break
        else:
            break
def main():  # pragma: no cover
    global client
    op = None
    path = None
    payload = None
    proxy_uri = None
    try:
        opts, args = getopt.getopt(sys.argv[1:], "ho:p:P:f:", ["help", "operation=", "path=", "payload=",
                                                               "payload_file=", "proxy-uri-header="])
    except getopt.GetoptError as err:
        # print help information and exit:
        print (str(err))  # will print something like "option -a not recognized"
        usage()
        sys.exit(2)
    for o, a in opts:
        if o in ("-o", "--operation"):
            op = a
        elif o in ("-p", "--path"):
            path = a
        elif o in ("-P", "--payload"):
            payload = a
        elif o in ("-f", "--payload-file"):
            with open(a, 'r') as f:
                payload = f.read()
        elif o in ("-u", "--proxy-uri-header"):
            proxy_uri = a
        elif o in ("-h", "--help"):
            usage()
            sys.exit()
        else:
            usage()
            sys.exit(2)
    if op is None:
        print ("Operation must be specified")
        usage()
        sys.exit(2)
    if path is None:
        print ("Path must be specified")
        usage()
        sys.exit(2)
    if not path.startswith("coap://"):
        print ("Path must be conform to coap://host[:port]/path")
        usage()
        sys.exit(2)
    if proxy_uri and not proxy_uri.startswith("http://") and not proxy_uri.startswith("https://"):
        print ("Proxy-Uri header must be conform to http[s]://host[:port]/path")
        usage()
        sys.exit(2)
    host, port, path = parse_uri(path)
    try:
        tmp = socket.gethostbyname(host)
        host = tmp
    except socket.gaierror:
        pass
    client = HelperClient(server=(host, port))
    if op == "GET":
        if path is None:
            print ("Path cannot be empty for a GET request")
            usage()
            sys.exit(2)
        response = client.get(path) #GM:, proxy_uri=proxy_uri)
        print (response.pretty_print())
        client.stop()
    elif op == "OBSERVE":
        if path is None:
            print ("Path cannot be empty for a GET request")
            usage()
            sys.exit(2)
        client.observe(path, client_callback_observe)
    elif op == "DELETE":
        if path is None:
            print ("Path cannot be empty for a DELETE request")
            usage()
            sys.exit(2)
        response = client.delete(path) # GM:, proxy_uri=proxy_uri)
        print (response.pretty_print())
        client.stop()
    elif op == "POST":
        if path is None:
            print ("Path cannot be empty for a POST request")
            usage()
            sys.exit(2)
        if payload is None:
            print ("Payload cannot be empty for a POST request")
            usage()
            sys.exit(2)
        response = client.post(path, payload) # GM:, proxy_uri=proxy_uri)
        print (response.pretty_print())
        client.stop()
    elif op == "PUT":
        if path is None:
            print ("Path cannot be empty for a PUT request")
            usage()
            sys.exit(2)
        if payload is None:
            print ("Payload cannot be empty for a PUT request")
            usage()
            sys.exit(2)
        response = client.put(path, payload) # GM:, proxy_uri=proxy_uri)
        print (response.pretty_print())
        client.stop()
    elif op == "DISCOVER":
        response = client.discover()
        print (response.pretty_print())
        client.stop()
    else:
        print ("Operation not recognized")
        usage()
        sys.exit(2)
if __name__ == '__main__':  # pragma: no cover
    main()
coapclient.py
testcoapbasic.bat
ETSI CoAP – Understanding the basic commands
286
Enter following commands on your laptop
testcoapsequence.bat
ETSI CoAP – Advanced mechanisms
287
Discovering resources on a CoAP server (RFC 6690)
« Constrained RESTful Environments (CoRE) Link Format »
Resource Directory (RD) registers EndPoints (EP)
An endpoint uses specific interfaces of RD to register, update and remove a registration
ETSI CoAP – Advanced mechanisms
288
Example directory:python coapclient.py -o GET -p coap://192.168.0.92:5683/.well-known/core
.well-known URI is defined in RFC 5785 and core is defined in RFC 6690 
Data format is defined in RFC 5988 (web linking)
	rt=resource type (proprietary)
	if=interface (url)
	ct=content type
	obs=observable (see next slide)
+--------------------------+----------+----+------------------------+ 
| Media type               | Encoding | ID | Reference              | 
+--------------------------+----------+----+------------------------+ 
| text/plain;              | -        | 0  | [RFC2046] [RFC3676]    | 
| charset=utf-8            |          |    | [RFC5147]              | 
| application/link-format  | -        | 40 | [RFC6690]              | 
| application/xml          | -        | 41 | [RFC3023]              | 
| application/octet-stream | -        | 42 | [RFC2045] [RFC2046]    | 
| application/exi          | -        | 47 | [REC-exi-20140211]     | 
| application/json         | -        | 50 | [RFC7159]              | 
+--------------------------+----------+----+------------------------+
ETSI CoAP – Advanced mechanisms
289
    Observing changes of a resource to avoid polling
    Defined in RFC 7641, including “obs” directory attribute
    On your client machine :
	* Create storage/1 topic at least once:
		python coapclient.py -o POST -p coap://192.168.0.92:5683/storage/1 -P TEST 
	* Subscribe as observer 
		python coapclient.py -o OBSERVE -p coap://192.168.0.92:5683/storage/1 
		returns initial value and asks to stop, answer N
	* Start another shell on your laptop and change resource content on server with:
		python coapclient.py -o PUT -p coap://192.168.0.92:5683/storage/1 -P TEST4 
		 ACK, CHANGED
	Note the update in the observing client shell / POST will not generate observations
ETSI CoAP – Analyzing the protocol
290
[ensure all clients are stopped] 
Start capturing in wireshark
	filter ‘coap’
play following command from your laptop:
python coapclient.py -o GET –p coap://192.168.0.92:5683/storage/1
Note the commands size
ETSI CoAP – Analyzing the protocol (fragmentation)
291
[ensure all clients are stopped] 
Start capturing in wireshark
	filter ‘coap’
play following command from your laptop:
python coapclient.py -o GET -p coap://coap.me/large Note the packet numbers,packets size & M=1/0
ETSI CoAP – Node Red as CoAP client
Install Node Red Palette
We’ll start & use « external » python coapserver.py, at url : coap://192.168.0.154:5683/storage/LED  
Create a coap POST node, with injector node payload «INIT »
Create a coap GET node with empty injector node  and display result in debug node
Create a coap PUT node, with injector node payload « LED_ON »
Create a coap PUT node, with injector node payload « LED_OFF »
Create a coap GET node with OBSERVE  flag, with empty injector node
     Then 
292
[Ensure python coapserver.py is started on raspberry]
Click POST injector at least once (creates the topic with ‘INIT’ value)
Click GET injector=> « INIT »
Click LED_ON injector
Click GET injector => LED_ON
Click Subscribe injector => LED_ON
Click LED_OFF injector => subscription debug changes to LED_OFF (regular GET node doesn’t)
ETSI CoAP – Node Red as CoAP client
293
ETSI CoAP – Node Red as CoAP client
294
Node red flow CoAPClient
[{"id":"df136e3e.4e7d","type":"tab","label":"CoAPClient","disabled":false,"info":""},{"id":"db345516.6fb288","type":"inject","z":"df136e3e.4e7d","name":"Start Subscribe","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"","x":120,"y":400,"wires":[["c0750d6e.d5125"]]},{"id":"8479ef81.37ad8","type":"debug","z":"df136e3e.4e7d","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","x":680,"y":400,"wires":[]},{"id":"6f958c62.409d54","type":"debug","z":"df136e3e.4e7d","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","x":660,"y":200,"wires":[]},{"id":"d24cae73.6f244","type":"inject","z":"df136e3e.4e7d","name":"","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"","x":90,"y":159.00000190734863,"wires":[["a8c5b72d.2760f8"]]},{"id":"e39a7abc.a27268","type":"inject","z":"df136e3e.4e7d","name":"","topic":"","payload":"LED_ON","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"","x":100,"y":240,"wires":[["9e6c880e.32a7d8"]]},{"id":"183c7a54.bd3016","type":"inject","z":"df136e3e.4e7d","name":"","topic":"","payload":"LED_OFF","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"","x":100,"y":280,"wires":[["9e6c880e.32a7d8"]]},{"id":"93124cd1.d5518","type":"inject","z":"df136e3e.4e7d","name":"","topic":"","payload":"INIT","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"","x":90,"y":80,"wires":[["256f1e85.2723d2"]]},{"id":"24d47160.cf305e","type":"comment","z":"df136e3e.4e7d","name":"!! Click here once to create topic on local coapserver.py (ensure coappserver.py is running on default port 5683","info":"","x":390,"y":40,"wires":[]},{"id":"c1e242ec.8666d","type":"comment","z":"df136e3e.4e7d","name":"Unitary PUT / GET","info":"","x":106,"y":123.00000190734863,"wires":[]},{"id":"2839e99a.f71716","type":"comment","z":"df136e3e.4e7d","name":"Subscription via Observe","info":"","x":130,"y":360,"wires":[]},{"id":"42fe5661.545528","type":"inject","z":"df136e3e.4e7d","name":"","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"","x":90.00000381469727,"y":201.00000381469727,"wires":[["f925ec76.18b2f"]]},{"id":"f925ec76.18b2f","type":"coap request","z":"df136e3e.4e7d","method":"GET","observe":false,"url":"coap://localhost:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"GET /storage/LED","x":410,"y":200,"wires":[["6f958c62.409d54"]]},{"id":"9e6c880e.32a7d8","type":"coap request","z":"df136e3e.4e7d","method":"PUT","observe":false,"url":"coap://localhost:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"PUT /storage/LED","x":410,"y":260,"wires":[[]]},{"id":"256f1e85.2723d2","type":"coap request","z":"df136e3e.4e7d","method":"POST","observe":false,"url":"coap://localhost:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"POST /storage/LED","x":420,"y":80,"wires":[[]]},{"id":"c0750d6e.d5125","type":"coap request","z":"df136e3e.4e7d","method":"GET","observe":true,"url":"coap://localhost:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"GET Observe /storage/LED","x":440,"y":400,"wires":[["8479ef81.37ad8"]]},{"id":"a8c5b72d.2760f8","type":"coap request","z":"df136e3e.4e7d","method":"GET","observe":false,"url":"coap://localhost:5683/.well-known/core","content-format":"text/plain","raw-buffer":false,"name":"GET /.well-known/core","x":419,"y":158,"wires":[["6f958c62.409d54"]]}]
ETSI CoAP – Node Red as CoAP server & LED control
We’ll use Node red coap server node at url : coap://127.0.0.1:55683/storage/LED  
Copy the 2 ‘PUT’ and the ‘GET’ CoAP output nodes from previous flow to your main MQTT flow and Update their server URL to coap://127.0.0.1:55683/storage/LED 
     (We use a different port to avoid conflicts with coapserver.py)
Create a POST /storage/LED coap input node, port 55863
Create a PUT /storage/LED coap input node
Connect these 2 inputs to a fct to convert coap msg.req.payload (byte array) buffer to standard msg.payload string
Connect this function node to your existing parse command node
Test from Python : python coapclient.py -o PUT -p coap://192.168.0.92:55683/storage/LED -P LED_OFF   	(^Z to stop or connect PUT input node to responder function as well: see next slide)
295
This is the node red embedded CoAP server URL&port
ETSI CoAP – Node Red as CoAP server & LED control
To answer CoAP state requests 
Create a GET /storage/LED coap input node, port 55683
Connect it to a fct to return LED state as string
Test it with python coapclient.py -o GET -p coap://192.168.0.92:55683/storage/LED
296
ETSI CoAP – Node Red as CoAP server & LED
297
ETSI CoAP – Node Red as CoAP server & LED
298
Node red flow CoAPServerLED
[{"id":"64900356.9f6658","type":"tab","label":"CoAPServerLED","disabled":false,"info":""},{"id":"c188ea20.9a2b68","type":"debug","z":"64900356.9f6658","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"req.payload","x":390,"y":340,"wires":[]},{"id":"ddf632db.5f6a48","type":"coap in","z":"64900356.9f6658","method":"POST","name":"","server":"495d5a17.d737ac","url":"/storage/LED","x":160,"y":340,"wires":[["c188ea20.9a2b68","7b47c80c.bac82c"]]},{"id":"d9658e27.791398","type":"coap request","z":"64900356.9f6658","method":"PUT","observe":false,"url":"coap://127.0.0.1:55683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"PUT /storage/LED","x":450,"y":160,"wires":[[]]},{"id":"9b09945b.23141","type":"inject","z":"64900356.9f6658","name":"","topic":"","payload":"LED_ON","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"","x":140,"y":140,"wires":[["d9658e27.791398"]]},{"id":"749b9e59.0b5a74","type":"inject","z":"64900356.9f6658","name":"","topic":"","payload":"LED_OFF","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"","x":140,"y":180,"wires":[["d9658e27.791398"]]},{"id":"d0af77c4.e0376","type":"coap in","z":"64900356.9f6658","method":"PUT","name":"","server":"495d5a17.d737ac","url":"/storage/LED","x":150,"y":380,"wires":[["c188ea20.9a2b68","7b47c80c.bac82c"]]},{"id":"f5bf76d7.6bc5f8","type":"switch","z":"64900356.9f6658","name":"Parse command","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"LED_OFF","vt":"str"},{"t":"eq","v":"LED_ON","vt":"str"},{"t":"eq","v":"LED_SWITCH","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":4,"x":600,"y":520,"wires":[["54ce97ae.a7a6bc"],["ef59f034.4cf05"],[],[]]},{"id":"54ce97ae.a7a6bc","type":"function","z":"64900356.9f6658","name":"Set LED state OFF","func":"var currentLedState = flow.get(\"LEDState\")||0;\nif (currentLedState===0)\n    return null;\n    \nledState = 0;\nmsg.payload = ledState;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"noerr":0,"x":850,"y":500,"wires":[["d42432e9.5c868"]]},{"id":"ef59f034.4cf05","type":"function","z":"64900356.9f6658","name":"Set LED state ON","func":"currentLedState = flow.get(\"LEDState\")||0;\nledPower=flow.get(\"LEDPower\")||0;\n\nif (currentLedState==1)\n    if (ledPower==100)\n        return null;\n    else\n        ledPower=100;\n\nledState = 1;\nif (ledPower===0)\n    ledPower=100;\n    \nmsg.payload = ledPower;\n\nflow.set(\"LEDState\", ledState);\nflow.set(\"LEDPower\", ledPower);\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":540,"wires":[["d42432e9.5c868"]]},{"id":"d42432e9.5c868","type":"change","z":"64900356.9f6658","name":"Dispatch","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1040,"y":520,"wires":[["e3c7960e.f41d68","47a10d1b.ae485c"]]},{"id":"47a10d1b.ae485c","type":"rpi-gpio out","z":"64900356.9f6658","name":"LED on GPIO18","pin":"12","set":false,"level":"0","freq":"","out":"pwm","x":1220,"y":480,"wires":[]},{"id":"e3c7960e.f41d68","type":"debug","z":"64900356.9f6658","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":1210,"y":540,"wires":[],"inputLabels":["msg.payload"]},{"id":"7b47c80c.bac82c","type":"function","z":"64900356.9f6658","name":"BufferToString","func":"msg.payload=msg.req.payload.toString();\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":400,"wires":[["f5bf76d7.6bc5f8","a1a99a9e.3f50c8"]]},{"id":"a1a99a9e.3f50c8","type":"debug","z":"64900356.9f6658","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"req.payload","x":610,"y":400,"wires":[]},{"id":"9eecec8a.2762b","type":"comment","z":"64900356.9f6658","name":"Add this to your MQTT flow","info":"","x":170,"y":260,"wires":[]},{"id":"e59b3266.13124","type":"comment","z":"64900356.9f6658","name":"..............................  Existing MQTT Flow.....................................","info":"","x":750,"y":460,"wires":[]},{"id":"5510c27a.af3768","type":"comment","z":"64900356.9f6658","name":"Copy and update this to your MQTT flow","info":"","x":220,"y":60,"wires":[]},{"id":"797fda09.797bc4","type":"function","z":"64900356.9f6658","name":"Responder","func":"currentLedState = flow.get(\"LEDState\")||0;\ncurrentLedPower = flow.get(\"LEDPower\")||0;\n\nif (currentLedState===0)\n    msg.res.end(\"0\");\nelse\n    msg.res.end(currentLedPower.toString());\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":300,"wires":[[]]},{"id":"20b99002.664764","type":"coap in","z":"64900356.9f6658","method":"GET","name":"","server":"495d5a17.d737ac","url":"/storage/LED","x":150,"y":300,"wires":[["797fda09.797bc4"]]},{"id":"8f45d623.197e88","type":"debug","z":"64900356.9f6658","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","x":720,"y":100,"wires":[]},{"id":"7a74b09b.49b53","type":"coap request","z":"64900356.9f6658","method":"GET","observe":true,"url":"coap://localhost:55683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"GET /storage/LED","x":450,"y":100,"wires":[["8f45d623.197e88"]]},{"id":"b0f3423a.8d45e","type":"inject","z":"64900356.9f6658","name":"","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"","x":130,"y":100,"wires":[["7a74b09b.49b53"]]},{"id":"495d5a17.d737ac","type":"coap-server","z":"","name":"NodeRedServer","port":"55683"}]
OMA - LWM2M
299
A device management protocol for IoT, over CoAP (v1.1) … or MQTT (v1.2)
Based on Interfaces and objects (collection of resources, data models)
Resource may be Read / Written / Executed
Resources URI : /ObjectID/ObjectInstance/ResourceID
Ex : 
Position exposed in tracker: object, Latitude & Longitude resources, e.g. « /P/L », R access
Smart home lamps control: Room object & Lamp number resource instance & lamp state resource, e.g « /Bedroom/1/State », RW access
Open Mobile Alliance
OMA - LWM2M
300
A good intro on the topic : 
https://mbed-media.mbed.com/filer_public/c1/c3/c1c35bec-5f0e-4a28-a422-115248c9a181/armmbed-lwm2m-webinar.pdf 
A bit more cryptic : 
http://www.openmobilealliance.org/release/LightweightM2M/Lightweight_Machine_to_Machine-v1_1-OMASpecworks.pdf 
Node Red support : 
https://www.npmjs.com/package/node-red-contrib-lwm2m 
For testing : 
The LWM2M server is available at  coap://leshan.eclipseprojects.io:5683  (both IPv4/6 are available) A web interface allows to interact with sample registered clients:  https://leshan.eclipseprojects.io/ 
Zigbee - IEEE 802.15.4
301
Protocol from Zigbee Alliance to create personal area networks
Low-Power, ‘simpler’ and cheaper than Wifi, 868 MHz, 915 MHz & 2.4GHz
10–100 meters, extended via mesh networking
Network gets stronger as it grows, self healing
127Bytes/packets (68B payload). 250 kbit/s
Secured with AES128
Domains 
Home automation
Sensors network
Industrial Control Systems (ICS)
Alarm panels
Lighting
…
Zigbee – Terminology & Architecture
302
Network layer (NW) in charge of mesh communications
Application Support (APS) & Application (APL)
APS provides security primitives to Applications
Profiles to allow interoperability 
ZigBee Smart Energy (SE - 0x0109)
ZigBee Personal Home & Hospital Care (PHHC - 0x0108)
ZigBee Home Automation (HA - 0x0104)
…
Clusters are functional packages in profiles
Define input/outputs for sets of features
E.g. light control On/Off in HA profile 
May be included in multiple profiles
MAC
PHY
NW
APS
APL
Profiles
Clusters
Zigbee - Mesh networking
303
Network roles
ZigBee Coordinator (ZC)
Unique, bootstraps network (decides the PAN id and radio channel)
Broadcasts beacon with network details to other devices
Then becomes a regular Router
ZigBee Router (ZR) 
Routes & stores message for its attached End-devices
ZigBee End-Device (ZED)   
Simplest device, Offline most of the time
Device types
FFD (Full Function Device) implement all specification’s protocols 
	They may act as coordinators, routers, and end-devices
RFD (Reduce Function Device) usually battery/memory-constrained devices 
	end-devices only	
Note mesh networking allows star or tree network types
Zigbee – Network level security
Basic access control to participate in a given Zigbee network
Independent of the applications
Network-wide key
All devices part of the network have a copy
128bits AES key used for
Payload encryption/decryption
Message authentication (MIC = hash)
Frame counter against replay attacks
Key renewal (with key index) from Trust Center (secured by previous key)
To block devices with compromised key rejoining later on (!)
Zigbee – Network level security
Hop By Hop security
Packets are authenticated & decrypted, then resent « securely » by routing entity
Confidentiality anyone? 
Blocks bad traffic immediately
How to distribute this network key ? The « join » phase with Trust Center (TC)…
Network join
Device must listen to beacon messages
Or send beacon request on several channels
Network Key will be sent to joining device after proper “authorization”
By a Central Trust Center (quite often the ZC)
Must authorize all new devices to join (i.e. get the key)
Or by Distributed Trust Centers 
Any router may authorize new devices to join (i.e. get the key)
How to secure this initial network key distribution?
First version were transmitting it in clear… so forcing a legit device to rejoin was leaking the key.
Zigbee - Application Support Security (APS)
APS is optional (but may be mandated in specific profiles like smart energy)
Provides E2E security (authn & confidentiality) of messages exchanged between 2 devices 
APS relies on shared key known by both entities : the link key(s)
TC (trust center) link key
Application link key
APS security is applied to network packet payload 
But how is this new link key established ?
Zigbee - Application Support Security (APS)
Devices may come with pre-established E2E APS link keys (leading to closed solutions)
Or rely on TC support for APS Link Keys bootstrapping
TC acts as trusted 3rd party
Application link key distribution secured by TC’s link key
Previously, network key was either distributed in clear or «known in advance» by all devices
With APS link key model, devices « know in advance » the link key, and receive the network key encrypted.
Still, how is the initial TC link key known?
Zigbee – Application Support Security (APS)
Provisioning of link key in Zigbee 3.0
308
Standard mode (minimal level)
All devices know a default TC link key 
Very often 	   5A:69:67:42:65:65:41:6C:6C:69:61:6E:63:65:30:39 ("ZigbeeAlliance09“)
Philips Hue uses 81:42:86:86:5D:C1:C8:B2:C8:CB:C5:2E:5D:65:D1:B8
Network key is sent « secured » with this default link key
Link key management is up to the TC (renew or not / 1 link key for all or 1 link key per device)
Zigbee 3.0 enhanced profiles (mandatory in some domains like smart energy)
Devices come with installation code
TC must be pre-provisioned with each authorized device installation code 
On join, both sides compute installation code link key 
Some profiles mandate initial link key renewal with certificates (CBKE : Certificate Based Key Establishment)
Zigbee – Security analysis
Protection of network key and  [default/shared] link keys accross all (cost-contrained) devices
Unsecure storage 
Hardware attacks
Provisioning of network key
In clear (residential security model, now forbidden with Zigbee 3.0)
Secured by link key (high security model, now minimal security level with Zigbee 3.0)
Provisioning of link key in Zigbee 3.0
Well known keys : Joining a new device or force rejoin (e.g. jamming) will leak both keys
Registration code : process out of scope for standard
Touchlink (based on proximity!)
Network architecture choice 
With or w/o TC
Lots of optional security mechanisms for TC 
Bad implementation 
Security vs usability & convenience
309
Zigbee - Attacks
Classes 
Sniffing
Clear traffic
Default link key
Force repair of a device and listen…
Replay
Forgery
DoS 
heavy load on a node,
Or forge packet with high Seq #
Some tools
Sniffer key
Wireshark
KillerBee python framework
310
After network encryption key has been captured and added to Trust center, you may decrypt all traffic 
Smart lamps – Our competition is facing problems ;)
311
https://www.rtbf.be/tendance/techno/detail_philips-hue-le-pont-de-premiere-generation-ne-pourra-bientot-plus-se-connecter-a-internet?id=10450953
https://www.theverge.com/2016/11/3/13507126/iot-drone-hack 
IoT in the news - Hue
Some home IoT gateways technologies		
CC2531 / ZiGate
IKEA Tradfri GW access via CoAP
Install coap-client with tls support on RPI
sudo apt-get install build-essential autoconf automake libtool
git clone --recursive https://github.com/obgm/libcoap.git
cd libcoap
git checkout dtls
git submodule update --init --recursive
./autogen.sh
./configure --disable-documentation --disable-shared
make
sudo make install
Find your Tradfri GW coap endpoint 
IP @ e.g. from DHCP: coaps://192.168.0.240:5684/
PSK written under the GW : ls2Iy2Wb3tLCpBC9 
More Infos : https://github.com/glenndehaan/ikea-tradfri-coap-docs/blob/master/README.md 
313
IKEA encoding of resources
15001 get root devices
15004 groups -> add/remove
15005 Moods  -> add / remove
15010 smart tasks
15011 Gateway
		9063 request session key
		9091 session Key
		15012  GW info
		9021 FW version
		9034 
		9030  GW  reboot  
		9031 GW factory default
		9102
		9094 send cert to GW
		9095 cognitoID to GW
		9110 add/remove
	/65xxx Device
		9001 name
		3311 bulb
			5850 on/off state
			5851 dimming lvl
			5706 color in HEX
		3312 plug
			5850 on/off state
			5851 dimming lvl
…
IKEA Tradfri GW access via CoAP
      Sample commands
List endpoints: coap-client -m get -u "Client_identity" -k "ls2Iy2Wb3tLCpBC9" "coaps://192.168.0.240:5684/.well-known/core"
<//15006>;ct=0;obs,<//15001>;ct=0;obs,<//15004>;ct=0;obs,<//15004/add>;ct=0,<//15004/remove>;ct=0,<//15010>;ct=0;obs,<//15005>;ct=0;obs,<//15005/add>;ct=0,<//15005/remove>;ct=0,<//15011/15012>;ct=0;obs,<//15011/9034>;ct=0,<//15011/9030>;ct=0,<//15011/9031>;ct=0,<//15011/9102>;ct=0,<//15011/9094>;ct=0;obs,<//15011/9095>;ct=0;obs,<//15011/9104>;ct=0;obs,<//15011/9110>;ct=0;obs,<//15011/9110/add>;ct=0,<//15011/9110/remove>;ct=0,<//15011/9110/update>;ct=0,<//sonos>;ct=0,<//15011/9063>;ct=0
Get session key : coap-client -m post -u "Client_identity" -k "ls2Iy2Wb3tLCpBC9" "coaps://192.168.0.240:5684/15011/9063" -e "{\"9090\":\"GERALD\"}"
	 {"9091":"UVBh1bILLhd6oqaD","9029":"1.13.0021"}
(Note : will only return session key on first time, to show it works use another username)
List devices : coap-client -m get -u "GERALD" -k "UVBh1bILLhd6oqaD" "coaps://192.168.0.240:5684/15001"
	 [65542,65544,65543]
Get device info :
     coap-client -m get -u "GERALD" -k "UVBh1bILLhd6oqaD" "coaps://192.168.0.240:5684/15001/65542"
   		{"9020":1615414355,"9001":"lampe","9003":65542,"9002":1606653847,"9054":0,"9019":1,"3":{"0":"IKEA of Sweden","1":"TRADFRI control outlet","2":"","3":"2.0.024","6":1,"7":4353},"5750":3,"3312":[{"5850":0,"5849":0,"5851":254,"9003":0}]}
Turn on/off outlet : 
     coap-client -m put -u "GERALD" -k "UVBh1bILLhd6oqaD" "coaps://192.168.0.240:5684/15001/65542" -e '{ "3312": [{ "5850":1}]}‘
314
Zigbee - IEEE 802.15.4
315
Protocol from Zigbee Alliance to create personal area networks
Low-Power, ‘simpler’ and cheaper than Wifi, 868 MHz, 915 MHz & 2.4GHz
10–100 meters, extended via mesh networking
Network get Stronger as it grows, secure, self healing
127Bytes/packets (68B payload). 250 kbit/s
Secured with AES128
Domains 
Home automation
Sensors network
Industrial Control Systems (ICS)
Alarm panels
Lighting
…
Connected Standard Alliance
(CSA)
Thread - IEEE 802.15.4
316
A connection protocol
IP Based
IPV6 6LoWPAN encapsulation & compression to send/receive IPV6 packets over 802.15.4
Complementary to Wifi for battery operated devices
Competitor for ZigBee & Zwave
Thread - IEEE 802.15.4
317
Thread roles
Thread border routers (routers, speakers…)bridges Thread network with Wifi/Ethernet
Commissioner provides interface for human admin to manage joining devices to the Thread network (mobile, server…),  requires commissioning credential input
Joining device
Thread device
Security
Mesh commissionning protocol is based on CoAP
Joiner Authn is forwarded by router to commissioner 
Authn & Key agreement : EC-JPAKE (NIST P-256 based key agreement for password-authenticated key exchange) on dTLS
Network-wide key : distributed securely to joiners by KEK. Protects casual eavesdropping, may be compromised on 1 node
V1.3
Added firmware update
Matter
318
A smart home standard
Initiated by project Connected Home over IP (Project CHIP) in 2019
Now maintained by the Connectivity Standards Alliance (CSA), 300+ companies
Officially launched in Nov 2022
Solves many pain points
Relies on IP networks
Offline capabilities
Multi admin applications
QR code & BLE device enrollment
 Agreement from many companies on how to do things in the same way (“nothing new”) and stop smart home fragmentation : an application layer working on IP connectivity
Matter
319
May be deployed as software update on most devices
Legacy Hubs may connect non compliant devices to Matter network
No security cameras support yet
Matter controller : used to enroll (commission) new matter devices to the network (QR or BLE). Typically a mobile. Transfers credentials to new devices as to join Matter network
No need to explain why ;-)
Process
All starts with secure boot (enabled!)
And software signature
With reliable flashing mechanisms (and recovery mechanism)
And a campaign manager to monitor progress and
To preserve download server and match its capacity
And prioritize critical fixes deployment vs evolutive changes
Challenges
Constrained bearer
Constrained memory
Securing the development process
Protecting the software issuer key
Consistency of « system level» upgrades (e.g. 100s car ECUs versions combinations to be tested)
Authorization of deployment (e.g. car maker to authorize an OEM update only after validation)
Capacity to remediate invalid (error/tampered firmware) without exposing system to « rollback attacks »
IP protection?
320
About IoT device firmware management
Some trends in IoT
Security ! (assessment, i/eSEs, pentesting,…)
Global 4/5/6G cellular coverage (Subscription management, …)
Blockchain for green energy, “produce & forget” manufacturing…
Edge computing (e.g. AWS green grass, GCP tensorflow…)
« The cloud » closer to the things (e.g. lambdas, broker, shadows…)
ML (in device or for risk management/preventive maintenance/…)
Regulations 
…
Check OWASP IoT Top 10 & IoTGoat: 
https://owasp.org/www-project-internet-of-things/ 
321
Edge Computing in the news… and in space!
322
Ref : https://www.futura-sciences.com/sciences/actualites/astronautique-spaceborne-supercalculateur-dote-ia-bord-station-spatiale-85760 
                         Charged By           :   
- “didn’t take reasonable steps to secure the software”
- “did not address security flaws in a timely manner and did not notify consumers”
- “mishandling of a private key code used to sign into device software”
- "lax security practices exposed the private lives of hundreds of consumers” 
What do they have in common?
FTC
323
IoT in the news
IoT in the news
Again!!
[…]
Attacker took control of my LED… so what?
Data exfiltration using hacked dimmable lights as covert channel (10KB/d !!)
Up to 100m distance
Bypass LED manufacturer PWM ‘soft limits’
Attack applies to airgapped networks!
https://eyalro.net/pdf/EyalShamirLed.pdf
Governments implement new regulations
327
Regulations enforcement 
NIST : National Institute for standards & technology
 Keys update every 1 to 5 years
EU cybersecurity rules on data protection (GDPR) and security of critical infrastructure (EPCIP)
End-to-end data encryption &access management
Implementing security best practices 
Challenge : when users and manufacturers are not the one impacted by a device compromise, who should bear the cost for the greater good?
328
Governments implement new regulations
329
Governments implement new regulations
330
Conclusion : Avoid the security pitfalls…
Consider the whole system and balance security appropriately to avoid false sense of security
Conclusion : Security by design, globally
A chain is as strong as its weakest link : Think security globally! 
Secure boot, Secure firmware update, code signing
Strong Authn, everywhere, with PoLP (Principle of Least Privilege), 0-trust
Data protection in transit & at rest, in processing (confidential computing, FHE)
Key diversification / lifecycle mgt / appropriate protection (scrambling, HSMs, SE, TPM, WBC…)
Active & continuous monitoring
…
 Never think you are not an interesting target!
 Review 3rd party components!
 Try to break it yourself, before someone else does…
	Lots of publications:                                      …
		                               Good luck!
331
Recommendations after the session
After you finalized all your projects, you should 
Clean AWS Account
Delete the SNS subscriptions
Delete IAM administrator role
Delete Rules and Lambdas
Delete device certificates
Close your AWS account
Reflash the RPI to delete all your credentials, certificates…
Remove saved configurations in WinSCP/PuTTY
Delete the Alexa skill from developer.amazon.com
Unregister Alexa mobile app from your amazon account (content & devices / devices)
Close your shiftr.io account
…
	If you want to continue exploring the domain you may delay this, but don’t forget!
332
AWS Academy : not required
Contact
           Gerald.Maunier@free.fr
           www.linkedin.com/in/geraldmaunier/
333
https://cyberwtf.com/ 
334
[{"id":"3bd72e5a35157b80","type":"tab","label":"Flow 1","disabled":true,"info":"","env":[]},{"id":"30b5a9db.13c7e6","type":"tab","label":"RPI_LED_1","disabled":true,"info":""},{"id":"d3f6bafc.517628","type":"tab","label":"RPI_LED_2","disabled":true,"info":""},{"id":"2d68519d.28fdfe","type":"tab","label":"RPI_BTN_1","disabled":true,"info":""},{"id":"d62b9251.93e15","type":"tab","label":"RPI_BTN_2","disabled":true,"info":""},{"id":"72ecef13.ebb5a","type":"tab","label":"RPI_LED_BTN_1","disabled":true,"info":""},{"id":"f7e0aaa6.572a88","type":"tab","label":"RPI_LED_BTN_2","disabled":true,"info":""},{"id":"1ded4532.a4972b","type":"tab","label":"RPI_LED_POWER","disabled":true,"info":""},{"id":"e741101a.b1d4","type":"tab","label":"MQTT_1","disabled":true,"info":""},{"id":"137193d4.a8058c","type":"tab","label":"SHIFTR.IO","disabled":true,"info":""},{"id":"1e548fd5.aa977","type":"tab","label":"DASHBOARD_1","disabled":true,"info":""},{"id":"3f152265.215cbe","type":"tab","label":"RPI_LED_BTN_MQTT_DASHBOARD_FINAL","disabled":false,"info":""},{"id":"5159049.a3450fc","type":"tab","label":"DASHBOARD_2","disabled":false,"info":""},{"id":"c3b403f3.a5a5b","type":"tab","label":"DASHBOARD_GROUP_PROJECT","disabled":false,"info":""},{"id":"2a24c7d9.e04938","type":"tab","label":"AWS1","disabled":true,"info":""},{"id":"8b6d1dc248c33d11","type":"tab","label":"AWS2","disabled":true,"info":""},{"id":"3da35f20.0b7b6","type":"tab","label":"AWS Policies#1","disabled":true,"info":""},{"id":"eeada7b9.633358","type":"tab","label":"AWS Policies#2","disabled":true,"info":""},{"id":"2ea861b1.19c0be","type":"tab","label":"AWSRules1","disabled":true,"info":""},{"id":"7055f43d.d3095c","type":"tab","label":"AWS SecProfile","disabled":true,"info":""},{"id":"df136e3e.4e7d","type":"tab","label":"CoAPClient","disabled":true,"info":""},{"id":"77dd7f0d.54335","type":"tab","label":"CoAPServerLED","disabled":true,"info":""},{"id":"d1da38f2.572138","type":"tab","label":"FINAL (on AWS)","disabled":true,"info":""},{"id":"bf296afbe68777e2","type":"tab","label":"Flow 4","disabled":true,"info":"","env":[]},{"id":"ba8bbef790ed6b79","type":"tls-config","name":"RPI2 Autogen","cert":"/home/pi/aws/acb6be34c8590a7f123c427bbd4bae6b76c99680b4c24d29c6f60e5a68cadcc7-certificate.pem.crt","key":"/home/pi/aws/acb6be34c8590a7f123c427bbd4bae6b76c99680b4c24d29c6f60e5a68cadcc7-private.pem.key","ca":"/home/pi/aws/AmazonRootCA1.pem","certname":"","keyname":"","caname":"","servername":"","verifyservercert":true,"alpnprotocol":""},{"id":"6ef2c7ecc7bb04bc","type":"mqtt-broker","name":"AWS","broker":"a1p9so0jpb0ckm-ats.iot.us-east-1.amazonaws.com","port":"8883","tls":"41d7a882.eec658","clientid":"RPI2","autoConnect":true,"usetls":true,"protocolVersion":"4","keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"87cc9444.0f3478","type":"mqtt-broker","name":"broker.hivemq.com","broker":"broker.hivemq.com","port":"1883","clientid":"","autoConnect":true,"usetls":false,"protocolVersion":4,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"2603cee1.048f22","type":"tls-config","name":"RPI1","cert":"/home/pi/OwnPKI/RPI1.crt","key":"/home/pi/OwnPKI/RPI1.key","ca":"/home/pi/awsCerts/AmazonRootCA1.pem","certname":"cc2956e006-certificate.pem.crt","keyname":"cc2956e006-private.pem.key","caname":"VeriSign-Class 3-Public-Primary-Certification-Authority-G5.pem","servername":"","verifyservercert":true,"alpnprotocol":""},{"id":"26cc290e.df7a56","type":"mqtt-broker","name":"AWS RPI1","broker":"a1p9so0jpb0ckm-ats.iot.us-east-1.amazonaws.com","port":"8883","tls":"2603cee1.048f22","clientid":"RPI1","autoConnect":true,"usetls":true,"protocolVersion":"4","keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willRetain":"false","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"41d7a882.eec658","type":"tls-config","name":"RPI2","cert":"/home/pi/OwnPKI/RPI2.crt","key":"/home/pi/OwnPKI/RPI2.key","ca":"/home/pi/awsCerts/AmazonRootCA1.pem","certname":"","keyname":"","caname":"","servername":"","verifyservercert":true,"alpnprotocol":""},{"id":"f443af26.bbf6b","type":"mqtt-broker","name":"AWS RPI2","broker":"a1p9so0jpb0ckm-ats.iot.us-east-1.amazonaws.com","port":"8883","tls":"41d7a882.eec658","clientid":"RPI2","autoConnect":true,"usetls":true,"protocolVersion":"4","keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willRetain":"false","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"8347ae6e.249ec","type":"mqtt-broker","name":"AWS RPI2 trying to fake RPI1","broker":"a16auruvfvphj1-ats.iot.us-east-1.amazonaws.com","port":"8883","tls":"41d7a882.eec658","clientid":"RPI1","autoConnect":true,"usetls":true,"protocolVersion":4,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"dac21b5b.b18148","type":"mqtt-broker","name":"mqtt.eclipse.org","broker":"mqtt.eclipse.org","port":"1883","clientid":"RPI1","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"1c9f8b1.96f8e75","type":"mqtt-broker","name":"shiftr.io","broker":"gerald:licIOy58XhOO6JC2@gerald.cloud.shiftr.io","port":"1883","clientid":"MyNodeRed","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"d327ea10.85a108","type":"mqtt-broker","name":"HiveMQ","broker":"broker.mqttdashboard.com","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"62eafb60.a61604","type":"mqtt-broker","name":"","broker":"test.mosquitto.org","port":"1883","clientid":"Test222","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"77fe118c.eeb1f","type":"mqtt-broker","name":"MQTTDashboard","broker":"broker.mqttdashboard.com","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"ca9a434.6ddeec","type":"mqtt-broker","name":"AWS RPI1 trying to fake RPI2","broker":"a16auruvfvphj1-ats.iot.us-east-1.amazonaws.com","port":"8883","tls":"2603cee1.048f22","clientid":"RPI2","usetls":true,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"e88ba527.cfceb8","type":"tls-config","name":"RPI3 own CA","cert":"/home/pi/OwnPKI/RPI3.crt","key":"/home/pi/OwnPKI/RPI3.key","ca":"/home/pi/OwnPKI/AmazonRootCA1.pem","certname":"RPI3.crt","keyname":"RPI3.key","caname":"AmazonRootCA1.pem","servername":"","verifyservercert":true,"alpnprotocol":""},{"id":"6ee9e116.283a7","type":"mqtt-broker","name":"AWS RPI3","broker":"a1p9so0jpb0ckm-ats.iot.us-east-1.amazonaws.com","port":"8883","tls":"e88ba527.cfceb8","clientid":"RPI3","autoConnect":true,"usetls":true,"protocolVersion":"4","keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"b1dcf4ce.3b88a8","type":"ui_tab","z":"3f152265.215cbe","name":"Home","icon":"link","order":1},{"id":"49ee7405.9ae99c","type":"ui_group","z":"3f152265.215cbe","name":"Second","tab":"4823d28e.7016ec","order":2,"disp":true,"width":"5","collapse":false},{"id":"4823d28e.7016ec","type":"ui_tab","name":"Home","icon":"dashboard","disabled":false,"hidden":false},{"id":"f23007e6.54c398","type":"ui_base","theme":{"name":"theme-light","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#0094CE","value":"#0094CE","edited":false},"page-titlebar-backgroundColor":{"value":"#0094CE","edited":false},"page-backgroundColor":{"value":"#fafafa","edited":false},"page-sidebar-backgroundColor":{"value":"#ffffff","edited":false},"group-textColor":{"value":"#1bbfff","edited":false},"group-borderColor":{"value":"#ffffff","edited":false},"group-backgroundColor":{"value":"#ffffff","edited":false},"widget-textColor":{"value":"#111111","edited":false},"widget-backgroundColor":{"value":"#0094ce","edited":false},"widget-borderColor":{"value":"#ffffff","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey","palette":"light"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"4608a4ea.943abc","type":"ui_group","name":"Test","tab":"4823d28e.7016ec","order":1,"disp":true,"width":"6","collapse":false},{"id":"ab690596.b277f8","type":"ui_tab","name":"Group","icon":"dashboard","disabled":false,"hidden":false},{"id":"e7794a15.c6d108","type":"ui_group","name":"Test","tab":"ab690596.b277f8","order":3,"disp":true,"width":"6","collapse":false},{"id":"63c5ce38.817cc","type":"ui_group","name":"bd4b99eb.217178","tab":"b1dcf4ce.3b88a8","order":null,"disp":true,"width":6},{"id":"50a4452b.d22cdc","type":"ui_spacer","name":"spacer","group":"63c5ce38.817cc","order":1,"width":1,"height":1},{"id":"7d4138fe.5bb9d8","type":"coap-server","name":"Embedded server","port":"5683","ipv6":false},{"id":"415e40d16c682325","type":"debug","z":"3bd72e5a35157b80","name":"debug 1","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":560,"y":120,"wires":[]},{"id":"35faa3f27e82d9da","type":"rpi-gpio in","z":"3bd72e5a35157b80","name":"","pin":"4","intype":"tri","debounce":"25","read":false,"bcm":true,"x":230,"y":100,"wires":[["415e40d16c682325"]]},{"id":"972254ded67606c1","type":"rpi-gpio out","z":"3bd72e5a35157b80","name":"","pin":"18","set":"","level":"0","freq":"","out":"out","bcm":true,"x":540,"y":220,"wires":[]},{"id":"5d5c1c94511f576e","type":"inject","z":"3bd72e5a35157b80","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"true","payloadType":"bool","x":230,"y":280,"wires":[["972254ded67606c1","2594928a7d9bd59d"]]},{"id":"9e23363d6133533b","type":"inject","z":"3bd72e5a35157b80","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"false","payloadType":"bool","x":230,"y":220,"wires":[["972254ded67606c1","81f0ef74de850d46"]]},{"id":"81f0ef74de850d46","type":"mqtt out","z":"3bd72e5a35157b80","name":"","topic":"RPI/RPI2/Test","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"6ef2c7ecc7bb04bc","x":620,"y":340,"wires":[]},{"id":"2594928a7d9bd59d","type":"mqtt out","z":"3bd72e5a35157b80","name":"","topic":"RPI/RPI2/Test","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"6ef2c7ecc7bb04bc","x":620,"y":440,"wires":[]},{"id":"3508d9c9aad11f77","type":"inject","z":"3bd72e5a35157b80","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"1","crontab":"","once":false,"onceDelay":"1","topic":"","payload":"","payloadType":"date","x":210,"y":460,"wires":[[]]},{"id":"5c2378cb01887741","type":"inject","z":"3bd72e5a35157b80","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":880,"y":160,"wires":[["e7a4e980cc1f5db2","9299d89f42cc7342"]]},{"id":"e7a4e980cc1f5db2","type":"debug","z":"3bd72e5a35157b80","name":"debug 2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1120,"y":160,"wires":[]},{"id":"9299d89f42cc7342","type":"debug","z":"3bd72e5a35157b80","name":"debug 3","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":1100,"y":400,"wires":[]},{"id":"3ab16a29362f793f","type":"inject","z":"3bd72e5a35157b80","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"0","payloadType":"num","x":850,"y":300,"wires":[["9299d89f42cc7342","e7a4e980cc1f5db2","50a4044374da1859"]]},{"id":"50a4044374da1859","type":"function","z":"3bd72e5a35157b80","name":"function 1","func":"msg.payload=1;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":940,"y":520,"wires":[["9299d89f42cc7342"]]},{"id":"980c9839eeebcdab","type":"inject","z":"3bd72e5a35157b80","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":220,"y":20,"wires":[["38c840fd71879bf1"]]},{"id":"38c840fd71879bf1","type":"debug","z":"3bd72e5a35157b80","name":"debug 4","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":500,"y":20,"wires":[]},{"id":"283b0aeb.64d366","type":"inject","z":"30b5a9db.13c7e6","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED OFF","payload":"0","payloadType":"num","x":170,"y":220,"wires":[["3d4e12a.e9702ee","e59efd27.4c3c5"]]},{"id":"3d4e12a.e9702ee","type":"debug","z":"30b5a9db.13c7e6","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":890,"y":200,"wires":[],"inputLabels":["msg.payload"]},{"id":"75d2cabd.049644","type":"inject","z":"30b5a9db.13c7e6","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED ON","payload":"1","payloadType":"num","x":160,"y":260,"wires":[["e59efd27.4c3c5","3d4e12a.e9702ee"]]},{"id":"e59efd27.4c3c5","type":"rpi-gpio out","z":"30b5a9db.13c7e6","name":"Led on GPIO18","pin":"18","set":true,"level":"0","freq":"","out":"out","bcm":true,"x":900,"y":260,"wires":[]},{"id":"15fb9d6e.98b8a3","type":"inject","z":"30b5a9db.13c7e6","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":120,"y":100,"wires":[["811e1f9a.fe376"]]},{"id":"811e1f9a.fe376","type":"debug","z":"30b5a9db.13c7e6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":340,"y":100,"wires":[]},{"id":"902a5801.3c24a8","type":"function","z":"d3f6bafc.517628","name":"Switch LED state","func":"var myvarnode = !context.get(\"myvarnode\");\ncontext.set(\"myvarnode\",myvarnode);\nmsg.payload=myvarnode;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":710,"y":460,"wires":[["eb402fd6.92129","725a55fc.06aeac"]]},{"id":"3a7b28a0.64f358","type":"inject","z":"d3f6bafc.517628","name":"chaque seconde","repeat":"1","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"date","x":330,"y":520,"wires":[[]]},{"id":"b59dbe3f.e3994","type":"inject","z":"d3f6bafc.517628","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED OFF","payload":"0","payloadType":"num","x":310,"y":360,"wires":[["725a55fc.06aeac","eb402fd6.92129"]]},{"id":"725a55fc.06aeac","type":"debug","z":"d3f6bafc.517628","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":1030,"y":340,"wires":[],"inputLabels":["msg.payload"]},{"id":"7224d36c.5491cc","type":"inject","z":"d3f6bafc.517628","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED ON","payload":"1","payloadType":"num","x":300,"y":400,"wires":[["eb402fd6.92129","725a55fc.06aeac"]]},{"id":"eb402fd6.92129","type":"rpi-gpio out","z":"d3f6bafc.517628","name":"Led on GPIO18","pin":"18","set":false,"level":"0","freq":"","out":"out","bcm":true,"x":1040,"y":400,"wires":[]},{"id":"c25a4ab6.bb9ab8","type":"inject","z":"d3f6bafc.517628","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"SWITCH LED","payload":"1","payloadType":"num","x":320,"y":460,"wires":[["902a5801.3c24a8"]]},{"id":"515abade.1a5be4","type":"debug","z":"2d68519d.28fdfe","name":"Button value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":770,"y":300,"wires":[],"inputLabels":["msg.payload"]},{"id":"23cd878a47e11f96","type":"rpi-gpio in","z":"2d68519d.28fdfe","name":"BTN on GPIO4","pin":"4","intype":"up","debounce":"25","read":true,"bcm":true,"x":320,"y":300,"wires":[["515abade.1a5be4"]]},{"id":"cb7f19a8.a7ae38","type":"rpi-gpio in","z":"d62b9251.93e15","name":"BTN on GPIO4","pin":"4","intype":"up","debounce":"25","read":true,"bcm":true,"x":360,"y":200,"wires":[["7304d5d2.cf722c"]]},{"id":"7304d5d2.cf722c","type":"rpi-gpio out","z":"d62b9251.93e15","name":"Led on GPIO18","pin":"18","set":false,"level":"0","freq":"","out":"out","bcm":true,"x":740,"y":200,"wires":[]},{"id":"3a693104.ead97e","type":"function","z":"72ecef13.ebb5a","name":"Switch LED state","func":"var myvarnode = !context.get(\"myvarnode\");\ncontext.set(\"myvarnode\", myvarnode);\nmsg.payload = myvarnode;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":670,"y":220,"wires":[["8a141a57.f516d8","9988edf5.8a8af"]]},{"id":"c1bf6711.e38f88","type":"inject","z":"72ecef13.ebb5a","name":"SWITCH LED","repeat":"1","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"date","x":220,"y":260,"wires":[[]]},{"id":"a2a5b2b3.448d4","type":"inject","z":"72ecef13.ebb5a","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED OFF","payload":"0","payloadType":"num","x":210,"y":120,"wires":[["9988edf5.8a8af","8a141a57.f516d8"]]},{"id":"9988edf5.8a8af","type":"debug","z":"72ecef13.ebb5a","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":930,"y":80,"wires":[],"inputLabels":["msg.payload"]},{"id":"38233206.e4beae","type":"inject","z":"72ecef13.ebb5a","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED ON","payload":"1","payloadType":"num","x":200,"y":160,"wires":[["8a141a57.f516d8","9988edf5.8a8af"]]},{"id":"8a141a57.f516d8","type":"rpi-gpio out","z":"72ecef13.ebb5a","name":"Led on GPIO18","pin":"18","set":false,"level":"0","freq":"","out":"out","bcm":true,"x":940,"y":160,"wires":[]},{"id":"6fea8dbc.4c0f14","type":"rpi-gpio in","z":"72ecef13.ebb5a","name":"BTN on GPIO4","pin":"4","intype":"up","debounce":"25","read":true,"bcm":true,"x":220,"y":340,"wires":[["883815dc.bf1768"]]},{"id":"65cb1f01.0628f","type":"inject","z":"72ecef13.ebb5a","name":"SWITCH LED","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":210,"y":220,"wires":[["3a693104.ead97e"]]},{"id":"3d09e14.de42a1e","type":"function","z":"72ecef13.ebb5a","name":"If button down","func":"if (msg.payload===0)\n    return msg;\n    \nreturn  null;","outputs":1,"noerr":0,"x":440,"y":340,"wires":[[]]},{"id":"883815dc.bf1768","type":"switch","z":"72ecef13.ebb5a","name":"If button down","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":440,"y":300,"wires":[["3a693104.ead97e"],[]]},{"id":"d2f464b2.6660e8","type":"function","z":"f7e0aaa6.572a88","name":"Set LED state OFF","func":"var ledState = flow.get(\"LEDState\")||0;\nif (ledState===0)\n    return null;\n    \nledState = 0;\nmsg.payload = 0;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":140,"wires":[["e9fc023b.8920b"]]},{"id":"26b192f9.d4ebee","type":"function","z":"f7e0aaa6.572a88","name":"Set LED state ON","func":"var ledState = flow.get(\"LEDState\")||0;\nif (ledState==1)\n        return null;\n\nledState = 1;\nmsg.payload = 1;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":180,"wires":[["e9fc023b.8920b"]]},{"id":"e9fc023b.8920b","type":"change","z":"f7e0aaa6.572a88","name":"Dispatch","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":840,"y":160,"wires":[["f8ab0385.82db1","6073fa84.ab0024"]]},{"id":"ed9fa045.b70e9","type":"function","z":"f7e0aaa6.572a88","name":"Switch LED state","func":"var ledState=!flow.get(\"LEDState\");\n\nmsg.payload = ledState;\nflow.set(\"LEDState\", ledState);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":240,"wires":[["e9fc023b.8920b"]]},{"id":"163c5025.a9a45","type":"inject","z":"f7e0aaa6.572a88","name":"SWITCH LED","repeat":"1","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"date","x":200,"y":280,"wires":[[]]},{"id":"2c2a8daf.e5d5a2","type":"inject","z":"f7e0aaa6.572a88","name":"LED OFF","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"0","payloadType":"num","x":180,"y":140,"wires":[["d2f464b2.6660e8"]]},{"id":"f8ab0385.82db1","type":"debug","z":"f7e0aaa6.572a88","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":1030,"y":120,"wires":[],"inputLabels":["msg.payload"]},{"id":"dadd521c.de8f4","type":"inject","z":"f7e0aaa6.572a88","name":"LED ON","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":180,"y":180,"wires":[["26b192f9.d4ebee"]]},{"id":"6073fa84.ab0024","type":"rpi-gpio out","z":"f7e0aaa6.572a88","name":"Led on GPIO18","pin":"18","set":false,"level":"0","freq":"","out":"out","bcm":true,"x":1040,"y":180,"wires":[]},{"id":"2faeb32a.d0df3c","type":"rpi-gpio in","z":"f7e0aaa6.572a88","name":"BTN on GPIO4","pin":"4","intype":"up","debounce":"25","read":true,"bcm":true,"x":200,"y":360,"wires":[["400b610c.e5b86"]]},{"id":"44fdd616.fc72d8","type":"inject","z":"f7e0aaa6.572a88","name":"SWITCH LED","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":190,"y":240,"wires":[["ed9fa045.b70e9"]]},{"id":"82e435d3.ebe668","type":"function","z":"f7e0aaa6.572a88","name":"If button down","func":"if (msg.payload===0)\n    return msg;\n    \nreturn  null;","outputs":1,"noerr":0,"x":420,"y":360,"wires":[[]]},{"id":"400b610c.e5b86","type":"switch","z":"f7e0aaa6.572a88","name":"If button down","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":420,"y":320,"wires":[["ed9fa045.b70e9"],[]]},{"id":"4d40f320.124c4c","type":"function","z":"1ded4532.a4972b","name":"Set LED state OFF","func":"var ledState = flow.get(\"LEDState\")||0;\nif (ledState==0)\n    return null;\n    \nledState = 0;\nmsg.payload = 0;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":260,"wires":[["d74a7fd2.a6e3a"]]},{"id":"733584fd.88eb2c","type":"function","z":"1ded4532.a4972b","name":"Set LED state ON","func":"var ledState = flow.get(\"LEDState\")||0;\nif (ledState==1)\n        return null;\n\nledState = 1;\nmsg.payload = 100;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":300,"wires":[["d74a7fd2.a6e3a"]]},{"id":"d74a7fd2.a6e3a","type":"change","z":"1ded4532.a4972b","name":"Dispatch","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":280,"wires":[["fdf7999c.451d18","32f6f47c.7e68cc"]]},{"id":"fcc668b1.76bcb8","type":"function","z":"1ded4532.a4972b","name":"Switch LED state","func":"var ledState=!flow.get(\"LEDState\");\n\nif (ledState==true)\n    msg.payload = 100;\nelse\n    msg.payload=0;\n    \nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":360,"wires":[["d74a7fd2.a6e3a"]]},{"id":"eb037f81.33f6b","type":"inject","z":"1ded4532.a4972b","name":"SWITCH LED","repeat":"1","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"date","x":220,"y":400,"wires":[[]]},{"id":"d8d5759e.47fd68","type":"inject","z":"1ded4532.a4972b","name":"LED OFF","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"0","payloadType":"num","x":200,"y":260,"wires":[["4d40f320.124c4c"]]},{"id":"fdf7999c.451d18","type":"debug","z":"1ded4532.a4972b","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":1050,"y":240,"wires":[],"inputLabels":["msg.payload"]},{"id":"f2d9c5b0.039c38","type":"inject","z":"1ded4532.a4972b","name":"LED ON","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":200,"y":300,"wires":[["733584fd.88eb2c"]]},{"id":"32f6f47c.7e68cc","type":"rpi-gpio out","z":"1ded4532.a4972b","name":"Led on GPIO18","pin":"18","set":false,"level":"0","freq":"","out":"pwm","bcm":true,"x":1060,"y":300,"wires":[]},{"id":"fa776874.b5fc08","type":"rpi-gpio in","z":"1ded4532.a4972b","name":"BTN on GPIO4","pin":"4","intype":"up","debounce":"25","read":true,"bcm":true,"x":220,"y":480,"wires":[["3e497bb1.b28e14"]]},{"id":"775d9f80.41707","type":"inject","z":"1ded4532.a4972b","name":"SWITCH LED","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":210,"y":360,"wires":[["fcc668b1.76bcb8"]]},{"id":"916cfc38.fb2e7","type":"function","z":"1ded4532.a4972b","name":"If button down","func":"if (msg.payload===0)\n    return msg;\n    \nreturn  null;","outputs":1,"noerr":0,"x":440,"y":480,"wires":[[]]},{"id":"3e497bb1.b28e14","type":"switch","z":"1ded4532.a4972b","name":"If button down","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":440,"y":440,"wires":[["fcc668b1.76bcb8"],[]]},{"id":"0d835a5383a8369c","type":"inject","z":"1ded4532.a4972b","name":"LED 50%","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":200,"y":180,"wires":[["9f0cf5db6961ae97"]]},{"id":"9f0cf5db6961ae97","type":"function","z":"1ded4532.a4972b","name":"Set LED state ON 50%","func":"var ledState = 1;\nmsg.payload = 50;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":660,"y":180,"wires":[["d74a7fd2.a6e3a"]]},{"id":"8664dc52.fbb3a","type":"function","z":"e741101a.b1d4","name":"Set LED state OFF","func":"var currentLedState = flow.get(\"LEDState\")||0;\nif (currentLedState===0)\n    return null;\n    \nvar ledState = 0;\nmsg.payload = 0;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":280,"wires":[["e1076d28.eceb5"]]},{"id":"f3057296.5e0d1","type":"function","z":"e741101a.b1d4","name":"Set LED state ON","func":"var currentLedState = flow.get(\"LEDState\")||0;\n\nif (currentLedState==1)\n        return null;\n\nvar ledState = 1;\n\nmsg.payload = 100;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":320,"wires":[["e1076d28.eceb5"]]},{"id":"e1076d28.eceb5","type":"change","z":"e741101a.b1d4","name":"Dispatch","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":300,"wires":[["439702e.ee91efc","7b6391a.971f07","c1e9340a.eacbd8"]]},{"id":"6803aaf4.9b7534","type":"function","z":"e741101a.b1d4","name":"Switch LED state","func":"var ledState=flow.get(\"LEDState\")||0;\n\n(ledState === 0) ? ledState = 1 : ledState = 0;\nif (ledState==1)\n    msg.payload = 100;\nelse\n    msg.payload=0;\n    \nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":380,"wires":[["e1076d28.eceb5"]]},{"id":"9c1b622a.a3a77","type":"inject","z":"e741101a.b1d4","name":"SWITCH LED","repeat":"1","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"date","x":120,"y":420,"wires":[[]]},{"id":"8edb7ef5.f8bc8","type":"inject","z":"e741101a.b1d4","name":"LED OFF","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"0","payloadType":"num","x":100,"y":280,"wires":[["8664dc52.fbb3a"]]},{"id":"439702e.ee91efc","type":"debug","z":"e741101a.b1d4","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":1050,"y":260,"wires":[],"inputLabels":["msg.payload"]},{"id":"8f40660b.b51ad8","type":"inject","z":"e741101a.b1d4","name":"LED ON","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":100,"y":320,"wires":[["f3057296.5e0d1"]]},{"id":"7b6391a.971f07","type":"rpi-gpio out","z":"e741101a.b1d4","name":"Led on GPIO18","pin":"18","set":false,"level":"0","freq":"","out":"pwm","bcm":true,"x":1060,"y":320,"wires":[]},{"id":"2b818147.c3b2ce","type":"rpi-gpio in","z":"e741101a.b1d4","name":"BTN on GPIO4","pin":"4","intype":"up","debounce":"25","read":true,"bcm":true,"x":120,"y":500,"wires":[["4c6dd0a9.5b8d4"]]},{"id":"90ecfd7a.25b96","type":"inject","z":"e741101a.b1d4","name":"SWITCH LED","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":110,"y":380,"wires":[["6803aaf4.9b7534"]]},{"id":"88d2dc67.f728b","type":"function","z":"e741101a.b1d4","name":"If button down","func":"if (msg.payload===0)\n    return msg;\n    \nreturn  null;","outputs":1,"noerr":0,"x":340,"y":500,"wires":[[]]},{"id":"4c6dd0a9.5b8d4","type":"switch","z":"e741101a.b1d4","name":"If button down","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":340,"y":460,"wires":[["6803aaf4.9b7534"],[]]},{"id":"c1e9340a.eacbd8","type":"mqtt out","z":"e741101a.b1d4","name":"Publish MyLEDState","topic":"RPI/RPI1/MyLEDState","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"87cc9444.0f3478","x":1080,"y":200,"wires":[]},{"id":"607137dc.8ab9d8","type":"mqtt in","z":"e741101a.b1d4","name":"","topic":"RPI/RPI1/MyLEDCommand","qos":"2","datatype":"auto","broker":"87cc9444.0f3478","nl":false,"rap":false,"inputs":0,"x":160,"y":120,"wires":[["71dc3ba1.16f504","56a3928e.c688dc"]]},{"id":"71dc3ba1.16f504","type":"switch","z":"e741101a.b1d4","name":"Parse command","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"LED_OFF","vt":"str"},{"t":"eq","v":"LED_ON","vt":"str"},{"t":"eq","v":"LED_SWITCH","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":4,"x":400,"y":120,"wires":[["8664dc52.fbb3a"],["f3057296.5e0d1"],["6803aaf4.9b7534"],[]]},{"id":"56a3928e.c688dc","type":"debug","z":"e741101a.b1d4","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":390,"y":180,"wires":[]},{"id":"b4499a64.705478","type":"delay","z":"e741101a.b1d4","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":880,"y":600,"wires":[[]]},{"id":"95192660.c60728","type":"delay","z":"e741101a.b1d4","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"10","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":900,"y":640,"wires":[[]]},{"id":"5d31a82c2b388adb","type":"comment","z":"e741101a.b1d4","name":"broker.hivemq.com","info":"","x":130,"y":40,"wires":[]},{"id":"0b1201e769557346","type":"mqtt in","z":"e741101a.b1d4","name":"","topic":"RPI/RPI1/MyLEDState","qos":"1","datatype":"auto-detect","broker":"d327ea10.85a108","nl":false,"rap":true,"rh":0,"inputs":0,"x":920,"y":540,"wires":[["d12681e0aa18f1a5"]]},{"id":"d12681e0aa18f1a5","type":"debug","z":"e741101a.b1d4","name":"LED Value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":1170,"y":540,"wires":[]},{"id":"a48b626f8270c023","type":"comment","z":"e741101a.b1d4","name":"DEBUG","info":"","x":870,"y":480,"wires":[]},{"id":"fa3cc41d.ff5428","type":"mqtt out","z":"137193d4.a8058c","name":"shiftr.io","topic":"","qos":"","retain":"","broker":"1c9f8b1.96f8e75","x":720,"y":260,"wires":[]},{"id":"7bf0c0cc.cdbca","type":"function","z":"137193d4.a8058c","name":"Rate Limiter 100ms","func":"\nvar interval = 100; // minimum interval between messages (ms)\ncontext.lastTime = context.lastTime || 0;\n\nvar now = Date.now();\n\nif (context.lastTime===0)\n{\n    context.lastTime = now;\n    return null;\n}\n\n\nif (now-context.lastTime > interval) {\n  context.lastTime = now;\n  return msg;\n} else {\n  return null;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":490,"y":260,"wires":[["fa3cc41d.ff5428","d205c8a7.c11348"]]},{"id":"d205c8a7.c11348","type":"debug","z":"137193d4.a8058c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":730,"y":340,"wires":[]},{"id":"d158d6f1.89bbc8","type":"mqtt in","z":"137193d4.a8058c","name":"","topic":"FisherHouse/#","qos":"0","datatype":"auto-detect","broker":"77fe118c.eeb1f","nl":false,"rap":false,"inputs":0,"x":221.11112213134766,"y":307.7777900695801,"wires":[["836df232ad8c6116"]]},{"id":"becb353f.786828","type":"delay","z":"137193d4.a8058c","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"10","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":477.7777786254883,"y":308.88890266418457,"wires":[["d205c8a7.c11348","fa3cc41d.ff5428"]]},{"id":"c400345c.b33ff8","type":"mqtt in","z":"137193d4.a8058c","d":true,"name":"#","topic":"#","qos":"0","datatype":"auto","broker":"62eafb60.a61604","inputs":0,"x":187.66667938232422,"y":185.22224044799805,"wires":[["becb353f.786828"]]},{"id":"717eacfe.ba5bc4","type":"mqtt in","z":"137193d4.a8058c","name":"","topic":"FisherSystem/#","qos":"0","datatype":"auto-detect","broker":"77fe118c.eeb1f","nl":false,"rap":false,"inputs":0,"x":222.2222137451172,"y":245.55556678771973,"wires":[["836df232ad8c6116"]]},{"id":"836df232ad8c6116","type":"change","z":"137193d4.a8058c","name":"Unlimited","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":470,"y":380,"wires":[["d205c8a7.c11348","fa3cc41d.ff5428"]]},{"id":"6548e005.29678","type":"ui_slider","z":"1e548fd5.aa977","name":"slider","label":"slider","tooltip":"","group":"4608a4ea.943abc","order":6,"width":0,"height":0,"passthru":true,"outs":"all","topic":"test","topicType":"str","min":0,"max":"100","step":"10","className":"","x":450,"y":240,"wires":[["6d10cd30.79f024","f66a6ffc.6e235","ee4df0ea.7ff18"]]},{"id":"ee4df0ea.7ff18","type":"ui_text_input","z":"1e548fd5.aa977","name":"","label":"Select a value","tooltip":"","group":"4608a4ea.943abc","order":4,"width":0,"height":0,"passthru":false,"mode":"text","delay":300,"topic":"","sendOnBlur":true,"className":"","topicType":"str","x":240,"y":240,"wires":[["6548e005.29678"]]},{"id":"6d10cd30.79f024","type":"ui_gauge","z":"1e548fd5.aa977","name":"","group":"4608a4ea.943abc","order":9,"width":0,"height":0,"gtype":"gage","title":"gauge","label":"units","format":"{{value}}","min":0,"max":"100","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":670,"y":180,"wires":[]},{"id":"f66a6ffc.6e235","type":"ui_chart","z":"1e548fd5.aa977","name":"","group":"4608a4ea.943abc","order":11,"width":0,"height":0,"label":"chart","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"60","cutout":0,"useOneColor":false,"useUTC":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"outputs":1,"useDifferentColor":false,"x":670,"y":300,"wires":[[]]},{"id":"b94d3f90420b6d3f","type":"delay","z":"1e548fd5.aa977","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":300,"y":460,"wires":[[]]},{"id":"9e79a24b.119fd","type":"function","z":"3f152265.215cbe","name":"Switch LED state","func":"ledState=flow.get(\"LEDState\")||0;\nledPower=flow.get(\"LEDPower\")||0;\n\n(ledState === 0) ? ledState = 1 : ledState = 0;\nif (ledState==1)\n    {\n    if (ledPower===0)\n        ledPower=100;\n    msg.payload = ledPower;\n    }\nelse\n    msg.payload=0;\n    \nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":280,"wires":[["787e5b2c.a62404"]]},{"id":"577fc370.c516ec","type":"inject","z":"3f152265.215cbe","name":"SWITCH LED","repeat":"1","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"date","x":220,"y":320,"wires":[[]]},{"id":"55ef513a.7cb9d","type":"inject","z":"3f152265.215cbe","name":"LED OFF","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED OFF","payload":"0","payloadType":"num","x":200,"y":180,"wires":[["b8e52af8.91b5d8"]]},{"id":"e24ce3c1.d694c","type":"debug","z":"3f152265.215cbe","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":1110,"y":280,"wires":[],"inputLabels":["msg.payload"]},{"id":"2f2556b.a0869aa","type":"inject","z":"3f152265.215cbe","name":"LED ON","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED ON","payload":"ledPower","payloadType":"flow","x":200,"y":220,"wires":[["2fbc2614.bd7eda"]]},{"id":"38d3dc7.6469224","type":"rpi-gpio out","z":"3f152265.215cbe","name":"LED on GPIO18","pin":"18","set":false,"level":"0","freq":"","out":"pwm","bcm":true,"x":1120,"y":220,"wires":[]},{"id":"22f4c07.9e18d4","type":"rpi-gpio in","z":"3f152265.215cbe","name":"BTN on GPIO4","pin":"4","intype":"up","debounce":"25","read":true,"bcm":true,"x":220,"y":520,"wires":[["9eaf8262.2ef44"]]},{"id":"f42683eb.15bf7","type":"inject","z":"3f152265.215cbe","name":"SWITCH LED","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":210,"y":280,"wires":[["9e79a24b.119fd"]]},{"id":"5a6f8759.71f788","type":"function","z":"3f152265.215cbe","name":"If button down","func":"if (msg.payload===0)\n    return msg;\n    \nreturn  null;","outputs":1,"noerr":0,"x":420,"y":560,"wires":[[]]},{"id":"9eaf8262.2ef44","type":"switch","z":"3f152265.215cbe","name":"If button down","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":420,"y":520,"wires":[["9e79a24b.119fd"],[]]},{"id":"b8e52af8.91b5d8","type":"function","z":"3f152265.215cbe","name":"Set LED state OFF","func":"var currentLedState = flow.get(\"LEDState\")||0;\nif (currentLedState===0)\n    return null;\n    \nledState = 0;\nmsg.payload = ledState;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"noerr":0,"x":750,"y":180,"wires":[["787e5b2c.a62404"]]},{"id":"2fbc2614.bd7eda","type":"function","z":"3f152265.215cbe","name":"Set LED state ON","func":"currentLedState = flow.get(\"LEDState\")||0;\nledPower=flow.get(\"LEDPower\")||0;\n\nif (currentLedState==1)\n    if (ledPower==100)\n        return null;\n    else\n        ledPower=100;\n\nledState = 1;\nif (ledPower===0)\n    ledPower=100;\n    \nmsg.payload = ledPower;\n\nflow.set(\"LEDState\", ledState);\nflow.set(\"LEDPower\", ledPower);\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":220,"wires":[["787e5b2c.a62404"]]},{"id":"ce9d00b3.b9f2f","type":"mqtt in","z":"3f152265.215cbe","name":"","topic":"RPI/RPI1/MyLEDCommand","qos":"2","datatype":"auto","broker":"87cc9444.0f3478","inputs":0,"x":260,"y":40,"wires":[["de85a353.9ce42","e9b7d71d.451ed8"]]},{"id":"b9a52cb1.4f503","type":"mqtt out","z":"3f152265.215cbe","name":"Publish MyLEDState","topic":"RPI/RPI1/MyLEDState","qos":"","retain":"","broker":"87cc9444.0f3478","x":1140,"y":160,"wires":[]},{"id":"de85a353.9ce42","type":"switch","z":"3f152265.215cbe","name":"Parse command","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"LED_OFF","vt":"str"},{"t":"eq","v":"LED_ON","vt":"str"},{"t":"eq","v":"LED_SWITCH","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":4,"x":500,"y":40,"wires":[["b8e52af8.91b5d8"],["2fbc2614.bd7eda"],["9e79a24b.119fd"],["f8a45bac.ced858"]]},{"id":"e9b7d71d.451ed8","type":"debug","z":"3f152265.215cbe","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":490,"y":100,"wires":[]},{"id":"787e5b2c.a62404","type":"change","z":"3f152265.215cbe","name":"Dispatch","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":940,"y":220,"wires":[["e24ce3c1.d694c","38d3dc7.6469224","b9a52cb1.4f503","9b34547b.7e8bb8"]]},{"id":"f8a45bac.ced858","type":"change","z":"3f152265.215cbe","name":"Unknown command","rules":[{"t":"change","p":"payload","pt":"msg","from":"^(.*)$","fromt":"re","to":"Unknown MQTT command received : [$1] ","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":760,"y":40,"wires":[["9fabd03f.4376"]]},{"id":"ef0dfbee.65c3a8","type":"mqtt in","z":"3f152265.215cbe","name":"","topic":"RPI/RPI1/MyLEDPower","qos":"2","datatype":"auto","broker":"87cc9444.0f3478","inputs":0,"x":240,"y":140,"wires":[["e9b7d71d.451ed8","3b52a474.ea0d2c"]]},{"id":"3b52a474.ea0d2c","type":"function","z":"3f152265.215cbe","name":"Set LED Power","func":"var ledPower=msg.payload;\nvar ledState;\n\nif (ledPower===0)\n    {\n    ledState=0;\n    ledPower=100;\n    }\nelse\n    ledState=1;\n    \nflow.set(\"LEDState\", ledState);\nflow.set(\"LEDPower\", ledPower);\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":140,"wires":[["787e5b2c.a62404"]]},{"id":"9fabd03f.4376","type":"ui_text","z":"3f152265.215cbe","d":true,"group":"4608a4ea.943abc","order":13,"width":0,"height":0,"name":"Error","label":"text","format":"{{msg.payload}}","layout":"row-spread","x":1090,"y":40,"wires":[]},{"id":"b8c8d490.c9ad58","type":"ui_button","z":"3f152265.215cbe","name":"","group":"4608a4ea.943abc","order":2,"width":0,"height":0,"passthru":false,"label":"OFF","tooltip":"","color":"","bgcolor":"red","icon":"","payload":"0","payloadType":"str","topic":"","topicType":"str","x":190,"y":380,"wires":[["b8e52af8.91b5d8"]]},{"id":"cc0d31f6.b2af","type":"ui_button","z":"3f152265.215cbe","name":"","group":"4608a4ea.943abc","order":1,"width":0,"height":0,"passthru":false,"label":"ON","tooltip":"","color":"","bgcolor":"green","icon":"","payload":"1","payloadType":"str","topic":"","topicType":"str","x":190,"y":420,"wires":[["2fbc2614.bd7eda"]]},{"id":"3c84a633.401fba","type":"ui_switch","z":"3f152265.215cbe","name":"","label":"switch","tooltip":"","group":"4608a4ea.943abc","order":3,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"","topicType":"str","style":"","onvalue":"true","onvalueType":"bool","onicon":"power_settings_new","oncolor":"green","offvalue":"false","offvalueType":"bool","officon":"power_settings_new","offcolor":"red","animate":true,"x":190,"y":460,"wires":[["9e79a24b.119fd"]]},{"id":"9b34547b.7e8bb8","type":"link out","z":"3f152265.215cbe","name":"Display LED state","links":["6256c124.88157"],"x":1055,"y":380,"wires":[]},{"id":"54100fe1a08865e9","type":"comment","z":"3f152265.215cbe","name":"broker.hivemq.com","info":"","x":110,"y":100,"wires":[]},{"id":"679c406996b791fd","type":"comment","z":"3f152265.215cbe","name":"Activate also Dashboard_2","info":"","x":830,"y":440,"wires":[]},{"id":"1142b282.8ede2d","type":"mqtt out","z":"5159049.a3450fc","name":"Change LED power","topic":"RPI/RPI1/MyLEDPower","qos":"","retain":"","broker":"87cc9444.0f3478","x":570,"y":160,"wires":[]},{"id":"2435f94a.752026","type":"mqtt in","z":"5159049.a3450fc","name":"","topic":"RPI/RPI1/MyLEDState","qos":"2","datatype":"auto","broker":"87cc9444.0f3478","inputs":0,"x":400,"y":340,"wires":[["7e9195.01644e6c","c0292ab9.549ae8","fd93cb91.cba208"]]},{"id":"fd93cb91.cba208","type":"debug","z":"5159049.a3450fc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":617,"y":440.9999990463257,"wires":[]},{"id":"e7e8dcb7.08ca7","type":"debug","z":"5159049.a3450fc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":550,"y":100,"wires":[]},{"id":"9cdd9777.a77e48","type":"ui_slider","z":"5159049.a3450fc","name":"","label":"slider","tooltip":"","group":"4608a4ea.943abc","order":7,"width":0,"height":0,"passthru":true,"outs":"all","topic":"","topicType":"str","min":0,"max":"100","step":"10","x":370,"y":40,"wires":[["91bba0a4.473b8","1142b282.8ede2d","e7e8dcb7.08ca7"]]},{"id":"91bba0a4.473b8","type":"ui_text_input","z":"5159049.a3450fc","name":"","label":"Select a value","tooltip":"","group":"4608a4ea.943abc","order":5,"width":0,"height":0,"passthru":false,"mode":"text","delay":300,"topic":"","sendOnBlur":true,"className":"","topicType":"str","x":120,"y":40,"wires":[["9cdd9777.a77e48"]]},{"id":"7e9195.01644e6c","type":"ui_gauge","z":"5159049.a3450fc","name":"","group":"4608a4ea.943abc","order":10,"width":0,"height":0,"gtype":"gage","title":"gauge","label":"units","format":"{{value}}","min":0,"max":"100","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":607,"y":340.9999990463257,"wires":[]},{"id":"c0292ab9.549ae8","type":"ui_chart","z":"5159049.a3450fc","name":"","group":"4608a4ea.943abc","order":12,"width":0,"height":0,"label":"chart","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"60","cutout":0,"useOneColor":false,"useUTC":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"outputs":1,"useDifferentColor":false,"x":607,"y":380.9999990463257,"wires":[[]]},{"id":"16c0e0af.a6fb2f","type":"ui_text","z":"5159049.a3450fc","group":"4608a4ea.943abc","order":8,"width":0,"height":0,"name":"","label":"LED is ","format":"{{msg.payload}}%","layout":"row-spread","x":210,"y":260,"wires":[]},{"id":"6256c124.88157","type":"link in","z":"5159049.a3450fc","name":"","links":["9b34547b.7e8bb8"],"x":100,"y":260,"wires":[["16c0e0af.a6fb2f"]]},{"id":"c3c8cfd0.71c9c","type":"mqtt in","z":"c3b403f3.a5a5b","name":"","topic":"RPI/+/MyLEDState","qos":"2","datatype":"auto","broker":"87cc9444.0f3478","inputs":0,"x":190,"y":200,"wires":[["5be95b40.71da54","12861adf.f936e5","101f4f3b.ef0201"]]},{"id":"12861adf.f936e5","type":"switch","z":"c3b403f3.a5a5b","name":"Which RPI","property":"topic","propertyType":"msg","rules":[{"t":"regex","v":"^RPI/RPI1","vt":"str","case":false},{"t":"regex","v":"^RPI/RPI2","vt":"str","case":false},{"t":"regex","v":"^RPI/RPI3","vt":"str","case":false},{"t":"regex","v":"^RPI/RPI4","vt":"str","case":false},{"t":"regex","v":"^RPI/RPI45","vt":"str","case":false}],"checkall":"true","repair":false,"outputs":5,"x":410,"y":200,"wires":[["d689c20f.b8758"],["b87997e7.66d298"],["f9cbf8a3.611cc8"],["4776ca0e.419484"],["5c7fa99879505dce"]]},{"id":"5be95b40.71da54","type":"debug","z":"c3b403f3.a5a5b","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":390,"y":20,"wires":[]},{"id":"101f4f3b.ef0201","type":"debug","z":"c3b403f3.a5a5b","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"topic","x":400,"y":80,"wires":[]},{"id":"bb2b4aba.9af848","type":"mqtt out","z":"c3b403f3.a5a5b","name":"Publish","topic":"","qos":"","retain":"","broker":"87cc9444.0f3478","x":1220,"y":260,"wires":[]},{"id":"a33bad1.077475","type":"change","z":"c3b403f3.a5a5b","name":"Set Command LED_SWITCH","rules":[{"t":"set","p":"payload","pt":"msg","to":"LED_SWITCH","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":990,"y":200,"wires":[["bb2b4aba.9af848"]]},{"id":"cc7297a1.e80e38","type":"function","z":"c3b403f3.a5a5b","name":"NOTIFY ALL","func":"var msg1 = {}, msg2 = {}, msg3 = {}, msg4 = {}, msg5 = {}\nmsg1.payload=msg.payload\nmsg1.topic=\"RPI/RPI1/MyLEDCommand\"\n\nmsg2.payload=msg.payload\nmsg2.topic=\"RPI/RPI2/MyLEDCommand\"\n\nmsg3.payload=msg.payload\nmsg3.topic=\"RPI/RPI3/MyLEDCommand\"\n\nmsg4.payload=msg.payload\nmsg4.topic=\"RPI/RPI4/MyLEDCommand\"\n\nmsg5.payload = msg.payload\nmsg5.topic = \"RPI/RPI5/MyLEDCommand\"\n\nreturn  [msg1,msg2,msg3,msg4,msg5]\n","outputs":5,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1050,"y":320,"wires":[["bb2b4aba.9af848"],["bb2b4aba.9af848"],["bb2b4aba.9af848"],["bb2b4aba.9af848"],["bb2b4aba.9af848"]]},{"id":"3f103d04.1b9182","type":"ui_button","z":"c3b403f3.a5a5b","name":"","group":"e7794a15.c6d108","order":1,"width":0,"height":0,"passthru":false,"label":"ALL OFF","tooltip":"","color":"","bgcolor":"RED","icon":"","payload":"LED_OFF","payloadType":"str","topic":"","topicType":"str","x":760.4000244140625,"y":356,"wires":[["cc7297a1.e80e38"]]},{"id":"d9101543.14acc8","type":"ui_button","z":"c3b403f3.a5a5b","name":"","group":"e7794a15.c6d108","order":4,"width":0,"height":0,"passthru":false,"label":"Switch","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"RPI/RPI1/MyLEDCommand","topicType":"str","x":750,"y":140,"wires":[["a33bad1.077475"]]},{"id":"169b634f.f0fbed","type":"ui_button","z":"c3b403f3.a5a5b","name":"","group":"e7794a15.c6d108","order":6,"width":0,"height":0,"passthru":false,"label":"Switch","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"RPI/RPI2/MyLEDCommand","topicType":"str","x":750,"y":180,"wires":[["a33bad1.077475"]]},{"id":"ba542ac1.c112a8","type":"ui_button","z":"c3b403f3.a5a5b","name":"","group":"e7794a15.c6d108","order":8,"width":0,"height":0,"passthru":false,"label":"Switch","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"RPI/RPI3/MyLEDCommand","topicType":"str","x":750,"y":220,"wires":[["a33bad1.077475"]]},{"id":"d43e6744.5d83c8","type":"ui_button","z":"c3b403f3.a5a5b","name":"","group":"e7794a15.c6d108","order":10,"width":0,"height":0,"passthru":false,"label":"Switch","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"RPI/RPI4/MyLEDCommand","topicType":"str","x":750,"y":260,"wires":[["a33bad1.077475"]]},{"id":"ca6b7299.603c6","type":"ui_button","z":"c3b403f3.a5a5b","name":"","group":"e7794a15.c6d108","order":2,"width":0,"height":0,"passthru":false,"label":"ALL ON","tooltip":"","color":"","bgcolor":"GREEN ","icon":"","payload":"LED_ON","payloadType":"str","topic":"","topicType":"str","x":760,"y":400,"wires":[["cc7297a1.e80e38"]]},{"id":"d689c20f.b8758","type":"ui_text","z":"c3b403f3.a5a5b","group":"e7794a15.c6d108","order":3,"width":0,"height":0,"name":"","label":"RPI 1 LED is ","format":"{{msg.payload}}%","layout":"row-spread","x":610,"y":140,"wires":[]},{"id":"b87997e7.66d298","type":"ui_text","z":"c3b403f3.a5a5b","group":"e7794a15.c6d108","order":5,"width":0,"height":0,"name":"","label":"RPI 2 LED is ","format":"{{msg.payload}}%","layout":"row-spread","x":610,"y":180,"wires":[]},{"id":"f9cbf8a3.611cc8","type":"ui_text","z":"c3b403f3.a5a5b","group":"e7794a15.c6d108","order":7,"width":0,"height":0,"name":"","label":"RPI 3 LED is ","format":"{{msg.payload}}%","layout":"row-spread","x":610,"y":220,"wires":[]},{"id":"4776ca0e.419484","type":"ui_text","z":"c3b403f3.a5a5b","group":"e7794a15.c6d108","order":9,"width":0,"height":0,"name":"","label":"RPI 4 LED is ","format":"{{msg.payload}}%","layout":"row-spread","x":610,"y":260,"wires":[]},{"id":"5c7fa99879505dce","type":"ui_text","z":"c3b403f3.a5a5b","group":"e7794a15.c6d108","order":11,"width":0,"height":0,"name":"","label":"RPI 5 LED is ","format":"{{msg.payload}}%","layout":"row-spread","className":"","x":610,"y":300,"wires":[]},{"id":"60168c1031696079","type":"ui_button","z":"c3b403f3.a5a5b","name":"","group":"e7794a15.c6d108","order":12,"width":0,"height":0,"passthru":false,"label":"Switch","tooltip":"","color":"","bgcolor":"","className":"","icon":"","payload":"","payloadType":"str","topic":"RPI/RPI5/MyLEDCommand","topicType":"str","x":750,"y":300,"wires":[["a33bad1.077475"]]},{"id":"94f1ac505db1c5ab","type":"comment","z":"c3b403f3.a5a5b","name":"Activate also Dashboard_2","info":"","x":290,"y":440,"wires":[]},{"id":"ae8bafb87f16e723","type":"comment","z":"c3b403f3.a5a5b","name":"Activate also RPI_LED_BTN_MQTT_DASHBOARD_FINAL","info":"","x":390,"y":400,"wires":[]},{"id":"a08d8405.9e5598","type":"inject","z":"2a24c7d9.e04938","name":"","props":[{"p":"payload","v":"{\"value\":\"1\"}","vt":"json"},{"p":"topic","v":"RPI/Test","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/Test","payload":"{\"value\":\"1\"}","payloadType":"json","x":360,"y":220,"wires":[["72ed5abf.fafa04"]]},{"id":"72ed5abf.fafa04","type":"mqtt out","z":"2a24c7d9.e04938","name":"","topic":"RPI/Test","qos":"1","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"26cc290e.df7a56","x":620,"y":220,"wires":[]},{"id":"77387b4b.3a6134","type":"mqtt in","z":"2a24c7d9.e04938","name":"","topic":"RPI/Test","qos":"1","datatype":"auto","broker":"26cc290e.df7a56","inputs":0,"x":310,"y":300,"wires":[["d6d053a6.3410f"]]},{"id":"d6d053a6.3410f","type":"debug","z":"2a24c7d9.e04938","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","x":630,"y":300,"wires":[]},{"id":"2defc925d5ea89d2","type":"inject","z":"8b6d1dc248c33d11","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI1/Test","payload":"{\"value\":\"81\"}","payloadType":"json","x":240,"y":260,"wires":[["c0bfd5fc757c7886"]]},{"id":"c0bfd5fc757c7886","type":"mqtt out","z":"8b6d1dc248c33d11","name":"","topic":"","qos":"0","retain":"","broker":"26cc290e.df7a56","x":435,"y":260,"wires":[],"l":false},{"id":"e86555edfcfc29bf","type":"debug","z":"8b6d1dc248c33d11","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","x":490,"y":340,"wires":[]},{"id":"b9f7c2d925303129","type":"mqtt in","z":"8b6d1dc248c33d11","name":"","topic":"RPI/RPI1/Test","qos":"1","datatype":"auto","broker":"26cc290e.df7a56","inputs":0,"x":185.5555419921875,"y":338.88887453079224,"wires":[["e86555edfcfc29bf"]]},{"id":"0b0a41156c71317c","type":"comment","z":"8b6d1dc248c33d11","name":"Trying to get the publisher name","info":"","x":410,"y":160,"wires":[]},{"id":"174770b1.af3eff","type":"mqtt out","z":"3da35f20.0b7b6","name":"from RPI1:RPI/RPI2/Test","topic":"RPI/RPI2/Test","qos":"0","retain":"","broker":"26cc290e.df7a56","x":848.3333587646484,"y":152.2222080230713,"wires":[]},{"id":"54077064.3aeae","type":"inject","z":"3da35f20.0b7b6","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI2/Test","payload":"{\"value\":\"3\"}","payloadType":"json","x":488.33335876464844,"y":152.2222080230713,"wires":[["174770b1.af3eff"]]},{"id":"d6f83725.dc0588","type":"inject","z":"3da35f20.0b7b6","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI1/Test","payload":"{\"value\":\"1\"}","payloadType":"json","x":487.7777404785156,"y":56.666669845581055,"wires":[["5198119c.efe39"]]},{"id":"5198119c.efe39","type":"mqtt out","z":"3da35f20.0b7b6","name":"from RPI1:RPI/RPI1/Test","topic":"RPI/RPI1/Test","qos":"0","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"26cc290e.df7a56","x":847.7777404785156,"y":56.666669845581055,"wires":[]},{"id":"3d03a375.8a892c","type":"comment","z":"3da35f20.0b7b6","name":"Impersonate publication OK as RPI1 is allowed to publish on any topic","info":"","x":713.8888549804688,"y":203.33333587646484,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"6bc360fb.8d20f","type":"comment","z":"3da35f20.0b7b6","name":"'All' policy on RPI1 & RPI2","info":"","x":115,"y":20,"wires":[]},{"id":"ffbd2bd4.805278","type":"comment","z":"3da35f20.0b7b6","name":"Real RPI1","info":"","x":106.66669845581055,"y":55.555551528930664,"wires":[]},{"id":"6e8eb10c.aa959","type":"comment","z":"3da35f20.0b7b6","name":"Real RPI2","info":"","x":107.77777862548828,"y":104.44444274902344,"wires":[]},{"id":"e34c73e.fff5f9","type":"comment","z":"3da35f20.0b7b6","name":"RPI1 fakes RPI2 messages","info":"","x":165.5555648803711,"y":152.2222194671631,"wires":[]},{"id":"138302e7.5f060d","type":"mqtt out","z":"3da35f20.0b7b6","name":"from RPI2:RPI/RPI2/Test","topic":"RPI/RPI2/Test","qos":"0","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"f443af26.bbf6b","x":848.8889083862305,"y":105.5555648803711,"wires":[]},{"id":"a85b3b6c.318598","type":"inject","z":"3da35f20.0b7b6","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI2/Test","payload":"{\"value\":\"2\"}","payloadType":"json","x":488.88890838623047,"y":105.5555648803711,"wires":[["138302e7.5f060d"]]},{"id":"5c4fce11.61124","type":"mqtt in","z":"3da35f20.0b7b6","name":"RPI1 subs to RPI/#","topic":"RPI/#","qos":"1","datatype":"auto","broker":"26cc290e.df7a56","inputs":0,"x":450,"y":420,"wires":[["2749f2.3b46360e"]]},{"id":"2749f2.3b46360e","type":"debug","z":"3da35f20.0b7b6","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","targetType":"msg","x":880,"y":440,"wires":[]},{"id":"765af254.ee5c0c","type":"debug","z":"3da35f20.0b7b6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":871.6666793823242,"y":492.22224283218384,"wires":[]},{"id":"7173d20e.ab313c","type":"mqtt in","z":"3da35f20.0b7b6","name":"RPI2 subs to RPI/#","topic":"RPI/#","qos":"1","datatype":"auto","broker":"f443af26.bbf6b","inputs":0,"x":442.7777786254883,"y":492.22222900390625,"wires":[["765af254.ee5c0c"]]},{"id":"1ce6a438.82291c","type":"comment","z":"3da35f20.0b7b6","name":"No constraints on subscriptions","info":"","x":135,"y":411.111120223999,"wires":[]},{"id":"334219c2.c5ea06","type":"comment","z":"3da35f20.0b7b6","name":">> Attach publish & subscribe policy v1 to RPI2 to block it","info":"","x":670,"y":340,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"3d7bb76b.421668","type":"inject","z":"3da35f20.0b7b6","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI1/Test","payload":"{\"value\":\"4\"}","payloadType":"json","x":490,"y":240,"wires":[["b5ba52fc.32582"]]},{"id":"b5ba52fc.32582","type":"mqtt out","z":"3da35f20.0b7b6","name":"from RPI2:RPI/RPI1/Test","topic":"RPI/RPI1/Test","qos":"0","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"f443af26.bbf6b","x":850,"y":240,"wires":[]},{"id":"d9049ca3.b1765","type":"comment","z":"3da35f20.0b7b6","name":"RPI2 fakes RPI1 messages","info":"","x":167.22220611572266,"y":240.0000114440918,"wires":[]},{"id":"b6d353b5.2483b","type":"comment","z":"3da35f20.0b7b6","name":"Impersonate publication OK as RPI1 is allowed to publish on any topic","info":"","x":715.5554962158203,"y":291.11112785339355,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"b49308c1.e3e7e8","type":"mqtt in","z":"eeada7b9.633358","name":"RPI1 subs to RPI/#","topic":"RPI/#","qos":"1","datatype":"auto","broker":"26cc290e.df7a56","inputs":0,"x":442.7777786254883,"y":588.8889827728271,"wires":[["98a97537.90f4a8"]]},{"id":"98a97537.90f4a8","type":"debug","z":"eeada7b9.633358","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","targetType":"msg","x":881.6666793823242,"y":588.8889966011047,"wires":[]},{"id":"d8e63b73.782118","type":"debug","z":"eeada7b9.633358","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":871.6666793823242,"y":641.111225605011,"wires":[]},{"id":"3f1cb0ff.68a0a","type":"mqtt in","z":"eeada7b9.633358","name":"RPI2 subs to RPI/#","topic":"RPI/#","qos":"1","datatype":"auto","broker":"f443af26.bbf6b","inputs":0,"x":442.7777786254883,"y":641.1112117767334,"wires":[["d8e63b73.782118"]]},{"id":"7bd5804.565268","type":"mqtt out","z":"eeada7b9.633358","name":"From RPI2:RPI/RPI2/Test","topic":"RPI/RPI2/Test","qos":"0","retain":"","broker":"f443af26.bbf6b","x":850,"y":80,"wires":[]},{"id":"97f30e52.24805","type":"inject","z":"eeada7b9.633358","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI2/Test","payload":"{\"value\":\"4\"}","payloadType":"json","x":470,"y":80,"wires":[["7bd5804.565268"]]},{"id":"b31972f1.b1fc9","type":"comment","z":"eeada7b9.633358","name":">> attach policy v2 to RPI2 to block it as soon as it connects","info":"","x":720,"y":220,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"11a6406a.a4d8a","type":"comment","z":"eeada7b9.633358","name":"No constraints on subscriptions","info":"","x":135,"y":560.0001029968262,"wires":[]},{"id":"3583a474.bb170c","type":"comment","z":"eeada7b9.633358","name":"Connection & Publication constraints on RPI2 : Publish & Subscibe Policy version 1","info":"","x":296.6666259765625,"y":45.555542945861816,"wires":[]},{"id":"e264a194.9318d","type":"mqtt out","z":"eeada7b9.633358","name":"Connect from RPI2 as fake RPI1:RPI/RPI1/Test","topic":"RPI/RPI1/Test","qos":"0","retain":"","broker":"8347ae6e.249ec","x":781.6666259765625,"y":123.33332633972168,"wires":[]},{"id":"bf1902d2.3dc0f","type":"comment","z":"eeada7b9.633358","name":"Impersonate connection OK as thing name matches client ID!","info":"","x":726.1111145019531,"y":174.44451808929443,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"21f41d28.e18572","type":"comment","z":"eeada7b9.633358","name":"RPI2 still connecting & publishing","info":"","x":179.4444122314453,"y":81.33332824707031,"wires":[]},{"id":"a53e9ba6.7b66a8","type":"comment","z":"eeada7b9.633358","name":"RPI2 using RPI1 as clientID","info":"","x":170.55551147460938,"y":129.11111164093018,"wires":[]},{"id":"73137f63.2e3f5","type":"comment","z":"eeada7b9.633358","name":"#B (real RPI) gets disconnected by #A publish above","info":"","x":1170,"y":580,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"5e6e4861.030c98","type":"inject","z":"eeada7b9.633358","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI1/Test","payload":"{\"value\":\"5\"}","payloadType":"json","x":471.6666259765625,"y":123.33332633972168,"wires":[["e264a194.9318d"]]},{"id":"7072bcc.f8af344","type":"comment","z":"eeada7b9.633358","name":"#A gets (fake RPI1) disconnected by #B subscribe below","info":"","x":1170,"y":140,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"39a94fa8.d0f4b","type":"debug","z":"eeada7b9.633358","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":878.8889007568359,"y":740.0000138282776,"wires":[]},{"id":"600f65a.be1b59c","type":"mqtt in","z":"eeada7b9.633358","d":true,"name":"RPI2 subs to #","topic":"#","qos":"1","datatype":"auto","broker":"f443af26.bbf6b","nl":false,"rap":false,"inputs":0,"x":440,"y":740,"wires":[["39a94fa8.d0f4b"]]},{"id":"17b801e2.41269e","type":"comment","z":"eeada7b9.633358","name":">> attach policy v3 to RPI2 to restrut topic to RPI/#","info":"","x":710,"y":700,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"173b856e.90befb","type":"inject","z":"2ea861b1.19c0be","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI1/Test","payload":"{\"value\":\"101\"}","payloadType":"json","x":220,"y":140,"wires":[["fff859d.1867ba8"]]},{"id":"fff859d.1867ba8","type":"mqtt out","z":"2ea861b1.19c0be","name":"","topic":"RPI/RPI1/Test","qos":"0","retain":"","broker":"26cc290e.df7a56","x":620,"y":100,"wires":[]},{"id":"747916da.05bb78","type":"mqtt in","z":"2ea861b1.19c0be","name":"","topic":"RPI/RPI1/Test","qos":"1","broker":"26cc290e.df7a56","inputs":0,"x":158.8888931274414,"y":220.0000057220459,"wires":[["cfb98368.aea26"]]},{"id":"cfb98368.aea26","type":"debug","z":"2ea861b1.19c0be","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":470,"y":220,"wires":[]},{"id":"30f35717.364b88","type":"inject","z":"2ea861b1.19c0be","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI1/Test","payload":"{\"value\":\"1\"}","payloadType":"json","x":210,"y":60,"wires":[["fff859d.1867ba8"]]},{"id":"c859866e.5e01e8","type":"mqtt in","z":"2ea861b1.19c0be","name":"","topic":"RPI/Alert","qos":"1","datatype":"auto","broker":"26cc290e.df7a56","inputs":0,"x":151,"y":300,"wires":[["9726e8df.816498"]]},{"id":"9726e8df.816498","type":"debug","z":"2ea861b1.19c0be","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":470,"y":300,"wires":[]},{"id":"117d7e9c.f301e1","type":"inject","z":"2ea861b1.19c0be","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI1/Test","payload":"{\"value\":\"81\"}","payloadType":"json","x":220,"y":100,"wires":[["fff859d.1867ba8"]]},{"id":"cf028543.02fcf8","type":"debug","z":"2ea861b1.19c0be","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","x":470,"y":380,"wires":[]},{"id":"9f138b08.bfb5b8","type":"mqtt in","z":"2ea861b1.19c0be","name":"","topic":"RPI/Alert2","qos":"1","datatype":"auto","broker":"26cc290e.df7a56","inputs":0,"x":151,"y":380,"wires":[["cf028543.02fcf8"]]},{"id":"c4588bd3.5d5978","type":"mqtt out","z":"2ea861b1.19c0be","name":"","topic":"RPI/RPI3/Test","qos":"0","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"6ee9e116.283a7","x":484.4444274902344,"y":508.88885498046875,"wires":[]},{"id":"b3bb77ba.b33a28","type":"inject","z":"2ea861b1.19c0be","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI3/Test","payload":"{\"value\":\"1\"}","payloadType":"json","x":204.44444274902344,"y":510.0000150203705,"wires":[["c4588bd3.5d5978"]]},{"id":"b6f0a782.6fcfb8","type":"debug","z":"2ea861b1.19c0be","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":473.33331298828125,"y":567.7777709960938,"wires":[]},{"id":"5415b0a3.68ae7","type":"mqtt in","z":"2ea861b1.19c0be","name":"","topic":"RPI/RPI3/#","qos":"1","datatype":"auto","broker":"6ee9e116.283a7","nl":false,"rap":false,"inputs":0,"x":154.33331298828125,"y":567.7777709960938,"wires":[["b6f0a782.6fcfb8"]]},{"id":"920dead2.541598","type":"comment","z":"2ea861b1.19c0be","name":"with Own CA","info":"","x":450,"y":460,"wires":[]},{"id":"268163b4.1c1b9c","type":"inject","z":"2ea861b1.19c0be","name":"RPI/RPI1/Test:{\"value\":\"101\",\"default\":\"My Message\"}","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI1/Test","payload":"{\"value\":\"101\",\"default\":\"My Message\"}","payloadType":"json","x":280,"y":180,"wires":[["fff859d.1867ba8"]]},{"id":"df770ac8.e984d8","type":"mqtt out","z":"7055f43d.d3095c","name":"","topic":"RPI/RPI1/Test","qos":"0","retain":"","broker":"26cc290e.df7a56","x":540,"y":200,"wires":[]},{"id":"d1bb35b4.707508","type":"inject","z":"7055f43d.d3095c","name":"","props":[{"p":"payload","v":"{\"value\":\"1\"}","vt":"json"},{"p":"topic","v":"RPI/RPI1/Test","vt":"str"}],"repeat":"1","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI1/Test","payload":"{\"value\":\"1\"}","payloadType":"json","x":240,"y":200,"wires":[["37a9027b.8857de","df770ac8.e984d8"]]},{"id":"37a9027b.8857de","type":"debug","z":"7055f43d.d3095c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","x":530,"y":280,"wires":[]},{"id":"db345516.6fb288","type":"inject","z":"df136e3e.4e7d","name":"Start Subscribe","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"str","x":120,"y":400,"wires":[["c0750d6e.d5125"]]},{"id":"8479ef81.37ad8","type":"debug","z":"df136e3e.4e7d","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","x":680,"y":400,"wires":[]},{"id":"6f958c62.409d54","type":"debug","z":"df136e3e.4e7d","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","statusVal":"payload","statusType":"auto","x":660,"y":200,"wires":[]},{"id":"d24cae73.6f244","type":"inject","z":"df136e3e.4e7d","name":"","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"str","x":90,"y":159.00000190734863,"wires":[["a8c5b72d.2760f8"]]},{"id":"e39a7abc.a27268","type":"inject","z":"df136e3e.4e7d","name":"","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"LED_ON","payloadType":"str","x":100,"y":240,"wires":[["9e6c880e.32a7d8"]]},{"id":"183c7a54.bd3016","type":"inject","z":"df136e3e.4e7d","name":"","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"LED_OFF","payloadType":"str","x":100,"y":280,"wires":[["9e6c880e.32a7d8"]]},{"id":"93124cd1.d5518","type":"inject","z":"df136e3e.4e7d","name":"","props":[{"p":"payload","v":"INIT","vt":"str"},{"p":"topic","v":"","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"INIT","payloadType":"str","x":90,"y":80,"wires":[["256f1e85.2723d2"]]},{"id":"24d47160.cf305e","type":"comment","z":"df136e3e.4e7d","name":"!! Click here once to create topic on local coapserver.py (ensure coappserver.py is running on default port 5683","info":"","x":390,"y":40,"wires":[]},{"id":"c1e242ec.8666d","type":"comment","z":"df136e3e.4e7d","name":"Unitary PUT / GET","info":"","x":106,"y":123.00000190734863,"wires":[]},{"id":"2839e99a.f71716","type":"comment","z":"df136e3e.4e7d","name":"Subscription via Observe","info":"","x":130,"y":360,"wires":[]},{"id":"42fe5661.545528","type":"inject","z":"df136e3e.4e7d","name":"","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"str","x":90.00000381469727,"y":201.00000381469727,"wires":[["f925ec76.18b2f"]]},{"id":"f925ec76.18b2f","type":"coap request","z":"df136e3e.4e7d","method":"GET","observe":false,"url":"coap://localhost:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"GET /storage/LED","x":410,"y":200,"wires":[["6f958c62.409d54"]]},{"id":"9e6c880e.32a7d8","type":"coap request","z":"df136e3e.4e7d","method":"PUT","observe":false,"url":"coap://localhost:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"PUT /storage/LED","x":410,"y":260,"wires":[[]]},{"id":"256f1e85.2723d2","type":"coap request","z":"df136e3e.4e7d","method":"POST","observe":false,"url":"coap://localhost:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"POST /storage/LED","x":420,"y":80,"wires":[[]]},{"id":"c0750d6e.d5125","type":"coap request","z":"df136e3e.4e7d","method":"GET","observe":true,"url":"coap://localhost:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"GET Observe /storage/LED","x":440,"y":400,"wires":[["8479ef81.37ad8"]]},{"id":"a8c5b72d.2760f8","type":"coap request","z":"df136e3e.4e7d","method":"GET","observe":false,"url":"coap://localhost:5683/.well-known/core","content-format":"text/plain","raw-buffer":false,"name":"GET /.well-known/core","x":419,"y":158,"wires":[["6f958c62.409d54"]]},{"id":"8b608ac5.eb4a18","type":"debug","z":"77dd7f0d.54335","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"req.payload","statusVal":"req.payload","statusType":"auto","x":390,"y":480,"wires":[]},{"id":"a991aa15.e79fd8","type":"inject","z":"77dd7f0d.54335","name":"","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"LED_ON","payloadType":"str","x":140,"y":280,"wires":[["5250ebd3.53f0b4"]]},{"id":"c9ff69d6.52b138","type":"inject","z":"77dd7f0d.54335","name":"","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"LED_OFF","payloadType":"str","x":140,"y":320,"wires":[["5250ebd3.53f0b4"]]},{"id":"8762efce.90d52","type":"switch","z":"77dd7f0d.54335","name":"Parse command","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"LED_OFF","vt":"str"},{"t":"eq","v":"LED_ON","vt":"str"},{"t":"eq","v":"LED_SWITCH","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":4,"x":600,"y":660,"wires":[["c6216511.b36758"],["e720cd4c.dfad3"],[],[]]},{"id":"c6216511.b36758","type":"function","z":"77dd7f0d.54335","name":"Set LED state OFF","func":"var currentLedState = flow.get(\"LEDState\")||0;\nif (currentLedState===0)\n    return null;\n    \nledState = 0;\nmsg.payload = ledState;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"noerr":0,"x":850,"y":640,"wires":[["a03f3b02.dcc888"]]},{"id":"e720cd4c.dfad3","type":"function","z":"77dd7f0d.54335","name":"Set LED state ON","func":"currentLedState = flow.get(\"LEDState\")||0;\nledPower=flow.get(\"LEDPower\")||0;\n\nif (currentLedState==1)\n    if (ledPower==100)\n        return null;\n    else\n        ledPower=100;\n\nledState = 1;\nif (ledPower===0)\n    ledPower=100;\n    \nmsg.payload = ledPower;\n\nflow.set(\"LEDState\", ledState);\nflow.set(\"LEDPower\", ledPower);\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":680,"wires":[["a03f3b02.dcc888"]]},{"id":"a03f3b02.dcc888","type":"change","z":"77dd7f0d.54335","name":"Dispatch","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1040,"y":660,"wires":[["e321e233.9feef","5adf2c3c.271474"]]},{"id":"5adf2c3c.271474","type":"rpi-gpio out","z":"77dd7f0d.54335","name":"LED on GPIO18","pin":"18","set":false,"level":"0","freq":"","out":"pwm","bcm":true,"x":1220,"y":620,"wires":[]},{"id":"e321e233.9feef","type":"debug","z":"77dd7f0d.54335","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","statusVal":"payload","statusType":"auto","x":1210,"y":680,"wires":[],"inputLabels":["msg.payload"]},{"id":"d269ecd7.5c924","type":"function","z":"77dd7f0d.54335","name":"BufferToString","func":"msg.payload=msg.req.payload.toString();\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":540,"wires":[["8762efce.90d52","7b990096.2694c"]]},{"id":"7b990096.2694c","type":"debug","z":"77dd7f0d.54335","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"req.payload","statusVal":"req.payload","statusType":"auto","x":610,"y":540,"wires":[]},{"id":"8f05942.f8d3668","type":"comment","z":"77dd7f0d.54335","name":"Add this to your MQTT flow","info":"","x":170,"y":400,"wires":[]},{"id":"71f34405.c2557c","type":"comment","z":"77dd7f0d.54335","name":"..............................  Existing MQTT Flow.....................................","info":"","x":750,"y":600,"wires":[]},{"id":"9733bed3.3de08","type":"comment","z":"77dd7f0d.54335","name":"Copy and update this to your MQTT flow","info":"","x":220,"y":200,"wires":[]},{"id":"d4fe2981.99b578","type":"function","z":"77dd7f0d.54335","name":"Responder","func":"var currentLedState = flow.get(\"LEDState\")||0;\nvar currentLedPower = flow.get(\"LEDPower\")||0;\n\nif (currentLedState===0)\n    msg.res.end(\"0\");\nelse\n    msg.res.end(currentLedPower.toString());\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":390,"y":440,"wires":[[]]},{"id":"6b264052.6cc76","type":"debug","z":"77dd7f0d.54335","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":720,"y":240,"wires":[]},{"id":"e6fc18b2.616108","type":"inject","z":"77dd7f0d.54335","name":"","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"str","x":130,"y":240,"wires":[["e4ddcaee.0bed18"]]},{"id":"da7071fd.d6d7b","type":"function","z":"77dd7f0d.54335","name":"Responder","func":"msg.res.end();\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":371.111083984375,"y":669.3333129882812,"wires":[[]]},{"id":"da4948af.4c63e8","type":"coap in","z":"77dd7f0d.54335","method":"POST","name":"","server":"7d4138fe.5bb9d8","url":"/storage/LED","x":160,"y":480,"wires":[["8b608ac5.eb4a18","d269ecd7.5c924","da7071fd.d6d7b"]]},{"id":"a38cc33e.cf8dd","type":"coap in","z":"77dd7f0d.54335","method":"PUT","name":"","server":"7d4138fe.5bb9d8","url":"/storage/LED","x":150,"y":520,"wires":[["8b608ac5.eb4a18","d269ecd7.5c924","da7071fd.d6d7b"]]},{"id":"61a1a231.66892c","type":"coap in","z":"77dd7f0d.54335","method":"GET","name":"","server":"7d4138fe.5bb9d8","url":"/storage/LED","x":150,"y":440,"wires":[["d4fe2981.99b578"]]},{"id":"5250ebd3.53f0b4","type":"coap request","z":"77dd7f0d.54335","method":"PUT","confirmable":false,"observe":false,"multicast":false,"url":"coap://127.0.0.1:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"PUT /storage/LED","x":450,"y":300,"wires":[[]]},{"id":"e4ddcaee.0bed18","type":"coap request","z":"77dd7f0d.54335","method":"GET","confirmable":false,"observe":true,"multicast":false,"url":"coap://localhost:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"GET /storage/LED","x":450,"y":240,"wires":[["6b264052.6cc76"]]},{"id":"43f501588d6c2481","type":"comment","z":"77dd7f0d.54335","name":"This uses the NodeRed embedded coap server on port 55683","info":"","x":280,"y":20,"wires":[]},{"id":"f32a70102eb76658","type":"inject","z":"77dd7f0d.54335","name":"","props":[{"p":"payload","v":"INIT","vt":"str"},{"p":"topic","v":"","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"INIT","payloadType":"str","x":130,"y":100,"wires":[["d0e35bc804c43150"]]},{"id":"56f36aeefc48ffc4","type":"comment","z":"77dd7f0d.54335","name":"!! Click here once to create topic on embedded coap server on port 55683","info":"","x":320,"y":60,"wires":[]},{"id":"d0e35bc804c43150","type":"coap request","z":"77dd7f0d.54335","method":"POST","confirmable":false,"observe":false,"multicast":false,"url":"coap://localhost:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"POST /storage/LED","x":460,"y":100,"wires":[[]]},{"id":"53b1d0c5200fe1b5","type":"comment","z":"77dd7f0d.54335","name":"LATEST VERSION OF COAP DOESN'T HANDLE THE CUSTOM PORT !","info":"","x":640,"y":40,"wires":[]},{"id":"3cb343bd.6f98ac","type":"function","z":"d1da38f2.572138","name":"Switch LED state","func":"ledState=flow.get(\"LEDState\")||0;\nledPower=flow.get(\"LEDPower\")||0;\n\n(ledState === 0) ? ledState = 1 : ledState = 0;\nif (ledState==1)\n    {\n    if (ledPower===0)\n        ledPower=100;\n    msg.payload = ledPower;\n    }\nelse\n    msg.payload=0;\n    \nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"noerr":0,"x":630.0000076293945,"y":476.9999952316284,"wires":[["71990b72.037c34"]]},{"id":"4d28f84b.cf5518","type":"inject","z":"d1da38f2.572138","name":"LED OFF","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED OFF","payload":"0","payloadType":"num","x":87.00000762939453,"y":516.9999980926514,"wires":[["a0cafd07.403d"]]},{"id":"3fa58c9d.3c79d4","type":"debug","z":"d1da38f2.572138","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":990,"y":500.0000009536743,"wires":[],"inputLabels":["msg.payload"]},{"id":"efa6eb3a.67a658","type":"inject","z":"d1da38f2.572138","name":"LED ON","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED ON","payload":"ledPower","payloadType":"flow","x":87.00000381469727,"y":586.9999980926514,"wires":[["e7e335fc.210258"]]},{"id":"adbf9cfb.cb672","type":"rpi-gpio out","z":"d1da38f2.572138","name":"LED on GPIO18","pin":"18","set":false,"level":"0","freq":"","out":"pwm","bcm":true,"x":1000,"y":440.0000009536743,"wires":[]},{"id":"c2262900.bcd998","type":"rpi-gpio in","z":"d1da38f2.572138","name":"BTN on GPIO4","pin":"4","intype":"up","debounce":"25","read":true,"bcm":true,"x":85,"y":737.9999990463257,"wires":[["b92db6ed.c29d18"]]},{"id":"5507ea75.e7c8f4","type":"inject","z":"d1da38f2.572138","name":"SWITCH LED","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":97,"y":656.9999985694885,"wires":[["3cb343bd.6f98ac"]]},{"id":"9a97de1b.d215f","type":"function","z":"d1da38f2.572138","name":"If button down","func":"if (msg.payload===0)\n    return msg;\n    \nreturn  null;","outputs":1,"noerr":0,"x":302.0908966064453,"y":771.7272939682007,"wires":[[]]},{"id":"b92db6ed.c29d18","type":"switch","z":"d1da38f2.572138","name":"If button down","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":300,"y":736.9999990463257,"wires":[["3cb343bd.6f98ac"],[]]},{"id":"a0cafd07.403d","type":"function","z":"d1da38f2.572138","name":"Set LED state OFF","func":"var currentLedState = flow.get(\"LEDState\")||0;\nif (currentLedState===0)\n    return null;\n    \nledState = 0;\nmsg.payload = ledState;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"noerr":0,"x":630,"y":400.0000009536743,"wires":[["71990b72.037c34"]]},{"id":"e7e335fc.210258","type":"function","z":"d1da38f2.572138","name":"Set LED state ON","func":"currentLedState = flow.get(\"LEDState\")||0;\nledPower=flow.get(\"LEDPower\")||0;\n\nif (currentLedState==1)\n    if (ledPower==100)\n        return null;\n    else\n        ledPower=100;\n\nledState = 1;\nif (ledPower===0)\n    ledPower=100;\n    \nmsg.payload = ledPower;\n\nflow.set(\"LEDState\", ledState);\nflow.set(\"LEDPower\", ledPower);\nreturn msg;","outputs":1,"noerr":0,"x":630.0000076293945,"y":438.9999942779541,"wires":[["71990b72.037c34"]]},{"id":"284b2edf.9d3fe2","type":"mqtt in","z":"d1da38f2.572138","name":"","topic":"RPI/RPI1/MyLEDCommand","qos":"1","datatype":"auto","broker":"26cc290e.df7a56","inputs":0,"x":125,"y":261.00000381469727,"wires":[["eb955d42.95fa","fe08a0ee.0847f"]]},{"id":"629e915b.0b3cb","type":"mqtt out","z":"d1da38f2.572138","name":"Publish MyLEDState","topic":"RPI/RPI1/MyLEDState","qos":"1","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"26cc290e.df7a56","x":1020,"y":380.0000009536743,"wires":[]},{"id":"eb955d42.95fa","type":"switch","z":"d1da38f2.572138","name":"Parse command","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"LED_OFF","vt":"str"},{"t":"eq","v":"LED_ON","vt":"str"},{"t":"eq","v":"LED_SWITCH","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":4,"x":375.00000762939453,"y":243.00000381469727,"wires":[["a0cafd07.403d"],["e7e335fc.210258"],["3cb343bd.6f98ac"],["d2be01ff.eb577"]]},{"id":"fe08a0ee.0847f","type":"debug","z":"d1da38f2.572138","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":372.00000381469727,"y":313.0000057220459,"wires":[]},{"id":"71990b72.037c34","type":"change","z":"d1da38f2.572138","name":"Dispatch","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":820,"y":440.0000009536743,"wires":[["5cf8169c.da6a18","3fa58c9d.3c79d4","adbf9cfb.cb672","629e915b.0b3cb","79c451d6.9620c","a7858c99.6363a"]]},{"id":"d2be01ff.eb577","type":"change","z":"d1da38f2.572138","name":"Unknown command","rules":[{"t":"change","p":"payload","pt":"msg","from":"^(.*)$","fromt":"re","to":"Unknown MQTT command received : [$1] ","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":623.0000076293945,"y":212.00002765655518,"wires":[["1da5117d.e6ef8f","b3ae5d0e.d1c73"]]},{"id":"249e17d7.e62398","type":"mqtt in","z":"d1da38f2.572138","name":"","topic":"RPI/RPI1/MyLEDPower","qos":"1","datatype":"auto","broker":"26cc290e.df7a56","inputs":0,"x":105,"y":333.99999237060547,"wires":[["fe08a0ee.0847f","ca57bde7.0ef7f"]]},{"id":"ca57bde7.0ef7f","type":"function","z":"d1da38f2.572138","name":"Set LED Power","func":"var ledPower=msg.payload;\nvar ledState;\n\nif (ledPower===0)\n    {\n    ledState=0;\n    ledPower=100;\n    }\nelse\n    ledState=1;\n    \nflow.set(\"LEDState\", ledState);\nflow.set(\"LEDPower\", ledPower);\nreturn msg;","outputs":1,"noerr":0,"x":620,"y":360.0000009536743,"wires":[["71990b72.037c34"]]},{"id":"f5e5f436.626ca8","type":"comment","z":"d1da38f2.572138","name":"CoAP PUT (controls) ","info":"","x":107.0909013748169,"y":820.7272758483887,"wires":[]},{"id":"b817ab0f.93e2c8","type":"debug","z":"d1da38f2.572138","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"req.payload","targetType":"msg","statusVal":"req.payload","statusType":"auto","x":370.00000381469727,"y":96.00000095367432,"wires":[]},{"id":"fa71236f.0c43e","type":"function","z":"d1da38f2.572138","name":"BufferToString","func":"msg.payload=msg.req.payload.toString();\nmsg.res.end(\"200\");\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":372.00000762939453,"y":141.00000190734863,"wires":[["afb871dc.0df8f","eb955d42.95fa"]]},{"id":"afb871dc.0df8f","type":"debug","z":"d1da38f2.572138","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"req.payload","x":601.0000076293945,"y":141.0000023841858,"wires":[]},{"id":"1328aa8e.b07d35","type":"function","z":"d1da38f2.572138","name":"Responder","func":"currentLedState = flow.get(\"LEDState\")||0;\ncurrentLedPower = flow.get(\"LEDPower\")||0;\n\nif (currentLedState===0)\n    msg.res.end(\"0\");\nelse\n    msg.res.end(currentLedPower.toString());\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":361.00000381469727,"y":59.00000047683716,"wires":[[]]},{"id":"524806ea.b17788","type":"inject","z":"d1da38f2.572138","name":"","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"LED_ON","payloadType":"str","x":100,"y":900,"wires":[["73657.a36079a94"]]},{"id":"90e8ca81.5a2928","type":"inject","z":"d1da38f2.572138","name":"","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"LED_OFF","payloadType":"str","x":100,"y":940,"wires":[["73657.a36079a94"]]},{"id":"aee3a4d8.d72fd8","type":"debug","z":"d1da38f2.572138","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","x":680,"y":860,"wires":[]},{"id":"9a0f5948.6e4118","type":"inject","z":"d1da38f2.572138","name":"","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"str","x":90,"y":860,"wires":[["92c4dc4f.ee56b"]]},{"id":"b3ae5d0e.d1c73","type":"debug","z":"d1da38f2.572138","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","x":1010,"y":160,"wires":[],"inputLabels":["msg.payload"]},{"id":"7c118c47.8462a4","type":"comment","z":"d1da38f2.572138","name":"CoAP responder","info":"","x":85,"y":23.599998474121094,"wires":[]},{"id":"84ca7a6.8949e88","type":"comment","z":"d1da38f2.572138","name":"MQTT responder","info":"","x":85,"y":192.00000381469727,"wires":[]},{"id":"83efc7ef.e1bc78","type":"comment","z":"d1da38f2.572138","name":"Dashboard & inflow controls","info":"","x":125,"y":380.99999618530273,"wires":[]},{"id":"ec4b2ecf.e3cbb","type":"comment","z":"d1da38f2.572138","name":"Hardware button","info":"","x":85,"y":699.9999990463257,"wires":[]},{"id":"742e1437.a167dc","type":"comment","z":"d1da38f2.572138","name":"LED state & commands mgt","info":"","x":656,"y":314,"wires":[]},{"id":"9b4b4006.c1226","type":"comment","z":"d1da38f2.572138","name":"LED change, notifications, dashboard out","info":"","x":981.0000152587891,"y":296.00001430511475,"wires":[]},{"id":"f48d9bc2.2c4b98","type":"ui_button","z":"d1da38f2.572138","name":"","group":"4608a4ea.943abc","order":1,"width":0,"height":0,"passthru":false,"label":"ON","tooltip":"","color":"","bgcolor":"green","icon":"","payload":"1","payloadType":"str","topic":"","topicType":"str","x":78,"y":552.9999961853027,"wires":[["e7e335fc.210258"]]},{"id":"95dbf3cd.463de","type":"ui_button","z":"d1da38f2.572138","name":"","group":"4608a4ea.943abc","order":2,"width":0,"height":0,"passthru":false,"label":"OFF","tooltip":"","color":"","bgcolor":"red","icon":"","payload":"0","payloadType":"str","topic":"","topicType":"str","x":78,"y":481.9999942779541,"wires":[["a0cafd07.403d"]]},{"id":"87385d1b.f38e3","type":"ui_switch","z":"d1da38f2.572138","name":"","label":"switch","tooltip":"","group":"4608a4ea.943abc","order":3,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"","topicType":"str","style":"","onvalue":"true","onvalueType":"bool","onicon":"power_settings_new","oncolor":"green","offvalue":"false","offvalueType":"bool","officon":"power_settings_new","offcolor":"red","animate":true,"x":78,"y":622.9999961853027,"wires":[["3cb343bd.6f98ac"]]},{"id":"f904144e.9247f8","type":"ui_slider","z":"d1da38f2.572138","name":"","label":"slider","tooltip":"","group":"4608a4ea.943abc","order":7,"width":0,"height":0,"passthru":true,"outs":"all","topic":"","topicType":"str","min":0,"max":"100","step":"10","x":276.00000381469727,"y":402.99999237060547,"wires":[["ca57bde7.0ef7f","a6958df0.81df2"]]},{"id":"a6958df0.81df2","type":"ui_text_input","z":"d1da38f2.572138","name":"","label":"Select a value","tooltip":"","group":"4608a4ea.943abc","order":5,"width":0,"height":0,"passthru":true,"mode":"text","delay":300,"topic":"","topicType":"str","x":115.00005340576172,"y":446.9999942779541,"wires":[["f904144e.9247f8"]]},{"id":"5cf8169c.da6a18","type":"ui_text","z":"d1da38f2.572138","group":"4608a4ea.943abc","order":8,"width":0,"height":0,"name":"","label":"LED is ","format":"{{msg.payload}}%","layout":"row-spread","x":970,"y":560.0000009536743,"wires":[]},{"id":"1da5117d.e6ef8f","type":"ui_text","z":"d1da38f2.572138","group":"63c5ce38.817cc","order":13,"width":0,"height":0,"name":"Error","label":"text","format":"{{msg.payload}}","layout":"row-spread","x":988.0000152587891,"y":218.00000286102295,"wires":[]},{"id":"79c451d6.9620c","type":"ui_gauge","z":"d1da38f2.572138","name":"","group":"4608a4ea.943abc","order":10,"width":0,"height":0,"gtype":"gage","title":"gauge","label":"units","format":"{{value}}","min":0,"max":"100","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":971.0000114440918,"y":603.0000085830688,"wires":[]},{"id":"a7858c99.6363a","type":"ui_chart","z":"d1da38f2.572138","name":"","group":"4608a4ea.943abc","order":12,"width":0,"height":0,"label":"chart","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"60","cutout":0,"useOneColor":false,"useUTC":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"outputs":1,"useDifferentColor":false,"x":972.0000114440918,"y":643.0000085830688,"wires":[[]]},{"id":"7cb47eb9.1117d","type":"inject","z":"d1da38f2.572138","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"100","payloadType":"num","x":690,"y":560,"wires":[["adbf9cfb.cb672"]]},{"id":"7ac72bf9.4a5854","type":"inject","z":"d1da38f2.572138","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"0","payloadType":"num","x":690,"y":520,"wires":[["adbf9cfb.cb672"]]},{"id":"e649beba52fbce9f","type":"inject","z":"d1da38f2.572138","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"LED_SWITCH","payloadType":"str","x":110,"y":980,"wires":[["73657.a36079a94"]]},{"id":"81ace750.9a42e8","type":"coap in","z":"d1da38f2.572138","method":"POST","name":"","server":"7d4138fe.5bb9d8","url":"/storage/LED","x":90,"y":100,"wires":[["b817ab0f.93e2c8","fa71236f.0c43e"]]},{"id":"9e55ad59.0fc69","type":"coap in","z":"d1da38f2.572138","method":"PUT","name":"","server":"7d4138fe.5bb9d8","url":"/storage/LED","x":95,"y":139.00000190734863,"wires":[["b817ab0f.93e2c8","fa71236f.0c43e"]]},{"id":"b5033d56.3fedc","type":"coap in","z":"d1da38f2.572138","method":"GET","name":"","server":"7d4138fe.5bb9d8","url":"/storage/LED","x":95,"y":59.00000190734863,"wires":[["1328aa8e.b07d35"]]},{"id":"73657.a36079a94","type":"coap request","z":"d1da38f2.572138","method":"PUT","confirmable":false,"observe":false,"multicast":false,"url":"coap://127.0.0.1:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"PUT /storage/LED","x":410,"y":920,"wires":[[]]},{"id":"92c4dc4f.ee56b","type":"coap request","z":"d1da38f2.572138","method":"GET","confirmable":false,"observe":true,"multicast":false,"url":"coap://localhost:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"GET /storage/LED","x":410,"y":860,"wires":[["aee3a4d8.d72fd8"]]},{"id":"33f70d58f14e37fa","type":"comment","z":"d1da38f2.572138","name":"LATEST VERSION OF COAP DOESN'T HANDLE THE CUSTOM PORT !","info":"","x":480,"y":820,"wires":[]},{"id":"1f3be2894eca4339","type":"comment","z":"d1da38f2.572138","name":"LATEST VERSION OF COAP DOESN'T HANDLE THE CUSTOM PORT !","info":"","x":420,"y":40,"wires":[]},{"id":"8b99762d836ed762","type":"inject","z":"bf296afbe68777e2","name":"Lancement périodique","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"str","x":160,"y":160,"wires":[["696b93b8ceb7813e"]]},{"id":"696b93b8ceb7813e","type":"exec","z":"bf296afbe68777e2","command":"raspistill -o /tmp/cam.jpg -w 640 -h 480","addpay":"","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"Capture de l'image","x":390,"y":160,"wires":[["ec362090e450de13"],[],[]]},{"id":"ec362090e450de13","type":"exec","z":"bf296afbe68777e2","command":"base64 -i \"/tmp/cam.jpg\"","addpay":"payload","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"Conversion base 64","x":640,"y":160,"wires":[["03c250751f52eca7"],[],[]]},{"id":"03c250751f52eca7","type":"template","z":"bf296afbe68777e2","name":"Contenu du mail","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<html>\n    <head>\n        <meta charset=\"utf8\"/>\n    </head>\n    <body>\n        <h1>Projet Photo par email</h1>\n        <img src=\"data:image/jpg;base64,{{payload}}\"/>\n    </body>\n</html>","output":"str","x":320,"y":320,"wires":[["23edc1f4dafdf61f","383deaccd2141dce"]]},{"id":"23edc1f4dafdf61f","type":"debug","z":"bf296afbe68777e2","name":"Formatage","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":350,"y":400,"wires":[]},{"id":"383deaccd2141dce","type":"template","z":"bf296afbe68777e2","name":"Email expediteur","field":"from","fieldType":"msg","format":"text","syntax":"plain","template":"yadegun@free.fr","output":"str","x":590,"y":320,"wires":[["5d24a589b977628c","0e25248176b7fa7d"]]},{"id":"5d24a589b977628c","type":"debug","z":"bf296afbe68777e2","name":"Sujet email","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":830,"y":400,"wires":[]},{"id":"0e25248176b7fa7d","type":"sendgrid","z":"bf296afbe68777e2","from":"yadegun@free.fr","multiple":false,"to":"yadegun@free.fr","name":"Envoi mail","content":"text","templateId":"","templateData":"","x":870,"y":320,"wires":[]},{"id":"03f9cf88dc11c44b","type":"sendgrid","z":"bf296afbe68777e2","from":"yadegun@free.fr","multiple":false,"to":"yadegun@free.fr","name":"Envoi mail","content":"text","templateId":"","templateData":"","x":470,"y":540,"wires":[]},{"id":"975a508d0520edf2","type":"inject","z":"bf296afbe68777e2","name":"","props":[{"p":"payload"},{"p":"from","v":"yadegun@free.fr","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"body","payloadType":"str","x":110,"y":540,"wires":[["03f9cf88dc11c44b"]]}]
Node Red All flows
335
[{"id":"3bd72e5a35157b80","type":"tab","label":"Flow 1","disabled":false,"info":"","env":[]},{"id":"30b5a9db.13c7e6","type":"tab","label":"RPI_LED_1","disabled":true,"info":""},{"id":"d3f6bafc.517628","type":"tab","label":"RPI_LED_2","disabled":true,"info":""},{"id":"2d68519d.28fdfe","type":"tab","label":"RPI_BTN_1","disabled":true,"info":""},{"id":"d62b9251.93e15","type":"tab","label":"RPI_BTN_2","disabled":true,"info":""},{"id":"72ecef13.ebb5a","type":"tab","label":"RPI_LED_BTN_1","disabled":true,"info":""},{"id":"f7e0aaa6.572a88","type":"tab","label":"RPI_LED_BTN_2","disabled":true,"info":""},{"id":"1ded4532.a4972b","type":"tab","label":"RPI_LED_POWER","disabled":true,"info":""},{"id":"e741101a.b1d4","type":"tab","label":"MQTT_1","disabled":true,"info":""},{"id":"137193d4.a8058c","type":"tab","label":"SHIFTR.IO","disabled":true,"info":""},{"id":"1e548fd5.aa977","type":"tab","label":"DASHBOARD_1","disabled":true,"info":""},{"id":"3f152265.215cbe","type":"tab","label":"RPI_LED_BTN_MQTT_DASHBOARD_FINAL","disabled":true,"info":""},{"id":"5159049.a3450fc","type":"tab","label":"DASHBOARD_2","disabled":true,"info":""},{"id":"c3b403f3.a5a5b","type":"tab","label":"DASHBOARD_GROUP_PROJECT","disabled":true,"info":""},{"id":"2a24c7d9.e04938","type":"tab","label":"AWS1","disabled":true,"info":""},{"id":"8b6d1dc248c33d11","type":"tab","label":"AWS2","disabled":true,"info":""},{"id":"3da35f20.0b7b6","type":"tab","label":"AWS Policies#1","disabled":true,"info":""},{"id":"eeada7b9.633358","type":"tab","label":"AWS Policies#2","disabled":true,"info":""},{"id":"fe1f66fac233d8f2","type":"tab","label":"AWS Own CA","disabled":true,"info":"","env":[]},{"id":"2ea861b1.19c0be","type":"tab","label":"AWSRules1","disabled":true,"info":""},{"id":"7055f43d.d3095c","type":"tab","label":"AWS SecProfile","disabled":true,"info":""},{"id":"df136e3e.4e7d","type":"tab","label":"CoAPClient","disabled":true,"info":""},{"id":"77dd7f0d.54335","type":"tab","label":"CoAPServerLED","disabled":true,"info":""},{"id":"d1da38f2.572138","type":"tab","label":"FINAL (on AWS)","disabled":true,"info":""},{"id":"bf296afbe68777e2","type":"tab","label":"Flow 4","disabled":true,"info":"","env":[]},{"id":"05fb78acddcc6eb0","type":"ui_base","theme":{"name":"theme-light","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#0094CE","value":"#0094CE","edited":false},"page-titlebar-backgroundColor":{"value":"#0094CE","edited":false},"page-backgroundColor":{"value":"#fafafa","edited":false},"page-sidebar-backgroundColor":{"value":"#ffffff","edited":false},"group-textColor":{"value":"#1bbfff","edited":false},"group-borderColor":{"value":"#ffffff","edited":false},"group-backgroundColor":{"value":"#ffffff","edited":false},"widget-textColor":{"value":"#111111","edited":false},"widget-backgroundColor":{"value":"#0094ce","edited":false},"widget-borderColor":{"value":"#ffffff","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey","palette":"light"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"87cc9444.0f3478","type":"mqtt-broker","name":"broker.hivemq.com","broker":"broker.hivemq.com","port":"1883","clientid":"","autoConnect":true,"usetls":false,"protocolVersion":4,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"4823d28e.7016ec","type":"ui_tab","name":"Home","icon":"dashboard","disabled":false,"hidden":false},{"id":"4608a4ea.943abc","type":"ui_group","name":"Test","tab":"4823d28e.7016ec","order":1,"disp":true,"width":"6","collapse":false},{"id":"ba8bbef790ed6b79","type":"tls-config","name":"RPI2 Autogen","cert":"/home/pi/awsCerts/03264be421936fd2dd86eff5355a21b844e16c07c406635716847fcd84436fe9-certificate.pem.crt","key":"/home/pi/awsCerts/03264be421936fd2dd86eff5355a21b844e16c07c406635716847fcd84436fe9-private.pem.key","ca":"/home/pi/awsCerts/AmazonRootCA1.pem","certname":"","keyname":"","caname":"","servername":"","verifyservercert":true,"alpnprotocol":""},{"id":"6ef2c7ecc7bb04bc","type":"mqtt-broker","name":"AWS RPI1","broker":"a2mi339glkcxco-ats.iot.us-east-1.amazonaws.com","port":"8883","tls":"2603cee1.048f22","clientid":"RPI1","autoConnect":true,"usetls":true,"protocolVersion":"4","keepalive":"60","cleansession":true,"autoUnsubscribe":true,"birthTopic":"","birthQos":"0","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"26cc290e.df7a56","type":"mqtt-broker","name":"AWS RPI1 Autogen","broker":"a2mi339glkcxco-ats.iot.us-east-1.amazonaws.com","port":"8883","tls":"1cc4b93929660fc5","clientid":"RPI1","autoConnect":true,"usetls":true,"protocolVersion":"3","keepalive":"60","cleansession":true,"autoUnsubscribe":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willRetain":"false","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"41d7a882.eec658","type":"tls-config","name":"RPI2","cert":"/home/pi/OwnPKI/RPI2.crt","key":"/home/pi/OwnPKI/RPI2.key","ca":"/home/pi/OwnPKI/AmazonRootCA1.pem","certname":"","keyname":"","caname":"","servername":"","verifyservercert":true,"alpnprotocol":""},{"id":"f443af26.bbf6b","type":"mqtt-broker","name":"AWS RPI2 Autogen","broker":"a2mi339glkcxco-ats.iot.us-east-1.amazonaws.com","port":"8883","tls":"ba8bbef790ed6b79","clientid":"RPI2","autoConnect":true,"usetls":true,"protocolVersion":"4","keepalive":"60","cleansession":true,"autoUnsubscribe":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willRetain":"false","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"8347ae6e.249ec","type":"mqtt-broker","name":"AWS RPI2 trying to fake RPI1","broker":"a2mi339glkcxco-ats.iot.us-east-1.amazonaws.com","port":"8883","tls":"ba8bbef790ed6b79","clientid":"RPI1","autoConnect":true,"usetls":true,"protocolVersion":"4","keepalive":"60","cleansession":true,"autoUnsubscribe":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willRetain":"false","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"dac21b5b.b18148","type":"mqtt-broker","name":"mqtt.eclipse.org","broker":"mqtt.eclipse.org","port":"1883","clientid":"RPI1","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"1c9f8b1.96f8e75","type":"mqtt-broker","name":"shiftr.io","broker":"gerald:licIOy58XhOO6JC2@gerald.cloud.shiftr.io","port":"1883","clientid":"MyNodeRed","autoConnect":true,"usetls":false,"protocolVersion":"4","keepalive":"60","cleansession":true,"autoUnsubscribe":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willRetain":"false","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"d327ea10.85a108","type":"mqtt-broker","name":"HiveMQ","broker":"broker.mqttdashboard.com","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"62eafb60.a61604","type":"mqtt-broker","name":"","broker":"test.mosquitto.org","port":"1883","clientid":"Test222","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"77fe118c.eeb1f","type":"mqtt-broker","name":"MQTTDashboard","broker":"broker.mqttdashboard.com","port":"1883","clientid":"","autoConnect":true,"usetls":false,"protocolVersion":"4","keepalive":"60","cleansession":true,"autoUnsubscribe":true,"birthTopic":"","birthQos":"0","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"ca9a434.6ddeec","type":"mqtt-broker","name":"AWS RPI1 trying to fake RPI2","broker":"a16auruvfvphj1-ats.iot.us-east-1.amazonaws.com","port":"8883","tls":"2603cee1.048f22","clientid":"RPI2","usetls":true,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"e88ba527.cfceb8","type":"tls-config","name":"RPI3","cert":"/home/pi/OwnPKI/RPI3.crt","key":"/home/pi/OwnPKI/RPI3.key","ca":"/home/pi/OwnPKI/AmazonRootCA1.pem","certname":"RPI3.crt","keyname":"RPI3.key","caname":"AmazonRootCA1.pem","servername":"","verifyservercert":true,"alpnprotocol":""},{"id":"6ee9e116.283a7","type":"mqtt-broker","name":"AWS RPI3","broker":"a2mi339glkcxco-ats.iot.us-east-1.amazonaws.com","port":"8883","tls":"e88ba527.cfceb8","clientid":"RPI3","autoConnect":true,"usetls":true,"protocolVersion":"4","keepalive":"60","cleansession":true,"autoUnsubscribe":true,"birthTopic":"","birthQos":"0","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"b1dcf4ce.3b88a8","type":"ui_tab","z":"3f152265.215cbe","name":"Home","icon":"link","order":1},{"id":"49ee7405.9ae99c","type":"ui_group","z":"3f152265.215cbe","name":"Second","tab":"4823d28e.7016ec","order":2,"disp":true,"width":"5","collapse":false},{"id":"ab690596.b277f8","type":"ui_tab","name":"Group","icon":"dashboard","disabled":false,"hidden":false},{"id":"e7794a15.c6d108","type":"ui_group","name":"Test","tab":"ab690596.b277f8","order":3,"disp":true,"width":"6","collapse":false},{"id":"63c5ce38.817cc","type":"ui_group","name":"bd4b99eb.217178","tab":"b1dcf4ce.3b88a8","order":null,"disp":true,"width":6},{"id":"50a4452b.d22cdc","type":"ui_spacer","name":"spacer","group":"63c5ce38.817cc","order":1,"width":1,"height":1},{"id":"7d4138fe.5bb9d8","type":"coap-server","name":"Embedded server","port":"5683","ipv6":false},{"id":"1cc4b93929660fc5","type":"tls-config","name":"RPI1 Autogen","cert":"/home/pi/awsCerts/7414a2b700a85910f043b54ee13ae165b91addb2cfc474840e82a564e71eb97e-certificate.pem.crt","key":"/home/pi/awsCerts/7414a2b700a85910f043b54ee13ae165b91addb2cfc474840e82a564e71eb97e-private.pem.key","ca":"/home/pi/awsCerts/AmazonRootCA1.pem","certname":"07b783c72d76c4b6f4ea387fb4054a09b0edeabaf457ec9746490578047607ee-certificate.pem.crt","keyname":"07b783c72d76c4b6f4ea387fb4054a09b0edeabaf457ec9746490578047607ee-private.pem.key","caname":"AmazonRootCA1 (1).pem","servername":"","verifyservercert":false,"alpnprotocol":""},{"id":"2603cee1.048f22","type":"tls-config","name":"RPI1","cert":"/home/pi/OwnPKI/RPI1full.crt","key":"/home/pi/OwnPKI/RPI1.key","ca":"/home/pi/awsCerts/AmazonRootCA1.pem","certname":"cc2956e006-certificate.pem.crt","keyname":"cc2956e006-private.pem.key","caname":"VeriSign-Class 3-Public-Primary-Certification-Authority-G5.pem","servername":"","verifyservercert":true,"alpnprotocol":""},{"id":"980c9839eeebcdab","type":"inject","z":"3bd72e5a35157b80","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":220,"y":20,"wires":[["38c840fd71879bf1"]]},{"id":"38c840fd71879bf1","type":"debug","z":"3bd72e5a35157b80","name":"debug 4","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":500,"y":20,"wires":[]},{"id":"283b0aeb.64d366","type":"inject","z":"30b5a9db.13c7e6","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED OFF","payload":"0","payloadType":"num","x":170,"y":220,"wires":[["3d4e12a.e9702ee","e59efd27.4c3c5"]]},{"id":"3d4e12a.e9702ee","type":"debug","z":"30b5a9db.13c7e6","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":890,"y":200,"wires":[],"inputLabels":["msg.payload"]},{"id":"75d2cabd.049644","type":"inject","z":"30b5a9db.13c7e6","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED ON","payload":"1","payloadType":"num","x":160,"y":260,"wires":[["e59efd27.4c3c5","3d4e12a.e9702ee"]]},{"id":"e59efd27.4c3c5","type":"rpi-gpio out","z":"30b5a9db.13c7e6","name":"Led on GPIO18","pin":"18","set":true,"level":"0","freq":"","out":"out","bcm":true,"x":900,"y":260,"wires":[]},{"id":"15fb9d6e.98b8a3","type":"inject","z":"30b5a9db.13c7e6","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":120,"y":100,"wires":[["811e1f9a.fe376"]]},{"id":"811e1f9a.fe376","type":"debug","z":"30b5a9db.13c7e6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":340,"y":100,"wires":[]},{"id":"902a5801.3c24a8","type":"function","z":"d3f6bafc.517628","name":"Switch LED state","func":"var myvarnode = !context.get(\"myvarnode\");\ncontext.set(\"myvarnode\",myvarnode);\nmsg.payload=myvarnode;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":710,"y":460,"wires":[["eb402fd6.92129","725a55fc.06aeac"]]},{"id":"3a7b28a0.64f358","type":"inject","z":"d3f6bafc.517628","name":"chaque seconde","repeat":"1","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"date","x":330,"y":520,"wires":[[]]},{"id":"b59dbe3f.e3994","type":"inject","z":"d3f6bafc.517628","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED OFF","payload":"0","payloadType":"num","x":310,"y":360,"wires":[["725a55fc.06aeac","eb402fd6.92129"]]},{"id":"725a55fc.06aeac","type":"debug","z":"d3f6bafc.517628","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":1030,"y":340,"wires":[],"inputLabels":["msg.payload"]},{"id":"7224d36c.5491cc","type":"inject","z":"d3f6bafc.517628","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED ON","payload":"1","payloadType":"num","x":300,"y":400,"wires":[["eb402fd6.92129","725a55fc.06aeac"]]},{"id":"eb402fd6.92129","type":"rpi-gpio out","z":"d3f6bafc.517628","name":"Led on GPIO18","pin":"18","set":false,"level":"0","freq":"","out":"out","bcm":true,"x":1040,"y":400,"wires":[]},{"id":"c25a4ab6.bb9ab8","type":"inject","z":"d3f6bafc.517628","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"SWITCH LED","payload":"1","payloadType":"num","x":320,"y":460,"wires":[["902a5801.3c24a8"]]},{"id":"515abade.1a5be4","type":"debug","z":"2d68519d.28fdfe","name":"Button value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":770,"y":300,"wires":[],"inputLabels":["msg.payload"]},{"id":"23cd878a47e11f96","type":"rpi-gpio in","z":"2d68519d.28fdfe","name":"BTN on GPIO4","pin":"4","intype":"up","debounce":"25","read":true,"bcm":true,"x":320,"y":300,"wires":[["515abade.1a5be4"]]},{"id":"cb7f19a8.a7ae38","type":"rpi-gpio in","z":"d62b9251.93e15","name":"BTN on GPIO4","pin":"4","intype":"up","debounce":"25","read":true,"bcm":true,"x":360,"y":200,"wires":[["7304d5d2.cf722c"]]},{"id":"7304d5d2.cf722c","type":"rpi-gpio out","z":"d62b9251.93e15","name":"Led on GPIO18","pin":"18","set":true,"level":"0","freq":"","out":"out","bcm":true,"x":740,"y":200,"wires":[]},{"id":"3a693104.ead97e","type":"function","z":"72ecef13.ebb5a","name":"Switch LED state","func":"var myvarnode = !context.get(\"myvarnode\");\ncontext.set(\"myvarnode\", myvarnode);\nmsg.payload = myvarnode;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":670,"y":220,"wires":[["8a141a57.f516d8","9988edf5.8a8af"]]},{"id":"c1bf6711.e38f88","type":"inject","z":"72ecef13.ebb5a","name":"SWITCH LED","repeat":"1","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"date","x":220,"y":260,"wires":[[]]},{"id":"a2a5b2b3.448d4","type":"inject","z":"72ecef13.ebb5a","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED OFF","payload":"0","payloadType":"num","x":210,"y":120,"wires":[["9988edf5.8a8af","8a141a57.f516d8"]]},{"id":"9988edf5.8a8af","type":"debug","z":"72ecef13.ebb5a","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":930,"y":80,"wires":[],"inputLabels":["msg.payload"]},{"id":"38233206.e4beae","type":"inject","z":"72ecef13.ebb5a","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED ON","payload":"1","payloadType":"num","x":200,"y":160,"wires":[["8a141a57.f516d8","9988edf5.8a8af"]]},{"id":"8a141a57.f516d8","type":"rpi-gpio out","z":"72ecef13.ebb5a","name":"Led on GPIO18","pin":"18","set":false,"level":"0","freq":"","out":"out","bcm":true,"x":940,"y":160,"wires":[]},{"id":"6fea8dbc.4c0f14","type":"rpi-gpio in","z":"72ecef13.ebb5a","name":"BTN on GPIO4","pin":"4","intype":"up","debounce":"25","read":true,"bcm":true,"x":220,"y":340,"wires":[["883815dc.bf1768"]]},{"id":"65cb1f01.0628f","type":"inject","z":"72ecef13.ebb5a","name":"SWITCH LED","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":210,"y":220,"wires":[["3a693104.ead97e"]]},{"id":"3d09e14.de42a1e","type":"function","z":"72ecef13.ebb5a","name":"If button down","func":"if (msg.payload===0)\n    return msg;\n    \nreturn  null;","outputs":1,"noerr":0,"x":440,"y":340,"wires":[[]]},{"id":"883815dc.bf1768","type":"switch","z":"72ecef13.ebb5a","name":"If button down","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":440,"y":300,"wires":[["3a693104.ead97e"],[]]},{"id":"d2f464b2.6660e8","type":"function","z":"f7e0aaa6.572a88","name":"Set LED state OFF","func":"var ledState = flow.get(\"LEDState\")||0;\nif (ledState===0)\n    return null;\n    \nledState = 0;\nmsg.payload = 0;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":140,"wires":[["e9fc023b.8920b"]]},{"id":"26b192f9.d4ebee","type":"function","z":"f7e0aaa6.572a88","name":"Set LED state ON","func":"var ledState = flow.get(\"LEDState\")||0;\nif (ledState==1)\n        return null;\n\nledState = 1;\nmsg.payload = 1;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":180,"wires":[["e9fc023b.8920b"]]},{"id":"e9fc023b.8920b","type":"change","z":"f7e0aaa6.572a88","name":"Dispatch","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":840,"y":160,"wires":[["f8ab0385.82db1","6073fa84.ab0024"]]},{"id":"ed9fa045.b70e9","type":"function","z":"f7e0aaa6.572a88","name":"Switch LED state","func":"var ledState=!flow.get(\"LEDState\");\n\nmsg.payload = ledState;\nflow.set(\"LEDState\", ledState);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":240,"wires":[["e9fc023b.8920b"]]},{"id":"163c5025.a9a45","type":"inject","z":"f7e0aaa6.572a88","name":"SWITCH LED","repeat":"1","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"date","x":200,"y":280,"wires":[[]]},{"id":"2c2a8daf.e5d5a2","type":"inject","z":"f7e0aaa6.572a88","name":"LED OFF","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"0","payloadType":"num","x":180,"y":140,"wires":[["d2f464b2.6660e8"]]},{"id":"f8ab0385.82db1","type":"debug","z":"f7e0aaa6.572a88","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":1030,"y":120,"wires":[],"inputLabels":["msg.payload"]},{"id":"dadd521c.de8f4","type":"inject","z":"f7e0aaa6.572a88","name":"LED ON","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":180,"y":180,"wires":[["26b192f9.d4ebee"]]},{"id":"6073fa84.ab0024","type":"rpi-gpio out","z":"f7e0aaa6.572a88","name":"Led on GPIO18","pin":"18","set":false,"level":"0","freq":"","out":"out","bcm":true,"x":1040,"y":180,"wires":[]},{"id":"2faeb32a.d0df3c","type":"rpi-gpio in","z":"f7e0aaa6.572a88","name":"BTN on GPIO4","pin":"4","intype":"up","debounce":"25","read":true,"bcm":true,"x":200,"y":360,"wires":[["400b610c.e5b86"]]},{"id":"44fdd616.fc72d8","type":"inject","z":"f7e0aaa6.572a88","name":"SWITCH LED","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":190,"y":240,"wires":[["ed9fa045.b70e9"]]},{"id":"82e435d3.ebe668","type":"function","z":"f7e0aaa6.572a88","name":"If button down","func":"if (msg.payload===0)\n    return msg;\n    \nreturn  null;","outputs":1,"noerr":0,"x":420,"y":360,"wires":[[]]},{"id":"400b610c.e5b86","type":"switch","z":"f7e0aaa6.572a88","name":"If button down","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":420,"y":320,"wires":[["ed9fa045.b70e9"],[]]},{"id":"5c5d15a1242e1e51","type":"change","z":"f7e0aaa6.572a88","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":400,"wires":[[]]},{"id":"4d40f320.124c4c","type":"function","z":"1ded4532.a4972b","name":"Set LED state OFF","func":"var ledState = flow.get(\"LEDState\")||0;\nif (ledState==0)\n    return null;\n    \nledState = 0;\nmsg.payload = 0;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":260,"wires":[["d74a7fd2.a6e3a"]]},{"id":"733584fd.88eb2c","type":"function","z":"1ded4532.a4972b","name":"Set LED state ON","func":"var ledState = flow.get(\"LEDState\")||0;\nif (ledState==1)\n        return null;\n\nledState = 1;\nmsg.payload = 100;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":300,"wires":[["d74a7fd2.a6e3a"]]},{"id":"d74a7fd2.a6e3a","type":"change","z":"1ded4532.a4972b","name":"Dispatch","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":280,"wires":[["fdf7999c.451d18","32f6f47c.7e68cc"]]},{"id":"fcc668b1.76bcb8","type":"function","z":"1ded4532.a4972b","name":"Switch LED state","func":"var ledState=!flow.get(\"LEDState\");\n\nif (ledState==true)\n    msg.payload = 100;\nelse\n    msg.payload=0;\n    \nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":360,"wires":[["d74a7fd2.a6e3a"]]},{"id":"eb037f81.33f6b","type":"inject","z":"1ded4532.a4972b","name":"SWITCH LED","repeat":"1","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"date","x":220,"y":400,"wires":[[]]},{"id":"d8d5759e.47fd68","type":"inject","z":"1ded4532.a4972b","name":"LED OFF","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"0","payloadType":"num","x":200,"y":260,"wires":[["4d40f320.124c4c"]]},{"id":"fdf7999c.451d18","type":"debug","z":"1ded4532.a4972b","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":1050,"y":240,"wires":[],"inputLabels":["msg.payload"]},{"id":"f2d9c5b0.039c38","type":"inject","z":"1ded4532.a4972b","name":"LED ON","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":200,"y":300,"wires":[["733584fd.88eb2c"]]},{"id":"32f6f47c.7e68cc","type":"rpi-gpio out","z":"1ded4532.a4972b","name":"Led on GPIO18","pin":"18","set":false,"level":"0","freq":"","out":"pwm","bcm":true,"x":1060,"y":300,"wires":[]},{"id":"fa776874.b5fc08","type":"rpi-gpio in","z":"1ded4532.a4972b","name":"BTN on GPIO4","pin":"4","intype":"up","debounce":"25","read":true,"bcm":true,"x":220,"y":480,"wires":[["3e497bb1.b28e14"]]},{"id":"775d9f80.41707","type":"inject","z":"1ded4532.a4972b","name":"SWITCH LED","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":210,"y":360,"wires":[["fcc668b1.76bcb8"]]},{"id":"916cfc38.fb2e7","type":"function","z":"1ded4532.a4972b","name":"If button down","func":"if (msg.payload===0)\n    return msg;\n    \nreturn  null;","outputs":1,"noerr":0,"x":440,"y":480,"wires":[[]]},{"id":"3e497bb1.b28e14","type":"switch","z":"1ded4532.a4972b","name":"If button down","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":440,"y":440,"wires":[["fcc668b1.76bcb8"],[]]},{"id":"0d835a5383a8369c","type":"inject","z":"1ded4532.a4972b","name":"LED 50%","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":200,"y":180,"wires":[["9f0cf5db6961ae97"]]},{"id":"9f0cf5db6961ae97","type":"function","z":"1ded4532.a4972b","name":"Set LED state ON 50%","func":"var ledState = 1;\nmsg.payload = 50;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":660,"y":180,"wires":[["d74a7fd2.a6e3a"]]},{"id":"8664dc52.fbb3a","type":"function","z":"e741101a.b1d4","name":"Set LED state OFF","func":"var currentLedState = flow.get(\"LEDState\")||0;\nif (currentLedState===0)\n    return null;\n    \nvar ledState = 0;\nmsg.payload = 0;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":280,"wires":[["e1076d28.eceb5"]]},{"id":"f3057296.5e0d1","type":"function","z":"e741101a.b1d4","name":"Set LED state ON","func":"var currentLedState = flow.get(\"LEDState\")||0;\n\nif (currentLedState==1)\n        return null;\n\nvar ledState = 1;\n\nmsg.payload = 100;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":320,"wires":[["e1076d28.eceb5"]]},{"id":"e1076d28.eceb5","type":"change","z":"e741101a.b1d4","name":"Dispatch","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":300,"wires":[["439702e.ee91efc","7b6391a.971f07","c1e9340a.eacbd8"]]},{"id":"6803aaf4.9b7534","type":"function","z":"e741101a.b1d4","name":"Switch LED state","func":"var ledState=flow.get(\"LEDState\")||0;\n\n(ledState === 0) ? ledState = 1 : ledState = 0;\nif (ledState==1)\n    msg.payload = 100;\nelse\n    msg.payload=0;\n    \nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":380,"wires":[["e1076d28.eceb5"]]},{"id":"9c1b622a.a3a77","type":"inject","z":"e741101a.b1d4","name":"SWITCH LED","repeat":"1","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"date","x":120,"y":420,"wires":[[]]},{"id":"8edb7ef5.f8bc8","type":"inject","z":"e741101a.b1d4","name":"LED OFF","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"0","payloadType":"num","x":100,"y":280,"wires":[["8664dc52.fbb3a"]]},{"id":"439702e.ee91efc","type":"debug","z":"e741101a.b1d4","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":1050,"y":260,"wires":[],"inputLabels":["msg.payload"]},{"id":"8f40660b.b51ad8","type":"inject","z":"e741101a.b1d4","name":"LED ON","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":100,"y":320,"wires":[["f3057296.5e0d1"]]},{"id":"7b6391a.971f07","type":"rpi-gpio out","z":"e741101a.b1d4","name":"Led on GPIO18","pin":"18","set":false,"level":"0","freq":"","out":"pwm","bcm":true,"x":1060,"y":320,"wires":[]},{"id":"2b818147.c3b2ce","type":"rpi-gpio in","z":"e741101a.b1d4","name":"BTN on GPIO4","pin":"4","intype":"up","debounce":"25","read":true,"bcm":true,"x":120,"y":500,"wires":[["4c6dd0a9.5b8d4"]]},{"id":"90ecfd7a.25b96","type":"inject","z":"e741101a.b1d4","name":"SWITCH LED","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":110,"y":380,"wires":[["6803aaf4.9b7534"]]},{"id":"88d2dc67.f728b","type":"function","z":"e741101a.b1d4","name":"If button down","func":"if (msg.payload===0)\n    return msg;\n    \nreturn  null;","outputs":1,"noerr":0,"x":340,"y":500,"wires":[[]]},{"id":"4c6dd0a9.5b8d4","type":"switch","z":"e741101a.b1d4","name":"If button down","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":340,"y":460,"wires":[["6803aaf4.9b7534"],[]]},{"id":"c1e9340a.eacbd8","type":"mqtt out","z":"e741101a.b1d4","name":"Publish MyLEDState","topic":"RPI/RPI1/MyLEDState","qos":"1","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"87cc9444.0f3478","x":1080,"y":200,"wires":[]},{"id":"607137dc.8ab9d8","type":"mqtt in","z":"e741101a.b1d4","name":"","topic":"RPI/RPI1/MyLEDCommand","qos":"1","datatype":"auto","broker":"87cc9444.0f3478","nl":false,"rap":false,"inputs":0,"x":160,"y":120,"wires":[["71dc3ba1.16f504","56a3928e.c688dc"]]},{"id":"71dc3ba1.16f504","type":"switch","z":"e741101a.b1d4","name":"Parse command","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"LED_OFF","vt":"str"},{"t":"eq","v":"LED_ON","vt":"str"},{"t":"eq","v":"LED_SWITCH","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":4,"x":400,"y":120,"wires":[["8664dc52.fbb3a"],["f3057296.5e0d1"],["6803aaf4.9b7534"],[]]},{"id":"56a3928e.c688dc","type":"debug","z":"e741101a.b1d4","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","statusVal":"payload","statusType":"auto","x":390,"y":180,"wires":[]},{"id":"b4499a64.705478","type":"delay","z":"e741101a.b1d4","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":940,"y":680,"wires":[[]]},{"id":"95192660.c60728","type":"delay","z":"e741101a.b1d4","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"10","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":960,"y":720,"wires":[[]]},{"id":"5d31a82c2b388adb","type":"comment","z":"e741101a.b1d4","name":"broker.hivemq.com","info":"","x":130,"y":40,"wires":[]},{"id":"0b1201e769557346","type":"mqtt in","z":"e741101a.b1d4","name":"","topic":"RPI/RPI1/MyLEDState","qos":"1","datatype":"auto-detect","broker":"d327ea10.85a108","nl":false,"rap":true,"rh":0,"inputs":0,"x":980,"y":620,"wires":[["d12681e0aa18f1a5"]]},{"id":"d12681e0aa18f1a5","type":"debug","z":"e741101a.b1d4","name":"LED Value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":1230,"y":620,"wires":[]},{"id":"a48b626f8270c023","type":"comment","z":"e741101a.b1d4","name":"DEBUG","info":"","x":930,"y":560,"wires":[]},{"id":"cb81cbcc8f28af44","type":"mqtt out","z":"e741101a.b1d4","name":"Publish MyLEDCommand","topic":"RPI/RPI1/MyLEDCommand","qos":"1","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"87cc9444.0f3478","x":1150,"y":800,"wires":[]},{"id":"7972afdc52d263a6","type":"inject","z":"e741101a.b1d4","name":"\"LED_OFF\"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"LED_OFF","payloadType":"str","x":950,"y":780,"wires":[["cb81cbcc8f28af44"]]},{"id":"0587e17f874f8787","type":"inject","z":"e741101a.b1d4","name":"\"LED_ON\"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"LED_ON","payloadType":"str","x":940,"y":820,"wires":[["cb81cbcc8f28af44"]]},{"id":"fa3cc41d.ff5428","type":"mqtt out","z":"137193d4.a8058c","name":"shiftr.io","topic":"","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"1c9f8b1.96f8e75","x":720,"y":260,"wires":[]},{"id":"7bf0c0cc.cdbca","type":"function","z":"137193d4.a8058c","name":"Rate Limiter 100ms","func":"\nvar interval = 100; // minimum interval between messages (ms)\ncontext.lastTime = context.lastTime || 0;\n\nvar now = Date.now();\n\nif (context.lastTime===0)\n{\n    context.lastTime = now;\n    return null;\n}\n\n\nif (now-context.lastTime > interval) {\n  context.lastTime = now;\n  return msg;\n} else {\n  return null;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":490,"y":260,"wires":[["fa3cc41d.ff5428","d205c8a7.c11348"]]},{"id":"d205c8a7.c11348","type":"debug","z":"137193d4.a8058c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":730,"y":340,"wires":[]},{"id":"d158d6f1.89bbc8","type":"mqtt in","z":"137193d4.a8058c","name":"","topic":"FisherHouse/#","qos":"0","datatype":"auto-detect","broker":"77fe118c.eeb1f","nl":false,"rap":false,"inputs":0,"x":220,"y":380,"wires":[["836df232ad8c6116"]]},{"id":"becb353f.786828","type":"delay","z":"137193d4.a8058c","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"10","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":477.7777786254883,"y":308.88890266418457,"wires":[["d205c8a7.c11348","fa3cc41d.ff5428"]]},{"id":"c400345c.b33ff8","type":"mqtt in","z":"137193d4.a8058c","d":true,"name":"#","topic":"#","qos":"0","datatype":"auto","broker":"62eafb60.a61604","nl":false,"rap":false,"inputs":0,"x":190,"y":260,"wires":[["becb353f.786828"]]},{"id":"717eacfe.ba5bc4","type":"mqtt in","z":"137193d4.a8058c","name":"","topic":"FisherSystem/#","qos":"0","datatype":"auto-detect","broker":"77fe118c.eeb1f","nl":false,"rap":false,"inputs":0,"x":220,"y":320,"wires":[["836df232ad8c6116"]]},{"id":"836df232ad8c6116","type":"change","z":"137193d4.a8058c","name":"Unlimited","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":470,"y":380,"wires":[["d205c8a7.c11348","fa3cc41d.ff5428"]]},{"id":"6548e005.29678","type":"ui_slider","z":"1e548fd5.aa977","name":"slider","label":"slider","tooltip":"","group":"4608a4ea.943abc","order":6,"width":0,"height":0,"passthru":true,"outs":"all","topic":"test","topicType":"str","min":0,"max":"100","step":"10","className":"","x":450,"y":240,"wires":[["6d10cd30.79f024","f66a6ffc.6e235","ee4df0ea.7ff18"]]},{"id":"ee4df0ea.7ff18","type":"ui_text_input","z":"1e548fd5.aa977","name":"","label":"Select a value","tooltip":"","group":"4608a4ea.943abc","order":4,"width":0,"height":0,"passthru":false,"mode":"text","delay":300,"topic":"","sendOnBlur":true,"className":"","topicType":"str","x":240,"y":240,"wires":[["6548e005.29678"]]},{"id":"6d10cd30.79f024","type":"ui_gauge","z":"1e548fd5.aa977","name":"","group":"4608a4ea.943abc","order":9,"width":0,"height":0,"gtype":"gage","title":"gauge","label":"units","format":"{{value}}","min":0,"max":"100","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":670,"y":180,"wires":[]},{"id":"f66a6ffc.6e235","type":"ui_chart","z":"1e548fd5.aa977","name":"","group":"4608a4ea.943abc","order":11,"width":0,"height":0,"label":"chart","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"60","cutout":0,"useOneColor":false,"useUTC":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"outputs":1,"useDifferentColor":false,"x":670,"y":300,"wires":[[]]},{"id":"b94d3f90420b6d3f","type":"delay","z":"1e548fd5.aa977","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":300,"y":460,"wires":[[]]},{"id":"9e79a24b.119fd","type":"function","z":"3f152265.215cbe","name":"Switch LED state","func":"var ledState=flow.get(\"LEDState\")||0;\nvar ledPower=flow.get(\"LEDPower\")||0;\n\n(ledState === 0) ? ledState = 1 : ledState = 0;\nif (ledState==1)\n    {\n    if (ledPower===0)\n        ledPower=100;\n    msg.payload = ledPower;\n    }\nelse\n    msg.payload=0;\n    \nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":750,"y":280,"wires":[["787e5b2c.a62404"]]},{"id":"577fc370.c516ec","type":"inject","z":"3f152265.215cbe","name":"SWITCH LED","repeat":"1","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"date","x":220,"y":320,"wires":[[]]},{"id":"55ef513a.7cb9d","type":"inject","z":"3f152265.215cbe","name":"LED OFF","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED OFF","payload":"0","payloadType":"num","x":200,"y":180,"wires":[["b8e52af8.91b5d8"]]},{"id":"e24ce3c1.d694c","type":"debug","z":"3f152265.215cbe","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":1110,"y":280,"wires":[],"inputLabels":["msg.payload"]},{"id":"2f2556b.a0869aa","type":"inject","z":"3f152265.215cbe","name":"LED ON","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED ON","payload":"ledPower","payloadType":"flow","x":200,"y":220,"wires":[["2fbc2614.bd7eda"]]},{"id":"38d3dc7.6469224","type":"rpi-gpio out","z":"3f152265.215cbe","name":"LED on GPIO18","pin":"18","set":false,"level":"0","freq":"","out":"pwm","bcm":true,"x":1120,"y":220,"wires":[]},{"id":"22f4c07.9e18d4","type":"rpi-gpio in","z":"3f152265.215cbe","name":"BTN on GPIO4","pin":"4","intype":"up","debounce":"25","read":true,"bcm":true,"x":220,"y":520,"wires":[["9eaf8262.2ef44"]]},{"id":"f42683eb.15bf7","type":"inject","z":"3f152265.215cbe","name":"SWITCH LED","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":210,"y":280,"wires":[["9e79a24b.119fd"]]},{"id":"5a6f8759.71f788","type":"function","z":"3f152265.215cbe","name":"If button down","func":"if (msg.payload===0)\n    return msg;\n    \nreturn  null;","outputs":1,"noerr":0,"x":420,"y":560,"wires":[[]]},{"id":"9eaf8262.2ef44","type":"switch","z":"3f152265.215cbe","name":"If button down","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":420,"y":520,"wires":[["9e79a24b.119fd"],[]]},{"id":"b8e52af8.91b5d8","type":"function","z":"3f152265.215cbe","name":"Set LED state OFF","func":"var currentLedState = flow.get(\"LEDState\")||0;\nif (currentLedState===0)\n    return null;\n    \nvar ledState = 0;\nmsg.payload = ledState;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":750,"y":180,"wires":[["787e5b2c.a62404"]]},{"id":"2fbc2614.bd7eda","type":"function","z":"3f152265.215cbe","name":"Set LED state ON","func":"var currentLedState = flow.get(\"LEDState\")||0;\nvar ledPower=flow.get(\"LEDPower\")||0;\n\nif (currentLedState==1)\n    if (ledPower==100)\n        return null;\n    else\n        ledPower=100;\n\nvar ledState = 1;\n\nif (ledPower==0)\n    ledPower=100;\n    \nmsg.payload = ledPower;\n\nflow.set(\"LEDState\", ledState);\nflow.set(\"LEDPower\", ledPower);\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":750,"y":220,"wires":[["787e5b2c.a62404"]]},{"id":"ce9d00b3.b9f2f","type":"mqtt in","z":"3f152265.215cbe","name":"","topic":"RPI/RPI1/MyLEDCommand","qos":"2","datatype":"auto","broker":"87cc9444.0f3478","inputs":0,"x":260,"y":40,"wires":[["de85a353.9ce42","e9b7d71d.451ed8"]]},{"id":"b9a52cb1.4f503","type":"mqtt out","z":"3f152265.215cbe","name":"Publish MyLEDState","topic":"RPI/RPI1/MyLEDState","qos":"","retain":"","broker":"87cc9444.0f3478","x":1140,"y":160,"wires":[]},{"id":"de85a353.9ce42","type":"switch","z":"3f152265.215cbe","name":"Parse command","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"LED_OFF","vt":"str"},{"t":"eq","v":"LED_ON","vt":"str"},{"t":"eq","v":"LED_SWITCH","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":4,"x":500,"y":40,"wires":[["b8e52af8.91b5d8"],["2fbc2614.bd7eda"],["9e79a24b.119fd"],["f8a45bac.ced858"]]},{"id":"e9b7d71d.451ed8","type":"debug","z":"3f152265.215cbe","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":490,"y":100,"wires":[]},{"id":"787e5b2c.a62404","type":"change","z":"3f152265.215cbe","name":"Dispatch","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":940,"y":220,"wires":[["e24ce3c1.d694c","38d3dc7.6469224","b9a52cb1.4f503","9b34547b.7e8bb8"]]},{"id":"f8a45bac.ced858","type":"change","z":"3f152265.215cbe","name":"Unknown command","rules":[{"t":"change","p":"payload","pt":"msg","from":"^(.*)$","fromt":"re","to":"Unknown MQTT command received : [$1] ","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":760,"y":40,"wires":[["9fabd03f.4376"]]},{"id":"ef0dfbee.65c3a8","type":"mqtt in","z":"3f152265.215cbe","name":"","topic":"RPI/RPI1/MyLEDPower","qos":"2","datatype":"auto","broker":"87cc9444.0f3478","inputs":0,"x":240,"y":140,"wires":[["e9b7d71d.451ed8","3b52a474.ea0d2c"]]},{"id":"3b52a474.ea0d2c","type":"function","z":"3f152265.215cbe","name":"Set LED Power","func":"var ledPower=msg.payload;\nvar ledState;\n\nif (ledPower===0)\n    {\n    ledState=0;\n    ledPower=100;\n    }\nelse\n    ledState=1;\n    \nflow.set(\"LEDState\", ledState);\nflow.set(\"LEDPower\", ledPower);\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":740,"y":140,"wires":[["787e5b2c.a62404"]]},{"id":"9fabd03f.4376","type":"ui_text","z":"3f152265.215cbe","d":true,"group":"4608a4ea.943abc","order":13,"width":0,"height":0,"name":"Error","label":"text","format":"{{msg.payload}}","layout":"row-spread","x":1090,"y":40,"wires":[]},{"id":"b8c8d490.c9ad58","type":"ui_button","z":"3f152265.215cbe","name":"","group":"4608a4ea.943abc","order":2,"width":0,"height":0,"passthru":false,"label":"OFF","tooltip":"","color":"","bgcolor":"red","icon":"","payload":"0","payloadType":"str","topic":"","topicType":"str","x":190,"y":380,"wires":[["b8e52af8.91b5d8"]]},{"id":"cc0d31f6.b2af","type":"ui_button","z":"3f152265.215cbe","name":"","group":"4608a4ea.943abc","order":1,"width":0,"height":0,"passthru":false,"label":"ON","tooltip":"","color":"","bgcolor":"green","icon":"","payload":"1","payloadType":"str","topic":"","topicType":"str","x":190,"y":420,"wires":[["2fbc2614.bd7eda"]]},{"id":"3c84a633.401fba","type":"ui_switch","z":"3f152265.215cbe","name":"","label":"switch","tooltip":"","group":"4608a4ea.943abc","order":3,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"","topicType":"str","style":"","onvalue":"true","onvalueType":"bool","onicon":"power_settings_new","oncolor":"green","offvalue":"false","offvalueType":"bool","officon":"power_settings_new","offcolor":"red","animate":true,"x":190,"y":460,"wires":[["9e79a24b.119fd"]]},{"id":"9b34547b.7e8bb8","type":"link out","z":"3f152265.215cbe","name":"Display LED state","links":["6256c124.88157"],"x":1055,"y":380,"wires":[]},{"id":"54100fe1a08865e9","type":"comment","z":"3f152265.215cbe","name":"broker.hivemq.com","info":"","x":110,"y":100,"wires":[]},{"id":"679c406996b791fd","type":"comment","z":"3f152265.215cbe","name":"Activate also Dashboard_2","info":"","x":830,"y":440,"wires":[]},{"id":"1142b282.8ede2d","type":"mqtt out","z":"5159049.a3450fc","name":"Change LED power","topic":"RPI/RPI1/MyLEDPower","qos":"","retain":"","broker":"87cc9444.0f3478","x":570,"y":160,"wires":[]},{"id":"2435f94a.752026","type":"mqtt in","z":"5159049.a3450fc","name":"","topic":"RPI/RPI1/MyLEDState","qos":"2","datatype":"auto","broker":"87cc9444.0f3478","inputs":0,"x":400,"y":340,"wires":[["7e9195.01644e6c","c0292ab9.549ae8","fd93cb91.cba208"]]},{"id":"fd93cb91.cba208","type":"debug","z":"5159049.a3450fc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":617,"y":440.9999990463257,"wires":[]},{"id":"e7e8dcb7.08ca7","type":"debug","z":"5159049.a3450fc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":550,"y":100,"wires":[]},{"id":"9cdd9777.a77e48","type":"ui_slider","z":"5159049.a3450fc","name":"","label":"slider","tooltip":"","group":"4608a4ea.943abc","order":7,"width":0,"height":0,"passthru":true,"outs":"all","topic":"","topicType":"str","min":0,"max":"100","step":"10","x":370,"y":40,"wires":[["91bba0a4.473b8","1142b282.8ede2d","e7e8dcb7.08ca7"]]},{"id":"91bba0a4.473b8","type":"ui_text_input","z":"5159049.a3450fc","name":"","label":"Select a value","tooltip":"","group":"4608a4ea.943abc","order":5,"width":0,"height":0,"passthru":false,"mode":"text","delay":300,"topic":"","sendOnBlur":true,"className":"","topicType":"str","x":120,"y":40,"wires":[["9cdd9777.a77e48"]]},{"id":"7e9195.01644e6c","type":"ui_gauge","z":"5159049.a3450fc","name":"","group":"4608a4ea.943abc","order":10,"width":0,"height":0,"gtype":"gage","title":"gauge","label":"units","format":"{{value}}","min":0,"max":"100","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":607,"y":340.9999990463257,"wires":[]},{"id":"c0292ab9.549ae8","type":"ui_chart","z":"5159049.a3450fc","name":"","group":"4608a4ea.943abc","order":12,"width":0,"height":0,"label":"chart","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"60","cutout":0,"useOneColor":false,"useUTC":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"outputs":1,"useDifferentColor":false,"x":607,"y":380.9999990463257,"wires":[[]]},{"id":"16c0e0af.a6fb2f","type":"ui_text","z":"5159049.a3450fc","group":"4608a4ea.943abc","order":8,"width":0,"height":0,"name":"","label":"LED is ","format":"{{msg.payload}}%","layout":"row-spread","x":210,"y":260,"wires":[]},{"id":"6256c124.88157","type":"link in","z":"5159049.a3450fc","name":"","links":["9b34547b.7e8bb8"],"x":100,"y":260,"wires":[["16c0e0af.a6fb2f"]]},{"id":"a0e68909d114e228","type":"comment","z":"5159049.a3450fc","name":"Requires RPI_LED_BTN_MQTT_DASHBOARD_FINAL","info":"","x":240,"y":540,"wires":[]},{"id":"c3c8cfd0.71c9c","type":"mqtt in","z":"c3b403f3.a5a5b","name":"","topic":"RPI/+/MyLEDState","qos":"2","datatype":"auto","broker":"87cc9444.0f3478","inputs":0,"x":190,"y":200,"wires":[["5be95b40.71da54","12861adf.f936e5","101f4f3b.ef0201"]]},{"id":"12861adf.f936e5","type":"switch","z":"c3b403f3.a5a5b","name":"Which RPI","property":"topic","propertyType":"msg","rules":[{"t":"regex","v":"^RPI/RPI1","vt":"str","case":false},{"t":"regex","v":"^RPI/RPI2","vt":"str","case":false},{"t":"regex","v":"^RPI/RPI3","vt":"str","case":false},{"t":"regex","v":"^RPI/RPI4","vt":"str","case":false},{"t":"regex","v":"^RPI/RPI45","vt":"str","case":false}],"checkall":"true","repair":false,"outputs":5,"x":410,"y":200,"wires":[["d689c20f.b8758"],["b87997e7.66d298"],["f9cbf8a3.611cc8"],["4776ca0e.419484"],["5c7fa99879505dce"]]},{"id":"5be95b40.71da54","type":"debug","z":"c3b403f3.a5a5b","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":390,"y":20,"wires":[]},{"id":"101f4f3b.ef0201","type":"debug","z":"c3b403f3.a5a5b","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"topic","x":400,"y":80,"wires":[]},{"id":"bb2b4aba.9af848","type":"mqtt out","z":"c3b403f3.a5a5b","name":"Publish","topic":"","qos":"","retain":"","broker":"87cc9444.0f3478","x":1220,"y":260,"wires":[]},{"id":"a33bad1.077475","type":"change","z":"c3b403f3.a5a5b","name":"Set Command LED_SWITCH","rules":[{"t":"set","p":"payload","pt":"msg","to":"LED_SWITCH","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":990,"y":200,"wires":[["bb2b4aba.9af848"]]},{"id":"cc7297a1.e80e38","type":"function","z":"c3b403f3.a5a5b","name":"NOTIFY ALL","func":"var msg1 = {}, msg2 = {}, msg3 = {}, msg4 = {}, msg5 = {}\nmsg1.payload=msg.payload\nmsg1.topic=\"RPI/RPI1/MyLEDCommand\"\n\nmsg2.payload=msg.payload\nmsg2.topic=\"RPI/RPI2/MyLEDCommand\"\n\nmsg3.payload=msg.payload\nmsg3.topic=\"RPI/RPI3/MyLEDCommand\"\n\nmsg4.payload=msg.payload\nmsg4.topic=\"RPI/RPI4/MyLEDCommand\"\n\nmsg5.payload = msg.payload\nmsg5.topic = \"RPI/RPI5/MyLEDCommand\"\n\nreturn  [msg1,msg2,msg3,msg4,msg5]\n","outputs":5,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1050,"y":320,"wires":[["bb2b4aba.9af848"],["bb2b4aba.9af848"],["bb2b4aba.9af848"],["bb2b4aba.9af848"],["bb2b4aba.9af848"]]},{"id":"3f103d04.1b9182","type":"ui_button","z":"c3b403f3.a5a5b","name":"","group":"e7794a15.c6d108","order":1,"width":0,"height":0,"passthru":false,"label":"ALL OFF","tooltip":"","color":"","bgcolor":"RED","icon":"","payload":"LED_OFF","payloadType":"str","topic":"","topicType":"str","x":760.4000244140625,"y":356,"wires":[["cc7297a1.e80e38"]]},{"id":"d9101543.14acc8","type":"ui_button","z":"c3b403f3.a5a5b","name":"","group":"e7794a15.c6d108","order":4,"width":0,"height":0,"passthru":false,"label":"Switch","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"RPI/RPI1/MyLEDCommand","topicType":"str","x":750,"y":140,"wires":[["a33bad1.077475"]]},{"id":"169b634f.f0fbed","type":"ui_button","z":"c3b403f3.a5a5b","name":"","group":"e7794a15.c6d108","order":6,"width":0,"height":0,"passthru":false,"label":"Switch","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"RPI/RPI2/MyLEDCommand","topicType":"str","x":750,"y":180,"wires":[["a33bad1.077475"]]},{"id":"ba542ac1.c112a8","type":"ui_button","z":"c3b403f3.a5a5b","name":"","group":"e7794a15.c6d108","order":8,"width":0,"height":0,"passthru":false,"label":"Switch","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"RPI/RPI3/MyLEDCommand","topicType":"str","x":750,"y":220,"wires":[["a33bad1.077475"]]},{"id":"d43e6744.5d83c8","type":"ui_button","z":"c3b403f3.a5a5b","name":"","group":"e7794a15.c6d108","order":10,"width":0,"height":0,"passthru":false,"label":"Switch","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"RPI/RPI4/MyLEDCommand","topicType":"str","x":750,"y":260,"wires":[["a33bad1.077475"]]},{"id":"ca6b7299.603c6","type":"ui_button","z":"c3b403f3.a5a5b","name":"","group":"e7794a15.c6d108","order":2,"width":0,"height":0,"passthru":false,"label":"ALL ON","tooltip":"","color":"","bgcolor":"GREEN ","icon":"","payload":"LED_ON","payloadType":"str","topic":"","topicType":"str","x":760,"y":400,"wires":[["cc7297a1.e80e38"]]},{"id":"d689c20f.b8758","type":"ui_text","z":"c3b403f3.a5a5b","group":"e7794a15.c6d108","order":3,"width":0,"height":0,"name":"","label":"RPI 1 LED is ","format":"{{msg.payload}}%","layout":"row-spread","x":610,"y":140,"wires":[]},{"id":"b87997e7.66d298","type":"ui_text","z":"c3b403f3.a5a5b","group":"e7794a15.c6d108","order":5,"width":0,"height":0,"name":"","label":"RPI 2 LED is ","format":"{{msg.payload}}%","layout":"row-spread","x":610,"y":180,"wires":[]},{"id":"f9cbf8a3.611cc8","type":"ui_text","z":"c3b403f3.a5a5b","group":"e7794a15.c6d108","order":7,"width":0,"height":0,"name":"","label":"RPI 3 LED is ","format":"{{msg.payload}}%","layout":"row-spread","x":610,"y":220,"wires":[]},{"id":"4776ca0e.419484","type":"ui_text","z":"c3b403f3.a5a5b","group":"e7794a15.c6d108","order":9,"width":0,"height":0,"name":"","label":"RPI 4 LED is ","format":"{{msg.payload}}%","layout":"row-spread","x":610,"y":260,"wires":[]},{"id":"5c7fa99879505dce","type":"ui_text","z":"c3b403f3.a5a5b","group":"e7794a15.c6d108","order":11,"width":0,"height":0,"name":"","label":"RPI 5 LED is ","format":"{{msg.payload}}%","layout":"row-spread","className":"","x":610,"y":300,"wires":[]},{"id":"60168c1031696079","type":"ui_button","z":"c3b403f3.a5a5b","name":"","group":"e7794a15.c6d108","order":12,"width":0,"height":0,"passthru":false,"label":"Switch","tooltip":"","color":"","bgcolor":"","className":"","icon":"","payload":"","payloadType":"str","topic":"RPI/RPI5/MyLEDCommand","topicType":"str","x":750,"y":300,"wires":[["a33bad1.077475"]]},{"id":"94f1ac505db1c5ab","type":"comment","z":"c3b403f3.a5a5b","name":"Activate also Dashboard_2","info":"","x":290,"y":460,"wires":[]},{"id":"ae8bafb87f16e723","type":"comment","z":"c3b403f3.a5a5b","name":"Activate also RPI_LED_BTN_MQTT_DASHBOARD_FINAL","info":"","x":390,"y":400,"wires":[]},{"id":"a08d8405.9e5598","type":"inject","z":"2a24c7d9.e04938","name":"","props":[{"p":"payload","v":"{\"value\":\"1\"}","vt":"json"},{"p":"topic","v":"RPI/Test","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/Test","payload":"{\"value\":\"1\"}","payloadType":"json","x":360,"y":220,"wires":[["72ed5abf.fafa04"]]},{"id":"72ed5abf.fafa04","type":"mqtt out","z":"2a24c7d9.e04938","name":"","topic":"RPI/Test","qos":"0","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"6ef2c7ecc7bb04bc","x":640,"y":220,"wires":[]},{"id":"77387b4b.3a6134","type":"mqtt in","z":"2a24c7d9.e04938","name":"","topic":"RPI/Test","qos":"1","datatype":"auto","broker":"6ef2c7ecc7bb04bc","nl":false,"rap":false,"inputs":0,"x":310,"y":300,"wires":[["d6d053a6.3410f"]]},{"id":"d6d053a6.3410f","type":"debug","z":"2a24c7d9.e04938","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":610,"y":300,"wires":[]},{"id":"4c4d7e64df3dc02b","type":"comment","z":"2a24c7d9.e04938","name":"RPI Autogen cert","info":"","x":340,"y":120,"wires":[]},{"id":"2defc925d5ea89d2","type":"inject","z":"8b6d1dc248c33d11","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI1/Test","payload":"{\"value\":\"81\"}","payloadType":"json","x":240,"y":260,"wires":[["c0bfd5fc757c7886"]]},{"id":"c0bfd5fc757c7886","type":"mqtt out","z":"8b6d1dc248c33d11","name":"","topic":"","qos":"0","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"26cc290e.df7a56","x":435,"y":260,"wires":[],"l":false},{"id":"e86555edfcfc29bf","type":"debug","z":"8b6d1dc248c33d11","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":490,"y":340,"wires":[]},{"id":"b9f7c2d925303129","type":"mqtt in","z":"8b6d1dc248c33d11","name":"","topic":"RPI/RPI1/Test","qos":"1","datatype":"auto","broker":"26cc290e.df7a56","nl":false,"rap":false,"inputs":0,"x":185.5555419921875,"y":338.88887453079224,"wires":[["e86555edfcfc29bf"]]},{"id":"0b0a41156c71317c","type":"comment","z":"8b6d1dc248c33d11","name":"Trying to get the publisher name in the topic name","info":"","x":410,"y":160,"wires":[]},{"id":"0f1a3ffd1b83ea56","type":"comment","z":"8b6d1dc248c33d11","name":"RPI Autogen cert","info":"","x":300,"y":120,"wires":[]},{"id":"174770b1.af3eff","type":"mqtt out","z":"3da35f20.0b7b6","name":"from RPI1:RPI/RPI2/Test","topic":"RPI/RPI2/Test","qos":"0","retain":"","broker":"26cc290e.df7a56","x":848.3333587646484,"y":152.2222080230713,"wires":[]},{"id":"54077064.3aeae","type":"inject","z":"3da35f20.0b7b6","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI2/Test","payload":"{\"value\":\"3\"}","payloadType":"json","x":488.33335876464844,"y":152.2222080230713,"wires":[["174770b1.af3eff"]]},{"id":"d6f83725.dc0588","type":"inject","z":"3da35f20.0b7b6","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI1/Test","payload":"{\"value\":\"1\"}","payloadType":"json","x":487.7777404785156,"y":56.666669845581055,"wires":[["5198119c.efe39"]]},{"id":"5198119c.efe39","type":"mqtt out","z":"3da35f20.0b7b6","name":"from RPI1:RPI/RPI1/Test","topic":"RPI/RPI1/Test","qos":"0","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"26cc290e.df7a56","x":847.7777404785156,"y":56.666669845581055,"wires":[]},{"id":"3d03a375.8a892c","type":"comment","z":"3da35f20.0b7b6","name":"Impersonate publication OK as RPI1 is allowed to publish on any topic","info":"","x":713.8888549804688,"y":203.33333587646484,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"6bc360fb.8d20f","type":"comment","z":"3da35f20.0b7b6","name":"'All' policy on RPI1 & RPI2","info":"","x":115,"y":20,"wires":[]},{"id":"ffbd2bd4.805278","type":"comment","z":"3da35f20.0b7b6","name":"Real RPI1","info":"","x":106.66669845581055,"y":55.555551528930664,"wires":[]},{"id":"6e8eb10c.aa959","type":"comment","z":"3da35f20.0b7b6","name":"Real RPI2","info":"","x":107.77777862548828,"y":104.44444274902344,"wires":[]},{"id":"e34c73e.fff5f9","type":"comment","z":"3da35f20.0b7b6","name":"RPI1 fakes RPI2 messages","info":"","x":165.5555648803711,"y":152.2222194671631,"wires":[]},{"id":"138302e7.5f060d","type":"mqtt out","z":"3da35f20.0b7b6","name":"from RPI2:RPI/RPI2/Test","topic":"RPI/RPI2/Test","qos":"0","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"f443af26.bbf6b","x":848.8889083862305,"y":105.5555648803711,"wires":[]},{"id":"a85b3b6c.318598","type":"inject","z":"3da35f20.0b7b6","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI2/Test","payload":"{\"value\":\"2\"}","payloadType":"json","x":488.88890838623047,"y":105.5555648803711,"wires":[["138302e7.5f060d"]]},{"id":"5c4fce11.61124","type":"mqtt in","z":"3da35f20.0b7b6","name":"RPI1 subs to RPI/#","topic":"RPI/#","qos":"1","datatype":"auto","broker":"26cc290e.df7a56","inputs":0,"x":450,"y":420,"wires":[["2749f2.3b46360e"]]},{"id":"2749f2.3b46360e","type":"debug","z":"3da35f20.0b7b6","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","targetType":"msg","x":880,"y":440,"wires":[]},{"id":"765af254.ee5c0c","type":"debug","z":"3da35f20.0b7b6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":871.6666793823242,"y":492.22224283218384,"wires":[]},{"id":"7173d20e.ab313c","type":"mqtt in","z":"3da35f20.0b7b6","name":"RPI2 subs to RPI/#","topic":"RPI/#","qos":"1","datatype":"auto","broker":"f443af26.bbf6b","inputs":0,"x":442.7777786254883,"y":492.22222900390625,"wires":[["765af254.ee5c0c"]]},{"id":"1ce6a438.82291c","type":"comment","z":"3da35f20.0b7b6","name":"No constraints on subscriptions","info":"","x":135,"y":411.111120223999,"wires":[]},{"id":"334219c2.c5ea06","type":"comment","z":"3da35f20.0b7b6","name":">> Attach publish & subscribe policy v1 to RPI2 to block it: client ID !=Topic","info":"","x":720,"y":340,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"3d7bb76b.421668","type":"inject","z":"3da35f20.0b7b6","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI1/Test","payload":"{\"value\":\"4\"}","payloadType":"json","x":490,"y":240,"wires":[["b5ba52fc.32582"]]},{"id":"b5ba52fc.32582","type":"mqtt out","z":"3da35f20.0b7b6","name":"from RPI2:RPI/RPI1/Test","topic":"RPI/RPI1/Test","qos":"0","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"f443af26.bbf6b","x":850,"y":240,"wires":[]},{"id":"d9049ca3.b1765","type":"comment","z":"3da35f20.0b7b6","name":"RPI2 fakes RPI1 messages","info":"","x":167.22220611572266,"y":240.0000114440918,"wires":[]},{"id":"b6d353b5.2483b","type":"comment","z":"3da35f20.0b7b6","name":"Impersonate publication OK as RPI1 is allowed to publish on any topic","info":"","x":715.5554962158203,"y":291.11112785339355,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"b49308c1.e3e7e8","type":"mqtt in","z":"eeada7b9.633358","name":"RPI1 subs to RPI/#","topic":"RPI/#","qos":"1","datatype":"auto","broker":"26cc290e.df7a56","inputs":0,"x":442.7777786254883,"y":588.8889827728271,"wires":[["98a97537.90f4a8"]]},{"id":"98a97537.90f4a8","type":"debug","z":"eeada7b9.633358","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","targetType":"msg","x":881.6666793823242,"y":588.8889966011047,"wires":[]},{"id":"d8e63b73.782118","type":"debug","z":"eeada7b9.633358","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":871.6666793823242,"y":641.111225605011,"wires":[]},{"id":"3f1cb0ff.68a0a","type":"mqtt in","z":"eeada7b9.633358","name":"RPI2 subs to RPI/#","topic":"RPI/#","qos":"1","datatype":"auto","broker":"f443af26.bbf6b","inputs":0,"x":442.7777786254883,"y":641.1112117767334,"wires":[["d8e63b73.782118"]]},{"id":"7bd5804.565268","type":"mqtt out","z":"eeada7b9.633358","name":"From RPI2:RPI/RPI2/Test","topic":"RPI/RPI2/Test","qos":"0","retain":"","broker":"f443af26.bbf6b","x":850,"y":80,"wires":[]},{"id":"97f30e52.24805","type":"inject","z":"eeada7b9.633358","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI2/Test","payload":"{\"value\":\"4\"}","payloadType":"json","x":470,"y":80,"wires":[["7bd5804.565268"]]},{"id":"b31972f1.b1fc9","type":"comment","z":"eeada7b9.633358","name":">> attach policy v2 to RPI2 to block it as soon as it connects as thingName != Topic","info":"","x":790,"y":220,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"11a6406a.a4d8a","type":"comment","z":"eeada7b9.633358","name":"No constraints on subscriptions","info":"","x":135,"y":560.0001029968262,"wires":[]},{"id":"3583a474.bb170c","type":"comment","z":"eeada7b9.633358","name":"Connection & Publication constraints on RPI2 : Publish & Subscibe Policy version 1","info":"","x":296.6666259765625,"y":45.555542945861816,"wires":[]},{"id":"e264a194.9318d","type":"mqtt out","z":"eeada7b9.633358","name":"Connect from RPI2 as fake RPI1:RPI/RPI1/Test","topic":"RPI/RPI1/Test","qos":"0","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"8347ae6e.249ec","x":781.6666259765625,"y":123.33332633972168,"wires":[]},{"id":"bf1902d2.3dc0f","type":"comment","z":"eeada7b9.633358","name":"Impersonate connection OK as thing name matches client ID!","info":"","x":726.1111145019531,"y":174.44451808929443,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"21f41d28.e18572","type":"comment","z":"eeada7b9.633358","name":"RPI2 still connecting & publishing","info":"","x":179.4444122314453,"y":81.33332824707031,"wires":[]},{"id":"a53e9ba6.7b66a8","type":"comment","z":"eeada7b9.633358","name":"RPI2 using RPI1 as clientID","info":"","x":170.55551147460938,"y":129.11111164093018,"wires":[]},{"id":"73137f63.2e3f5","type":"comment","z":"eeada7b9.633358","name":"#B (real RPI) gets disconnected by #A publish above","info":"","x":1170,"y":560,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"5e6e4861.030c98","type":"inject","z":"eeada7b9.633358","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI1/Test","payload":"{\"value\":\"5\"}","payloadType":"json","x":471.6666259765625,"y":123.33332633972168,"wires":[["e264a194.9318d"]]},{"id":"7072bcc.f8af344","type":"comment","z":"eeada7b9.633358","name":"#A gets (fake RPI1) disconnected by #B subscribe below","info":"","x":1170,"y":140,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"39a94fa8.d0f4b","type":"debug","z":"eeada7b9.633358","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":878.8889007568359,"y":740.0000138282776,"wires":[]},{"id":"600f65a.be1b59c","type":"mqtt in","z":"eeada7b9.633358","d":true,"name":"RPI2 subs to #","topic":"#","qos":"1","datatype":"auto","broker":"f443af26.bbf6b","nl":false,"rap":false,"inputs":0,"x":440,"y":740,"wires":[["39a94fa8.d0f4b"]]},{"id":"17b801e2.41269e","type":"comment","z":"eeada7b9.633358","name":">> attach policy v3 to RPI2 to restrict topic to RPI/#","info":"","x":710,"y":700,"wires":[],"icon":"node-red/arrow-in.png"},{"id":"e9a4f0f7576a6b71","type":"inject","z":"fe1f66fac233d8f2","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI1/Test","payload":"{\"value\":\"81\"}","payloadType":"json","x":200,"y":200,"wires":[["e2ccf2470dae7e68"]]},{"id":"e2ccf2470dae7e68","type":"mqtt out","z":"fe1f66fac233d8f2","name":"","topic":"","qos":"0","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"6ef2c7ecc7bb04bc","x":395,"y":200,"wires":[],"l":false},{"id":"ba021b9fc899519f","type":"debug","z":"fe1f66fac233d8f2","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":450,"y":280,"wires":[]},{"id":"932add1b0d6164db","type":"mqtt in","z":"fe1f66fac233d8f2","name":"","topic":"RPI/RPI1/Test","qos":"1","datatype":"auto","broker":"6ef2c7ecc7bb04bc","nl":false,"rap":false,"inputs":0,"x":145.5555419921875,"y":278.88887453079224,"wires":[["ba021b9fc899519f"]]},{"id":"b82b1fbc82f8a539","type":"comment","z":"fe1f66fac233d8f2","name":"Using our Own CA","info":"","x":150,"y":120,"wires":[]},{"id":"173b856e.90befb","type":"inject","z":"2ea861b1.19c0be","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI1/Test","payload":"{\"value\":\"101\"}","payloadType":"json","x":220,"y":140,"wires":[["fff859d.1867ba8"]]},{"id":"fff859d.1867ba8","type":"mqtt out","z":"2ea861b1.19c0be","name":"","topic":"RPI/RPI1/Test","qos":"0","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"6ef2c7ecc7bb04bc","x":620,"y":100,"wires":[]},{"id":"30f35717.364b88","type":"inject","z":"2ea861b1.19c0be","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI1/Test","payload":"{\"value\":\"1\"}","payloadType":"json","x":210,"y":60,"wires":[["fff859d.1867ba8"]]},{"id":"c859866e.5e01e8","type":"mqtt in","z":"2ea861b1.19c0be","name":"","topic":"RPI/Alert","qos":"1","datatype":"auto","broker":"6ef2c7ecc7bb04bc","nl":false,"rap":false,"inputs":0,"x":151,"y":300,"wires":[["9726e8df.816498"]]},{"id":"9726e8df.816498","type":"debug","z":"2ea861b1.19c0be","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":470,"y":300,"wires":[]},{"id":"117d7e9c.f301e1","type":"inject","z":"2ea861b1.19c0be","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI1/Test","payload":"{\"value\":\"81\"}","payloadType":"json","x":220,"y":100,"wires":[["fff859d.1867ba8"]]},{"id":"cf028543.02fcf8","type":"debug","z":"2ea861b1.19c0be","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","x":470,"y":380,"wires":[]},{"id":"9f138b08.bfb5b8","type":"mqtt in","z":"2ea861b1.19c0be","name":"","topic":"RPI/Alert2","qos":"1","datatype":"auto","broker":"6ef2c7ecc7bb04bc","nl":false,"rap":false,"inputs":0,"x":151,"y":380,"wires":[["cf028543.02fcf8"]]},{"id":"c4588bd3.5d5978","type":"mqtt out","z":"2ea861b1.19c0be","name":"","topic":"RPI/RPI3/Test","qos":"0","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"6ee9e116.283a7","x":484.4444274902344,"y":508.88885498046875,"wires":[]},{"id":"b3bb77ba.b33a28","type":"inject","z":"2ea861b1.19c0be","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI3/Test","payload":"{\"value\":\"1\"}","payloadType":"json","x":204.44444274902344,"y":510.0000150203705,"wires":[["c4588bd3.5d5978"]]},{"id":"b6f0a782.6fcfb8","type":"debug","z":"2ea861b1.19c0be","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":473.33331298828125,"y":567.7777709960938,"wires":[]},{"id":"5415b0a3.68ae7","type":"mqtt in","z":"2ea861b1.19c0be","name":"","topic":"RPI/RPI3/#","qos":"1","datatype":"auto","broker":"6ee9e116.283a7","nl":false,"rap":false,"inputs":0,"x":154.33331298828125,"y":567.7777709960938,"wires":[["b6f0a782.6fcfb8"]]},{"id":"920dead2.541598","type":"comment","z":"2ea861b1.19c0be","name":"with Own CA","info":"","x":150,"y":20,"wires":[]},{"id":"268163b4.1c1b9c","type":"inject","z":"2ea861b1.19c0be","name":"RPI/RPI1/Test:{\"value\":\"101\",\"default\":\"My Message\"}","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI1/Test","payload":"{\"value\":\"101\",\"default\":\"My Message\"}","payloadType":"json","x":280,"y":180,"wires":[["fff859d.1867ba8"]]},{"id":"cfb98368.aea26","type":"debug","z":"2ea861b1.19c0be","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":470,"y":220,"wires":[]},{"id":"747916da.05bb78","type":"mqtt in","z":"2ea861b1.19c0be","name":"","topic":"RPI/RPI1/Test","qos":"1","datatype":"auto-detect","broker":"6ef2c7ecc7bb04bc","nl":false,"rap":false,"inputs":0,"x":158.8888931274414,"y":220.0000057220459,"wires":[["cfb98368.aea26"]]},{"id":"df770ac8.e984d8","type":"mqtt out","z":"7055f43d.d3095c","name":"","topic":"RPI/RPI1/Test","qos":"0","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"6ef2c7ecc7bb04bc","x":540,"y":200,"wires":[]},{"id":"d1bb35b4.707508","type":"inject","z":"7055f43d.d3095c","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"1","crontab":"","once":false,"onceDelay":0.1,"topic":"RPI/RPI1/Test","payload":"{\"value\":\"1\"}","payloadType":"json","x":240,"y":200,"wires":[["37a9027b.8857de","df770ac8.e984d8"]]},{"id":"37a9027b.8857de","type":"debug","z":"7055f43d.d3095c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","x":530,"y":280,"wires":[]},{"id":"3ab6d948995c1664","type":"debug","z":"7055f43d.d3095c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":850,"y":380,"wires":[]},{"id":"f9bc65c7fdcd6ed7","type":"mqtt in","z":"7055f43d.d3095c","name":"","topic":"RPI/RPI1/Test","qos":"1","datatype":"auto-detect","broker":"6ef2c7ecc7bb04bc","nl":false,"rap":false,"inputs":0,"x":538.8888931274414,"y":380.0000057220459,"wires":[["3ab6d948995c1664"]]},{"id":"db345516.6fb288","type":"inject","z":"df136e3e.4e7d","name":"Start Subscribe","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"str","x":120,"y":400,"wires":[["c0750d6e.d5125"]]},{"id":"8479ef81.37ad8","type":"debug","z":"df136e3e.4e7d","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","x":680,"y":400,"wires":[]},{"id":"6f958c62.409d54","type":"debug","z":"df136e3e.4e7d","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","statusVal":"payload","statusType":"auto","x":660,"y":200,"wires":[]},{"id":"d24cae73.6f244","type":"inject","z":"df136e3e.4e7d","name":"","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"str","x":90,"y":159.00000190734863,"wires":[["a8c5b72d.2760f8"]]},{"id":"e39a7abc.a27268","type":"inject","z":"df136e3e.4e7d","name":"","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"LED_ON","payloadType":"str","x":100,"y":240,"wires":[["9e6c880e.32a7d8"]]},{"id":"183c7a54.bd3016","type":"inject","z":"df136e3e.4e7d","name":"","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"LED_OFF","payloadType":"str","x":100,"y":280,"wires":[["9e6c880e.32a7d8"]]},{"id":"93124cd1.d5518","type":"inject","z":"df136e3e.4e7d","name":"","props":[{"p":"payload","v":"INIT","vt":"str"},{"p":"topic","v":"","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"INIT","payloadType":"str","x":90,"y":80,"wires":[["256f1e85.2723d2"]]},{"id":"24d47160.cf305e","type":"comment","z":"df136e3e.4e7d","name":"!! Click here once to create topic on local coapserver.py (ensure coappserver.py is running on default port 5683","info":"","x":390,"y":40,"wires":[]},{"id":"c1e242ec.8666d","type":"comment","z":"df136e3e.4e7d","name":"Unitary PUT / GET","info":"","x":106,"y":123.00000190734863,"wires":[]},{"id":"2839e99a.f71716","type":"comment","z":"df136e3e.4e7d","name":"Subscription via Observe","info":"","x":130,"y":360,"wires":[]},{"id":"42fe5661.545528","type":"inject","z":"df136e3e.4e7d","name":"","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"str","x":90.00000381469727,"y":201.00000381469727,"wires":[["f925ec76.18b2f"]]},{"id":"f925ec76.18b2f","type":"coap request","z":"df136e3e.4e7d","method":"GET","observe":false,"url":"coap://localhost:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"GET /storage/LED","x":410,"y":200,"wires":[["6f958c62.409d54"]]},{"id":"9e6c880e.32a7d8","type":"coap request","z":"df136e3e.4e7d","method":"PUT","observe":false,"url":"coap://localhost:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"PUT /storage/LED","x":410,"y":260,"wires":[[]]},{"id":"256f1e85.2723d2","type":"coap request","z":"df136e3e.4e7d","method":"POST","observe":false,"url":"coap://localhost:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"POST /storage/LED","x":420,"y":80,"wires":[[]]},{"id":"c0750d6e.d5125","type":"coap request","z":"df136e3e.4e7d","method":"GET","observe":true,"url":"coap://localhost:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"GET Observe /storage/LED","x":440,"y":400,"wires":[["8479ef81.37ad8"]]},{"id":"a8c5b72d.2760f8","type":"coap request","z":"df136e3e.4e7d","method":"GET","observe":false,"url":"coap://localhost:5683/.well-known/core","content-format":"text/plain","raw-buffer":false,"name":"GET /.well-known/core","x":419,"y":158,"wires":[["6f958c62.409d54"]]},{"id":"8b608ac5.eb4a18","type":"debug","z":"77dd7f0d.54335","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"req.payload","statusVal":"req.payload","statusType":"auto","x":390,"y":480,"wires":[]},{"id":"a991aa15.e79fd8","type":"inject","z":"77dd7f0d.54335","name":"","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"LED_ON","payloadType":"str","x":140,"y":280,"wires":[["5250ebd3.53f0b4"]]},{"id":"c9ff69d6.52b138","type":"inject","z":"77dd7f0d.54335","name":"","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"LED_OFF","payloadType":"str","x":140,"y":320,"wires":[["5250ebd3.53f0b4"]]},{"id":"8762efce.90d52","type":"switch","z":"77dd7f0d.54335","name":"Parse command","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"LED_OFF","vt":"str"},{"t":"eq","v":"LED_ON","vt":"str"},{"t":"eq","v":"LED_SWITCH","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":4,"x":600,"y":660,"wires":[["c6216511.b36758"],["e720cd4c.dfad3"],[],[]]},{"id":"c6216511.b36758","type":"function","z":"77dd7f0d.54335","name":"Set LED state OFF","func":"var currentLedState = flow.get(\"LEDState\")||0;\nif (currentLedState===0)\n    return null;\n    \nledState = 0;\nmsg.payload = ledState;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"noerr":0,"x":850,"y":640,"wires":[["a03f3b02.dcc888"]]},{"id":"e720cd4c.dfad3","type":"function","z":"77dd7f0d.54335","name":"Set LED state ON","func":"currentLedState = flow.get(\"LEDState\")||0;\nledPower=flow.get(\"LEDPower\")||0;\n\nif (currentLedState==1)\n    if (ledPower==100)\n        return null;\n    else\n        ledPower=100;\n\nledState = 1;\nif (ledPower===0)\n    ledPower=100;\n    \nmsg.payload = ledPower;\n\nflow.set(\"LEDState\", ledState);\nflow.set(\"LEDPower\", ledPower);\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":680,"wires":[["a03f3b02.dcc888"]]},{"id":"a03f3b02.dcc888","type":"change","z":"77dd7f0d.54335","name":"Dispatch","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1040,"y":660,"wires":[["e321e233.9feef","5adf2c3c.271474"]]},{"id":"5adf2c3c.271474","type":"rpi-gpio out","z":"77dd7f0d.54335","name":"LED on GPIO18","pin":"18","set":false,"level":"0","freq":"","out":"pwm","bcm":true,"x":1220,"y":620,"wires":[]},{"id":"e321e233.9feef","type":"debug","z":"77dd7f0d.54335","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","statusVal":"payload","statusType":"auto","x":1210,"y":680,"wires":[],"inputLabels":["msg.payload"]},{"id":"d269ecd7.5c924","type":"function","z":"77dd7f0d.54335","name":"BufferToString","func":"msg.payload=msg.req.payload.toString();\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":540,"wires":[["8762efce.90d52","7b990096.2694c"]]},{"id":"7b990096.2694c","type":"debug","z":"77dd7f0d.54335","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"req.payload","statusVal":"req.payload","statusType":"auto","x":610,"y":540,"wires":[]},{"id":"8f05942.f8d3668","type":"comment","z":"77dd7f0d.54335","name":"Add this to your MQTT flow","info":"","x":170,"y":400,"wires":[]},{"id":"71f34405.c2557c","type":"comment","z":"77dd7f0d.54335","name":"..............................  Existing MQTT Flow.....................................","info":"","x":750,"y":600,"wires":[]},{"id":"9733bed3.3de08","type":"comment","z":"77dd7f0d.54335","name":"Copy and update this to your MQTT flow","info":"","x":220,"y":200,"wires":[]},{"id":"d4fe2981.99b578","type":"function","z":"77dd7f0d.54335","name":"Responder","func":"var currentLedState = flow.get(\"LEDState\")||0;\nvar currentLedPower = flow.get(\"LEDPower\")||0;\n\nif (currentLedState===0)\n    msg.res.end(\"0\");\nelse\n    msg.res.end(currentLedPower.toString());\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":390,"y":440,"wires":[[]]},{"id":"6b264052.6cc76","type":"debug","z":"77dd7f0d.54335","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":720,"y":240,"wires":[]},{"id":"e6fc18b2.616108","type":"inject","z":"77dd7f0d.54335","name":"","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"str","x":130,"y":240,"wires":[["e4ddcaee.0bed18"]]},{"id":"da7071fd.d6d7b","type":"function","z":"77dd7f0d.54335","name":"Responder","func":"msg.res.end();\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":371.111083984375,"y":669.3333129882812,"wires":[[]]},{"id":"43f501588d6c2481","type":"comment","z":"77dd7f0d.54335","name":"This uses the NodeRed embedded coap server on port 55683","info":"","x":280,"y":20,"wires":[]},{"id":"f32a70102eb76658","type":"inject","z":"77dd7f0d.54335","name":"","props":[{"p":"payload","v":"INIT","vt":"str"},{"p":"topic","v":"","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"INIT","payloadType":"str","x":130,"y":100,"wires":[["d0e35bc804c43150"]]},{"id":"56f36aeefc48ffc4","type":"comment","z":"77dd7f0d.54335","name":"!! Click here once to create topic on embedded coap server on port 55683","info":"","x":320,"y":60,"wires":[]},{"id":"53b1d0c5200fe1b5","type":"comment","z":"77dd7f0d.54335","name":"LATEST VERSION OF COAP DOESN'T HANDLE THE CUSTOM PORT !","info":"","x":640,"y":40,"wires":[]},{"id":"da4948af.4c63e8","type":"coap in","z":"77dd7f0d.54335","method":"POST","name":"","server":"7d4138fe.5bb9d8","url":"/storage/LED","x":160,"y":480,"wires":[["8b608ac5.eb4a18","d269ecd7.5c924","da7071fd.d6d7b"]]},{"id":"a38cc33e.cf8dd","type":"coap in","z":"77dd7f0d.54335","method":"PUT","name":"","server":"7d4138fe.5bb9d8","url":"/storage/LED","x":150,"y":520,"wires":[["8b608ac5.eb4a18","d269ecd7.5c924","da7071fd.d6d7b"]]},{"id":"61a1a231.66892c","type":"coap in","z":"77dd7f0d.54335","method":"GET","name":"","server":"7d4138fe.5bb9d8","url":"/storage/LED","x":150,"y":440,"wires":[["d4fe2981.99b578"]]},{"id":"5250ebd3.53f0b4","type":"coap request","z":"77dd7f0d.54335","method":"PUT","confirmable":false,"observe":false,"multicast":false,"url":"coap://127.0.0.1:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"PUT /storage/LED","x":450,"y":300,"wires":[[]]},{"id":"e4ddcaee.0bed18","type":"coap request","z":"77dd7f0d.54335","method":"GET","confirmable":false,"observe":true,"multicast":false,"url":"coap://localhost:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"GET /storage/LED","x":450,"y":240,"wires":[["6b264052.6cc76"]]},{"id":"d0e35bc804c43150","type":"coap request","z":"77dd7f0d.54335","method":"POST","confirmable":false,"observe":false,"multicast":false,"url":"coap://localhost:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"POST /storage/LED","x":460,"y":100,"wires":[[]]},{"id":"3cb343bd.6f98ac","type":"function","z":"d1da38f2.572138","name":"Switch LED state","func":"ledState=flow.get(\"LEDState\")||0;\nledPower=flow.get(\"LEDPower\")||0;\n\n(ledState === 0) ? ledState = 1 : ledState = 0;\nif (ledState==1)\n    {\n    if (ledPower===0)\n        ledPower=100;\n    msg.payload = ledPower;\n    }\nelse\n    msg.payload=0;\n    \nflow.set(\"LEDState\", ledState);\nreturn msg;","outputs":1,"noerr":0,"x":630.0000076293945,"y":476.9999952316284,"wires":[["71990b72.037c34"]]},{"id":"4d28f84b.cf5518","type":"inject","z":"d1da38f2.572138","name":"LED OFF","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED OFF","payload":"0","payloadType":"num","x":87.00000762939453,"y":516.9999980926514,"wires":[["a0cafd07.403d"]]},{"id":"3fa58c9d.3c79d4","type":"debug","z":"d1da38f2.572138","name":"LED value","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":990,"y":500.0000009536743,"wires":[],"inputLabels":["msg.payload"]},{"id":"efa6eb3a.67a658","type":"inject","z":"d1da38f2.572138","name":"LED ON","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"LED ON","payload":"ledPower","payloadType":"flow","x":87.00000381469727,"y":586.9999980926514,"wires":[["e7e335fc.210258"]]},{"id":"adbf9cfb.cb672","type":"rpi-gpio out","z":"d1da38f2.572138","name":"LED on GPIO18","pin":"18","set":false,"level":"0","freq":"","out":"pwm","bcm":true,"x":1000,"y":440.0000009536743,"wires":[]},{"id":"c2262900.bcd998","type":"rpi-gpio in","z":"d1da38f2.572138","name":"BTN on GPIO4","pin":"4","intype":"up","debounce":"25","read":true,"bcm":true,"x":85,"y":737.9999990463257,"wires":[["b92db6ed.c29d18"]]},{"id":"5507ea75.e7c8f4","type":"inject","z":"d1da38f2.572138","name":"SWITCH LED","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":97,"y":656.9999985694885,"wires":[["3cb343bd.6f98ac"]]},{"id":"9a97de1b.d215f","type":"function","z":"d1da38f2.572138","name":"If button down","func":"if (msg.payload===0)\n    return msg;\n    \nreturn  null;","outputs":1,"noerr":0,"x":302.0908966064453,"y":771.7272939682007,"wires":[[]]},{"id":"b92db6ed.c29d18","type":"switch","z":"d1da38f2.572138","name":"If button down","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":300,"y":736.9999990463257,"wires":[["3cb343bd.6f98ac"],[]]},{"id":"a0cafd07.403d","type":"function","z":"d1da38f2.572138","name":"Set LED state OFF","func":"var currentLedState = flow.get(\"LEDState\")||0;\nif (currentLedState===0)\n    return null;\n    \nledState = 0;\nmsg.payload = ledState;\n\nflow.set(\"LEDState\", ledState);\nreturn msg;\n\n","outputs":1,"noerr":0,"x":630,"y":400.0000009536743,"wires":[["71990b72.037c34"]]},{"id":"e7e335fc.210258","type":"function","z":"d1da38f2.572138","name":"Set LED state ON","func":"currentLedState = flow.get(\"LEDState\")||0;\nledPower=flow.get(\"LEDPower\")||0;\n\nif (currentLedState==1)\n    if (ledPower==100)\n        return null;\n    else\n        ledPower=100;\n\nledState = 1;\nif (ledPower===0)\n    ledPower=100;\n    \nmsg.payload = ledPower;\n\nflow.set(\"LEDState\", ledState);\nflow.set(\"LEDPower\", ledPower);\nreturn msg;","outputs":1,"noerr":0,"x":630.0000076293945,"y":438.9999942779541,"wires":[["71990b72.037c34"]]},{"id":"284b2edf.9d3fe2","type":"mqtt in","z":"d1da38f2.572138","name":"","topic":"RPI/RPI1/MyLEDCommand","qos":"1","datatype":"auto","broker":"6ef2c7ecc7bb04bc","nl":false,"rap":false,"inputs":0,"x":125,"y":261.00000381469727,"wires":[["eb955d42.95fa","fe08a0ee.0847f"]]},{"id":"629e915b.0b3cb","type":"mqtt out","z":"d1da38f2.572138","name":"Publish MyLEDState","topic":"RPI/RPI1/MyLEDState","qos":"1","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"6ef2c7ecc7bb04bc","x":1020,"y":380.0000009536743,"wires":[]},{"id":"eb955d42.95fa","type":"switch","z":"d1da38f2.572138","name":"Parse command","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"LED_OFF","vt":"str"},{"t":"eq","v":"LED_ON","vt":"str"},{"t":"eq","v":"LED_SWITCH","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":4,"x":375.00000762939453,"y":243.00000381469727,"wires":[["a0cafd07.403d"],["e7e335fc.210258"],["3cb343bd.6f98ac"],["d2be01ff.eb577"]]},{"id":"fe08a0ee.0847f","type":"debug","z":"d1da38f2.572138","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":372.00000381469727,"y":313.0000057220459,"wires":[]},{"id":"71990b72.037c34","type":"change","z":"d1da38f2.572138","name":"Dispatch","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":820,"y":440.0000009536743,"wires":[["5cf8169c.da6a18","3fa58c9d.3c79d4","adbf9cfb.cb672","629e915b.0b3cb","79c451d6.9620c","a7858c99.6363a"]]},{"id":"d2be01ff.eb577","type":"change","z":"d1da38f2.572138","name":"Unknown command","rules":[{"t":"change","p":"payload","pt":"msg","from":"^(.*)$","fromt":"re","to":"Unknown MQTT command received : [$1] ","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":623.0000076293945,"y":212.00002765655518,"wires":[["1da5117d.e6ef8f","b3ae5d0e.d1c73"]]},{"id":"249e17d7.e62398","type":"mqtt in","z":"d1da38f2.572138","name":"","topic":"RPI/RPI1/MyLEDPower","qos":"1","datatype":"auto","broker":"6ef2c7ecc7bb04bc","nl":false,"rap":false,"inputs":0,"x":105,"y":333.99999237060547,"wires":[["fe08a0ee.0847f","ca57bde7.0ef7f"]]},{"id":"ca57bde7.0ef7f","type":"function","z":"d1da38f2.572138","name":"Set LED Power","func":"var ledPower=msg.payload;\nvar ledState;\n\nif (ledPower===0)\n    {\n    ledState=0;\n    ledPower=100;\n    }\nelse\n    ledState=1;\n    \nflow.set(\"LEDState\", ledState);\nflow.set(\"LEDPower\", ledPower);\nreturn msg;","outputs":1,"noerr":0,"x":620,"y":360.0000009536743,"wires":[["71990b72.037c34"]]},{"id":"f5e5f436.626ca8","type":"comment","z":"d1da38f2.572138","name":"CoAP PUT (controls) ","info":"","x":107.0909013748169,"y":820.7272758483887,"wires":[]},{"id":"b817ab0f.93e2c8","type":"debug","z":"d1da38f2.572138","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"req.payload","targetType":"msg","statusVal":"req.payload","statusType":"auto","x":370.00000381469727,"y":96.00000095367432,"wires":[]},{"id":"fa71236f.0c43e","type":"function","z":"d1da38f2.572138","name":"BufferToString","func":"msg.payload=msg.req.payload.toString();\nmsg.res.end(\"200\");\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":372.00000762939453,"y":141.00000190734863,"wires":[["afb871dc.0df8f","eb955d42.95fa"]]},{"id":"afb871dc.0df8f","type":"debug","z":"d1da38f2.572138","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"req.payload","x":601.0000076293945,"y":141.0000023841858,"wires":[]},{"id":"1328aa8e.b07d35","type":"function","z":"d1da38f2.572138","name":"Responder","func":"currentLedState = flow.get(\"LEDState\")||0;\ncurrentLedPower = flow.get(\"LEDPower\")||0;\n\nif (currentLedState===0)\n    msg.res.end(\"0\");\nelse\n    msg.res.end(currentLedPower.toString());\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":361.00000381469727,"y":59.00000047683716,"wires":[[]]},{"id":"524806ea.b17788","type":"inject","z":"d1da38f2.572138","name":"","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"LED_ON","payloadType":"str","x":100,"y":900,"wires":[["73657.a36079a94"]]},{"id":"90e8ca81.5a2928","type":"inject","z":"d1da38f2.572138","name":"","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"LED_OFF","payloadType":"str","x":100,"y":940,"wires":[["73657.a36079a94"]]},{"id":"aee3a4d8.d72fd8","type":"debug","z":"d1da38f2.572138","name":"","active":true,"tosidebar":true,"console":true,"tostatus":true,"complete":"payload","x":680,"y":860,"wires":[]},{"id":"9a0f5948.6e4118","type":"inject","z":"d1da38f2.572138","name":"","repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"","payloadType":"str","x":90,"y":860,"wires":[["92c4dc4f.ee56b"]]},{"id":"b3ae5d0e.d1c73","type":"debug","z":"d1da38f2.572138","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","x":1010,"y":140,"wires":[],"inputLabels":["msg.payload"]},{"id":"7c118c47.8462a4","type":"comment","z":"d1da38f2.572138","name":"CoAP responder","info":"","x":85,"y":23.599998474121094,"wires":[]},{"id":"84ca7a6.8949e88","type":"comment","z":"d1da38f2.572138","name":"MQTT responder","info":"","x":85,"y":192.00000381469727,"wires":[]},{"id":"83efc7ef.e1bc78","type":"comment","z":"d1da38f2.572138","name":"Dashboard & inflow controls","info":"","x":125,"y":380.99999618530273,"wires":[]},{"id":"ec4b2ecf.e3cbb","type":"comment","z":"d1da38f2.572138","name":"Hardware button","info":"","x":85,"y":699.9999990463257,"wires":[]},{"id":"742e1437.a167dc","type":"comment","z":"d1da38f2.572138","name":"LED state & commands mgt","info":"","x":656,"y":314,"wires":[]},{"id":"9b4b4006.c1226","type":"comment","z":"d1da38f2.572138","name":"LED change, notifications, dashboard out","info":"","x":981.0000152587891,"y":296.00001430511475,"wires":[]},{"id":"f48d9bc2.2c4b98","type":"ui_button","z":"d1da38f2.572138","name":"","group":"4608a4ea.943abc","order":1,"width":0,"height":0,"passthru":false,"label":"ON","tooltip":"","color":"","bgcolor":"green","icon":"","payload":"1","payloadType":"str","topic":"","topicType":"str","x":78,"y":552.9999961853027,"wires":[["e7e335fc.210258"]]},{"id":"95dbf3cd.463de","type":"ui_button","z":"d1da38f2.572138","name":"","group":"4608a4ea.943abc","order":2,"width":0,"height":0,"passthru":false,"label":"OFF","tooltip":"","color":"","bgcolor":"red","icon":"","payload":"0","payloadType":"str","topic":"","topicType":"str","x":78,"y":481.9999942779541,"wires":[["a0cafd07.403d"]]},{"id":"87385d1b.f38e3","type":"ui_switch","z":"d1da38f2.572138","name":"","label":"switch","tooltip":"","group":"4608a4ea.943abc","order":3,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"","topicType":"str","style":"","onvalue":"true","onvalueType":"bool","onicon":"power_settings_new","oncolor":"green","offvalue":"false","offvalueType":"bool","officon":"power_settings_new","offcolor":"red","animate":true,"x":78,"y":622.9999961853027,"wires":[["3cb343bd.6f98ac"]]},{"id":"f904144e.9247f8","type":"ui_slider","z":"d1da38f2.572138","name":"","label":"slider","tooltip":"","group":"4608a4ea.943abc","order":7,"width":0,"height":0,"passthru":true,"outs":"all","topic":"","topicType":"str","min":0,"max":"100","step":"10","x":276.00000381469727,"y":402.99999237060547,"wires":[["ca57bde7.0ef7f","a6958df0.81df2"]]},{"id":"a6958df0.81df2","type":"ui_text_input","z":"d1da38f2.572138","name":"","label":"Select a value","tooltip":"","group":"4608a4ea.943abc","order":5,"width":0,"height":0,"passthru":true,"mode":"text","delay":300,"topic":"","topicType":"str","x":115.00005340576172,"y":446.9999942779541,"wires":[["f904144e.9247f8"]]},{"id":"5cf8169c.da6a18","type":"ui_text","z":"d1da38f2.572138","group":"4608a4ea.943abc","order":8,"width":0,"height":0,"name":"","label":"LED is ","format":"{{msg.payload}}%","layout":"row-spread","x":970,"y":560.0000009536743,"wires":[]},{"id":"1da5117d.e6ef8f","type":"ui_text","z":"d1da38f2.572138","group":"63c5ce38.817cc","order":13,"width":0,"height":0,"name":"Error","label":"text","format":"{{msg.payload}}","layout":"row-spread","x":988.0000152587891,"y":218.00000286102295,"wires":[]},{"id":"79c451d6.9620c","type":"ui_gauge","z":"d1da38f2.572138","name":"","group":"4608a4ea.943abc","order":10,"width":0,"height":0,"gtype":"gage","title":"gauge","label":"units","format":"{{value}}","min":0,"max":"100","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":971.0000114440918,"y":603.0000085830688,"wires":[]},{"id":"a7858c99.6363a","type":"ui_chart","z":"d1da38f2.572138","name":"","group":"4608a4ea.943abc","order":12,"width":0,"height":0,"label":"chart","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"60","cutout":0,"useOneColor":false,"useUTC":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"outputs":1,"useDifferentColor":false,"x":972.0000114440918,"y":643.0000085830688,"wires":[[]]},{"id":"7cb47eb9.1117d","type":"inject","z":"d1da38f2.572138","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"100","payloadType":"num","x":690,"y":560,"wires":[["adbf9cfb.cb672"]]},{"id":"7ac72bf9.4a5854","type":"inject","z":"d1da38f2.572138","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"0","payloadType":"num","x":690,"y":520,"wires":[["adbf9cfb.cb672"]]},{"id":"e649beba52fbce9f","type":"inject","z":"d1da38f2.572138","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"","topic":"","payload":"LED_SWITCH","payloadType":"str","x":110,"y":980,"wires":[["73657.a36079a94"]]},{"id":"33f70d58f14e37fa","type":"comment","z":"d1da38f2.572138","name":"LATEST VERSION OF COAP DOESN'T HANDLE THE CUSTOM PORT ! Stop python server!","info":"","x":540,"y":820,"wires":[]},{"id":"1f3be2894eca4339","type":"comment","z":"d1da38f2.572138","name":"LATEST VERSION OF COAP DOESN'T HANDLE THE CUSTOM PORT ! Stop python server!","info":"","x":520,"y":40,"wires":[]},{"id":"81ace750.9a42e8","type":"coap in","z":"d1da38f2.572138","method":"POST","name":"","server":"7d4138fe.5bb9d8","url":"/storage/LED","x":90,"y":100,"wires":[["b817ab0f.93e2c8","fa71236f.0c43e"]]},{"id":"9e55ad59.0fc69","type":"coap in","z":"d1da38f2.572138","method":"PUT","name":"","server":"7d4138fe.5bb9d8","url":"/storage/LED","x":95,"y":139.00000190734863,"wires":[["b817ab0f.93e2c8","fa71236f.0c43e"]]},{"id":"b5033d56.3fedc","type":"coap in","z":"d1da38f2.572138","method":"GET","name":"","server":"7d4138fe.5bb9d8","url":"/storage/LED","x":95,"y":59.00000190734863,"wires":[["1328aa8e.b07d35"]]},{"id":"73657.a36079a94","type":"coap request","z":"d1da38f2.572138","method":"PUT","confirmable":false,"observe":false,"multicast":false,"url":"coap://127.0.0.1:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"PUT /storage/LED","x":410,"y":920,"wires":[[]]},{"id":"92c4dc4f.ee56b","type":"coap request","z":"d1da38f2.572138","method":"GET","confirmable":false,"observe":true,"multicast":false,"url":"coap://localhost:5683/storage/LED","content-format":"text/plain","raw-buffer":false,"name":"GET /storage/LED","x":410,"y":860,"wires":[["aee3a4d8.d72fd8"]]},{"id":"8b99762d836ed762","type":"inject","z":"bf296afbe68777e2","name":"Lancement périodique","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"str","x":160,"y":160,"wires":[["696b93b8ceb7813e"]]},{"id":"696b93b8ceb7813e","type":"exec","z":"bf296afbe68777e2","command":"raspistill -o /tmp/cam.jpg -w 640 -h 480","addpay":"","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"Capture de l'image","x":390,"y":160,"wires":[["ec362090e450de13"],[],[]]},{"id":"ec362090e450de13","type":"exec","z":"bf296afbe68777e2","command":"base64 -i \"/tmp/cam.jpg\"","addpay":"payload","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"Conversion base 64","x":640,"y":160,"wires":[["03c250751f52eca7"],[],[]]},{"id":"03c250751f52eca7","type":"template","z":"bf296afbe68777e2","name":"Contenu du mail","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<html>\n    <head>\n        <meta charset=\"utf8\"/>\n    </head>\n    <body>\n        <h1>Projet Photo par email</h1>\n        <img src=\"data:image/jpg;base64,{{payload}}\"/>\n    </body>\n</html>","output":"str","x":320,"y":320,"wires":[["23edc1f4dafdf61f","383deaccd2141dce"]]},{"id":"23edc1f4dafdf61f","type":"debug","z":"bf296afbe68777e2","name":"Formatage","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":350,"y":400,"wires":[]},{"id":"383deaccd2141dce","type":"template","z":"bf296afbe68777e2","name":"Email expediteur","field":"from","fieldType":"msg","format":"text","syntax":"plain","template":"yadegun@free.fr","output":"str","x":590,"y":320,"wires":[["5d24a589b977628c","0e25248176b7fa7d"]]},{"id":"5d24a589b977628c","type":"debug","z":"bf296afbe68777e2","name":"Sujet email","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"payload","statusType":"auto","x":830,"y":400,"wires":[]},{"id":"975a508d0520edf2","type":"inject","z":"bf296afbe68777e2","name":"","props":[{"p":"payload"},{"p":"from","v":"yadegun@free.fr","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"body","payloadType":"str","x":110,"y":540,"wires":[["03f9cf88dc11c44b"]]},{"id":"0e25248176b7fa7d","type":"sendgrid","z":"bf296afbe68777e2","from":"yadegun@free.fr","multiple":false,"to":"yadegun@free.fr","name":"Envoi mail","content":"text","templateId":"","templateData":"","x":870,"y":320,"wires":[]},{"id":"03f9cf88dc11c44b","type":"sendgrid","z":"bf296afbe68777e2","from":"yadegun@free.fr","multiple":false,"to":"yadegun@free.fr","name":"Envoi mail","content":"text","templateId":"","templateData":"","x":470,"y":540,"wires":[]}]
Node Red All flows 2025
